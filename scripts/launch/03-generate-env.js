#!/usr/bin/env node

/**
 * AZORA ENVIRONMENT CONFIGURATION GENERATOR
 * 
 * Generates .env.local files for all apps based on discovered services
 * Reads .azora-services.json and creates environment configurations
 * 
 * Usage: node scripts/generate-env.js
 */

const fs = require('fs');
const path = require('path');

const APPS = [
    'azora-sapiens',
    'azora-buildspaces',
    'azora-master',
    'azora-mint',
    'azora-finance',
    'azora-jobspaces',
];

async function generateEnvironments() {
    console.log('üîß Generating environment configurations...\n');

    // Read service discovery file
    const servicesPath = path.join(process.cwd(), '.azora-services.json');

    if (!fs.existsSync(servicesPath)) {
        console.error('‚ùå .azora-services.json not found. Run discover-services.js first.');
        process.exit(1);
    }

    const servicesConfig = JSON.parse(fs.readFileSync(servicesPath, 'utf-8'));
    const { services } = servicesConfig;

    // Generate for each app
    for (const appName of APPS) {
        const appPath = path.join(process.cwd(), 'apps', appName);

        if (!fs.existsSync(appPath)) {
            console.log(`‚ö†Ô∏è  Skipping ${appName} (directory not found)`);
            continue;
        }

        const envContent = generateEnvForApp(appName, services);
        const envPath = path.join(appPath, '.env.local');

        // Backup existing .env.local
        if (fs.existsSync(envPath)) {
            const backupPath = path.join(appPath, '.env.local.backup');
            fs.copyFileSync(envPath, backupPath);
            console.log(`üì¶ Backed up existing ${appName}/.env.local`);
        }

        fs.writeFileSync(envPath, envContent);
        console.log(`‚úÖ Generated ${appName}/.env.local`);
    }

    console.log('\n‚ú® Environment configuration complete!');
    console.log('\nüìù Next steps:');
    console.log('   1. Review generated .env.local files');
    console.log('   2. Add any missing API keys (AI providers, Stripe, etc.)');
    console.log('   3. Restart your development servers');
}

/**
 * Generate .env content for specific app
 */
function generateEnvForApp(appName, services) {
    const lines = [
        '# AZORA ENVIRONMENT CONFIGURATION',
        '# Auto-generated by generate-env.js',
        `# Generated: ${new Date().toISOString()}`,
        '',
        '# ==========================================',
        '# SERVICE URLS',
        '# ==========================================',
        '',
    ];

    // Add service URLs
    for (const [serviceName, config] of Object.entries(services)) {
        const envVar = `NEXT_PUBLIC_${serviceName.toUpperCase().replace(/-/g, '_')}_URL`;
        lines.push(`${envVar}=${config.url}`);
    }

    lines.push('');
    lines.push('# API Gateway (main entry point)');
    lines.push(`NEXT_PUBLIC_API_URL=${services['api-gateway']?.url || 'http://localhost:4000'}`);

    lines.push('');
    lines.push('# ==========================================');
    lines.push('# AI PROVIDER CONFIGURATION');
    lines.push('# ==========================================');
    lines.push('');
    lines.push('# Choose your AI provider: openai | anthropic | groq | together | huggingface | ollama');
    lines.push('NEXT_PUBLIC_AI_PROVIDER=groq');
    lines.push('');
    lines.push('# Add your API keys (optional - will use free tier if not provided)');
    lines.push('# Get free Groq key: https://console.groq.com');
    lines.push('GROQ_API_KEY=');
    lines.push('');
    lines.push('# Other providers (add if you want to use them)');
    lines.push('OPENAI_API_KEY=');
    lines.push('ANTHROPIC_API_KEY=');
    lines.push('TOGETHER_API_KEY=');
    lines.push('HUGGINGFACE_API_KEY=');

    lines.push('');
    lines.push('# ==========================================');
    lines.push('# AUTHENTICATION');
    lines.push('# ==========================================');
    lines.push('');
    lines.push('NEXTAUTH_URL=http://localhost:3000');
    lines.push('NEXTAUTH_SECRET=your-secret-key-change-in-production');

    lines.push('');
    lines.push('# ==========================================');
    lines.push('# PAYMENT (STRIPE)');
    lines.push('# ==========================================');
    lines.push('');
    lines.push('NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=');
    lines.push('STRIPE_SECRET_KEY=');
    lines.push('STRIPE_WEBHOOK_SECRET=');

    lines.push('');
    lines.push('# ==========================================');
    lines.push('# DATABASE');
    lines.push('# ==========================================');
    lines.push('');
    lines.push('DATABASE_URL=postgresql://user:password@localhost:5432/azora');

    lines.push('');
    lines.push('# ==========================================');
    lines.push('# FEATURE FLAGS');
    lines.push('# ==========================================');
    lines.push('');
    lines.push('NEXT_PUBLIC_FEATURE_ASSESSMENTS=false');
    lines.push('NEXT_PUBLIC_FEATURE_COLLABORATION=false');
    lines.push('NEXT_PUBLIC_FEATURE_ADVANCED_AI=false');
    lines.push('NEXT_PUBLIC_FEATURE_MARKETPLACE=false');

    lines.push('');
    lines.push('# ==========================================');
    lines.push('# ENVIRONMENT');
    lines.push('# ==========================================');
    lines.push('');
    lines.push('NODE_ENV=development');

    return lines.join('\n');
}

// Run if called directly
if (require.main === module) {
    generateEnvironments()
        .then(() => process.exit(0))
        .catch((error) => {
            console.error('‚ùå Error:', error.message);
            process.exit(1);
        });
}

module.exports = { generateEnvironments };
