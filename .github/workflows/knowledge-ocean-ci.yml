name: Knowledge Ocean CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'services/knowledge-ocean/**'
      - 'services/knowledge-ocean-service/**'
  pull_request:
    branches: [ main ]

jobs:
  test-knowledge-ocean:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: azora
          POSTGRES_PASSWORD: azora_dev_2025
          POSTGRES_DB: azora
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U azora" --health-interval 5s --health-timeout 5s --health-retries 5
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Wait for Postgres
        run: |
          for i in {1..20}; do
            pg_isready -h localhost -p 5432 -U azora && break || sleep 2
          done
      - name: Create pgvector extension
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-server-dev-all make gcc
          # some images may not include pgxn; try extension creation via psql
          PGPASSWORD=azora psql -h localhost -U azora -c "CREATE EXTENSION IF NOT EXISTS vector;"
      - name: Set up DATABASE_URL
        run: |
          echo "DATABASE_URL=postgresql://azora:azora_dev_2025@localhost:5432/azora" >> $GITHUB_ENV
      - name: Install dependencies
        run: |
          cd services/knowledge-ocean
          npm ci
      - name: Prisma generate
        run: |
          cd $GITHUB_WORKSPACE
          npx prisma@7.0.1 generate --config prisma.config.cjs
      - name: Install AI router
        run: |
          cd services/ai-provider-router
          npm ci
      - name: Run Prisma DB push (prisma v7)
        run: |
          # Use the monorepo root prisma schema when running db push
          cd $GITHUB_WORKSPACE
          npx prisma@7.0.1 db push --config prisma.config.cjs --accept-data-loss --force-reset
      - name: Start ai-provider-router & knowledge-ocean
        run: |
          # Start AI provider and Knowledge Ocean in the background
          cd services/ai-provider-router && npm run dev &
          sleep 1
          cd ../../services/knowledge-ocean && AI_PROVIDER_URL=http://localhost:4010 INDEX_API_KEY=ci-index-key npm run dev &
          sleep 3
      - name: Roundtrip index & search smoke test
        run: |
          cd services/knowledge-ocean
          # prepare env
          echo "INDEX_API_KEY=ci-index-key" >> $GITHUB_ENV
          echo "AI_PROVIDER_URL=http://localhost:4010" >> $GITHUB_ENV
          # Use node script to post index then query search
          node ./test/roundtrip.js
      - name: Run E2E Jest test (if services started)
        run: |
          cd services/knowledge-ocean
          npm run test:e2e || echo "E2E skipped or failed (non-critical)"
      - name: Run tests
        run: |
          cd services/knowledge-ocean
          npm test
