name: Deployment Notifications

on:
  workflow_run:
    workflows:
      - "Deploy Staging"
      - "Deploy Production"
    types: [completed]
  workflow_dispatch:

concurrency:
  group: deployment-notifications
  cancel-in-progress: false

jobs:
  notify-deployment-status:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Prepare deployment notification
        id: prepare-notification
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          WORKFLOW_URL="${{ github.event.workflow_run.html_url }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          
          # Determine environment
          if [[ "$WORKFLOW_NAME" == *"Production"* ]]; then
            ENVIRONMENT="Production"
            COLOR="danger"
          else
            ENVIRONMENT="Staging"
            COLOR="warning"
          fi
          
          # Determine status icon and color
          if [ "$CONCLUSION" = "success" ]; then
            STATUS_ICON="âœ…"
            STATUS_TEXT="Successful"
            COLOR="good"
          elif [ "$CONCLUSION" = "failure" ]; then
            STATUS_ICON="âŒ"
            STATUS_TEXT="Failed"
            COLOR="danger"
          else
            STATUS_ICON="âš ï¸"
            STATUS_TEXT="Cancelled"
            COLOR="warning"
          fi
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "status_icon=$STATUS_ICON" >> $GITHUB_OUTPUT
          echo "status_text=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "workflow_url=$WORKFLOW_URL" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "${{ steps.prepare-notification.outputs.status_icon }} ${{ steps.prepare-notification.outputs.environment }} Deployment ${{ steps.prepare-notification.outputs.status_text }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.prepare-notification.outputs.status_icon }} ${{ steps.prepare-notification.outputs.environment }} Deployment"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\n${{ steps.prepare-notification.outputs.environment }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\n${{ steps.prepare-notification.outputs.status_text }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.event.workflow_run.head_branch }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Timestamp:*\n$(date -u +%Y-%m-%d\\ %H:%M:%S\\ UTC)"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Deployment"
                      },
                      "url": "${{ steps.prepare-notification.outputs.workflow_url }}",
                      "style": "${{ steps.prepare-notification.outputs.color }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  notify-production-deployment-failure:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_run' && 
      github.event.workflow_run.conclusion == 'failure' &&
      contains(github.event.workflow_run.name, 'Production')
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Send critical alert for production failure
        if: secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ðŸš¨ CRITICAL: Production Deployment Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš¨ CRITICAL: Production Deployment Failed"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "A production deployment has failed and requires immediate attention.\n\n*Immediate Actions:*\n1. Check the deployment logs\n2. Assess the impact\n3. Determine if rollback is needed\n4. Notify the on-call team"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.event.workflow_run.name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.event.workflow_run.head_branch }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n`${{ github.event.workflow_run.head_sha }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Time:*\n$(date -u +%Y-%m-%d\\ %H:%M:%S\\ UTC)"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "url": "${{ github.event.workflow_run.html_url }}",
                      "style": "danger"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Rollback Procedures"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/blob/main/.github/PRODUCTION-ROLLBACK-PROCEDURES.md"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  create-deployment-incident:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_run' && 
      github.event.workflow_run.conclusion == 'failure' &&
      contains(github.event.workflow_run.name, 'Production')
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Create incident issue
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = '${{ github.event.workflow_run.name }}';
            const workflowUrl = '${{ github.event.workflow_run.html_url }}';
            const branch = '${{ github.event.workflow_run.head_branch }}';
            const commitSha = '${{ github.event.workflow_run.head_sha }}';
            
            const title = `ðŸš¨ Production Deployment Incident - ${new Date().toISOString().split('T')[0]}`;
            const body = `
## Production Deployment Failure

**Workflow:** ${workflowName}
**Branch:** ${branch}
**Commit:** \`${commitSha}\`
**Time:** ${new Date().toISOString()}

[View Workflow Run](${workflowUrl})

### Impact Assessment
- [ ] Determine if rollback is needed
- [ ] Check service health
- [ ] Review error logs
- [ ] Notify stakeholders

### Resolution Steps
1. Review the deployment logs
2. Identify the root cause
3. Decide on rollback vs. fix-forward
4. Execute recovery plan
5. Post-incident review

### Rollback Instructions
See [PRODUCTION-ROLLBACK-PROCEDURES.md](.github/PRODUCTION-ROLLBACK-PROCEDURES.md)

---
*This issue was automatically created by the Deployment Notifications workflow.*
            `;
            
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['incident', 'production', 'automated'],
              assignees: [] // Can be configured to assign to on-call
            });
            
            console.log(`Created incident issue: #${issue.number}`);

  send-deployment-summary:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Generate deployment summary
        id: summary
        run: |
          cat > deployment-summary.md << 'EOF'
          # Deployment Summary
          
          Generated: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)
          
          ## Recent Deployments
          
          ### Staging Deployments
          - Last deployment: [View](https://github.com/${{ github.repository }}/actions/workflows/deploy-staging.yml)
          - Status: Check workflow runs
          
          ### Production Deployments
          - Last deployment: [View](https://github.com/${{ github.repository }}/actions/workflows/deploy-production.yml)
          - Status: Check workflow runs
          
          ## Deployment Health
          
          - Staging: Monitoring...
          - Production: Monitoring...
          
          ## Recent Issues
          
          - None reported
          
          ---
          
          For detailed information, visit the [Actions](https://github.com/${{ github.repository }}/actions) page.
          EOF
          
          cat deployment-summary.md

      - name: Send summary to Slack
        if: secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ðŸ“Š Deployment Summary Report",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸ“Š Deployment Summary"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Repository:* ${{ github.repository }}\n*Generated:* $(date -u +%Y-%m-%d\\ %H:%M:%S\\ UTC)\n\nView detailed deployment information in the Actions tab."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Deployments"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions",
                      "style": "primary"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
