name: Artifact Cleanup

on:
  schedule:
    # Run cleanup every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Retention period in days'
        required: false
        default: '30'
      dry_run:
        description: 'Perform dry run (no deletion)'
        required: false
        type: boolean
        default: true

jobs:
  cleanup-test-artifacts:
    runs-on: ubuntu-latest
    name: Cleanup Test Artifacts (30 days)
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup cleanup script
        run: chmod +x .github/scripts/cleanup-artifacts.sh
      
      - name: Cleanup test artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          RETENTION_DAYS: 30
        run: |
          echo "=== Cleaning up test artifacts (30+ days old) ==="
          .github/scripts/cleanup-artifacts.sh \
            --retention-days 30 \
            --verbose
      
      - name: Generate cleanup report
        if: always()
        run: |
          cat > test-artifacts-cleanup-report.md << 'EOF'
          # Test Artifacts Cleanup Report
          
          **Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Retention Period:** 30 days
          **Artifact Types:**
          - Unit test reports
          - Integration test reports
          - E2E test reports (HTML)
          - JUnit XML results
          
          ## Cleanup Status
          
          Cleanup completed. See workflow logs for details.
          
          ## Retention Policy
          
          Test artifacts are retained for 30 days to allow for:
          - Test result review and analysis
          - Debugging test failures
          - Coverage trend analysis
          
          After 30 days, artifacts are automatically deleted to:
          - Reduce storage usage
          - Maintain repository cleanliness
          - Comply with retention policies
          
          EOF
          cat test-artifacts-cleanup-report.md
      
      - name: Upload cleanup report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-cleanup-report
          path: test-artifacts-cleanup-report.md
          retention-days: 30

  cleanup-coverage-artifacts:
    runs-on: ubuntu-latest
    name: Cleanup Coverage Artifacts (90 days)
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup cleanup script
        run: chmod +x .github/scripts/cleanup-artifacts.sh
      
      - name: Cleanup coverage artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          RETENTION_DAYS: 90
        run: |
          echo "=== Cleaning up coverage artifacts (90+ days old) ==="
          .github/scripts/cleanup-artifacts.sh \
            --retention-days 90 \
            --verbose
      
      - name: Generate cleanup report
        if: always()
        run: |
          cat > coverage-artifacts-cleanup-report.md << 'EOF'
          # Coverage Artifacts Cleanup Report
          
          **Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Retention Period:** 90 days
          **Artifact Types:**
          - Coverage reports (HTML)
          - Coverage reports (JSON)
          
          ## Cleanup Status
          
          Cleanup completed. See workflow logs for details.
          
          ## Retention Policy
          
          Coverage artifacts are retained for 90 days to allow for:
          - Coverage trend analysis over 3 months
          - Historical comparison of code quality
          - Identification of coverage regressions
          
          After 90 days, artifacts are automatically deleted to:
          - Reduce storage usage
          - Archive older coverage data separately if needed
          - Comply with retention policies
          
          EOF
          cat coverage-artifacts-cleanup-report.md
      
      - name: Upload cleanup report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-artifacts-cleanup-report
          path: coverage-artifacts-cleanup-report.md
          retention-days: 30

  cleanup-security-artifacts:
    runs-on: ubuntu-latest
    name: Cleanup Security Artifacts (1 year)
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup cleanup script
        run: chmod +x .github/scripts/cleanup-artifacts.sh
      
      - name: Cleanup security artifacts older than 1 year
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          RETENTION_DAYS: 365
        run: |
          echo "=== Cleaning up security artifacts (365+ days old) ==="
          .github/scripts/cleanup-artifacts.sh \
            --retention-days 365 \
            --verbose
      
      - name: Generate cleanup report
        if: always()
        run: |
          cat > security-artifacts-cleanup-report.md << 'EOF'
          # Security Artifacts Cleanup Report
          
          **Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Retention Period:** 365 days (1 year)
          **Artifact Types:**
          - npm audit reports
          - CodeQL SAST results
          - Secret scan reports
          - Consolidated security reports
          
          ## Cleanup Status
          
          Cleanup completed. See workflow logs for details.
          
          ## Retention Policy
          
          Security artifacts are retained for 1 year to:
          - Maintain compliance audit trails
          - Track security vulnerabilities over time
          - Support incident investigations
          - Meet regulatory requirements
          
          After 1 year, artifacts are automatically deleted to:
          - Reduce storage usage
          - Archive critical security data separately if needed
          - Comply with data retention policies
          
          ## Important Notes
          
          - Critical security findings should be archived separately
          - Incident-related artifacts may require longer retention
          - Contact security team before deleting security artifacts
          
          EOF
          cat security-artifacts-cleanup-report.md
      
      - name: Upload cleanup report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-artifacts-cleanup-report
          path: security-artifacts-cleanup-report.md
          retention-days: 30

  cleanup-deployment-artifacts:
    runs-on: ubuntu-latest
    name: Cleanup Deployment Artifacts (1 year)
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup cleanup script
        run: chmod +x .github/scripts/cleanup-artifacts.sh
      
      - name: Cleanup deployment artifacts older than 1 year
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          RETENTION_DAYS: 365
        run: |
          echo "=== Cleaning up deployment artifacts (365+ days old) ==="
          .github/scripts/cleanup-artifacts.sh \
            --retention-days 365 \
            --verbose
      
      - name: Generate cleanup report
        if: always()
        run: |
          cat > deployment-artifacts-cleanup-report.md << 'EOF'
          # Deployment Artifacts Cleanup Report
          
          **Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Retention Period:** 365 days (1 year)
          **Artifact Types:**
          - Build logs
          - Migration logs
          - Deployment logs
          - Health check logs
          - Rollback logs
          - Deployment records (JSON)
          - Rollback instructions
          
          ## Cleanup Status
          
          Cleanup completed. See workflow logs for details.
          
          ## Retention Policy
          
          Deployment artifacts are retained for 1 year to:
          - Maintain deployment audit trails
          - Support incident investigations
          - Track deployment history
          - Meet compliance requirements
          - Enable rollback procedures
          
          After 1 year, artifacts are automatically deleted to:
          - Reduce storage usage
          - Archive critical deployment data separately if needed
          - Comply with data retention policies
          
          ## Important Notes
          
          - Production deployment records should be archived separately
          - Incident-related deployments may require longer retention
          - Contact DevOps team before deleting deployment artifacts
          
          EOF
          cat deployment-artifacts-cleanup-report.md
      
      - name: Upload cleanup report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifacts-cleanup-report
          path: deployment-artifacts-cleanup-report.md
          retention-days: 30

  cleanup-e2e-failure-artifacts:
    runs-on: ubuntu-latest
    name: Cleanup E2E Failure Artifacts (7 days)
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup cleanup script
        run: chmod +x .github/scripts/cleanup-artifacts.sh
      
      - name: Cleanup E2E failure artifacts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          RETENTION_DAYS: 7
        run: |
          echo "=== Cleaning up E2E failure artifacts (7+ days old) ==="
          .github/scripts/cleanup-artifacts.sh \
            --retention-days 7 \
            --verbose
      
      - name: Generate cleanup report
        if: always()
        run: |
          cat > e2e-failure-artifacts-cleanup-report.md << 'EOF'
          # E2E Failure Artifacts Cleanup Report
          
          **Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Retention Period:** 7 days
          **Artifact Types:**
          - E2E test videos (failure)
          - E2E test screenshots (failure)
          
          ## Cleanup Status
          
          Cleanup completed. See workflow logs for details.
          
          ## Retention Policy
          
          E2E failure artifacts are retained for 7 days to:
          - Debug test failures
          - Investigate flaky tests
          - Analyze visual regressions
          
          After 7 days, artifacts are automatically deleted to:
          - Reduce storage usage significantly (videos are large)
          - Maintain repository cleanliness
          - Comply with retention policies
          
          ## Recommendations
          
          - Download and archive critical failure videos before cleanup
          - Use HTML reports for longer-term failure analysis
          - Consider external storage for long-term video archival
          
          EOF
          cat e2e-failure-artifacts-cleanup-report.md
      
      - name: Upload cleanup report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-failure-artifacts-cleanup-report
          path: e2e-failure-artifacts-cleanup-report.md
          retention-days: 30

  cleanup-summary:
    runs-on: ubuntu-latest
    needs: [cleanup-test-artifacts, cleanup-coverage-artifacts, cleanup-security-artifacts, cleanup-deployment-artifacts, cleanup-e2e-failure-artifacts]
    if: always()
    steps:
      - name: Generate cleanup summary
        run: |
          cat > cleanup-summary.md << 'EOF'
          # Artifact Cleanup Summary
          
          **Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Workflow:** Artifact Cleanup
          
          ## Cleanup Results
          
          | Artifact Type | Retention | Status |
          |---------------|-----------|--------|
          | Test Artifacts | 30 days | ${{ needs.cleanup-test-artifacts.result }} |
          | Coverage Artifacts | 90 days | ${{ needs.cleanup-coverage-artifacts.result }} |
          | Security Artifacts | 1 year | ${{ needs.cleanup-security-artifacts.result }} |
          | Deployment Artifacts | 1 year | ${{ needs.cleanup-deployment-artifacts.result }} |
          | E2E Failure Artifacts | 7 days | ${{ needs.cleanup-e2e-failure-artifacts.result }} |
          
          ## Retention Policy Overview
          
          - **Test Reports:** 30 days - Verify test execution and results
          - **Coverage Reports:** 90 days - Track coverage trends
          - **Security Reports:** 1 year - Compliance and audit trail
          - **Deployment Logs:** 1 year - Deployment history and troubleshooting
          - **E2E Videos/Screenshots:** 7 days - Debug failures only
          
          ## Storage Impact
          
          Regular cleanup helps:
          - Reduce repository storage usage
          - Maintain compliance with retention policies
          - Improve artifact access performance
          - Reduce clutter in artifact listings
          
          ## Next Steps
          
          - Review cleanup reports in artifacts section
          - Monitor storage usage trends
          - Adjust retention periods if needed
          - Archive critical artifacts to long-term storage
          
          ## Related Documentation
          
          - [Artifact Retention Policy](./../ARTIFACT-RETENTION-POLICY.md)
          - [Workflow Documentation](./README.md)
          
          EOF
          cat cleanup-summary.md
      
      - name: Upload cleanup summary
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-summary
          path: cleanup-summary.md
          retention-days: 30
      
      - name: Notify team of cleanup completion
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: 'success'
          text: |
            âœ… Artifact cleanup completed
            
            Cleanup Summary:
            - Test artifacts (30 days): ${{ needs.cleanup-test-artifacts.result }}
            - Coverage artifacts (90 days): ${{ needs.cleanup-coverage-artifacts.result }}
            - Security artifacts (1 year): ${{ needs.cleanup-security-artifacts.result }}
            - Deployment artifacts (1 year): ${{ needs.cleanup-deployment-artifacts.result }}
            - E2E failure artifacts (7 days): ${{ needs.cleanup-e2e-failure-artifacts.result }}
            
            Check artifacts for detailed cleanup reports.
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
