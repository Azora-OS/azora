name: Workflow Monitoring & Notifications

on:
  workflow_run:
    workflows:
      - "CI - Linting & Type Checking"
      - "Test Suite"
      - "Security Scanning"
      - "E2E Tests"
      - "Deploy Staging"
      - "Deploy Production"
    types: [completed]
  schedule:
    # Daily digest at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:

concurrency:
  group: workflow-monitoring
  cancel-in-progress: false

jobs:
  notify-workflow-failure:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure'
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Prepare failure notification
        id: prepare-notification
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          WORKFLOW_URL="${{ github.event.workflow_run.html_url }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          COMMIT_MSG=$(git log --format=%B -n 1 "$COMMIT_SHA" 2>/dev/null || echo "Unknown commit")
          
          # Prepare Slack message
          cat > slack-payload.json << 'SLACK_EOF'
          {
            "text": "‚ùå Workflow Failed: ${{ github.event.workflow_run.name }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "‚ùå Workflow Failed"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Workflow:*\n$WORKFLOW_NAME"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n$BRANCH"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Commit:*\n`${COMMIT_SHA:0:7}`"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\nFailed"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Commit Message:*\n$COMMIT_MSG"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow"
                    },
                    "url": "$WORKFLOW_URL",
                    "style": "danger"
                  }
                ]
              }
            ]
          }
          SLACK_EOF
          
          echo "notification_prepared=true" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: steps.prepare-notification.outputs.notification_prepared == 'true' && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload-file-path: slack-payload.json
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Create GitHub issue for workflow failure
        if: github.event.workflow_run.conclusion == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = '${{ github.event.workflow_run.name }}';
            const workflowUrl = '${{ github.event.workflow_run.html_url }}';
            const branch = '${{ github.event.workflow_run.head_branch }}';
            
            const title = `üî¥ Workflow Failed: ${workflowName}`;
            const body = `
            ## Workflow Failure Report
            
            **Workflow:** ${workflowName}
            **Branch:** ${branch}
            **Status:** Failed
            
            [View Workflow Run](${workflowUrl})
            
            ### Action Required
            - Review the workflow logs
            - Identify the root cause
            - Fix the issue and push a new commit
            - Monitor the next workflow run
            
            ---
            *This issue was automatically created by the Workflow Monitoring system.*
            `;
            
            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['workflow-failure']
            });
            
            const existingIssue = issues.find(issue => 
              issue.title.includes(workflowName) && 
              issue.created_at > new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString()
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['workflow-failure', 'automated']
              });
            }

  notify-deployment-success:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_run' && 
      github.event.workflow_run.conclusion == 'success' &&
      (contains(github.event.workflow_run.name, 'Deploy') || contains(github.event.workflow_run.name, 'Production'))
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Send deployment success notification
        if: secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚úÖ Deployment Successful: ${{ github.event.workflow_run.name }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚úÖ Deployment Successful"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.event.workflow_run.name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.event.workflow_run.head_branch }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\nSuccess"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Duration:*\n${{ github.event.workflow_run.run_number }} min"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Deployment"
                      },
                      "url": "${{ github.event.workflow_run.html_url }}",
                      "style": "primary"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  collect-daily-metrics:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install GitHub CLI
        run: |
          if ! command -v gh &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y gh
          fi

      - name: Collect workflow metrics
        run: |
          bash .github/scripts/collect-workflow-metrics.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate metrics report
        run: |
          bash .github/scripts/generate-metrics-report.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload metrics as artifact
        uses: actions/upload-artifact@v3
        with:
          name: workflow-metrics
          path: .github/metrics/
          retention-days: 90

      - name: Send daily digest to Slack
        if: secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "üìä Daily Workflow Metrics Digest",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üìä Daily Workflow Metrics"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Date:* $(date -u +%Y-%m-%d)\n*Repository:* ${{ github.repository }}\n\nDetailed metrics report has been generated and is available in the workflow artifacts."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Metrics Report"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View All Workflows"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Commit metrics report
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -f ".github/metrics/METRICS-REPORT-$(date +%Y-%m-%d).md" ]; then
            git add .github/metrics/METRICS-REPORT-*.md
            git commit -m "docs: daily workflow metrics report" || true
            git push || true
          fi

  track-performance-trends:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Analyze performance trends
        run: |
          cat > analyze-trends.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          const metricsDir = '.github/metrics';
          const files = fs.readdirSync(metricsDir)
            .filter(f => f.startsWith('workflow-metrics-') && f.endsWith('.json'))
            .sort()
            .slice(-7); // Last 7 days
          
          if (files.length === 0) {
            console.log('No metrics files found');
            process.exit(0);
          }
          
          const trends = {};
          
          files.forEach(file => {
            const data = JSON.parse(fs.readFileSync(path.join(metricsDir, file), 'utf8'));
            data.workflows.forEach(workflow => {
              if (!trends[workflow.name]) {
                trends[workflow.name] = [];
              }
              trends[workflow.name].push({
                date: file.replace('workflow-metrics-', '').replace('.json', ''),
                success_rate: workflow.success_rate,
                avg_duration: workflow.avg_duration_minutes
              });
            });
          });
          
          // Analyze trends
          const analysis = {};
          Object.entries(trends).forEach(([name, data]) => {
            const successRates = data.map(d => d.success_rate);
            const durations = data.map(d => d.avg_duration);
            
            const successTrend = successRates[successRates.length - 1] - successRates[0];
            const durationTrend = durations[durations.length - 1] - durations[0];
            
            analysis[name] = {
              success_trend: successTrend > 0 ? 'üìà' : successTrend < 0 ? 'üìâ' : '‚Üí',
              duration_trend: durationTrend > 0 ? 'üìà' : durationTrend < 0 ? 'üìâ' : '‚Üí',
              current_success_rate: successRates[successRates.length - 1],
              current_duration: durations[durations.length - 1]
            };
          });
          
          console.log('Performance Trends (Last 7 Days):');
          console.log(JSON.stringify(analysis, null, 2));
          
          // Save analysis
          fs.writeFileSync(
            path.join(metricsDir, `performance-trends-${new Date().toISOString().split('T')[0]}.json`),
            JSON.stringify(analysis, null, 2)
          );
          EOF
          
          node analyze-trends.js

      - name: Upload performance trends
        uses: actions/upload-artifact@v3
        with:
          name: performance-trends
          path: .github/metrics/performance-trends-*.json
          retention-days: 365

  notify-performance-degradation:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Check for performance degradation
        id: check-degradation
        run: |
          cat > check-degradation.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          const metricsDir = '.github/metrics';
          const trendFiles = fs.readdirSync(metricsDir)
            .filter(f => f.startsWith('performance-trends-'))
            .sort()
            .slice(-2); // Last 2 days
          
          if (trendFiles.length < 2) {
            console.log('Not enough trend data');
            process.exit(0);
          }
          
          const today = JSON.parse(fs.readFileSync(path.join(metricsDir, trendFiles[1]), 'utf8'));
          const yesterday = JSON.parse(fs.readFileSync(path.join(metricsDir, trendFiles[0]), 'utf8'));
          
          const degradations = [];
          
          Object.entries(today).forEach(([name, metrics]) => {
            if (yesterday[name]) {
              const successDrop = yesterday[name].current_success_rate - metrics.current_success_rate;
              const durationIncrease = metrics.current_duration - yesterday[name].current_duration;
              
              if (successDrop > 5) {
                degradations.push(`${name}: Success rate dropped ${successDrop.toFixed(1)}%`);
              }
              if (durationIncrease > 2) {
                degradations.push(`${name}: Duration increased ${durationIncrease.toFixed(1)}min`);
              }
            }
          });
          
          if (degradations.length > 0) {
            console.log('DEGRADATIONS_FOUND=true');
            console.log('DEGRADATIONS=' + JSON.stringify(degradations));
          } else {
            console.log('DEGRADATIONS_FOUND=false');
          }
          EOF
          
          node check-degradation.js >> $GITHUB_OUTPUT

      - name: Send degradation alert
        if: steps.check-degradation.outputs.DEGRADATIONS_FOUND == 'true' && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚ö†Ô∏è Performance Degradation Detected",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ö†Ô∏è Performance Degradation Detected"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "The following workflows have shown performance degradation:\n\n${{ steps.check-degradation.outputs.DEGRADATIONS }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Metrics"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                      "style": "danger"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
