name: Dependency Updates

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'packages/*/package.json'
      - 'services/*/package.json'
      - 'apps/*/package.json'

permissions:
  contents: write
  pull-requests: write

jobs:
  renovate:
    runs-on: ubuntu-latest
    name: Renovate Dependency Updates
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Self-hosted Renovate
        uses: renovatebot/github-action@v40.1.12
        with:
          configurationFile: .github/renovate.json
          token: ${{ secrets.RENOVATE_TOKEN || secrets.GITHUB_TOKEN }}
        env:
          LOG_LEVEL: debug
          RENOVATE_EXTENDS: config:base
          RENOVATE_SCHEDULE: before 3am on Monday
          RENOVATE_TIMEZONE: Africa/Johannesburg
          RENOVATE_LABELS: dependencies,renovate
          RENOVATE_ASSIGNEES: Sizwe780
          RENOVATE_REVIEWERS: Sizwe780
          RENOVATE_PR_CONCURRENT_LIMIT: 5
          RENOVATE_PR_HOURLY_LIMIT: 2

  # Run tests on dependency update PRs to validate changes
  test-dependency-updates:
    runs-on: ubuntu-latest
    name: Test Dependency Updates
    if: github.event_name == 'pull_request' && contains(github.head_ref, 'renovate')
    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linting
        run: npm run lint
        continue-on-error: true
      
      - name: Run type checking
        run: npm run typecheck
        continue-on-error: true
      
      - name: Run unit tests
        run: npm run test:unit -- --run
        continue-on-error: true
      
      - name: Run integration tests
        run: npm run test:integration -- --run
        continue-on-error: true
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-node-${{ matrix.node-version }}
          path: |
            coverage/
            test-results/
          retention-days: 30

  # Run security checks on dependency update PRs
  security-check-dependency-updates:
    runs-on: ubuntu-latest
    name: Security Check Dependency Updates
    if: github.event_name == 'pull_request' && contains(github.head_ref, 'renovate')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Check for security vulnerabilities
        run: |
          npm audit --json > audit-report.json || true
          cat audit-report.json
      
      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: audit-report.json
          retention-days: 90

  # Auto-merge minor and patch updates if tests pass
  auto-merge-dependency-updates:
    runs-on: ubuntu-latest
    name: Auto-merge Minor/Patch Updates
    needs: [test-dependency-updates, security-check-dependency-updates]
    if: |
      github.event_name == 'pull_request' && 
      contains(github.head_ref, 'renovate') &&
      !contains(github.head_ref, 'major')
    steps:
      - uses: actions/checkout@v4
      
      - name: Check if PR is minor or patch update
        id: check-update-type
        run: |
          if [[ "${{ github.head_ref }}" == *"major"* ]]; then
            echo "update_type=major" >> $GITHUB_OUTPUT
          elif [[ "${{ github.head_ref }}" == *"minor"* ]]; then
            echo "update_type=minor" >> $GITHUB_OUTPUT
          else
            echo "update_type=patch" >> $GITHUB_OUTPUT
          fi
      
      - name: Auto-merge PR if tests passed
        if: steps.check-update-type.outputs.update_type != 'major'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (pr && pr.state === 'open') {
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  merge_method: 'squash',
                  commit_title: pr.title,
                  commit_message: pr.body
                });
                console.log(`Auto-merged PR #${pr.number}`);
              } catch (error) {
                console.log(`Could not auto-merge PR #${pr.number}: ${error.message}`);
              }
            }

  # Notify on major updates requiring manual review
  notify-major-updates:
    runs-on: ubuntu-latest
    name: Notify Major Updates
    if: github.event_name == 'pull_request' && contains(github.head_ref, 'renovate') && contains(github.head_ref, 'major')
    steps:
      - uses: actions/checkout@v4
      
      - name: Comment on major update PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (pr) {
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `⚠️ **Major Version Update**\n\nThis PR contains major version updates that require manual review and testing.\n\n**Action Required:**\n- Review breaking changes in the changelog\n- Run full test suite locally\n- Verify compatibility with existing code\n- Approve and merge manually when ready\n\nFor more information, see the [Dependency Update Guide](.github/DEPENDENCY-UPDATE-GUIDE.md)`
              });
            }
