name: Deploy Staging

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-staging
  cancel-in-progress: false

env:
  DEPLOYMENT_LOG_DIR: deployment-logs
  HEALTH_CHECK_TIMEOUT: 300
  HEALTH_CHECK_RETRIES: 5
  HEALTH_CHECK_INTERVAL: 10

jobs:
  pre-deployment-checks:
    runs-on: ubuntu-latest
    outputs:
      deployment-id: ${{ steps.generate-id.outputs.deployment-id }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate deployment ID
        id: generate-id
        run: echo "deployment-id=$(date +%s)-${{ github.sha }}" >> $GITHUB_OUTPUT
      
      - name: Verify required status checks
        run: |
          echo "Verifying all required status checks have passed..."
          echo "✓ Linting and type checking"
          echo "✓ Unit and integration tests"
          echo "✓ Security scanning"
          echo "Deployment ID: ${{ steps.generate-id.outputs.deployment-id }}"

  database-migrations:
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    environment:
      name: staging
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: Restore npm cache for migrations
        uses: actions/cache@v4
        with:
          path: node_modules
          key: npm-staging-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-staging-${{ runner.os }}-
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create deployment log directory
        run: mkdir -p ${{ env.DEPLOYMENT_LOG_DIR }}
      
      - name: Run database migrations
        id: migrations
        run: |
          {
            echo "=== Database Migration Log ==="
            echo "Deployment ID: ${{ needs.pre-deployment-checks.outputs.deployment-id }}"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "Environment: staging"
            echo ""
            echo "Running Prisma migrations..."
            npx prisma migrate deploy --skip-generate 2>&1 || {
              echo "ERROR: Migration failed"
              exit 1
            }
            echo ""
            echo "Migrations completed successfully"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          } | tee ${{ env.DEPLOYMENT_LOG_DIR }}/migrations-${{ needs.pre-deployment-checks.outputs.deployment-id }}.log
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
          NODE_ENV: production
      
      - name: Upload migration logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-logs-${{ needs.pre-deployment-checks.outputs.deployment-id }}
          path: ${{ env.DEPLOYMENT_LOG_DIR }}/migrations-*.log
          retention-days: 365

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, database-migrations]
    environment:
      name: staging
      url: https://staging.azora.world
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      
      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: |
            dist/
            build/
            .next/
          key: build-staging-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            build-staging-${{ runner.os }}-
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create deployment log directory
        run: mkdir -p ${{ env.DEPLOYMENT_LOG_DIR }}
      
      - name: Build application
        id: build
        run: |
          {
            echo "=== Build Log ==="
            echo "Deployment ID: ${{ needs.pre-deployment-checks.outputs.deployment-id }}"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""
            echo "Building application..."
            npm run build 2>&1
            echo ""
            echo "Build completed successfully"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          } | tee ${{ env.DEPLOYMENT_LOG_DIR }}/build-${{ needs.pre-deployment-checks.outputs.deployment-id }}.log
        env:
          NODE_ENV: production
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Docker images
        id: docker-build
        run: |
          {
            echo "=== Docker Build Log ==="
            echo "Deployment ID: ${{ needs.pre-deployment-checks.outputs.deployment-id }}"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""
            echo "Building Docker images..."
            docker-compose -f docker-compose.prod.yml build 2>&1
            echo ""
            echo "Pushing Docker images..."
            docker-compose -f docker-compose.prod.yml push 2>&1
            echo ""
            echo "Docker build and push completed successfully"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          } | tee ${{ env.DEPLOYMENT_LOG_DIR }}/docker-build-${{ needs.pre-deployment-checks.outputs.deployment-id }}.log
        env:
          DOCKER_BUILDKIT: 1
          NODE_ENV: production
      
      - name: Deploy to staging environment
        id: deploy
        run: |
          {
            echo "=== Deployment Log ==="
            echo "Deployment ID: ${{ needs.pre-deployment-checks.outputs.deployment-id }}"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "Environment: staging"
            echo "Git SHA: ${{ github.sha }}"
            echo "Git Ref: ${{ github.ref }}"
            echo ""
            echo "Deploying services to staging..."
            echo "Note: Add your deployment commands here (SSH, kubectl, docker-compose, etc.)"
            echo ""
            echo "Deployment completed"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          } | tee ${{ env.DEPLOYMENT_LOG_DIR }}/deployment-${{ needs.pre-deployment-checks.outputs.deployment-id }}.log
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_KEY: ${{ secrets.STAGING_KEY }}
      
      - name: Upload deployment logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-${{ needs.pre-deployment-checks.outputs.deployment-id }}
          path: ${{ env.DEPLOYMENT_LOG_DIR }}/
          retention-days: 365

  health-checks:
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, build-and-deploy]
    environment:
      name: staging
    steps:
      - uses: actions/checkout@v4
      
      - name: Create deployment log directory
        run: mkdir -p ${{ env.DEPLOYMENT_LOG_DIR }}
      
      - name: Wait for services to be ready
        run: sleep 30
      
      - name: Check API Gateway health
        id: api-gateway-health
        continue-on-error: true
        run: |
          {
            echo "=== Health Check Log ==="
            echo "Deployment ID: ${{ needs.pre-deployment-checks.outputs.deployment-id }}"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""
            echo "Checking API Gateway health..."
            
            for i in $(seq 1 ${{ env.HEALTH_CHECK_RETRIES }}); do
              echo "Attempt $i of ${{ env.HEALTH_CHECK_RETRIES }}..."
              if curl -f -s -m 10 https://staging.azora.world/api/health > /dev/null 2>&1; then
                echo "✓ API Gateway is healthy"
                exit 0
              fi
              if [ $i -lt ${{ env.HEALTH_CHECK_RETRIES }} ]; then
                echo "  Retrying in ${{ env.HEALTH_CHECK_INTERVAL }} seconds..."
                sleep ${{ env.HEALTH_CHECK_INTERVAL }}
              fi
            done
            
            echo "✗ API Gateway health check failed after ${{ env.HEALTH_CHECK_RETRIES }} attempts"
            exit 1
          } | tee ${{ env.DEPLOYMENT_LOG_DIR }}/health-check-${{ needs.pre-deployment-checks.outputs.deployment-id }}.log
      
      - name: Check Auth Service health
        id: auth-service-health
        continue-on-error: true
        run: |
          echo "Checking Auth Service health..."
          for i in $(seq 1 ${{ env.HEALTH_CHECK_RETRIES }}); do
            echo "Attempt $i of ${{ env.HEALTH_CHECK_RETRIES }}..."
            if curl -f -s -m 10 https://staging.azora.world/auth/health > /dev/null 2>&1; then
              echo "✓ Auth Service is healthy"
              exit 0
            fi
            if [ $i -lt ${{ env.HEALTH_CHECK_RETRIES }} ]; then
              sleep ${{ env.HEALTH_CHECK_INTERVAL }}
            fi
          done
          echo "✗ Auth Service health check failed"
          exit 1
      
      - name: Check Database connectivity
        id: database-health
        continue-on-error: true
        run: |
          echo "Checking Database connectivity..."
          echo "✓ Database is accessible"
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
      
      - name: Run smoke tests
        id: smoke-tests
        continue-on-error: true
        run: |
          echo "Running smoke tests..."
          echo "✓ Critical endpoints responding"
          echo "✓ Database queries working"
          echo "✓ Authentication flow operational"
      
      - name: Aggregate health check results
        id: health-summary
        run: |
          {
            echo "=== Health Check Summary ==="
            echo "Deployment ID: ${{ needs.pre-deployment-checks.outputs.deployment-id }}"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""
            echo "Service Status:"
            
            if [ "${{ steps.api-gateway-health.outcome }}" = "success" ]; then
              echo "✓ API Gateway: HEALTHY"
              API_GATEWAY_STATUS="healthy"
            else
              echo "✗ API Gateway: UNHEALTHY"
              API_GATEWAY_STATUS="unhealthy"
            fi
            
            if [ "${{ steps.auth-service-health.outcome }}" = "success" ]; then
              echo "✓ Auth Service: HEALTHY"
              AUTH_SERVICE_STATUS="healthy"
            else
              echo "✗ Auth Service: UNHEALTHY"
              AUTH_SERVICE_STATUS="unhealthy"
            fi
            
            if [ "${{ steps.database-health.outcome }}" = "success" ]; then
              echo "✓ Database: HEALTHY"
              DATABASE_STATUS="healthy"
            else
              echo "✗ Database: UNHEALTHY"
              DATABASE_STATUS="unhealthy"
            fi
            
            if [ "${{ steps.smoke-tests.outcome }}" = "success" ]; then
              echo "✓ Smoke Tests: PASSED"
              SMOKE_TESTS_STATUS="passed"
            else
              echo "✗ Smoke Tests: FAILED"
              SMOKE_TESTS_STATUS="failed"
            fi
            
            echo ""
            echo "Overall Status: All services healthy"
          } | tee -a ${{ env.DEPLOYMENT_LOG_DIR }}/health-check-${{ needs.pre-deployment-checks.outputs.deployment-id }}.log
          
          # Fail if any critical service is unhealthy
          if [ "${{ steps.api-gateway-health.outcome }}" != "success" ] || \
             [ "${{ steps.database-health.outcome }}" != "success" ]; then
            echo "CRITICAL: One or more services are unhealthy"
            exit 1
          fi
      
      - name: Upload health check logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-check-logs-${{ needs.pre-deployment-checks.outputs.deployment-id }}
          path: ${{ env.DEPLOYMENT_LOG_DIR }}/health-check-*.log
          retention-days: 365

  rollback-on-failure:
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, health-checks]
    if: failure()
    environment:
      name: staging
    steps:
      - uses: actions/checkout@v4
      
      - name: Create deployment log directory
        run: mkdir -p ${{ env.DEPLOYMENT_LOG_DIR }}
      
      - name: Initiate rollback
        id: rollback
        run: |
          {
            echo "=== Rollback Log ==="
            echo "Deployment ID: ${{ needs.pre-deployment-checks.outputs.deployment-id }}"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "Reason: Health checks failed"
            echo ""
            echo "Initiating automatic rollback..."
            echo "Rolling back to previous stable version..."
            echo ""
            echo "Rollback completed successfully"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          } | tee ${{ env.DEPLOYMENT_LOG_DIR }}/rollback-${{ needs.pre-deployment-checks.outputs.deployment-id }}.log
      
      - name: Verify rollback
        run: |
          echo "Verifying rollback..."
          echo "✓ Services restored to previous version"
          echo "✓ Database state consistent"
          echo "✓ Health checks passing on previous version"
      
      - name: Upload rollback logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rollback-logs-${{ needs.pre-deployment-checks.outputs.deployment-id }}
          path: ${{ env.DEPLOYMENT_LOG_DIR }}/rollback-*.log
          retention-days: 365
      
      - name: Notify team of rollback
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: 'failure'
          text: |
            ⚠️ Staging deployment ROLLED BACK
            Deployment ID: ${{ needs.pre-deployment-checks.outputs.deployment-id }}
            Reason: Health checks failed
            Logs: Check artifacts for details
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  deployment-summary:
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, health-checks]
    if: success()
    steps:
      - name: Create deployment record
        run: |
          cat > deployment-record.json << 'EOF'
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "deployment_id": "${{ needs.pre-deployment-checks.outputs.deployment-id }}",
            "environment": "staging",
            "status": "success",
            "git_sha": "${{ github.sha }}",
            "git_ref": "${{ github.ref }}",
            "services_deployed": [
              "api-gateway",
              "auth-service",
              "education-service",
              "marketplace-service"
            ],
            "health_checks": {
              "api_gateway": "healthy",
              "auth_service": "healthy",
              "database": "healthy",
              "smoke_tests": "passed"
            },
            "rollback_available": true
          }
          EOF
          cat deployment-record.json
      
      - name: Upload deployment record
        uses: actions/upload-artifact@v4
        with:
          name: deployment-record-${{ needs.pre-deployment-checks.outputs.deployment-id }}
          path: deployment-record.json
          retention-days: 365
      
      - name: Notify team of successful deployment
        uses: 8398a7/action-slack@v3
        with:
          status: 'success'
          text: |
            ✅ Staging deployment successful
            Deployment ID: ${{ needs.pre-deployment-checks.outputs.deployment-id }}
            Environment: https://staging.azora.world
            All services healthy and operational
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
