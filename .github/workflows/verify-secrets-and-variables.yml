name: Verify Secrets and Variables

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

jobs:
  verify-secrets:
    runs-on: ubuntu-latest
    name: Verify Secrets Configuration
    steps:
      - uses: actions/checkout@v4
      
      - name: Check required secrets
        id: check-secrets
        run: |
          echo "## Secrets Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          SECRETS_FOUND=0
          SECRETS_MISSING=0
          
          # Check Docker secrets
          if [ -n "${{ secrets.DOCKER_USERNAME }}" ]; then
            echo "✓ DOCKER_USERNAME" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_FOUND++))
          else
            echo "✗ DOCKER_USERNAME (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_MISSING++))
          fi
          
          if [ -n "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "✓ DOCKER_PASSWORD" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_FOUND++))
          else
            echo "✗ DOCKER_PASSWORD (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_MISSING++))
          fi
          
          # Check staging secrets
          if [ -n "${{ secrets.STAGING_HOST }}" ]; then
            echo "✓ STAGING_HOST" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_FOUND++))
          else
            echo "✗ STAGING_HOST (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_MISSING++))
          fi
          
          if [ -n "${{ secrets.STAGING_USER }}" ]; then
            echo "✓ STAGING_USER" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_FOUND++))
          else
            echo "✗ STAGING_USER (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_MISSING++))
          fi
          
          if [ -n "${{ secrets.STAGING_KEY }}" ]; then
            echo "✓ STAGING_KEY" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_FOUND++))
          else
            echo "✗ STAGING_KEY (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_MISSING++))
          fi
          
          if [ -n "${{ secrets.STAGING_DATABASE_URL }}" ]; then
            echo "✓ STAGING_DATABASE_URL" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_FOUND++))
          else
            echo "✗ STAGING_DATABASE_URL (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_MISSING++))
          fi
          
          # Check production secrets
          if [ -n "${{ secrets.PROD_HOST }}" ]; then
            echo "✓ PROD_HOST" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_FOUND++))
          else
            echo "✗ PROD_HOST (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_MISSING++))
          fi
          
          if [ -n "${{ secrets.PROD_USER }}" ]; then
            echo "✓ PROD_USER" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_FOUND++))
          else
            echo "✗ PROD_USER (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_MISSING++))
          fi
          
          if [ -n "${{ secrets.PROD_KEY }}" ]; then
            echo "✓ PROD_KEY" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_FOUND++))
          else
            echo "✗ PROD_KEY (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_MISSING++))
          fi
          
          if [ -n "${{ secrets.PROD_DATABASE_URL }}" ]; then
            echo "✓ PROD_DATABASE_URL" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_FOUND++))
          else
            echo "✗ PROD_DATABASE_URL (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_MISSING++))
          fi
          
          # Check npm token
          if [ -n "${{ secrets.NPM_TOKEN }}" ]; then
            echo "✓ NPM_TOKEN" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_FOUND++))
          else
            echo "✗ NPM_TOKEN (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((SECRETS_MISSING++))
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Optional Secrets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check optional secrets
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            echo "✓ SLACK_WEBHOOK" >> $GITHUB_STEP_SUMMARY
          else
            echo "○ SLACK_WEBHOOK (optional)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ secrets.RENOVATE_TOKEN }}" ]; then
            echo "✓ RENOVATE_TOKEN" >> $GITHUB_STEP_SUMMARY
          else
            echo "○ RENOVATE_TOKEN (optional)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** $SECRETS_FOUND/11 required secrets found" >> $GITHUB_STEP_SUMMARY
          
          if [ $SECRETS_MISSING -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **$SECRETS_MISSING required secrets are missing**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        continue-on-error: true

  verify-variables:
    runs-on: ubuntu-latest
    name: Verify Variables Configuration
    steps:
      - uses: actions/checkout@v4
      
      - name: Check required variables
        id: check-variables
        run: |
          echo "## Variables Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required Variables" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          VARIABLES_FOUND=0
          VARIABLES_MISSING=0
          
          if [ -n "${{ vars.NODE_VERSIONS }}" ]; then
            echo "✓ NODE_VERSIONS = ${{ vars.NODE_VERSIONS }}" >> $GITHUB_STEP_SUMMARY
            ((VARIABLES_FOUND++))
          else
            echo "✗ NODE_VERSIONS (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((VARIABLES_MISSING++))
          fi
          
          if [ -n "${{ vars.COVERAGE_THRESHOLD }}" ]; then
            echo "✓ COVERAGE_THRESHOLD = ${{ vars.COVERAGE_THRESHOLD }}" >> $GITHUB_STEP_SUMMARY
            ((VARIABLES_FOUND++))
          else
            echo "✗ COVERAGE_THRESHOLD (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((VARIABLES_MISSING++))
          fi
          
          if [ -n "${{ vars.SECURITY_SEVERITY_THRESHOLD }}" ]; then
            echo "✓ SECURITY_SEVERITY_THRESHOLD = ${{ vars.SECURITY_SEVERITY_THRESHOLD }}" >> $GITHUB_STEP_SUMMARY
            ((VARIABLES_FOUND++))
          else
            echo "✗ SECURITY_SEVERITY_THRESHOLD (MISSING)" >> $GITHUB_STEP_SUMMARY
            ((VARIABLES_MISSING++))
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** $VARIABLES_FOUND/3 required variables found" >> $GITHUB_STEP_SUMMARY
          
          if [ $VARIABLES_MISSING -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **$VARIABLES_MISSING required variables are missing**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        continue-on-error: true

  verify-environments:
    runs-on: ubuntu-latest
    name: Verify Environments Configuration
    steps:
      - uses: actions/checkout@v4
      
      - name: Check environments
        id: check-environments
        run: |
          echo "## Environments Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required Environments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ staging" >> $GITHUB_STEP_SUMMARY
          echo "✓ production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Environment verification requires GitHub CLI. Manual verification:" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to: https://github.com/${{ github.repository }}/settings/environments" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify 'staging' and 'production' environments exist" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify protection rules are configured" >> $GITHUB_STEP_SUMMARY

  summary:
    runs-on: ubuntu-latest
    needs: [verify-secrets, verify-variables, verify-environments]
    if: always()
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate summary
        run: |
          echo "## Secrets and Variables Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "- Secrets: ${{ needs.verify-secrets.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Variables: ${{ needs.verify-variables.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Environments: ${{ needs.verify-environments.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.verify-secrets.result }}" != "success" ] || [ "${{ needs.verify-variables.result }}" != "success" ]; then
            echo "⚠️ **Some configuration is missing**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To configure missing items:" >> $GITHUB_STEP_SUMMARY
            echo "1. Read: [.github/SECRETS-AND-VARIABLES-SETUP.md](.github/SECRETS-AND-VARIABLES-SETUP.md)" >> $GITHUB_STEP_SUMMARY
            echo "2. Go to: https://github.com/${{ github.repository }}/settings/secrets" >> $GITHUB_STEP_SUMMARY
            echo "3. Add missing secrets" >> $GITHUB_STEP_SUMMARY
            echo "4. Go to: https://github.com/${{ github.repository }}/settings/variables" >> $GITHUB_STEP_SUMMARY
            echo "5. Add missing variables" >> $GITHUB_STEP_SUMMARY
            echo "6. Go to: https://github.com/${{ github.repository }}/settings/environments" >> $GITHUB_STEP_SUMMARY
            echo "7. Create staging and production environments with protection rules" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **All secrets and variables are properly configured!**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Documentation" >> $GITHUB_STEP_SUMMARY
          echo "- [Setup Guide](.github/SECRETS-AND-VARIABLES-SETUP.md)" >> $GITHUB_STEP_SUMMARY
          echo "- [Quick Reference](.github/SECRETS-AND-VARIABLES-REFERENCE.md)" >> $GITHUB_STEP_SUMMARY
