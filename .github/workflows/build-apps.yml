name: ğŸ—ï¸ Build Desktop & Mobile Apps

on:
  push:
    branches: [main, release/*]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to build'
        required: true
        type: choice
        options:
          - all
          - desktop
          - mobile
          - windows
          - macos
          - linux
          - android
          - ios
        default: 'all'

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

jobs:
  # ===== WINDOWS BUILD =====
  build-windows:
    name: ğŸªŸ Build Windows (.exe)
    runs-on: windows-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.platforms == 'all' || 
        github.event.inputs.platforms == 'desktop' || 
        github.event.inputs.platforms == 'windows'))

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd apps/student-portal
          npm ci

      - name: ğŸ—ï¸ Build Next.js
        run: |
          cd apps/student-portal
          npm run build
          npm run export

      - name: ğŸ“¦ Install Electron Dependencies
        run: |
          cd apps/student-portal
          cp package.electron.json package.json
          npm install

      - name: ğŸªŸ Build Windows Installer
        run: |
          cd apps/student-portal
          npm run build:win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¤ Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: azora-student-portal-windows
          path: |
            apps/student-portal/dist/*.exe
          retention-days: 30

      - name: ğŸ“Š Build Stats
        run: |
          echo "âœ… Windows Build Complete"
          ls -lh apps/student-portal/dist/

  # ===== MACOS BUILD =====
  build-macos:
    name: ğŸ Build macOS (.dmg)
    runs-on: macos-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.platforms == 'all' || 
        github.event.inputs.platforms == 'desktop' || 
        github.event.inputs.platforms == 'macos'))

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd apps/student-portal
          npm ci

      - name: ğŸ—ï¸ Build Next.js
        run: |
          cd apps/student-portal
          npm run build
          npm run export

      - name: ğŸ“¦ Install Electron Dependencies
        run: |
          cd apps/student-portal
          cp package.electron.json package.json
          npm install

      - name: ğŸ Build macOS DMG
        run: |
          cd apps/student-portal
          npm run build:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¤ Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: azora-student-portal-macos
          path: |
            apps/student-portal/dist/*.dmg
            apps/student-portal/dist/*.zip
          retention-days: 30

      - name: ğŸ“Š Build Stats
        run: |
          echo "âœ… macOS Build Complete"
          ls -lh apps/student-portal/dist/

  # ===== LINUX BUILD =====
  build-linux:
    name: ğŸ§ Build Linux (.AppImage)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.platforms == 'all' || 
        github.event.inputs.platforms == 'desktop' || 
        github.event.inputs.platforms == 'linux'))

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd apps/student-portal
          npm ci

      - name: ğŸ—ï¸ Build Next.js
        run: |
          cd apps/student-portal
          npm run build
          npm run export

      - name: ğŸ“¦ Install Electron Dependencies
        run: |
          cd apps/student-portal
          cp package.electron.json package.json
          npm install

      - name: ğŸ§ Build Linux AppImage
        run: |
          cd apps/student-portal
          npm run build:linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¤ Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: azora-student-portal-linux
          path: |
            apps/student-portal/dist/*.AppImage
            apps/student-portal/dist/*.deb
            apps/student-portal/dist/*.rpm
          retention-days: 30

      - name: ğŸ“Š Build Stats
        run: |
          echo "âœ… Linux Build Complete"
          ls -lh apps/student-portal/dist/

  # ===== ANDROID BUILD =====
  build-android:
    name: ğŸ¤– Build Android (.apk)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.platforms == 'all' || 
        github.event.inputs.platforms == 'mobile' || 
        github.event.inputs.platforms == 'android'))

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ“¦ Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd apps/student-portal-mobile
          npm ci

      - name: ğŸ”‘ Decode Keystore
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > apps/student-portal-mobile/android/app/azora-release-key.keystore

      - name: ğŸ—ï¸ Build Android APK
        run: |
          cd apps/student-portal-mobile/android
          ./gradlew assembleRelease
        env:
          MYAPP_RELEASE_STORE_FILE: azora-release-key.keystore
          MYAPP_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          MYAPP_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
          MYAPP_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: ğŸ—ï¸ Build Android App Bundle (AAB)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          cd apps/student-portal-mobile/android
          ./gradlew bundleRelease

      - name: ğŸ“¤ Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: azora-student-portal-android
          path: |
            apps/student-portal-mobile/android/app/build/outputs/apk/**/*.apk
            apps/student-portal-mobile/android/app/build/outputs/bundle/**/*.aab
          retention-days: 30

      - name: ğŸ“Š Build Stats
        run: |
          echo "âœ… Android Build Complete"
          ls -lh apps/student-portal-mobile/android/app/build/outputs/apk/

  # ===== iOS BUILD =====
  build-ios:
    name: ğŸ Build iOS (.ipa)
    runs-on: macos-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.platforms == 'all' || 
        github.event.inputs.platforms == 'mobile' || 
        github.event.inputs.platforms == 'ios'))

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd apps/student-portal-mobile
          npm ci

      - name: ğŸ“¦ Install CocoaPods
        run: |
          cd apps/student-portal-mobile/ios
          pod install

      - name: ğŸ—ï¸ Build iOS
        run: |
          cd apps/student-portal-mobile/ios
          xcodebuild -workspace AzoraStudentPortal.xcworkspace \
            -scheme AzoraStudentPortal \
            -configuration Release \
            -archivePath build/AzoraStudentPortal.xcarchive \
            archive

      - name: ğŸ“¦ Export IPA
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          cd apps/student-portal-mobile/ios
          xcodebuild -exportArchive \
            -archivePath build/AzoraStudentPortal.xcarchive \
            -exportPath build \
            -exportOptionsPlist exportOptions.plist

      - name: ğŸ“¤ Upload iOS IPA
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: azora-student-portal-ios
          path: apps/student-portal-mobile/ios/build/*.ipa
          retention-days: 30

      - name: ğŸ“Š Build Stats
        run: |
          echo "âœ… iOS Build Complete"

  # ===== CREATE RELEASE =====
  create-release:
    name: ğŸ“¦ Create GitHub Release
    needs: [build-windows, build-macos, build-linux, build-android, build-ios]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4

      - name: ğŸ“¦ Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            azora-student-portal-windows/*.exe
            azora-student-portal-macos/*.dmg
            azora-student-portal-macos/*.zip
            azora-student-portal-linux/*.AppImage
            azora-student-portal-linux/*.deb
            azora-student-portal-android/*.apk
            azora-student-portal-android/*.aab
            azora-student-portal-ios/*.ipa
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ‰ Release Complete
        run: |
          echo "ğŸ‰ =================================="
          echo "ğŸ‰ RELEASE CREATED SUCCESSFULLY"
          echo "ğŸ‰ =================================="
          echo ""
          echo "âœ… Windows: .exe"
          echo "âœ… macOS: .dmg + .zip"
          echo "âœ… Linux: .AppImage + .deb"
          echo "âœ… Android: .apk + .aab"
          echo "âœ… iOS: .ipa"
          echo ""
          echo "ğŸš€ Ready for distribution!"
