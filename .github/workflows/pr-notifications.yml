name: PR Notifications & Feedback

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  workflow_run:
    workflows:
      - "CI - Linting & Type Checking"
      - "Test Suite"
      - "Security Scanning"
      - "E2E Tests"
    types: [completed]

concurrency:
  group: pr-notifications-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

jobs:
  notify-pr-opened:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Add welcome comment to new PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const comment = `## ðŸ‘‹ Welcome to Azora OS!

Thank you for your contribution! Here's what happens next:

### ðŸ” Automated Checks
Your PR will be automatically checked for:
- âœ… **Code Quality** - Linting and formatting
- âœ… **Type Safety** - TypeScript compilation
- âœ… **Tests** - Unit and integration tests
- âœ… **Security** - Vulnerability scanning
- âœ… **E2E Tests** - End-to-end functionality (optional)

### ðŸ“‹ Checklist
Before we can merge, please ensure:
- [ ] Code follows the project style guide
- [ ] Tests are included for new functionality
- [ ] Documentation is updated if needed
- [ ] No breaking changes without discussion
- [ ] Commit messages follow conventional commits

### ðŸš€ Next Steps
1. Wait for automated checks to complete
2. Address any feedback from reviewers
3. Keep your branch up to date with main
4. Request review when ready

### ðŸ“š Resources
- [Contributing Guide](CONTRIBUTING.md)
- [Code Review Guidelines](docs/CODE-REVIEW.md)
- [Testing Guidelines](docs/TESTING-GUIDELINES.md)
- [CI/CD Documentation](.github/workflows/README.md)

---
*This comment was automatically generated by the PR Notifications workflow.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: comment
            });

  notify-check-completion:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    permissions:
      pull-requests: write
      checks: read
    steps:
      - uses: actions/checkout@v4

      - name: Find associated PR
        id: find-pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: '${{ github.event.workflow_run.head_branch }}'
            });
            
            if (pullRequests.length > 0) {
              core.setOutput('pr-number', pullRequests[0].number);
              core.setOutput('pr-found', 'true');
            } else {
              core.setOutput('pr-found', 'false');
            }

      - name: Comment on PR with check results
        if: steps.find-pr.outputs.pr-found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = '${{ github.event.workflow_run.name }}';
            const conclusion = '${{ github.event.workflow_run.conclusion }}';
            const workflowUrl = '${{ github.event.workflow_run.html_url }}';
            const prNumber = ${{ steps.find-pr.outputs.pr-number }};
            
            let icon = 'âœ…';
            let status = 'passed';
            if (conclusion === 'failure') {
              icon = 'âŒ';
              status = 'failed';
            } else if (conclusion === 'skipped') {
              icon = 'âŠ˜';
              status = 'skipped';
            }
            
            const comment = `${icon} **${workflowName}** ${status}

[View workflow run](${workflowUrl})`;
            
            // Find existing comment for this workflow
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.find(c => 
              c.body.includes(workflowName) && 
              c.user.type === 'Bot'
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

  notify-check-failure-details:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure'
    permissions:
      pull-requests: write
      checks: read
    steps:
      - uses: actions/checkout@v4

      - name: Find associated PR
        id: find-pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: '${{ github.event.workflow_run.head_branch }}'
            });
            
            if (pullRequests.length > 0) {
              core.setOutput('pr-number', pullRequests[0].number);
              core.setOutput('pr-found', 'true');
            } else {
              core.setOutput('pr-found', 'false');
            }

      - name: Comment with failure details and guidance
        if: steps.find-pr.outputs.pr-found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = '${{ github.event.workflow_run.name }}';
            const workflowUrl = '${{ github.event.workflow_run.html_url }}';
            const prNumber = ${{ steps.find-pr.outputs.pr-number }};
            
            let guidance = '';
            
            if (workflowName.includes('Linting') || workflowName.includes('Type')) {
              guidance = `
### ðŸ”§ How to Fix
1. Run locally: \`npm run lint\` and \`npm run typecheck\`
2. Fix errors shown in the output
3. Use \`npm run lint:fix\` to auto-fix style issues
4. Commit and push your changes

### ðŸ“– Common Issues
- Unused imports or variables
- Type mismatches
- Style violations (spacing, semicolons, etc.)
              `;
            } else if (workflowName.includes('Test')) {
              guidance = `
### ðŸ”§ How to Fix
1. Run locally: \`npm run test:unit\` and \`npm run test:integration\`
2. Review the test output for failures
3. Fix the failing tests or the code they test
4. Ensure coverage is above 80%

### ðŸ“– Common Issues
- Logic errors in code
- Missing test setup
- Database/service connectivity issues
              `;
            } else if (workflowName.includes('Security')) {
              guidance = `
### ðŸ”§ How to Fix
1. Run locally: \`npm audit\`
2. Review the vulnerabilities found
3. Update packages: \`npm audit fix\`
4. For manual fixes, update package.json versions
5. Run \`npm ci\` to update lock file

### ðŸ“– Common Issues
- Outdated dependencies with known vulnerabilities
- Hardcoded secrets or credentials
- Unsafe code patterns
              `;
            } else if (workflowName.includes('E2E')) {
              guidance = `
### ðŸ”§ How to Fix
1. Check the test artifacts for screenshots/videos
2. Review the test failure details
3. Fix the application code or test
4. E2E failures don't block merging but should be addressed

### ðŸ“– Common Issues
- UI element selectors changed
- Timing issues in tests
- Test environment not ready
              `;
            }
            
            const comment = \`âŒ **\${workflowName} Failed**

[View workflow run](\${workflowUrl})

\${guidance}

---
**Need help?** Check the [CI/CD Documentation](.github/workflows/README.md) or ask in #dev-help on Slack.\`;
            
            // Check if we already have a failure comment for this workflow
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingFailureComment = comments.find(c => 
              c.body.includes(workflowName) && 
              c.body.includes('Failed') &&
              c.user.type === 'Bot'
            );
            
            if (!existingFailureComment) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

  notify-all-checks-passed:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      checks: read
    steps:
      - uses: actions/checkout@v4

      - name: Check if all required checks passed
        id: check-status
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const requiredChecks = [
              'CI - Linting & Type Checking',
              'Test Suite',
              'Security Scanning'
            ];
            
            const allPassed = requiredChecks.every(required => {
              const check = checkRuns.check_runs.find(c => c.name === required);
              return check && check.conclusion === 'success';
            });
            
            core.setOutput('all-passed', allPassed);

      - name: Comment when all checks pass
        if: steps.check-status.outputs.all-passed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Check if we already have a success comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });
            
            const hasSuccessComment = comments.some(c => 
              c.body.includes('All checks passed') &&
              c.user.type === 'Bot'
            );
            
            if (!hasSuccessComment) {
              const comment = \`ðŸŽ‰ **All checks passed!**

Your PR is ready to merge. Great work!

- âœ… Code quality checks
- âœ… Type safety checks
- âœ… Tests passing
- âœ… Security scan passed

A maintainer will review your changes shortly.\`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
            }

  notify-ready-for-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'ready_for_review'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Comment on ready for review
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const comment = \`ðŸ“‹ **Ready for Review**

This PR is now ready for review. A maintainer will be assigned shortly.

**PR Details:**
- **Author:** @\${pr.user.login}
- **Branch:** \${pr.head.ref}
- **Target:** \${pr.base.ref}
- **Changes:** \${pr.changed_files} files changed

**Reviewers:** Please check the automated checks above before reviewing.\`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: comment
            });
