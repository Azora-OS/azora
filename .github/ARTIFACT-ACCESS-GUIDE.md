# Artifact Access and Retrieval Guide

## Overview

This guide provides detailed instructions for accessing, retrieving, and managing GitHub Actions artifacts in the Azora OS project. Artifacts are generated by CI/CD workflows and contain test reports, coverage data, security scans, and deployment logs.

## Quick Start

### Via GitHub Web UI

1. Navigate to the repository: https://github.com/azora/azora-os
2. Click on the **Actions** tab
3. Select the workflow run you're interested in
4. Scroll down to the **Artifacts** section
5. Click the artifact name to download

### Via GitHub CLI

```bash
# List artifacts from a specific run
gh run view <run-id> --json artifacts

# Download artifact
gh run download <run-id> -n <artifact-name>

# Download all artifacts from a run
gh run download <run-id>
```

### Via GitHub API

```bash
# List all artifacts
curl -H "Authorization: token $GITHUB_TOKEN" \
  https://api.github.com/repos/azora/azora-os/actions/artifacts

# Download specific artifact
curl -H "Authorization: token $GITHUB_TOKEN" \
  -L https://api.github.com/repos/azora/azora-os/actions/artifacts/<artifact-id>/zip \
  -o artifact.zip
```

## Accessing Specific Artifact Types

### Test Reports

#### Finding Test Reports

1. Go to **Actions** â†’ **Test Suite** workflow
2. Find the run you want to review
3. Look for artifacts named:
   - `coverage-report-unit-node-*`
   - `coverage-report-integration-node-*`
   - `test-results-*`

#### Viewing Test Reports

**HTML Coverage Reports:**
```bash
# Download and extract
gh run download <run-id> -n coverage-report-unit-node-20.x
unzip coverage-report-unit-node-20.x.zip
open index.html  # macOS
# or
xdg-open index.html  # Linux
# or
start index.html  # Windows
```

**JUnit XML Results:**
```bash
# Download
gh run download <run-id> -n test-results-chromium-shard-1

# View in text format
cat junit-results.xml

# Parse with tools
python -m xml.dom.minidom junit-results.xml
```

### Coverage Reports

#### Accessing Coverage Data

```bash
# Download coverage report
gh run download <run-id> -n coverage-report-unit-node-20.x

# Extract and view
unzip coverage-report-unit-node-20.x.zip
cd coverage

# View coverage summary
cat coverage-summary.json | jq .

# View detailed coverage
open index.html
```

#### Comparing Coverage Across Runs

```bash
# Download multiple coverage reports
for run_id in <run-id-1> <run-id-2> <run-id-3>; do
  gh run download $run_id -n coverage-report-unit-node-20.x
done

# Compare coverage metrics
for dir in coverage-report-*/; do
  echo "=== $dir ==="
  cat "$dir/coverage-summary.json" | jq '.total.lines.pct'
done
```

### Security Reports

#### Accessing npm Audit Reports

```bash
# Download security artifacts
gh run download <run-id> -n npm-audit-reports

# Extract
unzip npm-audit-reports.zip

# View audit report
cat audit-report.json | jq .

# View summary
cat audit-summary.md
```

#### Accessing CodeQL Results

```bash
# Download CodeQL results
gh run download <run-id> -n codeql-results

# Extract
unzip codeql-results.zip

# View results
ls -la results/
cat results/sarif-results.sarif | jq .
```

#### Accessing Secret Scan Reports

```bash
# Download secret scan report
gh run download <run-id> -n secret-scan-report

# Extract and view
unzip secret-scan-report.zip
cat secret-scan-report.md
```

### E2E Test Reports

#### Accessing E2E Test Results

```bash
# Download E2E test report
gh run download <run-id> -n playwright-report-chromium-shard-1

# Extract
unzip playwright-report-chromium-shard-1.zip

# View HTML report
open index.html
```

#### Accessing E2E Failure Videos

```bash
# Download failure videos (only available for failed tests)
gh run download <run-id> -n test-videos-chromium-shard-1

# Extract
unzip test-videos-chromium-shard-1.zip

# View videos
ls -la test-results/
# Videos are in .webm format
```

#### Accessing E2E Failure Screenshots

```bash
# Download failure screenshots
gh run download <run-id> -n test-screenshots-chromium-shard-1

# Extract
unzip test-screenshots-chromium-shard-1.zip

# View screenshots
ls -la test-results/
# Screenshots are in .png format
```

### Deployment Artifacts

#### Accessing Deployment Records

```bash
# Download deployment record
gh run download <run-id> -n deployment-record-<deployment-id>

# Extract and view
unzip deployment-record-<deployment-id>.zip
cat deployment-record.json | jq .

# View specific fields
cat deployment-record.json | jq '.services_deployed'
cat deployment-record.json | jq '.health_checks'
```

#### Accessing Deployment Logs

```bash
# Download deployment logs
gh run download <run-id> -n deployment-logs-<deployment-id>

# Extract
unzip deployment-logs-<deployment-id>.zip

# View logs
ls -la
cat deployment-<deployment-id>.log
cat migrations-<deployment-id>.log
cat health-check-<deployment-id>.log
```

#### Accessing Rollback Instructions

```bash
# Download rollback instructions
gh run download <run-id> -n rollback-instructions-<deployment-id>

# Extract and view
unzip rollback-instructions-<deployment-id>.zip
cat ROLLBACK-INSTRUCTIONS.md
```

## Advanced Access Methods

### Using GitHub CLI with Filters

```bash
# List artifacts from a specific workflow
gh run list --workflow=test.yml --json databaseId,createdAt,status

# Download artifacts from latest successful run
LATEST_RUN=$(gh run list --workflow=test.yml --status success --limit 1 --json databaseId --jq '.[0].databaseId')
gh run download $LATEST_RUN -n coverage-report-unit-node-20.x
```

### Using GitHub API with jq

```bash
# Get artifact download URL
ARTIFACT_ID=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
  https://api.github.com/repos/azora/azora-os/actions/artifacts \
  | jq '.artifacts[] | select(.name=="coverage-report-unit-node-20.x") | .id' | head -1)

# Download artifact
curl -H "Authorization: token $GITHUB_TOKEN" \
  -L https://api.github.com/repos/azora/azora-os/actions/artifacts/$ARTIFACT_ID/zip \
  -o artifact.zip
```

### Batch Download Script

```bash
#!/bin/bash
# batch-download-artifacts.sh

WORKFLOW=$1
RUN_ID=$2
OUTPUT_DIR=${3:-.}

mkdir -p "$OUTPUT_DIR"

echo "Downloading all artifacts from run $RUN_ID..."

gh run download $RUN_ID --dir "$OUTPUT_DIR"

echo "Artifacts downloaded to $OUTPUT_DIR"
ls -lah "$OUTPUT_DIR"
```

Usage:
```bash
./batch-download-artifacts.sh test.yml 12345678 ./artifacts
```

## Artifact Retention and Availability

### Retention Periods

| Artifact Type | Retention | Availability |
|---------------|-----------|--------------|
| Test Reports | 30 days | Recent runs only |
| Coverage Reports | 90 days | 3-month history |
| Security Reports | 1 year | Full year history |
| Deployment Logs | 1 year | Full year history |
| E2E Videos | 7 days | Recent failures only |

### Checking Artifact Availability

```bash
# Check if artifact still exists
gh run view <run-id> --json artifacts

# Check artifact age
gh run view <run-id> --json createdAt

# Calculate days old
RUN_DATE=$(gh run view <run-id> --json createdAt --jq '.createdAt')
DAYS_OLD=$(( ($(date +%s) - $(date -d "$RUN_DATE" +%s)) / 86400 ))
echo "Artifact is $DAYS_OLD days old"
```

## Troubleshooting

### Artifact Not Found

**Problem:** Cannot find expected artifact

**Solutions:**
1. Verify the run ID is correct
2. Check if artifact retention period has expired
3. Verify the workflow actually generated the artifact
4. Check if the run failed (artifacts may not be generated)

```bash
# Verify run status
gh run view <run-id> --json status,conclusion

# List all artifacts from run
gh run view <run-id> --json artifacts
```

### Download Fails

**Problem:** Error downloading artifact

**Solutions:**
1. Verify GitHub token has necessary permissions
2. Check network connectivity
3. Try downloading via web UI instead
4. Verify artifact file size isn't too large

```bash
# Check artifact size
gh run view <run-id> --json artifacts | jq '.artifacts[] | {name, size_in_bytes}'

# Try downloading with verbose output
gh run download <run-id> -n <artifact-name> --verbose
```

### Artifact Extraction Issues

**Problem:** Cannot extract downloaded artifact

**Solutions:**
1. Verify file is actually a zip file
2. Check for corruption during download
3. Try extracting with different tools
4. Check disk space

```bash
# Verify zip file integrity
unzip -t artifact.zip

# Extract with verbose output
unzip -v artifact.zip

# Check file type
file artifact.zip
```

## Best Practices

### 1. Regular Archival

Archive critical artifacts to long-term storage:

```bash
# Archive deployment records
gh run list --workflow=deploy-production.yml --limit 100 --json databaseId | \
  jq -r '.[] | .databaseId' | \
  while read run_id; do
    gh run download $run_id -n deployment-record-* -d archive/
  done
```

### 2. Automated Reporting

Create scripts to generate reports from artifacts:

```bash
#!/bin/bash
# generate-coverage-report.sh

RUNS=10
echo "# Coverage Trend Report" > coverage-trend.md
echo "" >> coverage-trend.md

gh run list --workflow=test.yml --limit $RUNS --json databaseId | \
  jq -r '.[] | .databaseId' | \
  while read run_id; do
    gh run download $run_id -n coverage-report-unit-node-20.x -d temp/
    COVERAGE=$(cat temp/coverage-summary.json | jq '.total.lines.pct')
    echo "- Run $run_id: ${COVERAGE}%" >> coverage-trend.md
  done

cat coverage-trend.md
```

### 3. Monitoring Storage Usage

```bash
# Check total artifact storage
gh api repos/azora/azora-os/actions/artifacts \
  --paginate \
  --jq '[.artifacts[].size_in_bytes] | add' | \
  awk '{printf "Total: %.2f GB\n", $1/1024/1024/1024}'
```

### 4. Secure Access

```bash
# Use GitHub token from environment
export GITHUB_TOKEN=$(cat ~/.github/token)

# Or use gh auth
gh auth login

# Verify authentication
gh auth status
```

## Integration with External Tools

### Uploading to S3

```bash
#!/bin/bash
# upload-to-s3.sh

RUN_ID=$1
ARTIFACT_NAME=$2
S3_BUCKET=$3

# Download artifact
gh run download $RUN_ID -n $ARTIFACT_NAME

# Upload to S3
aws s3 cp $ARTIFACT_NAME.zip s3://$S3_BUCKET/artifacts/
```

### Sending to Slack

```bash
#!/bin/bash
# notify-slack.sh

RUN_ID=$1
ARTIFACT_NAME=$2
SLACK_WEBHOOK=$3

# Get artifact download URL
ARTIFACT_URL=$(gh run view $RUN_ID --json artifacts | \
  jq -r ".artifacts[] | select(.name==\"$ARTIFACT_NAME\") | .url")

# Send to Slack
curl -X POST $SLACK_WEBHOOK \
  -H 'Content-Type: application/json' \
  -d "{\"text\": \"Artifact available: $ARTIFACT_URL\"}"
```

## Related Documentation

- [Artifact Retention Policy](./ARTIFACT-RETENTION-POLICY.md)
- [Workflow Documentation](./workflows/README.md)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [GitHub CLI Documentation](https://cli.github.com/manual)

## Support

For questions or issues with artifact access:
1. Check this guide and related documentation
2. Review GitHub Actions troubleshooting guide
3. Contact the DevOps team
4. Open an issue in the repository

Last updated: November 19, 2024
