# Artifact Retention and Cleanup Policy

## Overview

This document defines the retention policies for all artifacts generated by GitHub Actions workflows in the Azora OS project. Proper artifact management ensures compliance with requirements, maintains audit trails, and prevents repository clutter while optimizing storage costs.

## Artifact Retention Schedule

### Test Artifacts

| Artifact Type | Retention Period | Purpose | Cleanup Method |
|---------------|-----------------|---------|-----------------|
| Unit Test Reports | 30 days | Verify test execution and results | Automatic GitHub Actions cleanup |
| Integration Test Reports | 30 days | Verify integration test execution | Automatic GitHub Actions cleanup |
| E2E Test Reports (HTML) | 30 days | Detailed E2E test results and traces | Automatic GitHub Actions cleanup |
| E2E Test Videos | 7 days | Debug failed E2E tests | Automatic GitHub Actions cleanup |
| E2E Test Screenshots | 7 days | Visual debugging of failures | Automatic GitHub Actions cleanup |
| JUnit XML Results | 30 days | CI/CD integration and reporting | Automatic GitHub Actions cleanup |

### Coverage Artifacts

| Artifact Type | Retention Period | Purpose | Cleanup Method |
|---------------|-----------------|---------|-----------------|
| Coverage Reports (HTML) | 90 days | Track coverage trends over time | Automatic GitHub Actions cleanup |
| Coverage Reports (JSON) | 90 days | Programmatic coverage analysis | Automatic GitHub Actions cleanup |
| Coverage Badges | Indefinite | Display in README | Manual management |

### Security Artifacts

| Artifact Type | Retention Period | Purpose | Cleanup Method |
|---------------|-----------------|---------|-----------------|
| npm Audit Reports | 1 year | Compliance and audit trail | Automatic GitHub Actions cleanup |
| CodeQL SAST Results | 1 year | Security vulnerability tracking | Automatic GitHub Actions cleanup |
| Secret Scan Reports | 1 year | Compliance and incident tracking | Automatic GitHub Actions cleanup |
| Security Consolidated Report | 1 year | Executive summary for audits | Automatic GitHub Actions cleanup |

### Deployment Artifacts

| Artifact Type | Retention Period | Purpose | Cleanup Method |
|---------------|-----------------|---------|-----------------|
| Build Logs | 1 year | Deployment audit trail | Automatic GitHub Actions cleanup |
| Migration Logs | 1 year | Database change tracking | Automatic GitHub Actions cleanup |
| Deployment Logs | 1 year | Deployment history and troubleshooting | Automatic GitHub Actions cleanup |
| Health Check Logs | 1 year | Service health verification | Automatic GitHub Actions cleanup |
| Rollback Logs | 1 year | Incident response tracking | Automatic GitHub Actions cleanup |
| Deployment Records (JSON) | 1 year | Structured deployment metadata | Automatic GitHub Actions cleanup |
| Rollback Instructions | 1 year | Emergency procedures | Automatic GitHub Actions cleanup |

### Build Artifacts

| Artifact Type | Retention Period | Purpose | Cleanup Method |
|---------------|-----------------|---------|-----------------|
| Docker Build Logs | 1 year | Build history and troubleshooting | Automatic GitHub Actions cleanup |
| Build Output | 30 days | Temporary build artifacts | Automatic GitHub Actions cleanup |

## Retention Policy Implementation

### GitHub Actions Configuration

All workflows use the `retention-days` parameter in the `upload-artifact` action:

```yaml
- name: Upload artifact
  uses: actions/upload-artifact@v4
  with:
    name: artifact-name
    path: path/to/artifact
    retention-days: 30  # Specify retention period
```

### Retention Periods by Workflow

#### Test Workflow (test.yml)
- Coverage reports: 30 days
- Test results: 30 days

#### E2E Tests Workflow (e2e-tests.yml)
- HTML reports: 30 days
- JUnit results: 30 days
- Videos (failure): 7 days
- Screenshots (failure): 7 days

#### Security Workflow (security.yml)
- npm audit reports: 365 days
- CodeQL results: 365 days
- Secret scan reports: 365 days
- Consolidated security report: 365 days

#### Staging Deployment Workflow (deploy-staging.yml)
- Migration logs: 365 days
- Build logs: 365 days
- Deployment logs: 365 days
- Health check logs: 365 days
- Deployment records: 365 days

#### Production Deployment Workflow (deploy-production.yml)
- Backup logs: 365 days
- Migration logs: 365 days
- Build logs: 365 days
- Rollout logs: 365 days
- Smoke test logs: 365 days
- Deployment records: 365 days
- Rollback instructions: 365 days
- Failure reports: 365 days

## Artifact Storage Management

### Storage Optimization

1. **Compression**: Large artifacts are automatically compressed by GitHub Actions
2. **Deduplication**: Identical artifacts are deduplicated across runs
3. **Cleanup**: Artifacts older than retention period are automatically deleted

### Storage Limits

- GitHub Actions provides free storage for public repositories
- Private repositories have storage limits based on plan
- Monitor storage usage in repository settings

### Accessing Artifacts

#### Via GitHub UI
1. Navigate to Actions tab
2. Select workflow run
3. Scroll to "Artifacts" section
4. Download desired artifact

#### Via GitHub CLI
```bash
# List artifacts for a workflow run
gh run view <run-id> --json artifacts

# Download artifact
gh run download <run-id> -n <artifact-name>
```

#### Via GitHub API
```bash
# List artifacts
curl -H "Authorization: token $GITHUB_TOKEN" \
  https://api.github.com/repos/azora/azora-os/actions/artifacts

# Download artifact
curl -H "Authorization: token $GITHUB_TOKEN" \
  -L https://api.github.com/repos/azora/azora-os/actions/artifacts/<artifact-id>/zip \
  -o artifact.zip
```

## Artifact Retrieval Procedures

### Retrieving Test Reports

1. **Recent test failures** (within 30 days):
   - Go to Actions → Test Suite workflow
   - Find the failed run
   - Download "test-results-*" artifact
   - Extract and open HTML report in browser

2. **Coverage trends** (within 90 days):
   - Go to Actions → Test Suite workflow
   - Find the run
   - Download "coverage-report-*" artifact
   - Compare coverage metrics across runs

### Retrieving Security Reports

1. **Vulnerability history** (within 1 year):
   - Go to Actions → Security Scanning workflow
   - Find the run
   - Download "npm-audit-reports" artifact
   - Review audit-report.json for vulnerability details

2. **SAST findings** (within 1 year):
   - Go to Actions → Security Scanning workflow
   - Find the run
   - Download "codeql-results" artifact
   - Review CodeQL analysis results

### Retrieving Deployment Records

1. **Deployment history** (within 1 year):
   - Go to Actions → Deploy Production workflow
   - Find the release tag
   - Download "deployment-record-*" artifact
   - Review deployment-record.json for metadata

2. **Rollback procedures** (within 1 year):
   - Go to Actions → Deploy Production workflow
   - Find the deployment
   - Download "rollback-instructions-*" artifact
   - Follow procedures if rollback needed

## Cleanup Procedures

### Automatic Cleanup

GitHub Actions automatically deletes artifacts when they exceed their retention period. No manual action required.

### Manual Cleanup

To manually delete artifacts:

```bash
# Delete specific artifact
gh run download <run-id> -n <artifact-name> --delete

# Delete all artifacts from a run
gh run delete <run-id>
```

### Bulk Cleanup Script

For bulk cleanup of old artifacts:

```bash
#!/bin/bash
# cleanup-old-artifacts.sh

RETENTION_DAYS=30
CUTOFF_DATE=$(date -d "$RETENTION_DAYS days ago" +%s)

# List all artifacts
gh run list --json databaseId,createdAt --limit 1000 | \
  jq -r '.[] | select(.createdAt | fromdateiso8601 < '$CUTOFF_DATE') | .databaseId' | \
  while read run_id; do
    echo "Deleting artifacts from run $run_id"
    gh run delete "$run_id"
  done
```

## Compliance and Audit Trail

### Retention for Compliance

- **Security artifacts** (1 year): Comply with security audit requirements
- **Deployment records** (1 year): Maintain audit trail for production changes
- **Test reports** (30 days): Verify code quality gates
- **Coverage reports** (90 days): Track quality metrics

### Audit Trail Access

All artifacts include metadata:
- Workflow name and run ID
- Timestamp of creation
- Git commit SHA
- Branch/tag information
- Actor (user who triggered workflow)

### Compliance Verification

To verify compliance:

1. Check artifact retention settings in workflows
2. Verify retention-days parameters match policy
3. Monitor storage usage in repository settings
4. Review artifact access logs (if available)

## Troubleshooting

### Artifact Not Found

**Problem**: Cannot find expected artifact

**Solutions**:
1. Verify artifact retention period hasn't expired
2. Check workflow run status (may have failed)
3. Verify artifact name matches exactly
4. Check repository permissions

### Storage Quota Exceeded

**Problem**: Cannot upload new artifacts due to storage limits

**Solutions**:
1. Delete old artifacts manually
2. Reduce retention periods for non-critical artifacts
3. Upgrade repository plan for more storage
4. Archive old artifacts to external storage

### Artifact Download Fails

**Problem**: Error downloading artifact

**Solutions**:
1. Verify GitHub token has necessary permissions
2. Check network connectivity
3. Try downloading via GitHub UI instead of CLI
4. Contact GitHub support if issue persists

## Best Practices

1. **Regular Review**: Review artifact retention policies quarterly
2. **Documentation**: Keep artifact access procedures up to date
3. **Monitoring**: Monitor storage usage trends
4. **Archival**: Archive critical artifacts to long-term storage (S3, etc.)
5. **Cleanup**: Regularly clean up temporary artifacts
6. **Security**: Restrict artifact access to authorized users
7. **Naming**: Use consistent, descriptive artifact names
8. **Organization**: Group related artifacts with consistent naming patterns

## Related Documentation

- [GitHub Actions Artifacts Documentation](https://docs.github.com/en/actions/managing-workflow-runs/about-workflow-runs#artifacts)
- [Workflow Documentation](./WORKFLOW-DOCUMENTATION-INDEX.md)
- [Deployment Procedures](./PRODUCTION-DEPLOYMENT-GUIDE.md)
- [Security Scanning Guide](./SECURITY-SCANNING-GUIDE.md)

## Policy Updates

This policy is reviewed and updated quarterly. Last updated: November 19, 2024

For questions or suggestions, contact the DevOps team.
