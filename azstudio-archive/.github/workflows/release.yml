name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  NODE_VERSION: '20'

jobs:
  # Build for Windows
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
        working-directory: ./azstudio
      
      - name: Build application
        run: npm run build
        working-directory: ./azstudio
      
      - name: Package NSIS installer
        run: npm run package:nsis
        working-directory: ./azstudio
        env:
          CSC_LINK: ${{ secrets.WINDOWS_CERT_FILE }}
          CSC_KEY_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
      
      - name: Package MSIX installer
        run: npm run package:msix
        working-directory: ./azstudio
        env:
          CSC_LINK: ${{ secrets.WINDOWS_CERT_FILE }}
          CSC_KEY_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD }}
      
      - name: Upload NSIS installer
        uses: actions/upload-artifact@v4
        with:
          name: azstudio-nsis-installer
          path: azstudio/release/*.exe
          retention-days: 90
      
      - name: Upload MSIX installer
        uses: actions/upload-artifact@v4
        with:
          name: azstudio-msix-installer
          path: azstudio/release/*.msix
          retention-days: 90
      
      - name: Calculate checksums
        run: |
          Get-ChildItem azstudio/release/*.exe, azstudio/release/*.msix | ForEach-Object {
            $hash = Get-FileHash $_.FullName -Algorithm SHA256
            "$($hash.Hash)  $($_.Name)" | Out-File -Append azstudio/release/checksums.txt
          }
      
      - name: Upload checksums
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: azstudio/release/checksums.txt
          retention-days: 90

  # Create GitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: windows-latest
    needs: [build-windows]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download NSIS installer
        uses: actions/download-artifact@v4
        with:
          name: azstudio-nsis-installer
          path: ./release/
      
      - name: Download MSIX installer
        uses: actions/download-artifact@v4
        with:
          name: azstudio-msix-installer
          path: ./release/
      
      - name: Download checksums
        uses: actions/download-artifact@v4
        with:
          name: checksums
          path: ./release/
      
      - name: Extract version from tag
        id: version
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          echo "version=$version" >> $env:GITHUB_OUTPUT
      
      - name: Generate release notes
        id: release_notes
        run: |
          $notes = @"
          ## AzStudio ${{ steps.version.outputs.version }}
          
          ### What's New
          
          - Feature updates and improvements
          - Bug fixes and performance enhancements
          - Security updates
          
          ### Installation
          
          **Windows:**
          - Download `AzStudio-Setup-${{ steps.version.outputs.version }}.exe` for NSIS installer
          - Download `AzStudio-${{ steps.version.outputs.version }}.msix` for Microsoft Store compatible package
          
          ### Checksums
          
          See `checksums.txt` for SHA256 checksums of all release files.
          
          ### Full Changelog
          
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for detailed changes.
          "@
          
          $notes | Out-File -FilePath release_notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: AzStudio ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            release/*.exe
            release/*.msix
            release/checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Deploy to Update Server
  deploy-update-server:
    name: Deploy to Update Server
    runs-on: windows-latest
    needs: [create-release]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
        working-directory: ./azstudio
      
      - name: Download installers
        uses: actions/download-artifact@v4
        with:
          name: azstudio-nsis-installer
          path: azstudio/release/
      
      - name: Deploy to stable channel
        run: node scripts/deploy-updates.js deploy stable
        working-directory: ./azstudio
        env:
          UPDATE_SERVER_URL: ${{ secrets.UPDATE_SERVER_URL }}
          UPDATE_SERVER_TOKEN: ${{ secrets.UPDATE_SERVER_TOKEN }}
      
      - name: Verify deployment
        run: |
          $response = Invoke-RestMethod -Uri "${{ secrets.UPDATE_SERVER_URL }}/latest.yml"
          Write-Host "Deployed version: $($response.version)"
          
          if ($response.version -ne "${{ steps.version.outputs.version }}") {
            Write-Error "Deployment verification failed"
            exit 1
          }
      
      - name: Update deployment status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              target_url: '${{ secrets.UPDATE_SERVER_URL }}',
              description: 'Deployed to stable channel',
              context: 'deployment/stable'
            });

  # Publish to Microsoft Store (optional)
  publish-store:
    name: Publish to Microsoft Store
    runs-on: windows-latest
    needs: [create-release]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download MSIX installer
        uses: actions/download-artifact@v4
        with:
          name: azstudio-msix-installer
          path: ./release/
      
      - name: Publish to Microsoft Store
        uses: microsoft/store-submission@v1
        with:
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          app-id: ${{ secrets.STORE_APP_ID }}
          package-path: ./release/*.msix

  # Notify stakeholders
  notify-release:
    name: Notify Release
    runs-on: windows-latest
    needs: [deploy-update-server]
    
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: 'success'
          text: |
            ðŸŽ‰ AzStudio ${{ github.ref_name }} has been released!
            
            Download: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: AzStudio ${{ github.ref_name }} Released
          body: |
            A new version of AzStudio has been released!
            
            Version: ${{ github.ref_name }}
            Download: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}
            
            Changelog: https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md
          to: ${{ secrets.RELEASE_NOTIFICATION_EMAIL }}
          from: AzStudio CI/CD

  # Rollback on failure
  rollback:
    name: Rollback on Failure
    runs-on: windows-latest
    needs: [deploy-update-server]
    if: failure()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
        working-directory: ./azstudio
      
      - name: Rollback deployment
        run: node scripts/deploy-updates.js rollback
        working-directory: ./azstudio
        env:
          UPDATE_SERVER_URL: ${{ secrets.UPDATE_SERVER_URL }}
          UPDATE_SERVER_TOKEN: ${{ secrets.UPDATE_SERVER_TOKEN }}
      
      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Release ${{ github.ref_name }} Failed - Rolled Back`,
              body: `The release deployment for ${{ github.ref_name }} failed and has been rolled back.
              
              **Tag:** ${{ github.ref_name }}
              **Workflow:** ${context.workflow}
              **Run:** ${context.runNumber}
              
              Please investigate the failure and create a new release.`,
              labels: ['release-failure', 'critical']
            });
