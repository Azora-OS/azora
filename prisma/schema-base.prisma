generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NOTE: This is a temporary base schema used to generate diffs where Sapiens
// models are not present. We copied content from the root schema and removed
// the Sapiens block to produce a 'before' snapshot.

// --- Copy content from the root schema up to, but not including, the SAPIENS block ---

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      UserRole @default(STUDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enrollments      Enrollment[]
  payments         Payment[]
  receipts         Receipt[]
  idempotencyKeys  IdempotencyKey[]
  profile          UserProfile?
  tokens           Token[]
  incidents        SafetyIncident[]
  wallets          Wallet[]
  miningActivities MiningActivity[]
  jobApplications  JobApplication[]
  skills           UserSkill[]
  assessments      Assessment[]
  chatSessions     ChatSession[]
  notifications    Notification[]
  consentRecords   ConsentRecord[]
  subscription     Subscription?
  coursesInstructed Course[] @relation("CourseInstructor")
  courseReviews    CourseReview[] @relation("CourseReviews")
  coursePurchases  CoursePurchase[] @relation("CoursePurchases")
  instructorEarnings InstructorEarnings[] @relation("InstructorEarnings")
  tokenBalance     TokenBalance?
  tokenTransactions TokenTransaction[]
  leaderboardEntries LeaderboardEntry[]
  tokenRedemptions TokenRedemption[]
  burnTransactions BurnTransaction[] @relation("BurnTransactions")
  proofOfKnowledge ProofOfKnowledge[] @relation("ProofOfKnowledge")
  queryClassifications QueryClassification[] @relation("QueryClassifications")
  scholarships Scholarship[]
  proofsOfValue ProofOfValue[]

  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model UserProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  bio         String?
  avatar      String?
  location    String?
  timezone    String?
  preferences String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model Course {
  id              String         @id @default(cuid())
  instructorId    String
  title           String
  description     String
  category        String
  level           CourseLevel    @default(BEGINNER)
  duration        Int            // in minutes
  price           Float          @default(0)
  currency        String         @default("ZAR")
  status          CourseStatus   @default(DRAFT)
  thumbnail       String?
  rating          Float          @default(0)
  enrollmentCount Int            @default(0)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  instructor      User           @relation("CourseInstructor", fields: [instructorId], references: [id], onDelete: Cascade)
  enrollments     Enrollment[]
  modules         CourseModule[]
  reviews         CourseReview[]
  purchases       CoursePurchase[]
  earnings        InstructorEarnings[]
  payments        Payment[]       @relation("CoursePayments")
  cohorts         Cohort[]
  credentials     Credential[]

  @@index([instructorId])
  @@index([status])
  @@index([category])
  @@index([level])
  @@map("courses")
}

model CourseReview {
  id        String   @id @default(cuid())
  courseId  String
  userId    String
  rating    Int      // 1-5
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user   User   @relation("CourseReviews", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
  @@index([courseId])
  @@index([userId])
  @@map("course_reviews")
}

model CoursePurchase {
  id        String   @id @default(cuid())
  courseId  String
  userId    String
  paymentId String?
  price     Float
  currency  String   @default("ZAR")
  purchasedAt DateTime @default(now())

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user   User   @relation("CoursePurchases", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
  @@index([courseId])
  @@index([userId])
  @@index([purchasedAt])
  @@map("course_purchases")
}

model InstructorEarnings {
  id              String   @id @default(cuid())
  courseId        String
  instructorId    String
  totalEarnings   Float    @default(0)
  paidEarnings    Float    @default(0)
  pendingEarnings Float    @default(0)
  lastPaidAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  course     Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  instructor User   @relation("InstructorEarnings", fields: [instructorId], references: [id], onDelete: Cascade)

  @@unique([courseId, instructorId])
  @@index([instructorId])
  @@map("instructor_earnings")
}

model CourseModule {
  id        String   @id @default(cuid())
  courseId  String
  title     String
  content   String
  order     Int
  createdAt DateTime @default(now())

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("course_modules")
}

model Enrollment {
  id          String           @id @default(cuid())
  userId      String
  studentId   String           // Alias for userId for backward compatibility
  courseId    String
  status      EnrollmentStatus @default(ACTIVE)
  progress    Float            @default(0)
  enrolledAt  DateTime         @default(now())
  completedAt DateTime?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([status])
  @@index([enrolledAt])
  @@map("enrollments")
}

model Payment {
  id                    String          @id @default(cuid())
  userId                String
  stripePaymentIntentId String          @unique
  amount                Int             // in cents
  currency              String          @default("usd")
  status                PaymentStatus   @default(PENDING)
  paymentMethodId       String?
  courseId              String?
  course                Course?         @relation("CoursePayments", fields: [courseId], references: [id])
  subscriptionTierId    String?
  metadata              Json            @default("{}")
  idempotencyKey        String          @unique
  receiptId             String?
  receipt               Receipt?
  refunds               Refund[]
  refundedAmount        Int?
  refundReason          String?
  errorCode             String?
  errorMessage          String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// ... (the rest of the schema after the Sapiens block) --- copied from root schema ---

// ============================================
// AI SERVICES (AI Family, Chat)
// ============================================

model ChatSession {
  id           String        @id @default(cuid())
  userId       String
  aiPersona    String        // elara, themba, sankofa, etc.
  title        String?
  context      Json?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@index([userId])
  @@map("chat_sessions")
}

model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String
  role      String   // user, assistant
  content   String
  metadata  Json?
  createdAt DateTime @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
  @@map("chat_messages")
}

model AIPersonality {
  id          String   @id @default(cuid())
  name        String   @unique
  role        String
  personality String
  mood        String   @default("neutral")
  traits      Json
  relationships Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("ai_personalities")
}

// (truncated rest for brevity in the base schema file; this base snapshot is only used for diff generation)
