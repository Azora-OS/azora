// Prisma schema for AI Ethics & Bias Monitoring Service
// Constitutional AI monitoring and ethical oversight for Azora OS

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AIDecision {
  id                    String   @id @default(cuid())
  decisionId            String   @unique
  serviceName           String
  modelName             String?
  modelVersion          String?
  createdAt             DateTime @default(now())

  // Decision Context
  userId                String?
  sessionId             String?
  requestType           String
  inputData             Json     // Sanitized input data
  outputData            Json     // AI model output

  // Decision Metadata
  processingTime        Float?   // milliseconds
  tokenCount            Int?
  cost                  Float?   // API cost in USD

  // Ethical Analysis
  biasAnalysis          BiasAnalysis?
  fairnessMetrics       FairnessMetrics?
  constitutionalChecks  ConstitutionalCheck[]

  // Monitoring Results
  riskLevel             RiskLevel @default(LOW)
  requiresReview        Boolean  @default(false)
  reviewStatus          ReviewStatus @default(PENDING)

  // Audit Trail
  reviewedBy            String?
  reviewedAt            DateTime?
  reviewNotes           String?
  overridden            Boolean  @default(false)
  overrideReason        String?

  @@index([serviceName, createdAt])
  @@index([userId, createdAt])
  @@index([riskLevel, requiresReview])
  @@index([reviewStatus])
  @@map("ai_decisions")
}

model BiasAnalysis {
  id                    String   @id @default(cuid())
  decisionId            String   @unique
  createdAt             DateTime @default(now())

  // Bias Detection Results
  biasDetected          Boolean  @default(false)
  biasTypes             BiasType[]

  // Demographic Analysis
  genderBias            Float?   // -1 to 1, negative = bias against group
  racialBias            Float?
  ageBias               Float?
  socioeconomicBias     Float?

  // Content Analysis
  sentimentBias         Float?
  topicBias             Json?    // Bias scores by topic
  languageBias          Json?    // Bias scores by language features

  // Statistical Measures
  disparateImpact       Float?   // Ratio of outcomes between groups
  statisticalParity     Float?   // Difference in positive outcomes

  // Confidence & Severity
  confidenceScore       Float    // 0.0 to 1.0
  severityScore         Float    // 0.0 to 1.0

  // Recommendations
  mitigationStrategies  String[]
  recommendedActions    String[]

  // Relationships
  decision              AIDecision @relation(fields: [decisionId], references: [decisionId], onDelete: Cascade)

  @@map("bias_analysis")
}

model FairnessMetrics {
  id                    String   @id @default(cuid())
  decisionId            String   @unique
  createdAt             DateTime @default(now())

  // Group Fairness Metrics
  demographicParity     Json?    // P(Y=1|A=a) for different groups A
  equalizedOdds         Json?    // TPR and FPR equality across groups
  equalOpportunity      Json?    // TPR equality across groups

  // Individual Fairness
  consistencyScore      Float?   // How similar users get similar outcomes

  // Counterfactual Fairness
  counterfactualScore   Float?   // Robustness to interventions

  // Causal Fairness
  causalEffect          Json?    // Causal effect analysis

  // Model Interpretability
  featureImportance     Json?    // SHAP values or similar
  partialDependence     Json?    // Partial dependence plots data

  // Performance Metrics
  accuracy              Float?
  precision             Float?
  recall                Float?
  f1Score               Float?

  // Relationships
  decision              AIDecision @relation(fields: [decisionId], references: [decisionId], onDelete: Cascade)

  @@map("fairness_metrics")
}

model ConstitutionalCheck {
  id                    String   @id @default(cuid())
  decisionId            String
  createdAt             DateTime @default(now())

  // Constitutional Principle
  principle             ConstitutionalPrinciple
  principleVersion      String   @default("1.0")

  // Compliance Assessment
  compliant             Boolean  @default(true)
  complianceScore       Float    // 0.0 to 1.0

  // Violation Details
  violationType         ViolationType?
  violationSeverity     ViolationSeverity?
  violationDescription  String?

  // Evidence & Reasoning
  evidence              Json?    // Supporting evidence for assessment
  reasoning             String?

  // Mitigation
  mitigationRequired    Boolean  @default(false)
  mitigationStrategy    String?

  // Relationships
  decision              AIDecision @relation(fields: [decisionId], references: [decisionId], onDelete: Cascade)

  @@index([principle, compliant])
  @@index([decisionId, principle])
  @@map("constitutional_checks")
}

model EthicalAuditLog {
  id                    String   @id @default(cuid())
  auditId               String   @unique
  createdAt             DateTime @default(now())
  auditPeriod           String   // e.g., "2024-Q1", "2024-01"

  // Audit Scope
  servicesAudited       String[] // List of services audited
  modelsAudited         String[] // List of models audited
  dataPeriod            Json     // Start and end dates

  // Audit Results
  totalDecisions        Int      @default(0)
  biasedDecisions       Int      @default(0)
  violationsFound       Int      @default(0)
  highRiskDecisions     Int      @default(0)

  // Compliance Scores
  overallCompliance     Float    // 0.0 to 1.0
  biasCompliance        Float
  fairnessCompliance    Float
  constitutionalCompliance Float

  // Detailed Findings
  findings              Json[]   // Array of audit findings
  recommendations       String[]

  // Review Status
  reviewedBy            String?
  reviewedAt            DateTime?
  reviewStatus          AuditStatus @default(PENDING)

  // Follow-up Actions
  actionItems           Json[]   // Array of required actions
  deadline              DateTime?

  @@index([auditPeriod, reviewStatus])
  @@map("ethical_audit_logs")
}

model TransparencyLog {
  id                    String   @id @default(cuid())
  decisionId            String
  createdAt             DateTime @default(now())

  // Explainability Data
  featureContributions  Json?    // Feature importance scores
  decisionPath          Json?    // Decision tree or rule path
  counterfactuals       Json?    // "What if" scenarios

  // Model Information
  modelArchitecture     String?
  trainingDataInfo      Json?    // Dataset statistics, demographics
  modelLimitations      String[]

  // User-facing Explanations
  simpleExplanation     String?  // User-friendly explanation
  detailedExplanation   String?  // Technical explanation

  // Confidence Metrics
  confidenceInterval    Json?    // Prediction confidence bounds
  uncertaintyScore      Float?

  @@index([decisionId])
  @@map("transparency_logs")
}

model BiasDetectionModel {
  id                    String   @id @default(cuid())
  name                  String   @unique
  version               String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Model Details
  modelType             BiasModelType
  algorithm             String
  parameters            Json

  // Training Data
  trainingSize          Int
  lastTrainedAt         DateTime?
  nextTrainingAt        DateTime?

  // Performance Metrics
  accuracy              Float?
  precision             Float?
  recall                Float?
  f1Score               Float?
  falsePositiveRate     Float?

  // Validation Results
  crossValidationScores Json?
  confusionMatrix       Json?

  // Status
  isActive              Boolean  @default(false)
  performanceHistory    Json[]  // Array of performance snapshots

  @@map("bias_detection_models")
}

model EthicsMetrics {
  id                    String   @id @default(cuid())
  date                  DateTime @default(now())
  metricType            EthicsMetricType

  // Aggregate Metrics
  totalDecisions        Int?
  biasedDecisions       Int?
  violationsCount       Int?
  highRiskDecisions     Int?

  // Compliance Metrics
  complianceRate        Float?
  biasDetectionRate     Float?
  falsePositiveRate     Float?

  // Performance Metrics
  avgProcessingTime     Float?
  avgComplianceScore    Float?
  systemUptime          Float?

  // Custom Metrics
  metadata              Json?

  @@unique([date, metricType])
  @@index([metricType, date])
  @@map("ethics_metrics")
}

model InterventionLog {
  id                    String   @id @default(cuid())
  decisionId            String
  createdAt             DateTime @default(now())

  // Intervention Details
  interventionType      InterventionType
  triggeredBy           String   // Rule or model that triggered intervention
  severity              InterventionSeverity

  // Original vs Modified
  originalDecision      Json
  modifiedDecision      Json?
  modificationReason    String

  // Outcome
  accepted              Boolean?
  userFeedback          String?
  effectivenessScore    Float?

  // Audit Trail
  reviewedBy            String?
  reviewedAt            DateTime?

  @@index([decisionId, interventionType])
  @@index([severity, createdAt])
  @@map("intervention_logs")
}

// Enums
enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ReviewStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  OVERRIDDEN
}

enum BiasType {
  GENDER
  RACE_ETHNICITY
  AGE
  SOCIOECONOMIC
  GEOGRAPHIC
  LANGUAGE
  CULTURAL
  HISTORICAL
  REPRESENTATION
  STEREOTYPING
}

enum ConstitutionalPrinciple {
  SOVEREIGNTY_AFRICAN
  HUMAN_DIGNITY
  EQUALITY_NON_DISCRIMINATION
  FREEDOM_EXPRESSION
  ACCESS_INFORMATION
  PRIVACY_DATA_PROTECTION
  ACCOUNTABILITY_TRANSPARENCY
  ETHICAL_AI_USE
  CULTURAL_PRESERVATION
  ECONOMIC_EMPOWERMENT
}

enum ViolationType {
  DISCRIMINATION
  PRIVACY_BREACH
  MISINFORMATION
  MANIPULATION
  CULTURAL_INSENSITIVITY
  SOVEREIGNTY_VIOLATION
  TRANSPARENCY_LACK
  CONSENT_VIOLATION
}

enum ViolationSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AuditStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REQUIRES_ACTION
}

enum BiasModelType {
  STATISTICAL_PARITY
  EQUALIZED_ODDS
  DEMOGRAPHIC_PARITY
  COUNTERFACTUAL_FAIRNESS
  NATURAL_LANGUAGE_BIAS
  SENTIMENT_BIAS
  TOPIC_BIAS
}

enum EthicsMetricType {
  DAILY_DECISIONS
  BIAS_DETECTION_RATE
  COMPLIANCE_METRICS
  SYSTEM_PERFORMANCE
  USER_FEEDBACK
  INTERVENTION_EFFECTIVENESS
  AUDIT_RESULTS
}

enum InterventionType {
  BIAS_MITIGATION
  COMPLIANCE_ENFORCEMENT
  CONTENT_MODERATION
  DECISION_OVERRIDE
  USER_CONSENT
  TRANSPARENCY_ENHANCEMENT
}

enum InterventionSeverity {
  WARNING
  MODIFICATION
  BLOCKING
  ESCALATION
}