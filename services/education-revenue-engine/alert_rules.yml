groups:
  - name: education_engine_alerts
    interval: 30s
    rules:
      # API Performance Alerts
      - alert: HighErrorRate
        expr: rate(http_errors_total[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} over the last 5 minutes"

      - alert: SlowApiResponse
        expr: histogram_quantile(0.95, http_request_duration_seconds) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow API response time"
          description: "95th percentile response time is {{ $value }}s"

      # Database Alerts
      - alert: DatabaseConnectionSlow
        expr: db_query_duration_seconds > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow database query detected"
          description: "Query duration is {{ $value }}s"

      - alert: HighDatabaseErrorRate
        expr: rate(db_queries_total{status="error"}[5m]) > 0.01
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High database error rate"
          description: "Database error rate is {{ $value | humanizePercentage }}"

      # AI Engine Alerts
      - alert: AiEngineHighLatency
        expr: histogram_quantile(0.95, ai_query_duration_seconds) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High AI engine latency"
          description: "95th percentile AI query latency is {{ $value }}s"

      - alert: AiEngineHighErrorRate
        expr: rate(ai_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High AI engine error rate"
          description: "AI engine error rate is {{ $value | humanizePercentage }}"

      # Cache Alerts
      - alert: LowCacheHitRate
        expr: |
          rate(cache_hits_total[5m]) / (rate(cache_hits_total[5m]) + rate(cache_misses_total[5m])) < 0.5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }}"

      # Memory Alerts
      - alert: HighMemoryUsage
        expr: memory_usage_bytes{type="heap_used"} / memory_usage_bytes{type="heap_total"} > 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High memory usage"
          description: "Heap memory usage is {{ $value | humanizePercentage }}"

      # Business Metrics Alerts
      - alert: LowConversionRate
        expr: |
          (rate(conversions_total[1h]) / rate(enrollments_total[1h])) < 0.3
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Low conversion rate"
          description: "Conversion rate is {{ $value | humanizePercentage }}"

      - alert: HighChurnRate
        expr: |
          (rate(enrollments_total{status="dropped"}[1h]) / rate(enrollments_total[1h])) > 0.2
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "High churn rate"
          description: "Churn rate is {{ $value | humanizePercentage }}"

      # System Alerts
      - alert: ServiceDown
        expr: up{job="education-engine"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Education Engine service is down"
          description: "The education engine service has been down for more than 1 minute"

      - alert: HighRequestRate
        expr: rate(http_requests_total[5m]) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request rate"
          description: "Request rate is {{ $value }} requests/sec"
