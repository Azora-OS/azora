const request = require('supertest');
const express = require('express');

function createTestApp() {
  const app = express();
  app.use(express.json());

  app.post('/api/security/assess-vulnerability', (req, res) => {
    const { system, components } = req.body;

    if (!system) {
      return res.status(400).json({ error: 'System identifier is required' });
    }

    const assessment = {
      assessmentId: `vuln_${Date.now()}`,
      system,
      components: components || [],
      vulnerabilities: [],
      riskScore: 0,
      recommendations: [],
      timestamp: new Date().toISOString()
    };

    res.json(assessment);
  });

  app.get('/api/security/vulnerability-report/:assessmentId', (req, res) => {
    const { assessmentId } = req.params;

    res.json({
      assessmentId,
      status: 'completed',
      summary: {
        critical: 0,
        high: 0,
        medium: 0,
        low: 0
      }
    });
  });

  return app;
}

describe('Azora Aegis - Vulnerability Assessment Tests', () => {
  let app;

  beforeEach(() => {
    app = createTestApp();
  });

  describe('POST /api/security/assess-vulnerability', () => {
    it('should perform vulnerability assessment', async () => {
      const response = await request(app)
        .post('/api/security/assess-vulnerability')
        .send({
          system: 'payment-service',
          components: ['api', 'database', 'cache']
        });

      expect(response.status).toBe(200);
      expect(response.body).toHaveProperty('assessmentId');
      expect(response.body.system).toBe('payment-service');
      expect(response.body.components).toEqual(['api', 'database', 'cache']);
    });

    it('should return error when system is missing', async () => {
      const response = await request(app)
        .post('/api/security/assess-vulnerability')
        .send({ components: ['api'] });

      expect(response.status).toBe(400);
      expect(response.body.error).toBe('System identifier is required');
    });

    it('should include risk score in assessment', async () => {
      const response = await request(app)
        .post('/api/security/assess-vulnerability')
        .send({ system: 'auth-service' });

      expect(response.status).toBe(200);
      expect(response.body).toHaveProperty('riskScore');
      expect(typeof response.body.riskScore).toBe('number');
    });

    it('should provide recommendations', async () => {
      const response = await request(app)
        .post('/api/security/assess-vulnerability')
        .send({ system: 'api-gateway' });

      expect(response.status).toBe(200);
      expect(response.body).toHaveProperty('recommendations');
      expect(Array.isArray(response.body.recommendations)).toBe(true);
    });
  });

  describe('GET /api/security/vulnerability-report/:assessmentId', () => {
    it('should retrieve vulnerability report', async () => {
      const assessmentId = 'vuln_123456';
      const response = await request(app)
        .get(`/api/security/vulnerability-report/${assessmentId}`);

      expect(response.status).toBe(200);
      expect(response.body.assessmentId).toBe(assessmentId);
      expect(response.body).toHaveProperty('status');
      expect(response.body).toHaveProperty('summary');
    });

    it('should include vulnerability severity summary', async () => {
      const response = await request(app)
        .get('/api/security/vulnerability-report/vuln_123');

      expect(response.status).toBe(200);
      expect(response.body.summary).toHaveProperty('critical');
      expect(response.body.summary).toHaveProperty('high');
      expect(response.body.summary).toHaveProperty('medium');
      expect(response.body.summary).toHaveProperty('low');
    });
  });
});
