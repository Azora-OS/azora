// Prisma schema for Personalization Engine Service
// AI-powered personalization and recommendation system for Azora OS

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model UserProfile {
  id                    String   @id @default(cuid())
  userId                String   @unique
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Basic Demographics
  age                   Int?
  location              String?
  timezone              String?
  language              String   @default("en")

  // Learning Profile
  learningStyle         LearningStyle @default(VISUAL)
  experienceLevel       ExperienceLevel @default(BEGINNER)
  preferredPace         PacePreference @default(MODERATE)
  timeCommitment        TimeCommitment @default(MODERATE)

  // Interests & Goals
  interests             String[] // Array of interest areas
  careerGoals           String[]
  learningObjectives    String[]

  // Behavioral Data
  totalTimeSpent        Int      @default(0) // minutes
  sessionsCount         Int      @default(0)
  lastActiveAt          DateTime?

  // AI Model Data
  personalityVector     Float[]  // ML vector representation
  skillVector           Float[]  // Current skill assessment
  preferenceVector      Float[]  // Content preferences

  // Relationships
  interactions          UserInteraction[]
  recommendations        Recommendation[]
  learningPaths         LearningPath[]
  achievements          Achievement[]

  @@map("user_profiles")
}

model UserInteraction {
  id                    String   @id @default(cuid())
  userId                String
  userProfileId         String
  createdAt             DateTime @default(now())

  // Interaction Details
  interactionType       InteractionType
  contentType           ContentType?
  contentId             String?
  moduleId              String?
  topicId               String?

  // Engagement Metrics
  timeSpent             Int      // seconds
  completionRate        Float?   // 0.0 to 1.0
  rating                Int?     // 1-5 stars
  feedback              String?

  // Behavioral Data
  scrollDepth           Float?   // 0.0 to 1.0
  clicksCount           Int      @default(0)
  questionsAsked        Int      @default(0)
  helpRequested         Boolean  @default(false)

  // Context
  deviceType            DeviceType?
  sessionId             String?
  referrer              String?

  // AI Processing
  sentimentScore        Float?
  engagementScore       Float?
  difficultyAssessment  Float?

  // Relationships
  userProfile           UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([interactionType, createdAt])
  @@index([contentType, contentId])
  @@map("user_interactions")
}

model Recommendation {
  id                    String   @id @default(cuid())
  userId                String
  userProfileId         String
  createdAt             DateTime @default(now())

  // Recommendation Details
  recommendationType    RecommendationType
  contentType           ContentType
  contentId             String
  title                 String
  description           String?

  // AI Scoring
  relevanceScore        Float    // 0.0 to 1.0
  confidenceScore       Float    // 0.0 to 1.0
  noveltyScore          Float?   // 0.0 to 1.0

  // Context
  triggerType           TriggerType?
  triggerId             String?

  // User Response
  viewedAt              DateTime?
  interactedAt          DateTime?
  completedAt           DateTime?
  rating                Int?     // 1-5 stars

  // Performance Tracking
  clickThroughRate      Float?
  completionRate        Float?
  satisfactionScore     Float?

  // Relationships
  userProfile           UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([recommendationType, relevanceScore])
  @@index([contentType, contentId])
  @@map("recommendations")
}

model LearningPath {
  id                    String   @id @default(cuid())
  userId                String
  userProfileId         String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Path Details
  title                 String
  description           String?
  topic                 String
  level                 ExperienceLevel @default(BEGINNER)

  // Structure
  modules               Json     // Array of module objects
  totalModules          Int      @default(0)
  estimatedDuration     Int      // minutes
  currentModule         Int      @default(0)

  // Progress
  completedModules      Int      @default(0)
  progressPercentage    Float    @default(0.0)
  timeSpent             Int      @default(0) // minutes
  lastAccessedAt        DateTime?

  // AI Adaptation
  adaptiveFactors       Json?    // Factors influencing path adaptation
  difficultyCurve       Float[]  // Difficulty progression
  recommendedPace       PacePreference

  // Status
  status                PathStatus @default(ACTIVE)
  completedAt           DateTime?
  certificateEarned     Boolean   @default(false)

  // Relationships
  userProfile           UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([topic, level])
  @@map("learning_paths")
}

model Achievement {
  id                    String   @id @default(cuid())
  userId                String
  userProfileId         String
  createdAt             DateTime @default(now())

  // Achievement Details
  achievementType       AchievementType
  title                 String
  description           String
  icon                  String?
  points                Int      @default(0)

  // Criteria
  criteria              Json     // Achievement requirements
  progress              Float    @default(0.0) // 0.0 to 1.0

  // Status
  unlockedAt            DateTime?
  claimedAt             DateTime?

  // Relationships
  userProfile           UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)

  @@index([userId, achievementType])
  @@map("achievements")
}

model ContentSimilarity {
  id                    String   @id @default(cuid())
  contentId             String
  similarContentId      String
  similarityScore       Float    // 0.0 to 1.0
  similarityType        SimilarityType
  createdAt             DateTime @default(now())

  @@unique([contentId, similarContentId, similarityType])
  @@index([contentId, similarityScore])
  @@map("content_similarity")
}

model RecommendationModel {
  id                    String   @id @default(cuid())
  name                  String   @unique
  version               String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Model Details
  modelType             ModelType
  algorithm             String
  parameters            Json

  // Performance Metrics
  accuracy              Float?
  precision             Float?
  recall                Float?
  f1Score               Float?

  // Training Data
  trainingSize          Int
  lastTrainedAt         DateTime?
  nextTrainingAt        DateTime?

  // Status
  isActive              Boolean  @default(false)
  performanceHistory    Json[]  // Array of performance snapshots

  @@map("recommendation_models")
}

model PersonalizationAnalytics {
  id                    String   @id @default(cuid())
  date                  DateTime @default(now())
  metricType            MetricType

  // Aggregate Metrics
  totalUsers            Int?
  totalInteractions     Int?
  totalRecommendations  Int?

  // Performance Metrics
  avgRelevanceScore     Float?
  avgEngagementRate     Float?
  avgCompletionRate     Float?

  // System Metrics
  modelAccuracy         Float?
  processingTime        Float? // milliseconds
  cacheHitRate          Float?

  // Custom Metrics
  metadata              Json?

  @@unique([date, metricType])
  @@index([metricType, date])
  @@map("personalization_analytics")
}

// Enums
enum LearningStyle {
  VISUAL
  AUDITORY
  KINESTHETIC
  READING_WRITING
  MIXED
}

enum ExperienceLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum PacePreference {
  SLOW
  MODERATE
  FAST
  ACCELERATED
}

enum TimeCommitment {
  LOW
  MODERATE
  HIGH
  INTENSIVE
}

enum InteractionType {
  VIEW
  COMPLETE
  RATE
  SHARE
  BOOKMARK
  SEARCH
  HELP_REQUEST
  QUIZ_ATTEMPT
  CERTIFICATE_EARNED
}

enum ContentType {
  LESSON
  QUIZ
  VIDEO
  ARTICLE
  EXERCISE
  PROJECT
  COURSE
  MODULE
  LEARNING_PATH
}

enum DeviceType {
  DESKTOP
  MOBILE
  TABLET
  OTHER
}

enum RecommendationType {
  CONTENT_BASED
  COLLABORATIVE
  TRENDING
  PERSONALIZED
  SIMILAR_USERS
  SEQUENTIAL
  REMEDIAL
}

enum TriggerType {
  USER_SEARCH
  CONTENT_COMPLETION
  QUIZ_RESULT
  TIME_BASED
  GOAL_PROGRESS
  SIMILAR_USER_ACTIVITY
}

enum PathStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

enum AchievementType {
  COMPLETION
  STREAK
  SKILL_MASTER
  TIME_BASED
  SOCIAL
  SPECIAL
}

enum SimilarityType {
  TOPIC
  SKILL
  DIFFICULTY
  STYLE
  COMPREHENSIVE
}

enum ModelType {
  COLLABORATIVE_FILTERING
  CONTENT_BASED
  MATRIX_FACTORIZATION
  NEURAL_NETWORK
  HYBRID
}

enum MetricType {
  DAILY_ACTIVE_USERS
  RECOMMENDATION_CLICKS
  CONTENT_COMPLETION
  LEARNING_PATH_PROGRESS
  USER_ENGAGEMENT
  SYSTEM_PERFORMANCE
  MODEL_ACCURACY
}