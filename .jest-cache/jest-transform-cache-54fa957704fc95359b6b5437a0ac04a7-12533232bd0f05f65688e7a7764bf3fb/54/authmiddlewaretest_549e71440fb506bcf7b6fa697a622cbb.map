{"version":3,"names":["_auth","require","describe","mockRequest","mockResponse","nextFunction","beforeEach","headers","status","jest","fn","mockReturnThis","json","it","userData","userId","email","token","Buffer","from","JSON","stringify","toString","authorization","authenticate","expect","user","toEqual","toHaveBeenCalled","toHaveBeenCalledWith","any","Error","role","middleware","requireRole","optionalAuth","toBeUndefined"],"sources":["auth-middleware.test.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\r\nimport { authenticate, requireRole, optionalAuth } from '../middleware/auth';\r\n\r\ndescribe('Shared Utilities - Authentication Middleware', () => {\r\n  let mockRequest: Partial<Request>;\r\n  let mockResponse: Partial<Response>;\r\n  let nextFunction: NextFunction;\r\n  \r\n  beforeEach(() => {\r\n    mockRequest = {\r\n      headers: {}\r\n    };\r\n    mockResponse = {\r\n      status: jest.fn().mockReturnThis(),\r\n      json: jest.fn().mockReturnThis()\r\n    };\r\n    nextFunction = jest.fn();\r\n  });\r\n  \r\n  describe('authenticate', () => {\r\n    it('should authenticate valid Bearer token', () => {\r\n      const userData = { userId: '123', email: 'test@azora.world' };\r\n      const token = Buffer.from(JSON.stringify(userData)).toString('base64');\r\n      \r\n      mockRequest.headers = {\r\n        authorization: `Bearer ${token}`\r\n      };\r\n      \r\n      authenticate(mockRequest as Request, mockResponse as Response, nextFunction);\r\n      \r\n      expect(mockRequest.user).toEqual(userData);\r\n      expect(nextFunction).toHaveBeenCalled();\r\n    });\r\n    \r\n    it('should reject request without authorization header', () => {\r\n      authenticate(mockRequest as Request, mockResponse as Response, nextFunction);\r\n      \r\n      expect(nextFunction).toHaveBeenCalledWith(expect.any(Error));\r\n    });\r\n    \r\n    it('should reject request with invalid token format', () => {\r\n      mockRequest.headers = {\r\n        authorization: 'InvalidFormat token'\r\n      };\r\n      \r\n      authenticate(mockRequest as Request, mockResponse as Response, nextFunction);\r\n      \r\n      expect(nextFunction).toHaveBeenCalledWith(expect.any(Error));\r\n    });\r\n    \r\n    it('should reject request with malformed token', () => {\r\n      mockRequest.headers = {\r\n        authorization: 'Bearer invalid-token'\r\n      };\r\n      \r\n      authenticate(mockRequest as Request, mockResponse as Response, nextFunction);\r\n      \r\n      expect(nextFunction).toHaveBeenCalledWith(expect.any(Error));\r\n    });\r\n  });\r\n  \r\n  describe('requireRole', () => {\r\n    it('should allow user with required role', () => {\r\n      mockRequest.user = {\r\n        userId: '123',\r\n        role: 'admin',\r\n        email: 'admin@azora.world'\r\n      };\r\n      \r\n      const middleware = requireRole(['admin', 'moderator']);\r\n      middleware(mockRequest as Request, mockResponse as Response, nextFunction);\r\n      \r\n      expect(nextFunction).toHaveBeenCalledWith();\r\n    });\r\n    \r\n    it('should reject user without required role', () => {\r\n      mockRequest.user = {\r\n        userId: '123',\r\n        role: 'user',\r\n        email: 'user@azora.world'\r\n      };\r\n      \r\n      const middleware = requireRole(['admin', 'moderator']);\r\n      middleware(mockRequest as Request, mockResponse as Response, nextFunction);\r\n      \r\n      expect(nextFunction).toHaveBeenCalledWith(expect.any(Error));\r\n    });\r\n    \r\n    it('should reject unauthenticated user', () => {\r\n      const middleware = requireRole(['admin']);\r\n      middleware(mockRequest as Request, mockResponse as Response, nextFunction);\r\n      \r\n      expect(nextFunction).toHaveBeenCalledWith(expect.any(Error));\r\n    });\r\n    \r\n    it('should handle multiple allowed roles', () => {\r\n      mockRequest.user = {\r\n        userId: '123',\r\n        role: 'moderator',\r\n        email: 'mod@azora.world'\r\n      };\r\n      \r\n      const middleware = requireRole(['admin', 'moderator', 'editor']);\r\n      middleware(mockRequest as Request, mockResponse as Response, nextFunction);\r\n      \r\n      expect(nextFunction).toHaveBeenCalledWith();\r\n    });\r\n  });\r\n  \r\n  describe('optionalAuth', () => {\r\n    it('should attach user if valid token provided', () => {\r\n      const userData = { userId: '123', email: 'test@azora.world' };\r\n      const token = Buffer.from(JSON.stringify(userData)).toString('base64');\r\n      \r\n      mockRequest.headers = {\r\n        authorization: `Bearer ${token}`\r\n      };\r\n      \r\n      optionalAuth(mockRequest as Request, mockResponse as Response, nextFunction);\r\n      \r\n      expect(mockRequest.user).toEqual(userData);\r\n      expect(nextFunction).toHaveBeenCalled();\r\n    });\r\n    \r\n    it('should continue without user if no token provided', () => {\r\n      optionalAuth(mockRequest as Request, mockResponse as Response, nextFunction);\r\n      \r\n      expect(mockRequest.user).toBeUndefined();\r\n      expect(nextFunction).toHaveBeenCalled();\r\n    });\r\n    \r\n    it('should continue without user if invalid token provided', () => {\r\n      mockRequest.headers = {\r\n        authorization: 'Bearer invalid-token'\r\n      };\r\n      \r\n      optionalAuth(mockRequest as Request, mockResponse as Response, nextFunction);\r\n      \r\n      expect(mockRequest.user).toBeUndefined();\r\n      expect(nextFunction).toHaveBeenCalled();\r\n    });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}