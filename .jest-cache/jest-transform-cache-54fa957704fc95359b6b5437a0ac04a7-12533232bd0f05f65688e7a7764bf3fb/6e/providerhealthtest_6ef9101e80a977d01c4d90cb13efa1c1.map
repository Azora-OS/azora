{"version":3,"names":["_types","require","describe","it","healthStatus","tier","RoutingTier","LOCAL_LLM","isHealthy","responseTime","lastChecked","Date","expect","toBe","toBeLessThan","RAP_SYSTEM","EXTERNAL_LLM","error","toBeDefined","failureCount","threshold","shouldDisable","highFailureCount","shouldDisableHigh","checkInterval","lastCheck","now","shouldCheck","getTime","providers","healthyCount","filter","p","length","totalCount","healthPercentage","priority","healthyProviders","sort","a","b","disabledAt","cooldownPeriod","canRecover","attempts","backoffMultiplier","delays","map","attempt","Math","min","pow"],"sources":["provider-health.test.ts"],"sourcesContent":["import { RoutingTier } from '../types';\r\n\r\ndescribe('AI Routing - Provider Health Checks', () => {\r\n  describe('Health Check System', () => {\r\n    it('should check local LLM provider health', async () => {\r\n      const healthStatus = {\r\n        tier: RoutingTier.LOCAL_LLM,\r\n        isHealthy: true,\r\n        responseTime: 50,\r\n        lastChecked: new Date(),\r\n      };\r\n\r\n      expect(healthStatus.isHealthy).toBe(true);\r\n      expect(healthStatus.responseTime).toBeLessThan(100);\r\n    });\r\n\r\n    it('should check RAP system provider health', async () => {\r\n      const healthStatus = {\r\n        tier: RoutingTier.RAP_SYSTEM,\r\n        isHealthy: true,\r\n        responseTime: 200,\r\n        lastChecked: new Date(),\r\n      };\r\n\r\n      expect(healthStatus.isHealthy).toBe(true);\r\n      expect(healthStatus.responseTime).toBeLessThan(500);\r\n    });\r\n\r\n    it('should check external LLM provider health', async () => {\r\n      const healthStatus = {\r\n        tier: RoutingTier.EXTERNAL_LLM,\r\n        isHealthy: true,\r\n        responseTime: 1000,\r\n        lastChecked: new Date(),\r\n      };\r\n\r\n      expect(healthStatus.isHealthy).toBe(true);\r\n      expect(healthStatus.responseTime).toBeLessThan(5000);\r\n    });\r\n\r\n    it('should mark provider as unhealthy on timeout', async () => {\r\n      const healthStatus = {\r\n        tier: RoutingTier.LOCAL_LLM,\r\n        isHealthy: false,\r\n        responseTime: 10000,\r\n        lastChecked: new Date(),\r\n        error: 'Timeout',\r\n      };\r\n\r\n      expect(healthStatus.isHealthy).toBe(false);\r\n      expect(healthStatus.error).toBe('Timeout');\r\n    });\r\n\r\n    it('should mark provider as unhealthy on error', async () => {\r\n      const healthStatus = {\r\n        tier: RoutingTier.EXTERNAL_LLM,\r\n        isHealthy: false,\r\n        responseTime: 0,\r\n        lastChecked: new Date(),\r\n        error: 'Connection refused',\r\n      };\r\n\r\n      expect(healthStatus.isHealthy).toBe(false);\r\n      expect(healthStatus.error).toBeDefined();\r\n    });\r\n\r\n    it('should track consecutive health check failures', () => {\r\n      const failureCount = 3;\r\n      const threshold = 5;\r\n\r\n      const shouldDisable = failureCount >= threshold;\r\n      expect(shouldDisable).toBe(false);\r\n\r\n      const highFailureCount = 6;\r\n      const shouldDisableHigh = highFailureCount >= threshold;\r\n      expect(shouldDisableHigh).toBe(true);\r\n    });\r\n\r\n    it('should reset failure count on successful health check', () => {\r\n      let failureCount = 3;\r\n\r\n      failureCount = 0;\r\n\r\n      expect(failureCount).toBe(0);\r\n    });\r\n\r\n    it('should perform periodic health checks', () => {\r\n      const checkInterval = 60000;\r\n      const lastCheck = new Date(Date.now() - 70000);\r\n      const now = new Date();\r\n\r\n      const shouldCheck = now.getTime() - lastCheck.getTime() >= checkInterval;\r\n      expect(shouldCheck).toBe(true);\r\n    });\r\n\r\n    it('should aggregate health status across all providers', () => {\r\n      const providers = [\r\n        { tier: RoutingTier.LOCAL_LLM, isHealthy: true },\r\n        { tier: RoutingTier.RAP_SYSTEM, isHealthy: true },\r\n        { tier: RoutingTier.EXTERNAL_LLM, isHealthy: false },\r\n      ];\r\n\r\n      const healthyCount = providers.filter(p => p.isHealthy).length;\r\n      const totalCount = providers.length;\r\n      const healthPercentage = (healthyCount / totalCount) * 100;\r\n\r\n      expect(healthPercentage).toBe(66.66666666666666);\r\n    });\r\n\r\n    it('should prioritize healthy providers in routing', () => {\r\n      const providers = [\r\n        { tier: RoutingTier.LOCAL_LLM, isHealthy: false, priority: 1 },\r\n        { tier: RoutingTier.RAP_SYSTEM, isHealthy: true, priority: 2 },\r\n        { tier: RoutingTier.EXTERNAL_LLM, isHealthy: true, priority: 3 },\r\n      ];\r\n\r\n      const healthyProviders = providers\r\n        .filter(p => p.isHealthy)\r\n        .sort((a, b) => a.priority - b.priority);\r\n\r\n      expect(healthyProviders.length).toBe(2);\r\n      expect(healthyProviders[0].tier).toBe(RoutingTier.RAP_SYSTEM);\r\n    });\r\n  });\r\n\r\n  describe('Provider Recovery', () => {\r\n    it('should attempt recovery after cooldown period', () => {\r\n      const disabledAt = new Date(Date.now() - 600000);\r\n      const cooldownPeriod = 300000;\r\n      const now = new Date();\r\n\r\n      const canRecover = now.getTime() - disabledAt.getTime() >= cooldownPeriod;\r\n      expect(canRecover).toBe(true);\r\n    });\r\n\r\n    it('should not attempt recovery during cooldown', () => {\r\n      const disabledAt = new Date(Date.now() - 100000);\r\n      const cooldownPeriod = 300000;\r\n      const now = new Date();\r\n\r\n      const canRecover = now.getTime() - disabledAt.getTime() >= cooldownPeriod;\r\n      expect(canRecover).toBe(false);\r\n    });\r\n\r\n    it('should gradually increase recovery attempts', () => {\r\n      const attempts = [1, 2, 3, 4, 5];\r\n      const backoffMultiplier = 2;\r\n\r\n      const delays = attempts.map(attempt => \r\n        Math.min(60000 * Math.pow(backoffMultiplier, attempt - 1), 600000)\r\n      );\r\n\r\n      expect(delays[0]).toBe(60000);\r\n      expect(delays[1]).toBe(120000);\r\n      expect(delays[2]).toBe(240000);\r\n      expect(delays[3]).toBe(480000);\r\n      expect(delays[4]).toBe(600000);\r\n    });\r\n  });\r\n});\r\n"],"mappings":";;AAAA,IAAAA,MAAA,GAAAC,OAAA;AAEAC,QAAQ,CAAC,qCAAqC,EAAE,MAAM;EACpDA,QAAQ,CAAC,qBAAqB,EAAE,MAAM;IACpCC,EAAE,CAAC,wCAAwC,EAAE,YAAY;MACvD,MAAMC,YAAY,GAAG;QACnBC,IAAI,EAAEC,kBAAW,CAACC,SAAS;QAC3BC,SAAS,EAAE,IAAI;QACfC,YAAY,EAAE,EAAE;QAChBC,WAAW,EAAE,IAAIC,IAAI,CAAC;MACxB,CAAC;MAEDC,MAAM,CAACR,YAAY,CAACI,SAAS,CAAC,CAACK,IAAI,CAAC,IAAI,CAAC;MACzCD,MAAM,CAACR,YAAY,CAACK,YAAY,CAAC,CAACK,YAAY,CAAC,GAAG,CAAC;IACrD,CAAC,CAAC;IAEFX,EAAE,CAAC,yCAAyC,EAAE,YAAY;MACxD,MAAMC,YAAY,GAAG;QACnBC,IAAI,EAAEC,kBAAW,CAACS,UAAU;QAC5BP,SAAS,EAAE,IAAI;QACfC,YAAY,EAAE,GAAG;QACjBC,WAAW,EAAE,IAAIC,IAAI,CAAC;MACxB,CAAC;MAEDC,MAAM,CAACR,YAAY,CAACI,SAAS,CAAC,CAACK,IAAI,CAAC,IAAI,CAAC;MACzCD,MAAM,CAACR,YAAY,CAACK,YAAY,CAAC,CAACK,YAAY,CAAC,GAAG,CAAC;IACrD,CAAC,CAAC;IAEFX,EAAE,CAAC,2CAA2C,EAAE,YAAY;MAC1D,MAAMC,YAAY,GAAG;QACnBC,IAAI,EAAEC,kBAAW,CAACU,YAAY;QAC9BR,SAAS,EAAE,IAAI;QACfC,YAAY,EAAE,IAAI;QAClBC,WAAW,EAAE,IAAIC,IAAI,CAAC;MACxB,CAAC;MAEDC,MAAM,CAACR,YAAY,CAACI,SAAS,CAAC,CAACK,IAAI,CAAC,IAAI,CAAC;MACzCD,MAAM,CAACR,YAAY,CAACK,YAAY,CAAC,CAACK,YAAY,CAAC,IAAI,CAAC;IACtD,CAAC,CAAC;IAEFX,EAAE,CAAC,8CAA8C,EAAE,YAAY;MAC7D,MAAMC,YAAY,GAAG;QACnBC,IAAI,EAAEC,kBAAW,CAACC,SAAS;QAC3BC,SAAS,EAAE,KAAK;QAChBC,YAAY,EAAE,KAAK;QACnBC,WAAW,EAAE,IAAIC,IAAI,CAAC,CAAC;QACvBM,KAAK,EAAE;MACT,CAAC;MAEDL,MAAM,CAACR,YAAY,CAACI,SAAS,CAAC,CAACK,IAAI,CAAC,KAAK,CAAC;MAC1CD,MAAM,CAACR,YAAY,CAACa,KAAK,CAAC,CAACJ,IAAI,CAAC,SAAS,CAAC;IAC5C,CAAC,CAAC;IAEFV,EAAE,CAAC,4CAA4C,EAAE,YAAY;MAC3D,MAAMC,YAAY,GAAG;QACnBC,IAAI,EAAEC,kBAAW,CAACU,YAAY;QAC9BR,SAAS,EAAE,KAAK;QAChBC,YAAY,EAAE,CAAC;QACfC,WAAW,EAAE,IAAIC,IAAI,CAAC,CAAC;QACvBM,KAAK,EAAE;MACT,CAAC;MAEDL,MAAM,CAACR,YAAY,CAACI,SAAS,CAAC,CAACK,IAAI,CAAC,KAAK,CAAC;MAC1CD,MAAM,CAACR,YAAY,CAACa,KAAK,CAAC,CAACC,WAAW,CAAC,CAAC;IAC1C,CAAC,CAAC;IAEFf,EAAE,CAAC,gDAAgD,EAAE,MAAM;MACzD,MAAMgB,YAAY,GAAG,CAAC;MACtB,MAAMC,SAAS,GAAG,CAAC;MAEnB,MAAMC,aAAa,GAAGF,YAAY,IAAIC,SAAS;MAC/CR,MAAM,CAACS,aAAa,CAAC,CAACR,IAAI,CAAC,KAAK,CAAC;MAEjC,MAAMS,gBAAgB,GAAG,CAAC;MAC1B,MAAMC,iBAAiB,GAAGD,gBAAgB,IAAIF,SAAS;MACvDR,MAAM,CAACW,iBAAiB,CAAC,CAACV,IAAI,CAAC,IAAI,CAAC;IACtC,CAAC,CAAC;IAEFV,EAAE,CAAC,uDAAuD,EAAE,MAAM;MAChE,IAAIgB,YAAY,GAAG,CAAC;MAEpBA,YAAY,GAAG,CAAC;MAEhBP,MAAM,CAACO,YAAY,CAAC,CAACN,IAAI,CAAC,CAAC,CAAC;IAC9B,CAAC,CAAC;IAEFV,EAAE,CAAC,uCAAuC,EAAE,MAAM;MAChD,MAAMqB,aAAa,GAAG,KAAK;MAC3B,MAAMC,SAAS,GAAG,IAAId,IAAI,CAACA,IAAI,CAACe,GAAG,CAAC,CAAC,GAAG,KAAK,CAAC;MAC9C,MAAMA,GAAG,GAAG,IAAIf,IAAI,CAAC,CAAC;MAEtB,MAAMgB,WAAW,GAAGD,GAAG,CAACE,OAAO,CAAC,CAAC,GAAGH,SAAS,CAACG,OAAO,CAAC,CAAC,IAAIJ,aAAa;MACxEZ,MAAM,CAACe,WAAW,CAAC,CAACd,IAAI,CAAC,IAAI,CAAC;IAChC,CAAC,CAAC;IAEFV,EAAE,CAAC,qDAAqD,EAAE,MAAM;MAC9D,MAAM0B,SAAS,GAAG,CAChB;QAAExB,IAAI,EAAEC,kBAAW,CAACC,SAAS;QAAEC,SAAS,EAAE;MAAK,CAAC,EAChD;QAAEH,IAAI,EAAEC,kBAAW,CAACS,UAAU;QAAEP,SAAS,EAAE;MAAK,CAAC,EACjD;QAAEH,IAAI,EAAEC,kBAAW,CAACU,YAAY;QAAER,SAAS,EAAE;MAAM,CAAC,CACrD;MAED,MAAMsB,YAAY,GAAGD,SAAS,CAACE,MAAM,CAACC,CAAC,IAAIA,CAAC,CAACxB,SAAS,CAAC,CAACyB,MAAM;MAC9D,MAAMC,UAAU,GAAGL,SAAS,CAACI,MAAM;MACnC,MAAME,gBAAgB,GAAIL,YAAY,GAAGI,UAAU,GAAI,GAAG;MAE1DtB,MAAM,CAACuB,gBAAgB,CAAC,CAACtB,IAAI,CAAC,iBAAiB,CAAC;IAClD,CAAC,CAAC;IAEFV,EAAE,CAAC,gDAAgD,EAAE,MAAM;MACzD,MAAM0B,SAAS,GAAG,CAChB;QAAExB,IAAI,EAAEC,kBAAW,CAACC,SAAS;QAAEC,SAAS,EAAE,KAAK;QAAE4B,QAAQ,EAAE;MAAE,CAAC,EAC9D;QAAE/B,IAAI,EAAEC,kBAAW,CAACS,UAAU;QAAEP,SAAS,EAAE,IAAI;QAAE4B,QAAQ,EAAE;MAAE,CAAC,EAC9D;QAAE/B,IAAI,EAAEC,kBAAW,CAACU,YAAY;QAAER,SAAS,EAAE,IAAI;QAAE4B,QAAQ,EAAE;MAAE,CAAC,CACjE;MAED,MAAMC,gBAAgB,GAAGR,SAAS,CAC/BE,MAAM,CAACC,CAAC,IAAIA,CAAC,CAACxB,SAAS,CAAC,CACxB8B,IAAI,CAAC,CAACC,CAAC,EAAEC,CAAC,KAAKD,CAAC,CAACH,QAAQ,GAAGI,CAAC,CAACJ,QAAQ,CAAC;MAE1CxB,MAAM,CAACyB,gBAAgB,CAACJ,MAAM,CAAC,CAACpB,IAAI,CAAC,CAAC,CAAC;MACvCD,MAAM,CAACyB,gBAAgB,CAAC,CAAC,CAAC,CAAChC,IAAI,CAAC,CAACQ,IAAI,CAACP,kBAAW,CAACS,UAAU,CAAC;IAC/D,CAAC,CAAC;EACJ,CAAC,CAAC;EAEFb,QAAQ,CAAC,mBAAmB,EAAE,MAAM;IAClCC,EAAE,CAAC,+CAA+C,EAAE,MAAM;MACxD,MAAMsC,UAAU,GAAG,IAAI9B,IAAI,CAACA,IAAI,CAACe,GAAG,CAAC,CAAC,GAAG,MAAM,CAAC;MAChD,MAAMgB,cAAc,GAAG,MAAM;MAC7B,MAAMhB,GAAG,GAAG,IAAIf,IAAI,CAAC,CAAC;MAEtB,MAAMgC,UAAU,GAAGjB,GAAG,CAACE,OAAO,CAAC,CAAC,GAAGa,UAAU,CAACb,OAAO,CAAC,CAAC,IAAIc,cAAc;MACzE9B,MAAM,CAAC+B,UAAU,CAAC,CAAC9B,IAAI,CAAC,IAAI,CAAC;IAC/B,CAAC,CAAC;IAEFV,EAAE,CAAC,6CAA6C,EAAE,MAAM;MACtD,MAAMsC,UAAU,GAAG,IAAI9B,IAAI,CAACA,IAAI,CAACe,GAAG,CAAC,CAAC,GAAG,MAAM,CAAC;MAChD,MAAMgB,cAAc,GAAG,MAAM;MAC7B,MAAMhB,GAAG,GAAG,IAAIf,IAAI,CAAC,CAAC;MAEtB,MAAMgC,UAAU,GAAGjB,GAAG,CAACE,OAAO,CAAC,CAAC,GAAGa,UAAU,CAACb,OAAO,CAAC,CAAC,IAAIc,cAAc;MACzE9B,MAAM,CAAC+B,UAAU,CAAC,CAAC9B,IAAI,CAAC,KAAK,CAAC;IAChC,CAAC,CAAC;IAEFV,EAAE,CAAC,6CAA6C,EAAE,MAAM;MACtD,MAAMyC,QAAQ,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;MAChC,MAAMC,iBAAiB,GAAG,CAAC;MAE3B,MAAMC,MAAM,GAAGF,QAAQ,CAACG,GAAG,CAACC,OAAO,IACjCC,IAAI,CAACC,GAAG,CAAC,KAAK,GAAGD,IAAI,CAACE,GAAG,CAACN,iBAAiB,EAAEG,OAAO,GAAG,CAAC,CAAC,EAAE,MAAM,CACnE,CAAC;MAEDpC,MAAM,CAACkC,MAAM,CAAC,CAAC,CAAC,CAAC,CAACjC,IAAI,CAAC,KAAK,CAAC;MAC7BD,MAAM,CAACkC,MAAM,CAAC,CAAC,CAAC,CAAC,CAACjC,IAAI,CAAC,MAAM,CAAC;MAC9BD,MAAM,CAACkC,MAAM,CAAC,CAAC,CAAC,CAAC,CAACjC,IAAI,CAAC,MAAM,CAAC;MAC9BD,MAAM,CAACkC,MAAM,CAAC,CAAC,CAAC,CAAC,CAACjC,IAAI,CAAC,MAAM,CAAC;MAC9BD,MAAM,CAACkC,MAAM,CAAC,CAAC,CAAC,CAAC,CAACjC,IAAI,CAAC,MAAM,CAAC;IAChC,CAAC,CAAC;EACJ,CAAC,CAAC;AACJ,CAAC,CAAC","ignoreList":[]}