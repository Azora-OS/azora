{"version":3,"names":["_vitest","require","_hierarchicalRouter","_costOptimizer","_responseCache","_queryClassifier","_localLlmService","_rapSystem","_redisCacheManager","_routingMetricsTracker","_types","vi","mock","describe","router","mockPrisma","mockClassifier","mockLocalLLM","mockRAP","mockCache","mockMetrics","mockCostOptimizer","mockResponseCache","defaultConfig","localLLMEnabled","localLLMModel","localLLMQuantization","rapEnabled","knowledgeOceanUrl","internalSourceWeight","externalSourceWeight","externalLLMEnabled","externalLLMProvider","externalLLMModel","cacheEnabled","cacheTTL","cacheMaxSize","costTrackingEnabled","costThreshold","latencyThreshold","fallbackOnLatency","redisUrl","redisKeyPrefix","beforeEach","clearAllMocks","QueryClassifier","LocalLLMService","RAPSystem","RedisCacheManager","RoutingMetricsTracker","CostOptimizer","ResponseCache","HierarchicalRouter","undefined","it","query","userId","mocked","classify","mockResolvedValue","id","classifiedAs","QueryComplexity","SIMPLE","confidence","routedTo","RoutingTier","LOCAL_LLM","calculateCost","shouldRejectQuery","getCheapestTier","mockResponse","content","routingTier","responseTime","cost","cached","processQuery","get","recordRouting","set","route","expect","toHaveBeenCalled","trackSpending","toHaveBeenCalledWith","context","budget","COMPLEX","EXTERNAL_LLM","mockResolvedValueOnce","RAP_SYSTEM","result","toBe","mockCostMetrics","getSpendingMetrics","getCostMetrics","mockUserSpending","totalSpent","spentByTier","queriesByTier","lastUpdated","Date","getUserSpending","mockCostComparison","compareCosts","queryHash","cachedEntry","response","ttl","expiresAt","now","hitCount","callArgs","calls","mockStats","hits","misses","size","hitRate","averageResponseTime","getStats","getResponseCacheStats","getCacheHitRate","getResponseCacheHitRate","clear","clearResponseCache","mockRejectedValueOnce","Error","recordFallback","mockReturnValue","chain","getFallbackChainForTier","toContain","mockUsageMetrics","tier","usageCount","usagePercentage","fallbackCount","fallbackRate","getTierUsageMetrics","getFallbackRate","getOverallFallbackRate","mockDistribution","getTierUsageDistribution"],"sources":["enhanced-routing-orchestrator.test.ts"],"sourcesContent":["/**\r\n * Enhanced Routing Orchestrator Tests\r\n * Tests for cost optimization, response caching, and fallback logic integration\r\n */\r\n\r\nimport { describe, it, expect, beforeEach, vi } from 'vitest';\r\nimport { HierarchicalRouter } from '../hierarchical-router';\r\nimport { CostOptimizer } from '../cost-optimizer';\r\nimport { ResponseCache } from '../response-cache';\r\nimport { QueryClassifier } from '../query-classifier';\r\nimport { LocalLLMService } from '../local-llm-service';\r\nimport { RAPSystem } from '../rap-system';\r\nimport { RedisCacheManager } from '../redis-cache-manager';\r\nimport { RoutingMetricsTracker } from '../routing-metrics-tracker';\r\nimport {\r\n  AIQuery,\r\n  AIResponse,\r\n  QueryComplexity,\r\n  RoutingTier,\r\n  AIRoutingConfig,\r\n  CacheEntry\r\n} from '../types';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\n// Mock dependencies\r\nvi.mock('../query-classifier');\r\nvi.mock('../local-llm-service');\r\nvi.mock('../rap-system');\r\nvi.mock('../redis-cache-manager');\r\nvi.mock('../routing-metrics-tracker');\r\nvi.mock('../cost-optimizer');\r\nvi.mock('../response-cache');\r\n\r\ndescribe('Enhanced Routing Orchestrator', () => {\r\n  let router: HierarchicalRouter;\r\n  let mockPrisma: PrismaClient;\r\n  let mockClassifier: QueryClassifier;\r\n  let mockLocalLLM: LocalLLMService;\r\n  let mockRAP: RAPSystem;\r\n  let mockCache: RedisCacheManager;\r\n  let mockMetrics: RoutingMetricsTracker;\r\n  let mockCostOptimizer: CostOptimizer;\r\n  let mockResponseCache: ResponseCache;\r\n\r\n  const defaultConfig: AIRoutingConfig = {\r\n    localLLMEnabled: true,\r\n    localLLMModel: 'llama',\r\n    localLLMQuantization: 'q4',\r\n    rapEnabled: true,\r\n    knowledgeOceanUrl: 'http://localhost:8000',\r\n    internalSourceWeight: 0.7,\r\n    externalSourceWeight: 0.3,\r\n    externalLLMEnabled: true,\r\n    externalLLMProvider: 'openai',\r\n    externalLLMModel: 'gpt-4',\r\n    cacheEnabled: true,\r\n    cacheTTL: 3600,\r\n    cacheMaxSize: 1000,\r\n    costTrackingEnabled: true,\r\n    costThreshold: 0.10,\r\n    latencyThreshold: 3000,\r\n    fallbackOnLatency: true,\r\n    redisUrl: 'redis://localhost:6379',\r\n    redisKeyPrefix: 'ai-routing:'\r\n  };\r\n\r\n  beforeEach(() => {\r\n    vi.clearAllMocks();\r\n\r\n    mockPrisma = {} as PrismaClient;\r\n    mockClassifier = new QueryClassifier() as any;\r\n    mockLocalLLM = new LocalLLMService() as any;\r\n    mockRAP = new RAPSystem({} as any) as any;\r\n    mockCache = new RedisCacheManager() as any;\r\n    mockMetrics = new RoutingMetricsTracker(mockPrisma) as any;\r\n    mockCostOptimizer = new CostOptimizer(mockPrisma) as any;\r\n    mockResponseCache = new ResponseCache() as any;\r\n\r\n    router = new HierarchicalRouter(\r\n      defaultConfig,\r\n      mockPrisma,\r\n      mockClassifier,\r\n      mockLocalLLM,\r\n      mockRAP,\r\n      undefined,\r\n      mockCache,\r\n      mockMetrics,\r\n      mockCostOptimizer,\r\n      mockResponseCache\r\n    );\r\n  });\r\n\r\n  describe('Cost Optimizer Integration', () => {\r\n    it('should calculate cost for routing decision', async () => {\r\n      const query: AIQuery = { query: 'What is AI?', userId: 'user-1' };\r\n\r\n      vi.mocked(mockClassifier.classify).mockResolvedValue({\r\n        id: 'class-1',\r\n        query: query.query,\r\n        classifiedAs: QueryComplexity.SIMPLE,\r\n        confidence: 0.9,\r\n        routedTo: RoutingTier.LOCAL_LLM\r\n      });\r\n\r\n      vi.mocked(mockCostOptimizer.calculateCost).mockResolvedValue(0);\r\n      vi.mocked(mockCostOptimizer.shouldRejectQuery).mockResolvedValue(false);\r\n      vi.mocked(mockCostOptimizer.getCheapestTier).mockResolvedValue(RoutingTier.LOCAL_LLM);\r\n\r\n      const mockResponse: AIResponse = {\r\n        id: 'resp-1',\r\n        content: 'AI is artificial intelligence',\r\n        routingTier: RoutingTier.LOCAL_LLM,\r\n        responseTime: 150,\r\n        cost: 0,\r\n        cached: false\r\n      };\r\n      vi.mocked(mockLocalLLM.processQuery).mockResolvedValue(mockResponse);\r\n      vi.mocked(mockCache.get).mockResolvedValue(null);\r\n      vi.mocked(mockMetrics.recordRouting).mockResolvedValue(undefined);\r\n      vi.mocked(mockResponseCache.set).mockResolvedValue(undefined);\r\n\r\n      await router.route(query);\r\n\r\n      expect(vi.mocked(mockCostOptimizer.calculateCost)).toHaveBeenCalled();\r\n    });\r\n\r\n    it('should track spending for user', async () => {\r\n      const query: AIQuery = { query: 'What is AI?', userId: 'user-1' };\r\n\r\n      vi.mocked(mockClassifier.classify).mockResolvedValue({\r\n        id: 'class-1',\r\n        query: query.query,\r\n        classifiedAs: QueryComplexity.SIMPLE,\r\n        confidence: 0.9,\r\n        routedTo: RoutingTier.LOCAL_LLM\r\n      });\r\n\r\n      vi.mocked(mockCostOptimizer.calculateCost).mockResolvedValue(0);\r\n      vi.mocked(mockCostOptimizer.shouldRejectQuery).mockResolvedValue(false);\r\n      vi.mocked(mockCostOptimizer.getCheapestTier).mockResolvedValue(RoutingTier.LOCAL_LLM);\r\n      vi.mocked(mockCostOptimizer.trackSpending).mockResolvedValue(undefined);\r\n\r\n      const mockResponse: AIResponse = {\r\n        id: 'resp-1',\r\n        content: 'AI is artificial intelligence',\r\n        routingTier: RoutingTier.LOCAL_LLM,\r\n        responseTime: 150,\r\n        cost: 0,\r\n        cached: false\r\n      };\r\n      vi.mocked(mockLocalLLM.processQuery).mockResolvedValue(mockResponse);\r\n      vi.mocked(mockCache.get).mockResolvedValue(null);\r\n      vi.mocked(mockMetrics.recordRouting).mockResolvedValue(undefined);\r\n      vi.mocked(mockResponseCache.set).mockResolvedValue(undefined);\r\n\r\n      await router.route(query);\r\n\r\n      expect(vi.mocked(mockCostOptimizer.trackSpending)).toHaveBeenCalledWith(\r\n        'user-1',\r\n        RoutingTier.LOCAL_LLM,\r\n        0\r\n      );\r\n    });\r\n\r\n    it('should downgrade tier when cost exceeds budget', async () => {\r\n      const query: AIQuery = {\r\n        query: 'Complex query',\r\n        userId: 'user-1',\r\n        context: { budget: 0.02 }\r\n      };\r\n\r\n      vi.mocked(mockClassifier.classify).mockResolvedValue({\r\n        id: 'class-1',\r\n        query: query.query,\r\n        classifiedAs: QueryComplexity.COMPLEX,\r\n        confidence: 0.9,\r\n        routedTo: RoutingTier.EXTERNAL_LLM\r\n      });\r\n\r\n      // External LLM cost exceeds budget\r\n      vi.mocked(mockCostOptimizer.calculateCost)\r\n        .mockResolvedValueOnce(0.08) // External LLM cost\r\n        .mockResolvedValueOnce(0.01); // RAP cost\r\n\r\n      vi.mocked(mockCostOptimizer.shouldRejectQuery)\r\n        .mockResolvedValueOnce(true) // Reject External LLM\r\n        .mockResolvedValueOnce(false); // Accept RAP\r\n\r\n      vi.mocked(mockCostOptimizer.getCheapestTier).mockResolvedValue(RoutingTier.RAP_SYSTEM);\r\n\r\n      const mockResponse: AIResponse = {\r\n        id: 'resp-1',\r\n        content: 'Response',\r\n        routingTier: RoutingTier.RAP_SYSTEM,\r\n        responseTime: 800,\r\n        cost: 0.01,\r\n        cached: false\r\n      };\r\n      vi.mocked(mockRAP.processQuery).mockResolvedValue(mockResponse);\r\n      vi.mocked(mockCache.get).mockResolvedValue(null);\r\n      vi.mocked(mockMetrics.recordRouting).mockResolvedValue(undefined);\r\n      vi.mocked(mockResponseCache.set).mockResolvedValue(undefined);\r\n\r\n      const result = await router.route(query);\r\n\r\n      expect(result.routingTier).toBe(RoutingTier.RAP_SYSTEM);\r\n      expect(result.cost).toBe(0.01);\r\n    });\r\n\r\n    it('should get cost metrics', async () => {\r\n      const mockCostMetrics = {\r\n        [RoutingTier.LOCAL_LLM]: 0,\r\n        [RoutingTier.RAP_SYSTEM]: 5.5,\r\n        [RoutingTier.EXTERNAL_LLM]: 12.3\r\n      };\r\n\r\n      vi.mocked(mockCostOptimizer.getSpendingMetrics).mockResolvedValue(mockCostMetrics);\r\n\r\n      const result = await router.getCostMetrics();\r\n\r\n      expect(result[RoutingTier.LOCAL_LLM]).toBe(0);\r\n      expect(result[RoutingTier.RAP_SYSTEM]).toBe(5.5);\r\n      expect(result[RoutingTier.EXTERNAL_LLM]).toBe(12.3);\r\n    });\r\n\r\n    it('should get user spending', async () => {\r\n      const mockUserSpending = {\r\n        userId: 'user-1',\r\n        totalSpent: 10.5,\r\n        spentByTier: {\r\n          [RoutingTier.LOCAL_LLM]: 0,\r\n          [RoutingTier.RAP_SYSTEM]: 5.5,\r\n          [RoutingTier.EXTERNAL_LLM]: 5.0\r\n        },\r\n        queriesByTier: {\r\n          [RoutingTier.LOCAL_LLM]: 50,\r\n          [RoutingTier.RAP_SYSTEM]: 100,\r\n          [RoutingTier.EXTERNAL_LLM]: 20\r\n        },\r\n        lastUpdated: new Date()\r\n      };\r\n\r\n      vi.mocked(mockCostOptimizer.getUserSpending).mockResolvedValue(mockUserSpending);\r\n\r\n      const result = await router.getUserSpending('user-1');\r\n\r\n      expect(result?.totalSpent).toBe(10.5);\r\n      expect(result?.spentByTier[RoutingTier.RAP_SYSTEM]).toBe(5.5);\r\n    });\r\n\r\n    it('should compare costs across tiers', async () => {\r\n      const mockCostComparison = {\r\n        [RoutingTier.LOCAL_LLM]: 0,\r\n        [RoutingTier.RAP_SYSTEM]: 0.03,\r\n        [RoutingTier.EXTERNAL_LLM]: 0.08\r\n      };\r\n\r\n      vi.mocked(mockCostOptimizer.compareCosts).mockResolvedValue(mockCostComparison);\r\n\r\n      const result = await router.compareCosts(100, 200);\r\n\r\n      expect(result[RoutingTier.LOCAL_LLM]).toBe(0);\r\n      expect(result[RoutingTier.RAP_SYSTEM]).toBe(0.03);\r\n      expect(result[RoutingTier.EXTERNAL_LLM]).toBe(0.08);\r\n    });\r\n\r\n    it('should get cheapest tier', async () => {\r\n      vi.mocked(mockCostOptimizer.getCheapestTier).mockResolvedValue(RoutingTier.LOCAL_LLM);\r\n\r\n      const result = await router.getCheapestTier();\r\n\r\n      expect(result).toBe(RoutingTier.LOCAL_LLM);\r\n    });\r\n  });\r\n\r\n  describe('Response Cache Integration', () => {\r\n    it('should return cached response on cache hit', async () => {\r\n      const query: AIQuery = { query: 'What is AI?' };\r\n      const queryHash = 'hash-123';\r\n\r\n      const cachedEntry: CacheEntry = {\r\n        id: 'cache-1',\r\n        queryHash,\r\n        query: query.query,\r\n        response: 'AI is artificial intelligence',\r\n        routingTier: RoutingTier.LOCAL_LLM,\r\n        cost: 0,\r\n        ttl: 3600,\r\n        expiresAt: new Date(Date.now() + 3600000),\r\n        hitCount: 5\r\n      };\r\n\r\n      vi.mocked(mockResponseCache.get).mockResolvedValue(cachedEntry);\r\n\r\n      const result = await router.route(query);\r\n\r\n      expect(result.cached).toBe(true);\r\n      expect(result.content).toBe('AI is artificial intelligence');\r\n      expect(result.cost).toBe(0);\r\n    });\r\n\r\n    it('should cache response after successful routing', async () => {\r\n      const query: AIQuery = { query: 'What is AI?' };\r\n\r\n      vi.mocked(mockClassifier.classify).mockResolvedValue({\r\n        id: 'class-1',\r\n        query: query.query,\r\n        classifiedAs: QueryComplexity.SIMPLE,\r\n        confidence: 0.9,\r\n        routedTo: RoutingTier.LOCAL_LLM\r\n      });\r\n\r\n      vi.mocked(mockCostOptimizer.calculateCost).mockResolvedValue(0);\r\n      vi.mocked(mockCostOptimizer.shouldRejectQuery).mockResolvedValue(false);\r\n      vi.mocked(mockCostOptimizer.getCheapestTier).mockResolvedValue(RoutingTier.LOCAL_LLM);\r\n\r\n      const mockResponse: AIResponse = {\r\n        id: 'resp-1',\r\n        content: 'AI is artificial intelligence',\r\n        routingTier: RoutingTier.LOCAL_LLM,\r\n        responseTime: 150,\r\n        cost: 0,\r\n        cached: false\r\n      };\r\n      vi.mocked(mockLocalLLM.processQuery).mockResolvedValue(mockResponse);\r\n      vi.mocked(mockResponseCache.get).mockResolvedValue(null);\r\n      vi.mocked(mockMetrics.recordRouting).mockResolvedValue(undefined);\r\n      vi.mocked(mockResponseCache.set).mockResolvedValue(undefined);\r\n\r\n      await router.route(query);\r\n\r\n      expect(vi.mocked(mockResponseCache.set)).toHaveBeenCalled();\r\n      const callArgs = vi.mocked(mockResponseCache.set).mock.calls[0][0];\r\n      expect(callArgs.response).toBe('AI is artificial intelligence');\r\n      expect(callArgs.routingTier).toBe(RoutingTier.LOCAL_LLM);\r\n    });\r\n\r\n    it('should get response cache statistics', async () => {\r\n      const mockStats = {\r\n        hits: 100,\r\n        misses: 50,\r\n        size: 150,\r\n        hitRate: 66.67,\r\n        averageResponseTime: 250\r\n      };\r\n\r\n      vi.mocked(mockResponseCache.getStats).mockResolvedValue(mockStats);\r\n\r\n      const result = await router.getResponseCacheStats();\r\n\r\n      expect(result.hits).toBe(100);\r\n      expect(result.misses).toBe(50);\r\n      expect(result.hitRate).toBe(66.67);\r\n    });\r\n\r\n    it('should get response cache hit rate', async () => {\r\n      vi.mocked(mockResponseCache.getCacheHitRate).mockResolvedValue(66.67);\r\n\r\n      const result = await router.getResponseCacheHitRate();\r\n\r\n      expect(result).toBe(66.67);\r\n    });\r\n\r\n    it('should clear response cache', async () => {\r\n      vi.mocked(mockResponseCache.clear).mockResolvedValue(150);\r\n\r\n      const result = await router.clearResponseCache();\r\n\r\n      expect(result).toBe(150);\r\n    });\r\n  });\r\n\r\n  describe('Fallback Logic', () => {\r\n    it('should record fallback event when tier fails', async () => {\r\n      const query: AIQuery = { query: 'What is Python?' };\r\n\r\n      vi.mocked(mockClassifier.classify).mockResolvedValue({\r\n        id: 'class-1',\r\n        query: query.query,\r\n        classifiedAs: QueryComplexity.SIMPLE,\r\n        confidence: 0.9,\r\n        routedTo: RoutingTier.LOCAL_LLM\r\n      });\r\n\r\n      vi.mocked(mockCostOptimizer.calculateCost).mockResolvedValue(0);\r\n      vi.mocked(mockCostOptimizer.shouldRejectQuery).mockResolvedValue(false);\r\n      vi.mocked(mockCostOptimizer.getCheapestTier).mockResolvedValue(RoutingTier.LOCAL_LLM);\r\n\r\n      // Local LLM fails\r\n      vi.mocked(mockLocalLLM.processQuery).mockRejectedValueOnce(\r\n        new Error('Local LLM unavailable')\r\n      );\r\n\r\n      // RAP succeeds\r\n      const mockResponse: AIResponse = {\r\n        id: 'resp-2',\r\n        content: 'Python is a programming language',\r\n        routingTier: RoutingTier.RAP_SYSTEM,\r\n        responseTime: 800,\r\n        cost: 0.03,\r\n        cached: false\r\n      };\r\n      vi.mocked(mockRAP.processQuery).mockResolvedValue(mockResponse);\r\n      vi.mocked(mockResponseCache.get).mockResolvedValue(null);\r\n      vi.mocked(mockMetrics.recordRouting).mockResolvedValue(undefined);\r\n      vi.mocked(mockMetrics.recordFallback).mockReturnValue(undefined);\r\n      vi.mocked(mockResponseCache.set).mockResolvedValue(undefined);\r\n\r\n      const result = await router.route(query);\r\n\r\n      expect(result.routingTier).toBe(RoutingTier.RAP_SYSTEM);\r\n      expect(vi.mocked(mockMetrics.recordFallback)).toHaveBeenCalledWith(\r\n        RoutingTier.LOCAL_LLM,\r\n        RoutingTier.RAP_SYSTEM\r\n      );\r\n    });\r\n\r\n    it('should get fallback chain for tier', () => {\r\n      const chain = router.getFallbackChainForTier(RoutingTier.LOCAL_LLM);\r\n\r\n      expect(chain).toContain(RoutingTier.LOCAL_LLM);\r\n      expect(chain).toContain(RoutingTier.RAP_SYSTEM);\r\n      expect(chain).toContain(RoutingTier.EXTERNAL_LLM);\r\n    });\r\n\r\n    it('should get tier usage metrics', () => {\r\n      const mockUsageMetrics = {\r\n        [RoutingTier.LOCAL_LLM]: {\r\n          tier: RoutingTier.LOCAL_LLM,\r\n          usageCount: 100,\r\n          usagePercentage: 50,\r\n          fallbackCount: 5,\r\n          fallbackRate: 5\r\n        },\r\n        [RoutingTier.RAP_SYSTEM]: {\r\n          tier: RoutingTier.RAP_SYSTEM,\r\n          usageCount: 80,\r\n          usagePercentage: 40,\r\n          fallbackCount: 2,\r\n          fallbackRate: 2.5\r\n        },\r\n        [RoutingTier.EXTERNAL_LLM]: {\r\n          tier: RoutingTier.EXTERNAL_LLM,\r\n          usageCount: 20,\r\n          usagePercentage: 10,\r\n          fallbackCount: 0,\r\n          fallbackRate: 0\r\n        }\r\n      };\r\n\r\n      vi.mocked(mockMetrics.getTierUsageMetrics).mockReturnValue(mockUsageMetrics);\r\n\r\n      const result = router.getTierUsageMetrics();\r\n\r\n      expect(result[RoutingTier.LOCAL_LLM].usagePercentage).toBe(50);\r\n      expect(result[RoutingTier.RAP_SYSTEM].fallbackRate).toBe(2.5);\r\n    });\r\n\r\n    it('should get fallback rate for tier', () => {\r\n      vi.mocked(mockMetrics.getFallbackRate).mockReturnValue(5);\r\n\r\n      const result = router.getFallbackRate(RoutingTier.LOCAL_LLM);\r\n\r\n      expect(result).toBe(5);\r\n    });\r\n\r\n    it('should get overall fallback rate', () => {\r\n      vi.mocked(mockMetrics.getOverallFallbackRate).mockReturnValue(3.2);\r\n\r\n      const result = router.getOverallFallbackRate();\r\n\r\n      expect(result).toBe(3.2);\r\n    });\r\n\r\n    it('should get tier usage distribution', () => {\r\n      const mockDistribution = {\r\n        [RoutingTier.LOCAL_LLM]: 50,\r\n        [RoutingTier.RAP_SYSTEM]: 40,\r\n        [RoutingTier.EXTERNAL_LLM]: 10\r\n      };\r\n\r\n      vi.mocked(mockMetrics.getTierUsageDistribution).mockReturnValue(mockDistribution);\r\n\r\n      const result = router.getTierUsageDistribution();\r\n\r\n      expect(result[RoutingTier.LOCAL_LLM]).toBe(50);\r\n      expect(result[RoutingTier.RAP_SYSTEM]).toBe(40);\r\n      expect(result[RoutingTier.EXTERNAL_LLM]).toBe(10);\r\n    });\r\n  });\r\n\r\n  describe('Integration Tests', () => {\r\n    it('should handle complete routing flow with cost optimization and caching', async () => {\r\n      const query: AIQuery = { query: 'What is AI?', userId: 'user-1' };\r\n\r\n      // Step 1: Cache miss\r\n      vi.mocked(mockResponseCache.get).mockResolvedValue(null);\r\n\r\n      // Step 2: Classify query\r\n      vi.mocked(mockClassifier.classify).mockResolvedValue({\r\n        id: 'class-1',\r\n        query: query.query,\r\n        classifiedAs: QueryComplexity.SIMPLE,\r\n        confidence: 0.9,\r\n        routedTo: RoutingTier.LOCAL_LLM\r\n      });\r\n\r\n      // Step 3: Cost optimization\r\n      vi.mocked(mockCostOptimizer.calculateCost).mockResolvedValue(0);\r\n      vi.mocked(mockCostOptimizer.shouldRejectQuery).mockResolvedValue(false);\r\n      vi.mocked(mockCostOptimizer.getCheapestTier).mockResolvedValue(RoutingTier.LOCAL_LLM);\r\n\r\n      // Step 4: Route to Local LLM\r\n      const mockResponse: AIResponse = {\r\n        id: 'resp-1',\r\n        content: 'AI is artificial intelligence',\r\n        routingTier: RoutingTier.LOCAL_LLM,\r\n        responseTime: 150,\r\n        cost: 0,\r\n        cached: false\r\n      };\r\n      vi.mocked(mockLocalLLM.processQuery).mockResolvedValue(mockResponse);\r\n\r\n      // Step 5: Track spending\r\n      vi.mocked(mockCostOptimizer.trackSpending).mockResolvedValue(undefined);\r\n\r\n      // Step 6: Cache response\r\n      vi.mocked(mockResponseCache.set).mockResolvedValue(undefined);\r\n\r\n      // Step 7: Record metrics\r\n      vi.mocked(mockMetrics.recordRouting).mockResolvedValue(undefined);\r\n\r\n      const result = await router.route(query);\r\n\r\n      expect(result.content).toBe('AI is artificial intelligence');\r\n      expect(result.routingTier).toBe(RoutingTier.LOCAL_LLM);\r\n      expect(result.cost).toBe(0);\r\n      expect(vi.mocked(mockCostOptimizer.trackSpending)).toHaveBeenCalled();\r\n      expect(vi.mocked(mockResponseCache.set)).toHaveBeenCalled();\r\n    });\r\n\r\n    it('should handle fallback with cost optimization', async () => {\r\n      const query: AIQuery = { query: 'Complex query', userId: 'user-1' };\r\n\r\n      vi.mocked(mockResponseCache.get).mockResolvedValue(null);\r\n\r\n      vi.mocked(mockClassifier.classify).mockResolvedValue({\r\n        id: 'class-1',\r\n        query: query.query,\r\n        classifiedAs: QueryComplexity.COMPLEX,\r\n        confidence: 0.9,\r\n        routedTo: RoutingTier.EXTERNAL_LLM\r\n      });\r\n\r\n      // External LLM fails\r\n      vi.mocked(mockCostOptimizer.calculateCost).mockResolvedValue(0.08);\r\n      vi.mocked(mockCostOptimizer.shouldRejectQuery).mockResolvedValue(false);\r\n      vi.mocked(mockCostOptimizer.getCheapestTier).mockResolvedValue(RoutingTier.EXTERNAL_LLM);\r\n\r\n      // Simulate failure and fallback\r\n      vi.mocked(mockLocalLLM.processQuery).mockRejectedValueOnce(new Error('Failed'));\r\n\r\n      // RAP succeeds\r\n      const mockResponse: AIResponse = {\r\n        id: 'resp-2',\r\n        content: 'Response from RAP',\r\n        routingTier: RoutingTier.RAP_SYSTEM,\r\n        responseTime: 800,\r\n        cost: 0.03,\r\n        cached: false\r\n      };\r\n      vi.mocked(mockRAP.processQuery).mockResolvedValue(mockResponse);\r\n      vi.mocked(mockMetrics.recordRouting).mockResolvedValue(undefined);\r\n      vi.mocked(mockMetrics.recordFallback).mockReturnValue(undefined);\r\n      vi.mocked(mockCostOptimizer.trackSpending).mockResolvedValue(undefined);\r\n      vi.mocked(mockResponseCache.set).mockResolvedValue(undefined);\r\n\r\n      const result = await router.route(query);\r\n\r\n      expect(result.routingTier).toBe(RoutingTier.RAP_SYSTEM);\r\n      expect(result.cost).toBe(0.03);\r\n    });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}