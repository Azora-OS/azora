{"version":3,"names":["_globals","require","_supertest","_interopRequireDefault","_stripe","e","__esModule","default","API_URL","process","env","PAY_SERVICE_URL","describe","beforeEach","mockStripe","reset","afterEach","it","res","request","post","send","email","name","userId","expect","status","toBe","body","customerId","toBeDefined","createRes","get","put","customerRes","paymentMethodId","attached","Array","isArray","paymentMethods","delete","detached","priceId","subscriptionId","updated","amount","currency","error"],"sources":["stripe-integration.test.ts"],"sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from '@jest/globals';\r\nimport request from 'supertest';\r\nimport { mockStripe } from '../../../tests/mocks/stripe.mock';\r\n\r\nconst API_URL = process.env.PAY_SERVICE_URL || 'http://localhost:3010';\r\n\r\ndescribe('Azora Pay - Stripe Integration', () => {\r\n  beforeEach(() => {\r\n    mockStripe.reset();\r\n  });\r\n\r\n  afterEach(() => {\r\n    mockStripe.reset();\r\n  });\r\n\r\n  describe('Customer Management', () => {\r\n    it('should create Stripe customer', async () => {\r\n      const res = await request(API_URL)\r\n        .post('/api/customers')\r\n        .send({\r\n          email: 'test@example.com',\r\n          name: 'Test User',\r\n          userId: 'user-123',\r\n        });\r\n\r\n      expect(res.status).toBe(201);\r\n      expect(res.body.customerId).toBeDefined();\r\n      expect(res.body.email).toBe('test@example.com');\r\n    });\r\n\r\n    it('should retrieve existing customer', async () => {\r\n      const createRes = await request(API_URL)\r\n        .post('/api/customers')\r\n        .send({\r\n          email: 'test@example.com',\r\n          name: 'Test User',\r\n          userId: 'user-123',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/customers/${createRes.body.customerId}`);\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.email).toBe('test@example.com');\r\n    });\r\n\r\n    it('should update customer information', async () => {\r\n      const createRes = await request(API_URL)\r\n        .post('/api/customers')\r\n        .send({\r\n          email: 'test@example.com',\r\n          name: 'Test User',\r\n          userId: 'user-123',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .put(`/api/customers/${createRes.body.customerId}`)\r\n        .send({\r\n          name: 'Updated Name',\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.name).toBe('Updated Name');\r\n    });\r\n  });\r\n\r\n  describe('Payment Methods', () => {\r\n    it('should attach payment method to customer', async () => {\r\n      const customerRes = await request(API_URL)\r\n        .post('/api/customers')\r\n        .send({\r\n          email: 'test@example.com',\r\n          userId: 'user-123',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .post('/api/payment-methods/attach')\r\n        .send({\r\n          customerId: customerRes.body.customerId,\r\n          paymentMethodId: 'pm_test_123',\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.attached).toBe(true);\r\n    });\r\n\r\n    it('should list customer payment methods', async () => {\r\n      const customerRes = await request(API_URL)\r\n        .post('/api/customers')\r\n        .send({\r\n          email: 'test@example.com',\r\n          userId: 'user-123',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/payment-methods/${customerRes.body.customerId}`);\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(Array.isArray(res.body.paymentMethods)).toBe(true);\r\n    });\r\n\r\n    it('should detach payment method', async () => {\r\n      const res = await request(API_URL)\r\n        .delete('/api/payment-methods/pm_test_123');\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.detached).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('Subscription Payments', () => {\r\n    it('should create subscription', async () => {\r\n      const customerRes = await request(API_URL)\r\n        .post('/api/customers')\r\n        .send({\r\n          email: 'test@example.com',\r\n          userId: 'user-123',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .post('/api/subscriptions')\r\n        .send({\r\n          customerId: customerRes.body.customerId,\r\n          priceId: 'price_test_123',\r\n        });\r\n\r\n      expect(res.status).toBe(201);\r\n      expect(res.body.subscriptionId).toBeDefined();\r\n      expect(res.body.status).toBe('active');\r\n    });\r\n\r\n    it('should cancel subscription', async () => {\r\n      const res = await request(API_URL)\r\n        .delete('/api/subscriptions/sub_test_123');\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.status).toBe('canceled');\r\n    });\r\n\r\n    it('should update subscription', async () => {\r\n      const res = await request(API_URL)\r\n        .put('/api/subscriptions/sub_test_123')\r\n        .send({\r\n          priceId: 'price_test_456',\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.updated).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('Error Handling', () => {\r\n    it('should handle Stripe API errors', async () => {\r\n      const res = await request(API_URL)\r\n        .post('/api/payments/intent')\r\n        .send({\r\n          amount: -100,\r\n          currency: 'usd',\r\n          userId: 'user-123',\r\n        });\r\n\r\n      expect(res.status).toBe(400);\r\n      expect(res.body.error).toBeDefined();\r\n    });\r\n\r\n    it('should handle network errors gracefully', async () => {\r\n      const res = await request(API_URL)\r\n        .get('/api/customers/invalid-customer-id');\r\n\r\n      expect(res.status).toBe(404);\r\n    });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}