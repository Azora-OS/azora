{"version":3,"names":["_getJestObj","mock","logger","info","jest","fn","error","warn","debug","ErrorHandler","handle","_globals","require","_subscriptionService","describe","subscriptionService","mockPrisma","beforeEach","subscription","create","mockResolvedValue","id","userId","tier","status","startDate","Date","renewalDate","now","createdAt","updatedAt","findFirst","findUnique","update","SubscriptionService","it","paymentMethodId","mockSubscription","result","createSubscription","expect","toEqual","toHaveBeenCalledWith","data","objectContaining","rejects","toThrow","subscriptionId","newTier","mockUpdatedSubscription","updateSubscription","toBe","toHaveBeenCalled","mockCancelledSubscription","cancelledAt","cancelSubscription","getSubscription","where","toBeNull","getUserSubscription"],"sources":["subscription-service.test.ts"],"sourcesContent":["import { describe, it, expect, beforeEach, jest } from '@jest/globals';\r\nimport { SubscriptionService } from '../subscription-service';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\n// Mock logger\r\njest.mock('../../shared/logging', () => ({\r\n  logger: {\r\n    info: jest.fn(),\r\n    error: jest.fn(),\r\n    warn: jest.fn(),\r\n    debug: jest.fn(),\r\n  },\r\n}));\r\n\r\n// Mock ErrorHandler\r\njest.mock('../../payment/error-handler', () => ({\r\n  ErrorHandler: {\r\n    handle: jest.fn((error) => error),\r\n  },\r\n}));\r\n\r\n// Mock Prisma\r\njest.mock('@prisma/client');\r\n\r\ndescribe('SubscriptionService', () => {\r\n  let subscriptionService: SubscriptionService;\r\n  let mockPrisma: any;\r\n\r\n  beforeEach(() => {\r\n    mockPrisma = {\r\n      subscription: {\r\n        create: jest.fn().mockResolvedValue({\r\n          id: 'sub_123',\r\n          userId: 'user123',\r\n          tier: 'PRO',\r\n          status: 'ACTIVE',\r\n          startDate: new Date(),\r\n          renewalDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),\r\n          createdAt: new Date(),\r\n          updatedAt: new Date(),\r\n        }),\r\n        findFirst: jest.fn().mockResolvedValue(null),\r\n        findUnique: jest.fn().mockResolvedValue({\r\n          id: 'sub_123',\r\n          userId: 'user123',\r\n          tier: 'PRO',\r\n          status: 'ACTIVE',\r\n          createdAt: new Date(),\r\n          updatedAt: new Date(),\r\n        }),\r\n        update: jest.fn().mockResolvedValue({\r\n          id: 'sub_123',\r\n          tier: 'ENTERPRISE',\r\n          status: 'ACTIVE',\r\n          updatedAt: new Date(),\r\n        }),\r\n      },\r\n    };\r\n    subscriptionService = new SubscriptionService();\r\n  });\r\n\r\n  describe('createSubscription', () => {\r\n    it('should create a new subscription for a user', async () => {\r\n      const userId = 'user123';\r\n      const tier = 'PRO';\r\n      const paymentMethodId = 'pm_123';\r\n\r\n      const mockSubscription = {\r\n        id: 'sub_123',\r\n        userId,\r\n        tier,\r\n        status: 'ACTIVE',\r\n        startDate: new Date(),\r\n        renewalDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),\r\n        createdAt: new Date(),\r\n        updatedAt: new Date(),\r\n      };\r\n\r\n      mockPrisma.subscription.create = jest.fn().mockResolvedValue(mockSubscription);\r\n\r\n      const result = await subscriptionService.createSubscription({\r\n        userId,\r\n        tier,\r\n        paymentMethodId,\r\n      });\r\n\r\n      expect(result).toEqual(mockSubscription);\r\n      expect(mockPrisma.subscription.create).toHaveBeenCalledWith({\r\n        data: expect.objectContaining({\r\n          userId,\r\n          tier,\r\n        }),\r\n      });\r\n    });\r\n\r\n    it('should throw error if user already has active subscription', async () => {\r\n      const userId = 'user123';\r\n\r\n      mockPrisma.subscription.findFirst = jest.fn().mockResolvedValue({\r\n        id: 'sub_existing',\r\n        userId,\r\n        status: 'ACTIVE',\r\n      });\r\n\r\n      await expect(\r\n        subscriptionService.createSubscription({\r\n          userId,\r\n          tier: 'PRO',\r\n          paymentMethodId: 'pm_123',\r\n        })\r\n      ).rejects.toThrow('User already has an active subscription');\r\n    });\r\n  });\r\n\r\n  describe('updateSubscription', () => {\r\n    it('should update subscription tier', async () => {\r\n      const subscriptionId = 'sub_123';\r\n      const newTier = 'ENTERPRISE';\r\n\r\n      const mockUpdatedSubscription = {\r\n        id: subscriptionId,\r\n        tier: newTier,\r\n        status: 'ACTIVE',\r\n        updatedAt: new Date(),\r\n      };\r\n\r\n      mockPrisma.subscription.update = jest.fn().mockResolvedValue(mockUpdatedSubscription);\r\n\r\n      const result = await subscriptionService.updateSubscription(subscriptionId, {\r\n        tier: newTier,\r\n      });\r\n\r\n      expect(result.tier).toBe(newTier);\r\n      expect(mockPrisma.subscription.update).toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe('cancelSubscription', () => {\r\n    it('should cancel an active subscription', async () => {\r\n      const subscriptionId = 'sub_123';\r\n\r\n      const mockCancelledSubscription = {\r\n        id: subscriptionId,\r\n        status: 'CANCELLED',\r\n        cancelledAt: new Date(),\r\n      };\r\n\r\n      mockPrisma.subscription.update = jest.fn().mockResolvedValue(mockCancelledSubscription);\r\n\r\n      const result = await subscriptionService.cancelSubscription(subscriptionId);\r\n\r\n      expect(result.status).toBe('CANCELLED');\r\n      expect(mockPrisma.subscription.update).toHaveBeenCalled();\r\n    });\r\n\r\n    it('should throw error if subscription not found', async () => {\r\n      mockPrisma.subscription.findUnique = jest.fn().mockResolvedValue(null);\r\n\r\n      await expect(subscriptionService.cancelSubscription('invalid_id')).rejects.toThrow(\r\n        'Subscription not found'\r\n      );\r\n    });\r\n  });\r\n\r\n  describe('getSubscription', () => {\r\n    it('should retrieve subscription by ID', async () => {\r\n      const subscriptionId = 'sub_123';\r\n      const mockSubscription = {\r\n        id: subscriptionId,\r\n        userId: 'user123',\r\n        tier: 'PRO',\r\n        status: 'ACTIVE',\r\n      };\r\n\r\n      mockPrisma.subscription.findUnique = jest.fn().mockResolvedValue(mockSubscription);\r\n\r\n      const result = await subscriptionService.getSubscription(subscriptionId);\r\n\r\n      expect(result).toEqual(mockSubscription);\r\n      expect(mockPrisma.subscription.findUnique).toHaveBeenCalledWith({\r\n        where: { id: subscriptionId },\r\n      });\r\n    });\r\n\r\n    it('should return null if subscription not found', async () => {\r\n      mockPrisma.subscription.findUnique = jest.fn().mockResolvedValue(null);\r\n\r\n      const result = await subscriptionService.getSubscription('invalid_id');\r\n\r\n      expect(result).toBeNull();\r\n    });\r\n  });\r\n\r\n  describe('getUserSubscription', () => {\r\n    it('should retrieve active subscription for user', async () => {\r\n      const userId = 'user123';\r\n      const mockSubscription = {\r\n        id: 'sub_123',\r\n        userId,\r\n        tier: 'PRO',\r\n        status: 'ACTIVE',\r\n      };\r\n\r\n      mockPrisma.subscription.findFirst = jest.fn().mockResolvedValue(mockSubscription);\r\n\r\n      const result = await subscriptionService.getUserSubscription(userId);\r\n\r\n      expect(result).toEqual(mockSubscription);\r\n      expect(mockPrisma.subscription.findFirst).toHaveBeenCalledWith({\r\n        where: {\r\n          userId,\r\n          status: 'ACTIVE',\r\n        },\r\n      });\r\n    });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}