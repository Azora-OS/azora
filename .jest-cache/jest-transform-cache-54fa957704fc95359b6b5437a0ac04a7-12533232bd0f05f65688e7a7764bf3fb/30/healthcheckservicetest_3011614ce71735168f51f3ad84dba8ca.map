{"version":3,"names":["_getJestObj","mock","_healthCheck","require","jest","describe","healthCheckService","mockPrisma","beforeEach","$queryRaw","fn","mockResolvedValue","user","count","course","enrollment","HealthCheckService","it","health","getHealthStatus","expect","status","toBe","timestamp","toBeDefined","uptime","toBeGreaterThan","checks","database","responseTime","toBeGreaterThanOrEqual","message","lastChecked","memory","toMatch","metrics","requestsPerSecond","errorRate","averageResponseTime","activeConnections","mockImplementation","Promise","resolve","setTimeout","mockRejectedValue","Error","toContain","recordRequest","requestCount","errorCount","totalResponseTime","diagnostics","getDiagnostics","system","nodeVersion","platform","heapUsed","heapTotal","external","rss","check"],"sources":["health-check.service.test.ts"],"sourcesContent":["/**\r\n * Health Check Service Tests\r\n */\r\n\r\nimport { HealthCheckService } from '../health-check.service';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\njest.mock('@prisma/client');\r\n\r\ndescribe('HealthCheckService', () => {\r\n  let healthCheckService: HealthCheckService;\r\n  let mockPrisma: any;\r\n\r\n  beforeEach(() => {\r\n    mockPrisma = {\r\n      $queryRaw: jest.fn().mockResolvedValue([{ '1': 1 }]),\r\n      user: {\r\n        count: jest.fn().mockResolvedValue(100),\r\n      },\r\n      course: {\r\n        count: jest.fn().mockResolvedValue(50),\r\n      },\r\n      enrollment: {\r\n        count: jest.fn().mockResolvedValue(500),\r\n      },\r\n    };\r\n\r\n    healthCheckService = new HealthCheckService(mockPrisma as PrismaClient);\r\n  });\r\n\r\n  describe('getHealthStatus', () => {\r\n    it('should return healthy status when all checks pass', async () => {\r\n      const health = await healthCheckService.getHealthStatus();\r\n\r\n      expect(health.status).toBe('healthy');\r\n      expect(health.timestamp).toBeDefined();\r\n      expect(health.uptime).toBeGreaterThan(0);\r\n      expect(health.checks).toBeDefined();\r\n      expect(health.checks.database).toBeDefined();\r\n    });\r\n\r\n    it('should include database check', async () => {\r\n      const health = await healthCheckService.getHealthStatus();\r\n\r\n      expect(health.checks.database.status).toBe('healthy');\r\n      expect(health.checks.database.responseTime).toBeGreaterThanOrEqual(0);\r\n      expect(health.checks.database.message).toBeDefined();\r\n      expect(health.checks.database.lastChecked).toBeDefined();\r\n    });\r\n\r\n    it('should include memory check', async () => {\r\n      const health = await healthCheckService.getHealthStatus();\r\n\r\n      expect(health.checks.memory).toBeDefined();\r\n      expect(health.checks.memory.status).toMatch(/healthy|degraded|unhealthy/);\r\n      expect(health.checks.memory.message).toBeDefined();\r\n    });\r\n\r\n    it('should include metrics', async () => {\r\n      const health = await healthCheckService.getHealthStatus();\r\n\r\n      expect(health.metrics).toBeDefined();\r\n      expect(health.metrics?.requestsPerSecond).toBeGreaterThanOrEqual(0);\r\n      expect(health.metrics?.errorRate).toBeGreaterThanOrEqual(0);\r\n      expect(health.metrics?.averageResponseTime).toBeGreaterThanOrEqual(0);\r\n      expect(health.metrics?.activeConnections).toBeGreaterThanOrEqual(0);\r\n    });\r\n\r\n    it('should return degraded status when database is slow', async () => {\r\n      // Mock slow database response\r\n      mockPrisma.$queryRaw = jest.fn().mockImplementation(\r\n        () => new Promise(resolve => setTimeout(() => resolve([{ '1': 1 }]), 150))\r\n      );\r\n\r\n      const health = await healthCheckService.getHealthStatus();\r\n\r\n      expect(health.checks.database.status).toBe('degraded');\r\n    });\r\n\r\n    it('should return unhealthy status when database fails', async () => {\r\n      mockPrisma.$queryRaw = jest.fn().mockRejectedValue(new Error('Connection failed'));\r\n\r\n      const health = await healthCheckService.getHealthStatus();\r\n\r\n      expect(health.status).toBe('unhealthy');\r\n      expect(health.checks.database.status).toBe('unhealthy');\r\n      expect(health.checks.database.message).toContain('Connection failed');\r\n    });\r\n  });\r\n\r\n  describe('recordRequest', () => {\r\n    it('should record successful requests', () => {\r\n      healthCheckService.recordRequest(100, false);\r\n      healthCheckService.recordRequest(150, false);\r\n\r\n      const health = healthCheckService['lastMetrics'];\r\n      expect(health.requestCount).toBe(2);\r\n      expect(health.errorCount).toBe(0);\r\n      expect(health.totalResponseTime).toBe(250);\r\n    });\r\n\r\n    it('should record failed requests', () => {\r\n      healthCheckService.recordRequest(100, false);\r\n      healthCheckService.recordRequest(150, true);\r\n\r\n      const health = healthCheckService['lastMetrics'];\r\n      expect(health.requestCount).toBe(2);\r\n      expect(health.errorCount).toBe(1);\r\n    });\r\n  });\r\n\r\n  describe('getDiagnostics', () => {\r\n    it('should return detailed diagnostics', async () => {\r\n      const diagnostics = await healthCheckService.getDiagnostics();\r\n\r\n      expect(diagnostics.health).toBeDefined();\r\n      expect(diagnostics.system).toBeDefined();\r\n      expect(diagnostics.system.uptime).toBeGreaterThan(0);\r\n      expect(diagnostics.system.memory).toBeDefined();\r\n      expect(diagnostics.system.nodeVersion).toBeDefined();\r\n      expect(diagnostics.system.platform).toBeDefined();\r\n      expect(diagnostics.timestamp).toBeDefined();\r\n    });\r\n\r\n    it('should include memory information', async () => {\r\n      const diagnostics = await healthCheckService.getDiagnostics();\r\n\r\n      expect(diagnostics.system.memory.heapUsed).toBeDefined();\r\n      expect(diagnostics.system.memory.heapTotal).toBeDefined();\r\n      expect(diagnostics.system.memory.external).toBeDefined();\r\n      expect(diagnostics.system.memory.rss).toBeDefined();\r\n    });\r\n  });\r\n\r\n  describe('checkMemory', () => {\r\n    it('should return healthy status for normal memory usage', () => {\r\n      const check = healthCheckService['checkMemory']();\r\n\r\n      expect(check.status).toMatch(/healthy|degraded|unhealthy/);\r\n      expect(check.message).toContain('Heap usage');\r\n      expect(check.lastChecked).toBeDefined();\r\n    });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}