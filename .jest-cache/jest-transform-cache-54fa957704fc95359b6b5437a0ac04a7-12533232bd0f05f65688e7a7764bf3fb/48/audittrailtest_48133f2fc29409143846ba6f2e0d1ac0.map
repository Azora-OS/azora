{"version":3,"names":["_globals","require","_supertest","_interopRequireDefault","_database","e","__esModule","default","API_URL","process","env","LEDGER_SERVICE_URL","describe","beforeEach","setupTestDatabase","afterEach","cleanupTestDatabase","it","createRes","request","post","send","amount","currency","accountId","type","res","get","body","data","id","expect","status","toBe","auditLog","toBeDefined","action","put","description","length","toBeGreaterThan","delete","some","log","Array","isArray","query","startDate","endDate","accountIds","report","totalTransactions","format","headers","toContain"],"sources":["audit-trail.test.ts"],"sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from '@jest/globals';\r\nimport request from 'supertest';\r\nimport { setupTestDatabase, cleanupTestDatabase } from '../../../tests/utils/database';\r\n\r\nconst API_URL = process.env.LEDGER_SERVICE_URL || 'http://localhost:3012';\r\n\r\ndescribe('Azora Ledger - Audit Trail', () => {\r\n  beforeEach(async () => {\r\n    await setupTestDatabase();\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await cleanupTestDatabase();\r\n  });\r\n\r\n  describe('Transaction Audit', () => {\r\n    it('should record transaction creation in audit log', async () => {\r\n      const createRes = await request(API_URL)\r\n        .post('/api/transactions')\r\n        .send({\r\n          amount: 100,\r\n          currency: 'USD',\r\n          accountId: 'account-123',\r\n          type: 'credit',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/audit/transactions/${createRes.body.data.id}`);\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.auditLog).toBeDefined();\r\n      expect(res.body.auditLog.action).toBe('CREATE');\r\n    });\r\n\r\n    it('should record transaction updates in audit log', async () => {\r\n      const createRes = await request(API_URL)\r\n        .post('/api/transactions')\r\n        .send({\r\n          amount: 100,\r\n          currency: 'USD',\r\n          accountId: 'account-123',\r\n        });\r\n\r\n      await request(API_URL)\r\n        .put(`/api/transactions/${createRes.body.data.id}`)\r\n        .send({\r\n          description: 'Updated',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/audit/transactions/${createRes.body.data.id}`);\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.auditLog.length).toBeGreaterThan(1);\r\n    });\r\n\r\n    it('should record transaction deletion in audit log', async () => {\r\n      const createRes = await request(API_URL)\r\n        .post('/api/transactions')\r\n        .send({\r\n          amount: 100,\r\n          currency: 'USD',\r\n          accountId: 'account-123',\r\n        });\r\n\r\n      await request(API_URL)\r\n        .delete(`/api/transactions/${createRes.body.data.id}`);\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/audit/transactions/${createRes.body.data.id}`);\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.auditLog.some((log: any) => log.action === 'DELETE')).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('Account Audit', () => {\r\n    it('should retrieve account audit trail', async () => {\r\n      const accountId = 'account-audit';\r\n\r\n      await request(API_URL)\r\n        .post('/api/transactions')\r\n        .send({\r\n          amount: 100,\r\n          currency: 'USD',\r\n          accountId,\r\n          type: 'credit',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/audit/accounts/${accountId}`);\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(Array.isArray(res.body.auditLog)).toBe(true);\r\n    });\r\n\r\n    it('should filter audit trail by date', async () => {\r\n      const accountId = 'account-date-audit';\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/audit/accounts/${accountId}`)\r\n        .query({\r\n          startDate: '2024-01-01',\r\n          endDate: '2024-12-31',\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(Array.isArray(res.body.auditLog)).toBe(true);\r\n    });\r\n\r\n    it('should filter audit trail by action type', async () => {\r\n      const accountId = 'account-action-audit';\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/audit/accounts/${accountId}`)\r\n        .query({\r\n          action: 'CREATE',\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(Array.isArray(res.body.auditLog)).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('Audit Report Generation', () => {\r\n    it('should generate audit report', async () => {\r\n      const res = await request(API_URL)\r\n        .post('/api/audit/reports')\r\n        .send({\r\n          startDate: '2024-01-01',\r\n          endDate: '2024-12-31',\r\n          accountIds: ['account-123', 'account-456'],\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.report).toBeDefined();\r\n      expect(res.body.report.totalTransactions).toBeDefined();\r\n    });\r\n\r\n    it('should export audit report as CSV', async () => {\r\n      const res = await request(API_URL)\r\n        .get('/api/audit/reports/export')\r\n        .query({\r\n          format: 'csv',\r\n          startDate: '2024-01-01',\r\n          endDate: '2024-12-31',\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.headers['content-type']).toContain('text/csv');\r\n    });\r\n\r\n    it('should export audit report as PDF', async () => {\r\n      const res = await request(API_URL)\r\n        .get('/api/audit/reports/export')\r\n        .query({\r\n          format: 'pdf',\r\n          startDate: '2024-01-01',\r\n          endDate: '2024-12-31',\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.headers['content-type']).toContain('application/pdf');\r\n    });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}