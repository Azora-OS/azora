{"version":3,"names":["_getJestObj","mock","_supertest","_interopRequireDefault","require","_express","_conversionMetrics","_conversionMetrics2","e","__esModule","default","jest","app","express","use","json","conversionMetricsRouter","describe","beforeEach","clearAllMocks","it","mockMetrics","period","freeUsers","premiumUsers","proUsers","conversionRate","churnRate","lifetimeValue","customerAcquisitionCost","paybackPeriod","conversionMetricsService","getConversionMetrics","mockResolvedValue","response","request","get","expect","status","toBe","body","success","data","toEqual","mockRejectedValue","Error","error","toContain","toBeCloseTo"],"sources":["conversion-metrics.routes.test.ts"],"sourcesContent":["import request from 'supertest';\r\nimport express from 'express';\r\nimport conversionMetricsRouter from '../conversion-metrics.routes';\r\nimport { conversionMetricsService } from '../../services/conversion-metrics.service';\r\n\r\n// Mock the service\r\njest.mock('../../services/conversion-metrics.service');\r\n\r\nconst app = express();\r\napp.use(express.json());\r\napp.use('/', conversionMetricsRouter);\r\n\r\ndescribe('Conversion Metrics Routes', () => {\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  describe('GET /analytics/conversion/metrics', () => {\r\n    it('should return conversion metrics for current month', async () => {\r\n      const mockMetrics = {\r\n        period: '2024-01',\r\n        freeUsers: 100,\r\n        premiumUsers: 30,\r\n        proUsers: 5,\r\n        conversionRate: 23.08,\r\n        churnRate: 5.2,\r\n        lifetimeValue: 50,\r\n        customerAcquisitionCost: 10,\r\n        paybackPeriod: 2.4,\r\n      };\r\n\r\n      (conversionMetricsService.getConversionMetrics as jest.Mock).mockResolvedValue(mockMetrics);\r\n\r\n      const response = await request(app).get('/analytics/conversion/metrics');\r\n\r\n      expect(response.status).toBe(200);\r\n      expect(response.body.success).toBe(true);\r\n      expect(response.body.data).toEqual(mockMetrics);\r\n    });\r\n\r\n    it('should handle errors gracefully', async () => {\r\n      (conversionMetricsService.getConversionMetrics as jest.Mock).mockRejectedValue(\r\n        new Error('Database error')\r\n      );\r\n\r\n      const response = await request(app).get('/analytics/conversion/metrics');\r\n\r\n      expect(response.status).toBe(500);\r\n      expect(response.body.success).toBe(false);\r\n      expect(response.body.error).toBe('Failed to fetch conversion metrics');\r\n    });\r\n  });\r\n\r\n  describe('GET /analytics/conversion/metrics/:period', () => {\r\n    it('should return conversion metrics for specified month', async () => {\r\n      const mockMetrics = {\r\n        period: '2024-03',\r\n        freeUsers: 150,\r\n        premiumUsers: 45,\r\n        proUsers: 10,\r\n        conversionRate: 23.08,\r\n        churnRate: 3.5,\r\n        lifetimeValue: 55,\r\n        customerAcquisitionCost: 12,\r\n        paybackPeriod: 2.6,\r\n      };\r\n\r\n      (conversionMetricsService.getConversionMetrics as jest.Mock).mockResolvedValue(mockMetrics);\r\n\r\n      const response = await request(app).get('/analytics/conversion/metrics/2024-03');\r\n\r\n      expect(response.status).toBe(200);\r\n      expect(response.body.success).toBe(true);\r\n      expect(response.body.data.period).toBe('2024-03');\r\n    });\r\n\r\n    it('should return conversion metrics for specified quarter', async () => {\r\n      const mockMetrics = {\r\n        period: '2024-Q1',\r\n        freeUsers: 300,\r\n        premiumUsers: 90,\r\n        proUsers: 20,\r\n        conversionRate: 23.08,\r\n        churnRate: 4.2,\r\n        lifetimeValue: 52,\r\n        customerAcquisitionCost: 11,\r\n        paybackPeriod: 2.5,\r\n      };\r\n\r\n      (conversionMetricsService.getConversionMetrics as jest.Mock).mockResolvedValue(mockMetrics);\r\n\r\n      const response = await request(app).get('/analytics/conversion/metrics/2024-Q1');\r\n\r\n      expect(response.status).toBe(200);\r\n      expect(response.body.success).toBe(true);\r\n      expect(response.body.data.period).toBe('2024-Q1');\r\n    });\r\n\r\n    it('should return conversion metrics for specified year', async () => {\r\n      const mockMetrics = {\r\n        period: '2024',\r\n        freeUsers: 1200,\r\n        premiumUsers: 360,\r\n        proUsers: 80,\r\n        conversionRate: 23.08,\r\n        churnRate: 4.0,\r\n        lifetimeValue: 51,\r\n        customerAcquisitionCost: 10.5,\r\n        paybackPeriod: 2.45,\r\n      };\r\n\r\n      (conversionMetricsService.getConversionMetrics as jest.Mock).mockResolvedValue(mockMetrics);\r\n\r\n      const response = await request(app).get('/analytics/conversion/metrics/2024');\r\n\r\n      expect(response.status).toBe(200);\r\n      expect(response.body.success).toBe(true);\r\n      expect(response.body.data.period).toBe('2024');\r\n    });\r\n\r\n    it('should reject invalid period format', async () => {\r\n      const response = await request(app).get('/analytics/conversion/metrics/invalid-period');\r\n\r\n      expect(response.status).toBe(400);\r\n      expect(response.body.success).toBe(false);\r\n      expect(response.body.error).toContain('Invalid period format');\r\n    });\r\n\r\n    it('should reject invalid month', async () => {\r\n      const response = await request(app).get('/analytics/conversion/metrics/2024-13');\r\n\r\n      expect(response.status).toBe(400);\r\n      expect(response.body.success).toBe(false);\r\n    });\r\n\r\n    it('should handle service errors', async () => {\r\n      (conversionMetricsService.getConversionMetrics as jest.Mock).mockRejectedValue(\r\n        new Error('Service error')\r\n      );\r\n\r\n      const response = await request(app).get('/analytics/conversion/metrics/2024-01');\r\n\r\n      expect(response.status).toBe(500);\r\n      expect(response.body.success).toBe(false);\r\n    });\r\n  });\r\n\r\n  describe('Data aggregation', () => {\r\n    it('should aggregate conversion metrics correctly', async () => {\r\n      const mockMetrics = {\r\n        period: '2024-01',\r\n        freeUsers: 100,\r\n        premiumUsers: 30,\r\n        proUsers: 5,\r\n        conversionRate: 23.08,\r\n        churnRate: 5.2,\r\n        lifetimeValue: 50,\r\n        customerAcquisitionCost: 10,\r\n        paybackPeriod: 2.4,\r\n      };\r\n\r\n      (conversionMetricsService.getConversionMetrics as jest.Mock).mockResolvedValue(mockMetrics);\r\n\r\n      const response = await request(app).get('/analytics/conversion/metrics/2024-01');\r\n\r\n      expect(response.body.data.freeUsers).toBe(100);\r\n      expect(response.body.data.premiumUsers).toBe(30);\r\n      expect(response.body.data.proUsers).toBe(5);\r\n      expect(response.body.data.conversionRate).toBeCloseTo(23.08, 1);\r\n    });\r\n  });\r\n});\r\n"],"mappings":";;AAKA;AACAA,WAAA,GAAKC,IAAI,CAAC,2CAA2C,CAAC;AANtD,IAAAC,UAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,QAAA,GAAAF,sBAAA,CAAAC,OAAA;AACA,IAAAE,kBAAA,GAAAH,sBAAA,CAAAC,OAAA;AACA,IAAAG,mBAAA,GAAAH,OAAA;AAAqF,SAAAD,uBAAAK,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,KAAAE,OAAA,EAAAF,CAAA;AAAA,SAAAR,YAAA;EAAA;IAAAW;EAAA,IAAAP,OAAA;EAAAJ,WAAA,GAAAA,CAAA,KAAAW,IAAA;EAAA,OAAAA,IAAA;AAAA;AAKrF,MAAMC,GAAG,GAAG,IAAAC,gBAAO,EAAC,CAAC;AACrBD,GAAG,CAACE,GAAG,CAACD,gBAAO,CAACE,IAAI,CAAC,CAAC,CAAC;AACvBH,GAAG,CAACE,GAAG,CAAC,GAAG,EAAEE,0BAAuB,CAAC;AAErCC,QAAQ,CAAC,2BAA2B,EAAE,MAAM;EAC1CC,UAAU,CAAC,MAAM;IACfP,IAAI,CAACQ,aAAa,CAAC,CAAC;EACtB,CAAC,CAAC;EAEFF,QAAQ,CAAC,mCAAmC,EAAE,MAAM;IAClDG,EAAE,CAAC,oDAAoD,EAAE,YAAY;MACnE,MAAMC,WAAW,GAAG;QAClBC,MAAM,EAAE,SAAS;QACjBC,SAAS,EAAE,GAAG;QACdC,YAAY,EAAE,EAAE;QAChBC,QAAQ,EAAE,CAAC;QACXC,cAAc,EAAE,KAAK;QACrBC,SAAS,EAAE,GAAG;QACdC,aAAa,EAAE,EAAE;QACjBC,uBAAuB,EAAE,EAAE;QAC3BC,aAAa,EAAE;MACjB,CAAC;MAEAC,4CAAwB,CAACC,oBAAoB,CAAeC,iBAAiB,CAACZ,WAAW,CAAC;MAE3F,MAAMa,QAAQ,GAAG,MAAM,IAAAC,kBAAO,EAACvB,GAAG,CAAC,CAACwB,GAAG,CAAC,+BAA+B,CAAC;MAExEC,MAAM,CAACH,QAAQ,CAACI,MAAM,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;MACjCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACC,OAAO,CAAC,CAACF,IAAI,CAAC,IAAI,CAAC;MACxCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACE,IAAI,CAAC,CAACC,OAAO,CAACtB,WAAW,CAAC;IACjD,CAAC,CAAC;IAEFD,EAAE,CAAC,iCAAiC,EAAE,YAAY;MAC/CW,4CAAwB,CAACC,oBAAoB,CAAeY,iBAAiB,CAC5E,IAAIC,KAAK,CAAC,gBAAgB,CAC5B,CAAC;MAED,MAAMX,QAAQ,GAAG,MAAM,IAAAC,kBAAO,EAACvB,GAAG,CAAC,CAACwB,GAAG,CAAC,+BAA+B,CAAC;MAExEC,MAAM,CAACH,QAAQ,CAACI,MAAM,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;MACjCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACC,OAAO,CAAC,CAACF,IAAI,CAAC,KAAK,CAAC;MACzCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACM,KAAK,CAAC,CAACP,IAAI,CAAC,oCAAoC,CAAC;IACxE,CAAC,CAAC;EACJ,CAAC,CAAC;EAEFtB,QAAQ,CAAC,2CAA2C,EAAE,MAAM;IAC1DG,EAAE,CAAC,sDAAsD,EAAE,YAAY;MACrE,MAAMC,WAAW,GAAG;QAClBC,MAAM,EAAE,SAAS;QACjBC,SAAS,EAAE,GAAG;QACdC,YAAY,EAAE,EAAE;QAChBC,QAAQ,EAAE,EAAE;QACZC,cAAc,EAAE,KAAK;QACrBC,SAAS,EAAE,GAAG;QACdC,aAAa,EAAE,EAAE;QACjBC,uBAAuB,EAAE,EAAE;QAC3BC,aAAa,EAAE;MACjB,CAAC;MAEAC,4CAAwB,CAACC,oBAAoB,CAAeC,iBAAiB,CAACZ,WAAW,CAAC;MAE3F,MAAMa,QAAQ,GAAG,MAAM,IAAAC,kBAAO,EAACvB,GAAG,CAAC,CAACwB,GAAG,CAAC,uCAAuC,CAAC;MAEhFC,MAAM,CAACH,QAAQ,CAACI,MAAM,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;MACjCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACC,OAAO,CAAC,CAACF,IAAI,CAAC,IAAI,CAAC;MACxCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACE,IAAI,CAACpB,MAAM,CAAC,CAACiB,IAAI,CAAC,SAAS,CAAC;IACnD,CAAC,CAAC;IAEFnB,EAAE,CAAC,wDAAwD,EAAE,YAAY;MACvE,MAAMC,WAAW,GAAG;QAClBC,MAAM,EAAE,SAAS;QACjBC,SAAS,EAAE,GAAG;QACdC,YAAY,EAAE,EAAE;QAChBC,QAAQ,EAAE,EAAE;QACZC,cAAc,EAAE,KAAK;QACrBC,SAAS,EAAE,GAAG;QACdC,aAAa,EAAE,EAAE;QACjBC,uBAAuB,EAAE,EAAE;QAC3BC,aAAa,EAAE;MACjB,CAAC;MAEAC,4CAAwB,CAACC,oBAAoB,CAAeC,iBAAiB,CAACZ,WAAW,CAAC;MAE3F,MAAMa,QAAQ,GAAG,MAAM,IAAAC,kBAAO,EAACvB,GAAG,CAAC,CAACwB,GAAG,CAAC,uCAAuC,CAAC;MAEhFC,MAAM,CAACH,QAAQ,CAACI,MAAM,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;MACjCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACC,OAAO,CAAC,CAACF,IAAI,CAAC,IAAI,CAAC;MACxCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACE,IAAI,CAACpB,MAAM,CAAC,CAACiB,IAAI,CAAC,SAAS,CAAC;IACnD,CAAC,CAAC;IAEFnB,EAAE,CAAC,qDAAqD,EAAE,YAAY;MACpE,MAAMC,WAAW,GAAG;QAClBC,MAAM,EAAE,MAAM;QACdC,SAAS,EAAE,IAAI;QACfC,YAAY,EAAE,GAAG;QACjBC,QAAQ,EAAE,EAAE;QACZC,cAAc,EAAE,KAAK;QACrBC,SAAS,EAAE,GAAG;QACdC,aAAa,EAAE,EAAE;QACjBC,uBAAuB,EAAE,IAAI;QAC7BC,aAAa,EAAE;MACjB,CAAC;MAEAC,4CAAwB,CAACC,oBAAoB,CAAeC,iBAAiB,CAACZ,WAAW,CAAC;MAE3F,MAAMa,QAAQ,GAAG,MAAM,IAAAC,kBAAO,EAACvB,GAAG,CAAC,CAACwB,GAAG,CAAC,oCAAoC,CAAC;MAE7EC,MAAM,CAACH,QAAQ,CAACI,MAAM,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;MACjCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACC,OAAO,CAAC,CAACF,IAAI,CAAC,IAAI,CAAC;MACxCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACE,IAAI,CAACpB,MAAM,CAAC,CAACiB,IAAI,CAAC,MAAM,CAAC;IAChD,CAAC,CAAC;IAEFnB,EAAE,CAAC,qCAAqC,EAAE,YAAY;MACpD,MAAMc,QAAQ,GAAG,MAAM,IAAAC,kBAAO,EAACvB,GAAG,CAAC,CAACwB,GAAG,CAAC,8CAA8C,CAAC;MAEvFC,MAAM,CAACH,QAAQ,CAACI,MAAM,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;MACjCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACC,OAAO,CAAC,CAACF,IAAI,CAAC,KAAK,CAAC;MACzCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACM,KAAK,CAAC,CAACC,SAAS,CAAC,uBAAuB,CAAC;IAChE,CAAC,CAAC;IAEF3B,EAAE,CAAC,6BAA6B,EAAE,YAAY;MAC5C,MAAMc,QAAQ,GAAG,MAAM,IAAAC,kBAAO,EAACvB,GAAG,CAAC,CAACwB,GAAG,CAAC,uCAAuC,CAAC;MAEhFC,MAAM,CAACH,QAAQ,CAACI,MAAM,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;MACjCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACC,OAAO,CAAC,CAACF,IAAI,CAAC,KAAK,CAAC;IAC3C,CAAC,CAAC;IAEFnB,EAAE,CAAC,8BAA8B,EAAE,YAAY;MAC5CW,4CAAwB,CAACC,oBAAoB,CAAeY,iBAAiB,CAC5E,IAAIC,KAAK,CAAC,eAAe,CAC3B,CAAC;MAED,MAAMX,QAAQ,GAAG,MAAM,IAAAC,kBAAO,EAACvB,GAAG,CAAC,CAACwB,GAAG,CAAC,uCAAuC,CAAC;MAEhFC,MAAM,CAACH,QAAQ,CAACI,MAAM,CAAC,CAACC,IAAI,CAAC,GAAG,CAAC;MACjCF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACC,OAAO,CAAC,CAACF,IAAI,CAAC,KAAK,CAAC;IAC3C,CAAC,CAAC;EACJ,CAAC,CAAC;EAEFtB,QAAQ,CAAC,kBAAkB,EAAE,MAAM;IACjCG,EAAE,CAAC,+CAA+C,EAAE,YAAY;MAC9D,MAAMC,WAAW,GAAG;QAClBC,MAAM,EAAE,SAAS;QACjBC,SAAS,EAAE,GAAG;QACdC,YAAY,EAAE,EAAE;QAChBC,QAAQ,EAAE,CAAC;QACXC,cAAc,EAAE,KAAK;QACrBC,SAAS,EAAE,GAAG;QACdC,aAAa,EAAE,EAAE;QACjBC,uBAAuB,EAAE,EAAE;QAC3BC,aAAa,EAAE;MACjB,CAAC;MAEAC,4CAAwB,CAACC,oBAAoB,CAAeC,iBAAiB,CAACZ,WAAW,CAAC;MAE3F,MAAMa,QAAQ,GAAG,MAAM,IAAAC,kBAAO,EAACvB,GAAG,CAAC,CAACwB,GAAG,CAAC,uCAAuC,CAAC;MAEhFC,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACE,IAAI,CAACnB,SAAS,CAAC,CAACgB,IAAI,CAAC,GAAG,CAAC;MAC9CF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACE,IAAI,CAAClB,YAAY,CAAC,CAACe,IAAI,CAAC,EAAE,CAAC;MAChDF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACE,IAAI,CAACjB,QAAQ,CAAC,CAACc,IAAI,CAAC,CAAC,CAAC;MAC3CF,MAAM,CAACH,QAAQ,CAACM,IAAI,CAACE,IAAI,CAAChB,cAAc,CAAC,CAACsB,WAAW,CAAC,KAAK,EAAE,CAAC,CAAC;IACjE,CAAC,CAAC;EACJ,CAAC,CAAC;AACJ,CAAC,CAAC","ignoreList":[]}