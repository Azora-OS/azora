{"version":3,"names":["shieldService","require","describe","beforeEach","threats","securityEvents","blockedIPs","clear","rateLimits","test","req","ip","method","url","query","id","body","headers","get","analysis","analyzeRequest","expect","length","toBeGreaterThan","some","t","type","toBe","riskScore","comment","i","isBlocked","isIPBlocked","blockIP","unblockIP","lowRiskReq","highRiskReq","lowRiskAnalysis","highRiskAnalysis","toBeLessThan","req1","req2","eventsByIP","getSecurityEvents","events","highRiskEvents","minRiskScore","stats","getThreatStats","totalEvents","totalThreats","Object","keys","threatTypes","removedCount","clearOldEvents"],"sources":["shield-service.test.js"],"sourcesContent":["const shieldService = require('../index');\n\ndescribe('Shield Service', () => {\n  beforeEach(() => {\n    // Clear data before each test\n    shieldService.threats = [];\n    shieldService.securityEvents = [];\n    shieldService.blockedIPs.clear();\n    shieldService.rateLimits.clear();\n  });\n\n  test('should detect SQL injection threats', () => {\n    const req = {\n      ip: '192.168.1.100',\n      method: 'GET',\n      url: '/api/users',\n      query: { id: \"1'; DROP TABLE users;\" },\n      body: {},\n      headers: {},\n      get: () => null\n    };\n\n    const analysis = shieldService.analyzeRequest(req);\n\n    expect(analysis.threats.length).toBeGreaterThan(0);\n    expect(analysis.threats.some(t => t.type === 'SQL_INJECTION')).toBe(true);\n    expect(analysis.riskScore).toBeGreaterThan(0);\n  });\n\n  test('should detect XSS threats', () => {\n    const req = {\n      ip: '192.168.1.100',\n      method: 'POST',\n      url: '/api/comments',\n      query: {},\n      body: { comment: '<script>alert(\"xss\")</script>' },\n      headers: {},\n      get: () => null\n    };\n\n    const analysis = shieldService.analyzeRequest(req);\n\n    expect(analysis.threats.length).toBeGreaterThan(0);\n    expect(analysis.threats.some(t => t.type === 'XSS')).toBe(true);\n    expect(analysis.riskScore).toBeGreaterThan(0);\n  });\n\n  test('should detect path traversal threats', () => {\n    const req = {\n      ip: '192.168.1.100',\n      method: 'GET',\n      url: '/api/files/../../../etc/passwd',\n      query: {},\n      body: {},\n      headers: {},\n      get: () => null\n    };\n\n    const analysis = shieldService.analyzeRequest(req);\n\n    expect(analysis.threats.length).toBeGreaterThan(0);\n    expect(analysis.threats.some(t => t.type === 'PATH_TRAVERSAL')).toBe(true);\n  });\n\n  test('should enforce rate limiting', () => {\n    const req = {\n      ip: '192.168.1.200',\n      method: 'GET',\n      url: '/api/data',\n      query: {},\n      body: {},\n      headers: {},\n      get: () => null\n    };\n\n    // Make many requests to trigger rate limiting\n    for (let i = 0; i < 150; i++) {\n      shieldService.analyzeRequest(req);\n    }\n\n    // Check if IP is blocked\n    const isBlocked = shieldService.isIPBlocked('192.168.1.200');\n    expect(isBlocked).toBe(true);\n  });\n\n  test('should block and unblock IP addresses', () => {\n    const ip = '192.168.1.150';\n\n    // Initially not blocked\n    expect(shieldService.isIPBlocked(ip)).toBe(false);\n\n    // Block IP\n    shieldService.blockIP(ip);\n    expect(shieldService.isIPBlocked(ip)).toBe(true);\n\n    // Unblock IP\n    shieldService.unblockIP(ip);\n    expect(shieldService.isIPBlocked(ip)).toBe(false);\n  });\n\n  test('should calculate risk scores correctly', () => {\n    const lowRiskReq = {\n      ip: '192.168.1.100',\n      method: 'GET',\n      url: '/api/users',\n      query: { id: 'normal-user-id' },\n      body: {},\n      headers: {},\n      get: () => null\n    };\n\n    const highRiskReq = {\n      ip: '192.168.1.101',\n      method: 'GET',\n      url: '/api/users',\n      query: { id: \"1'; DROP TABLE users;\" },\n      body: {},\n      headers: {},\n      get: () => null\n    };\n\n    const lowRiskAnalysis = shieldService.analyzeRequest(lowRiskReq);\n    const highRiskAnalysis = shieldService.analyzeRequest(highRiskReq);\n\n    expect(lowRiskAnalysis.riskScore).toBeLessThan(highRiskAnalysis.riskScore);\n  });\n\n  test('should filter security events', () => {\n    // Generate some test events\n    const req1 = {\n      ip: '192.168.1.100',\n      method: 'GET',\n      url: '/api/users',\n      query: { id: \"1'; DROP TABLE users;\" },\n      body: {},\n      headers: {},\n      get: () => null\n    };\n\n    const req2 = {\n      ip: '192.168.1.101',\n      method: 'POST',\n      url: '/api/comments',\n      query: {},\n      body: { comment: '<script>alert(\"xss\")</script>' },\n      headers: {},\n      get: () => null\n    };\n\n    shieldService.analyzeRequest(req1);\n    shieldService.analyzeRequest(req2);\n\n    // Filter by IP\n    const eventsByIP = shieldService.getSecurityEvents({ ip: '192.168.1.100' });\n    expect(eventsByIP.events.length).toBe(1);\n    expect(eventsByIP.events[0].ip).toBe('192.168.1.100');\n\n    // Filter by minimum risk score\n    const highRiskEvents = shieldService.getSecurityEvents({ minRiskScore: 5 });\n    expect(highRiskEvents.events.length).toBe(2);\n  });\n\n  test('should generate threat statistics', () => {\n    // Generate some test events\n    const req1 = {\n      ip: '192.168.1.100',\n      method: 'GET',\n      url: '/api/users',\n      query: { id: \"1'; DROP TABLE users;\" },\n      body: {},\n      headers: {},\n      get: () => null\n    };\n\n    const req2 = {\n      ip: '192.168.1.101',\n      method: 'POST',\n      url: '/api/comments',\n      query: {},\n      body: { comment: '<script>alert(\"xss\")</script>' },\n      headers: {},\n      get: () => null\n    };\n\n    shieldService.analyzeRequest(req1);\n    shieldService.analyzeRequest(req2);\n\n    const stats = shieldService.getThreatStats();\n\n    expect(stats.totalEvents).toBe(2);\n    expect(stats.totalThreats).toBe(2);\n    expect(Object.keys(stats.threatTypes).length).toBeGreaterThan(0);\n  });\n\n  test('should clear old events', () => {\n    // Generate some test events\n    const req = {\n      ip: '192.168.1.100',\n      method: 'GET',\n      url: '/api/users',\n      query: { id: 'normal-id' },\n      body: {},\n      headers: {},\n      get: () => null\n    };\n\n    shieldService.analyzeRequest(req);\n\n    expect(shieldService.securityEvents.length).toBe(1);\n\n    // Clear old events\n    const removedCount = shieldService.clearOldEvents(0); // Clear all events\n\n    expect(removedCount).toBe(1);\n    expect(shieldService.securityEvents.length).toBe(0);\n  });\n});\n"],"mappings":"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","ignoreList":[]}