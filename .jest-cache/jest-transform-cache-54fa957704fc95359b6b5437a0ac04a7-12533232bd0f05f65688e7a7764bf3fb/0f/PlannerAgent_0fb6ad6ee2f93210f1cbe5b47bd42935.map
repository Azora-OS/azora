{"version":3,"names":["PlannerAgent","constructor","aiOrchestrator","planTask","userPrompt","context","console","log","planningPrompt","buildPlanningPrompt","response","generateCode","tasks","parsePlan","content","dependencies","buildDependencyGraph","estimatedDuration","reduce","sum","task","rollbackPoints","map","rollbackPoint","aiResponse","jsonMatch","match","Error","parsed","JSON","parse","index","id","description","type","targetFiles","error","graph","Map","set","getExecutionOrder","dag","executed","Set","order","visit","taskId","has","deps","get","depId","find","t","push","add","validateDAG","errors","visited","recursionStack","hasCycle","delete","valid","length","exports"],"sources":["PlannerAgent.ts"],"sourcesContent":["import { AIOrchestrator, AIContext } from './AIOrchestrator';\n\nexport interface Task {\n  id: string;\n  description: string;\n  type: 'create' | 'modify' | 'delete' | 'refactor';\n  targetFiles: string[];\n  dependencies: string[];\n  rollbackPoint: string;\n  estimatedDuration: number;\n}\n\nexport interface TaskDAG {\n  tasks: Task[];\n  dependencies: Map<string, string[]>;\n  rollbackPoints: string[];\n  estimatedDuration: number;\n}\n\nexport class PlannerAgent {\n  private aiOrchestrator: AIOrchestrator;\n\n  constructor(aiOrchestrator: AIOrchestrator) {\n    this.aiOrchestrator = aiOrchestrator;\n  }\n\n  async planTask(userPrompt: string, context: AIContext): Promise<TaskDAG> {\n    console.log('Planning task:', userPrompt);\n\n    // Generate plan using AI\n    const planningPrompt = this.buildPlanningPrompt(userPrompt);\n    const response = await this.aiOrchestrator.generateCode(planningPrompt, context);\n\n    // Parse AI response into tasks\n    const tasks = this.parsePlan(response.content);\n\n    // Build dependency graph\n    const dependencies = this.buildDependencyGraph(tasks);\n\n    // Calculate estimated duration\n    const estimatedDuration = tasks.reduce((sum, task) => sum + task.estimatedDuration, 0);\n\n    // Identify rollback points\n    const rollbackPoints = tasks.map(task => task.rollbackPoint);\n\n    return {\n      tasks,\n      dependencies,\n      rollbackPoints,\n      estimatedDuration,\n    };\n  }\n\n  private buildPlanningPrompt(userPrompt: string): string {\n    return `\nYou are a software development planner. Break down the following task into a series of concrete, actionable steps.\n\nTask: ${userPrompt}\n\nFor each step, provide:\n1. A clear description of what needs to be done\n2. The type of operation (create, modify, delete, refactor)\n3. Which files will be affected\n4. Dependencies on other steps\n5. Estimated duration in minutes\n\nFormat your response as a JSON array of tasks:\n[\n  {\n    \"id\": \"task-1\",\n    \"description\": \"Create user model with TypeScript interfaces\",\n    \"type\": \"create\",\n    \"targetFiles\": [\"src/models/User.ts\"],\n    \"dependencies\": [],\n    \"estimatedDuration\": 5\n  },\n  {\n    \"id\": \"task-2\",\n    \"description\": \"Implement user service with CRUD operations\",\n    \"type\": \"create\",\n    \"targetFiles\": [\"src/services/UserService.ts\"],\n    \"dependencies\": [\"task-1\"],\n    \"estimatedDuration\": 10\n  }\n]\n\nImportant:\n- Each task should be small and focused (5-15 minutes)\n- Tasks should build on each other incrementally\n- Include proper error handling and validation\n- Follow TypeScript and modern JavaScript best practices\n`;\n  }\n\n  private parsePlan(aiResponse: string): Task[] {\n    try {\n      // Extract JSON from response (AI might include explanation text)\n      const jsonMatch = aiResponse.match(/\\[[\\s\\S]*\\]/);\n      if (!jsonMatch) {\n        throw new Error('No JSON array found in AI response');\n      }\n\n      const parsed = JSON.parse(jsonMatch[0]);\n      \n      return parsed.map((task: any, index: number) => ({\n        id: task.id || `task-${index + 1}`,\n        description: task.description,\n        type: task.type || 'modify',\n        targetFiles: task.targetFiles || [],\n        dependencies: task.dependencies || [],\n        rollbackPoint: `rollback-${task.id || index + 1}`,\n        estimatedDuration: task.estimatedDuration || 10,\n      }));\n    } catch (error) {\n      console.error('Failed to parse AI plan:', error);\n      \n      // Fallback: create a single task\n      return [{\n        id: 'task-1',\n        description: 'Complete the requested task',\n        type: 'modify',\n        targetFiles: [],\n        dependencies: [],\n        rollbackPoint: 'rollback-1',\n        estimatedDuration: 15,\n      }];\n    }\n  }\n\n  private buildDependencyGraph(tasks: Task[]): Map<string, string[]> {\n    const graph = new Map<string, string[]>();\n    \n    for (const task of tasks) {\n      graph.set(task.id, task.dependencies);\n    }\n    \n    return graph;\n  }\n\n  getExecutionOrder(dag: TaskDAG): Task[] {\n    const { tasks, dependencies } = dag;\n    const executed = new Set<string>();\n    const order: Task[] = [];\n\n    // Topological sort\n    const visit = (taskId: string) => {\n      if (executed.has(taskId)) return;\n\n      const deps = dependencies.get(taskId) || [];\n      for (const depId of deps) {\n        visit(depId);\n      }\n\n      const task = tasks.find(t => t.id === taskId);\n      if (task) {\n        order.push(task);\n        executed.add(taskId);\n      }\n    };\n\n    for (const task of tasks) {\n      visit(task.id);\n    }\n\n    return order;\n  }\n\n  validateDAG(dag: TaskDAG): { valid: boolean; errors: string[] } {\n    const errors: string[] = [];\n\n    // Check for circular dependencies\n    const visited = new Set<string>();\n    const recursionStack = new Set<string>();\n\n    const hasCycle = (taskId: string): boolean => {\n      visited.add(taskId);\n      recursionStack.add(taskId);\n\n      const deps = dag.dependencies.get(taskId) || [];\n      for (const depId of deps) {\n        if (!visited.has(depId)) {\n          if (hasCycle(depId)) return true;\n        } else if (recursionStack.has(depId)) {\n          return true;\n        }\n      }\n\n      recursionStack.delete(taskId);\n      return false;\n    };\n\n    for (const task of dag.tasks) {\n      if (!visited.has(task.id) && hasCycle(task.id)) {\n        errors.push(`Circular dependency detected involving task: ${task.id}`);\n      }\n    }\n\n    // Check for missing dependencies\n    for (const task of dag.tasks) {\n      for (const depId of task.dependencies) {\n        if (!dag.tasks.find(t => t.id === depId)) {\n          errors.push(`Task ${task.id} depends on non-existent task: ${depId}`);\n        }\n      }\n    }\n\n    return {\n      valid: errors.length === 0,\n      errors,\n    };\n  }\n}\n"],"mappings":"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","ignoreList":[]}