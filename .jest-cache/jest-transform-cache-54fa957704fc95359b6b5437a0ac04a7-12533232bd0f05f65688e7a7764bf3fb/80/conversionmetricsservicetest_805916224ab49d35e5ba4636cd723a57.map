{"version":3,"names":["_getJestObj","mock","PrismaClient","jest","fn","user","groupBy","count","payment","aggregate","_conversionMetrics","require","_client","describe","mockPrisma","beforeEach","clearAllMocks","it","mockResolvedValue","tier","_count","id","_avg","amount","_sum","metrics","conversionMetricsService","getConversionMetrics","expect","toHaveProperty","period","toBe","conversionRate","toBeCloseTo","lifetimeValue"],"sources":["conversion-metrics.service.test.ts"],"sourcesContent":["import { conversionMetricsService } from '../conversion-metrics.service';\r\nimport { PrismaClient } from '@prisma/client';\r\n\r\n// Mock Prisma\r\njest.mock('@prisma/client', () => ({\r\n  PrismaClient: jest.fn(() => ({\r\n    user: {\r\n      groupBy: jest.fn(),\r\n      count: jest.fn(),\r\n    },\r\n    payment: {\r\n      aggregate: jest.fn(),\r\n    },\r\n  })),\r\n}));\r\n\r\ndescribe('ConversionMetricsService', () => {\r\n  let mockPrisma: any;\r\n\r\n  beforeEach(() => {\r\n    jest.clearAllMocks();\r\n    mockPrisma = new PrismaClient();\r\n  });\r\n\r\n  describe('getConversionMetrics', () => {\r\n    it('should calculate conversion metrics for a given period', async () => {\r\n      // Mock user counts by tier\r\n      mockPrisma.user.groupBy.mockResolvedValue([\r\n        { tier: 'free', _count: { id: 100 } },\r\n        { tier: 'premium', _count: { id: 30 } },\r\n        { tier: 'pro', _count: { id: 5 } },\r\n      ]);\r\n\r\n      mockPrisma.user.count.mockResolvedValue(135);\r\n      mockPrisma.payment.aggregate.mockResolvedValue({\r\n        _avg: { amount: 50 },\r\n        _sum: { amount: 6750 },\r\n        _count: { id: 135 },\r\n      });\r\n\r\n      const metrics = await conversionMetricsService.getConversionMetrics('2024-01');\r\n\r\n      expect(metrics).toHaveProperty('period', '2024-01');\r\n      expect(metrics).toHaveProperty('freeUsers', 100);\r\n      expect(metrics).toHaveProperty('premiumUsers', 30);\r\n      expect(metrics).toHaveProperty('proUsers', 5);\r\n      expect(metrics).toHaveProperty('conversionRate');\r\n      expect(metrics).toHaveProperty('churnRate');\r\n      expect(metrics).toHaveProperty('lifetimeValue');\r\n      expect(metrics).toHaveProperty('customerAcquisitionCost');\r\n      expect(metrics).toHaveProperty('paybackPeriod');\r\n    });\r\n\r\n    it('should handle quarter format period', async () => {\r\n      mockPrisma.user.groupBy.mockResolvedValue([\r\n        { tier: 'free', _count: { id: 100 } },\r\n        { tier: 'premium', _count: { id: 30 } },\r\n      ]);\r\n\r\n      mockPrisma.user.count.mockResolvedValue(130);\r\n      mockPrisma.payment.aggregate.mockResolvedValue({\r\n        _avg: { amount: 50 },\r\n        _sum: { amount: 6500 },\r\n        _count: { id: 130 },\r\n      });\r\n\r\n      const metrics = await conversionMetricsService.getConversionMetrics('2024-Q1');\r\n\r\n      expect(metrics.period).toBe('2024-Q1');\r\n    });\r\n\r\n    it('should handle year format period', async () => {\r\n      mockPrisma.user.groupBy.mockResolvedValue([\r\n        { tier: 'free', _count: { id: 1000 } },\r\n        { tier: 'premium', _count: { id: 300 } },\r\n      ]);\r\n\r\n      mockPrisma.user.count.mockResolvedValue(1300);\r\n      mockPrisma.payment.aggregate.mockResolvedValue({\r\n        _avg: { amount: 50 },\r\n        _sum: { amount: 65000 },\r\n        _count: { id: 1300 },\r\n      });\r\n\r\n      const metrics = await conversionMetricsService.getConversionMetrics('2024');\r\n\r\n      expect(metrics.period).toBe('2024');\r\n    });\r\n\r\n    it('should calculate conversion rate correctly', async () => {\r\n      mockPrisma.user.groupBy.mockResolvedValue([\r\n        { tier: 'free', _count: { id: 70 } },\r\n        { tier: 'premium', _count: { id: 30 } },\r\n      ]);\r\n\r\n      mockPrisma.user.count.mockResolvedValue(100);\r\n      mockPrisma.payment.aggregate.mockResolvedValue({\r\n        _avg: { amount: 50 },\r\n        _sum: { amount: 5000 },\r\n        _count: { id: 100 },\r\n      });\r\n\r\n      const metrics = await conversionMetricsService.getConversionMetrics('2024-01');\r\n\r\n      // Conversion rate should be 30 / (70 + 30) * 100 = 30%\r\n      expect(metrics.conversionRate).toBeCloseTo(30, 1);\r\n    });\r\n\r\n    it('should return 0 for conversion rate when no users', async () => {\r\n      mockPrisma.user.groupBy.mockResolvedValue([]);\r\n      mockPrisma.user.count.mockResolvedValue(0);\r\n      mockPrisma.payment.aggregate.mockResolvedValue({\r\n        _avg: { amount: 0 },\r\n        _sum: { amount: 0 },\r\n        _count: { id: 0 },\r\n      });\r\n\r\n      const metrics = await conversionMetricsService.getConversionMetrics('2024-01');\r\n\r\n      expect(metrics.conversionRate).toBe(0);\r\n      expect(metrics.lifetimeValue).toBe(0);\r\n    });\r\n  });\r\n\r\n  describe('Period parsing', () => {\r\n    it('should parse month format correctly', async () => {\r\n      mockPrisma.user.groupBy.mockResolvedValue([\r\n        { tier: 'free', _count: { id: 100 } },\r\n      ]);\r\n\r\n      mockPrisma.user.count.mockResolvedValue(100);\r\n      mockPrisma.payment.aggregate.mockResolvedValue({\r\n        _avg: { amount: 0 },\r\n        _sum: { amount: 0 },\r\n        _count: { id: 0 },\r\n      });\r\n\r\n      const metrics = await conversionMetricsService.getConversionMetrics('2024-01');\r\n      expect(metrics.period).toBe('2024-01');\r\n    });\r\n\r\n    it('should parse quarter format correctly', async () => {\r\n      mockPrisma.user.groupBy.mockResolvedValue([\r\n        { tier: 'free', _count: { id: 100 } },\r\n      ]);\r\n\r\n      mockPrisma.user.count.mockResolvedValue(100);\r\n      mockPrisma.payment.aggregate.mockResolvedValue({\r\n        _avg: { amount: 0 },\r\n        _sum: { amount: 0 },\r\n        _count: { id: 0 },\r\n      });\r\n\r\n      const metrics = await conversionMetricsService.getConversionMetrics('2024-Q2');\r\n      expect(metrics.period).toBe('2024-Q2');\r\n    });\r\n\r\n    it('should parse year format correctly', async () => {\r\n      mockPrisma.user.groupBy.mockResolvedValue([\r\n        { tier: 'free', _count: { id: 100 } },\r\n      ]);\r\n\r\n      mockPrisma.user.count.mockResolvedValue(100);\r\n      mockPrisma.payment.aggregate.mockResolvedValue({\r\n        _avg: { amount: 0 },\r\n        _sum: { amount: 0 },\r\n        _count: { id: 0 },\r\n      });\r\n\r\n      const metrics = await conversionMetricsService.getConversionMetrics('2024');\r\n      expect(metrics.period).toBe('2024');\r\n    });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}