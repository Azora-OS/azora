796d0de64b3f2b24daa0b31f7a6e4b2d
"use strict";

// Mock dependencies
_getJestObj().mock('../ContextManager');
_getJestObj().mock('../PlannerAgent');
_getJestObj().mock('../CodeGeneratorAgent');
var _AIOrchestrator = require("../AIOrchestrator");
var _ContextManager = require("../ContextManager");
var _PlannerAgent = require("../PlannerAgent");
var _CodeGeneratorAgent = require("../CodeGeneratorAgent");
function _getJestObj() {
  const {
    jest
  } = require("@jest/globals");
  _getJestObj = () => jest;
  return jest;
}
describe('AIOrchestrator', () => {
  let orchestrator;
  let mockContextManager;
  let mockPlannerAgent;
  let mockCodeGenerator;
  beforeEach(() => {
    mockContextManager = new _ContextManager.ContextManager('/test/project');
    mockPlannerAgent = new _PlannerAgent.PlannerAgent();
    mockCodeGenerator = new _CodeGeneratorAgent.CodeGeneratorAgent();
    orchestrator = new _AIOrchestrator.AIOrchestrator('/test/project');
    orchestrator.contextManager = mockContextManager;
    orchestrator.plannerAgent = mockPlannerAgent;
    orchestrator.codeGenerator = mockCodeGenerator;
    jest.clearAllMocks();
  });
  describe('planTask', () => {
    it('should generate a task DAG from user prompt', async () => {
      const prompt = 'Add authentication to the user service';
      const mockContext = {
        files: ['/test/project/src/user-service.ts'],
        projectInfo: {
          frameworks: ['express', 'typescript']
        }
      };
      const mockDAG = {
        tasks: [{
          id: 'task-1',
          type: 'create-file',
          description: 'Create auth middleware',
          dependencies: [],
          rollbackPoint: 'before-task-1',
          operations: [],
          verification: [],
          estimatedDuration: 30
        }],
        dependencies: new Map([['task-1', []]]),
        rollbackPoints: ['before-task-1'],
        estimatedDuration: 30
      };
      mockContextManager.buildContext = jest.fn().mockResolvedValue(mockContext);
      mockPlannerAgent.generatePlan = jest.fn().mockResolvedValue(mockDAG);
      const result = await orchestrator.planTask(prompt, mockContext);
      expect(result).toBeDefined();
      expect(result.tasks.length).toBe(1);
      expect(result.tasks[0].description).toBe('Create auth middleware');
      expect(mockContextManager.buildContext).toHaveBeenCalled();
      expect(mockPlannerAgent.generatePlan).toHaveBeenCalledWith(prompt, mockContext);
    });
    it('should handle planning errors gracefully', async () => {
      const prompt = 'Invalid task';
      const mockContext = {
        files: [],
        projectInfo: {}
      };
      mockContextManager.buildContext = jest.fn().mockResolvedValue(mockContext);
      mockPlannerAgent.generatePlan = jest.fn().mockRejectedValue(new Error('Planning failed'));
      await expect(orchestrator.planTask(prompt, mockContext)).rejects.toThrow('Planning failed');
    });
  });
  describe('executeTask', () => {
    it('should execute a task successfully', async () => {
      const task = {
        id: 'task-1',
        type: 'create-file',
        description: 'Create test file',
        dependencies: [],
        rollbackPoint: 'before-task-1',
        operations: [{
          type: 'create',
          target: '/test/project/src/test.ts',
          action: {
            code: 'export function test() {}'
          },
          reversible: true
        }],
        verification: [],
        estimatedDuration: 10
      };
      mockCodeGenerator.executeOperation = jest.fn().mockResolvedValue({
        success: true,
        output: 'File created successfully'
      });
      const result = await orchestrator.executeTask(task);
      expect(result.success).toBe(true);
      expect(result.taskId).toBe('task-1');
      expect(mockCodeGenerator.executeOperation).toHaveBeenCalled();
    });
    it('should rollback on execution failure', async () => {
      const task = {
        id: 'task-1',
        type: 'modify-file',
        description: 'Modify test file',
        dependencies: [],
        rollbackPoint: 'before-task-1',
        operations: [{
          type: 'modify',
          target: '/test/project/src/test.ts',
          action: {
            code: 'invalid syntax'
          },
          reversible: true
        }],
        verification: [],
        estimatedDuration: 10
      };
      mockCodeGenerator.executeOperation = jest.fn().mockRejectedValue(new Error('Execution failed'));
      const result = await orchestrator.executeTask(task);
      expect(result.success).toBe(false);
      expect(result.error).toBeDefined();
    });
  });
  describe('selectModel', () => {
    it('should select GPT-4 for complex tasks', () => {
      const model = orchestrator.selectModel('refactor');
      expect(model).toBe('gpt-4-turbo');
    });
    it('should select Claude for code generation', () => {
      const model = orchestrator.selectModel('generate-code');
      expect(model).toBe('claude-3-opus');
    });
    it('should select GPT-3.5 for simple tasks', () => {
      const model = orchestrator.selectModel('simple');
      expect(model).toBe('gpt-3.5-turbo');
    });
  });
  describe('estimateCost', () => {
    it('should estimate cost based on prompt length', async () => {
      const prompt = 'Test prompt';
      const cost = await orchestrator.estimateCost(prompt);
      expect(cost).toBeGreaterThan(0);
      expect(typeof cost).toBe('number');
    });
    it('should return higher cost for longer prompts', async () => {
      const shortPrompt = 'Short';
      const longPrompt = 'This is a much longer prompt that should cost more to process';
      const shortCost = await orchestrator.estimateCost(shortPrompt);
      const longCost = await orchestrator.estimateCost(longPrompt);
      expect(longCost).toBeGreaterThan(shortCost);
    });
  });
  describe('caching', () => {
    it('should cache AI responses', async () => {
      const prompt = 'Test prompt';
      const response = 'Test response';
      await orchestrator.cacheResponse(prompt, response);
      const cached = await orchestrator.getCachedResponse(prompt);
      expect(cached).toBe(response);
    });
    it('should return null for uncached prompts', async () => {
      const cached = await orchestrator.getCachedResponse('non-existent');
      expect(cached).toBeNull();
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZ2V0SmVzdE9iaiIsIm1vY2siLCJfQUlPcmNoZXN0cmF0b3IiLCJyZXF1aXJlIiwiX0NvbnRleHRNYW5hZ2VyIiwiX1BsYW5uZXJBZ2VudCIsIl9Db2RlR2VuZXJhdG9yQWdlbnQiLCJqZXN0IiwiZGVzY3JpYmUiLCJvcmNoZXN0cmF0b3IiLCJtb2NrQ29udGV4dE1hbmFnZXIiLCJtb2NrUGxhbm5lckFnZW50IiwibW9ja0NvZGVHZW5lcmF0b3IiLCJiZWZvcmVFYWNoIiwiQ29udGV4dE1hbmFnZXIiLCJQbGFubmVyQWdlbnQiLCJDb2RlR2VuZXJhdG9yQWdlbnQiLCJBSU9yY2hlc3RyYXRvciIsImNvbnRleHRNYW5hZ2VyIiwicGxhbm5lckFnZW50IiwiY29kZUdlbmVyYXRvciIsImNsZWFyQWxsTW9ja3MiLCJpdCIsInByb21wdCIsIm1vY2tDb250ZXh0IiwiZmlsZXMiLCJwcm9qZWN0SW5mbyIsImZyYW1ld29ya3MiLCJtb2NrREFHIiwidGFza3MiLCJpZCIsInR5cGUiLCJkZXNjcmlwdGlvbiIsImRlcGVuZGVuY2llcyIsInJvbGxiYWNrUG9pbnQiLCJvcGVyYXRpb25zIiwidmVyaWZpY2F0aW9uIiwiZXN0aW1hdGVkRHVyYXRpb24iLCJNYXAiLCJyb2xsYmFja1BvaW50cyIsImJ1aWxkQ29udGV4dCIsImZuIiwibW9ja1Jlc29sdmVkVmFsdWUiLCJnZW5lcmF0ZVBsYW4iLCJyZXN1bHQiLCJwbGFuVGFzayIsImV4cGVjdCIsInRvQmVEZWZpbmVkIiwibGVuZ3RoIiwidG9CZSIsInRvSGF2ZUJlZW5DYWxsZWQiLCJ0b0hhdmVCZWVuQ2FsbGVkV2l0aCIsIm1vY2tSZWplY3RlZFZhbHVlIiwiRXJyb3IiLCJyZWplY3RzIiwidG9UaHJvdyIsInRhc2siLCJ0YXJnZXQiLCJhY3Rpb24iLCJjb2RlIiwicmV2ZXJzaWJsZSIsImV4ZWN1dGVPcGVyYXRpb24iLCJzdWNjZXNzIiwib3V0cHV0IiwiZXhlY3V0ZVRhc2siLCJ0YXNrSWQiLCJlcnJvciIsIm1vZGVsIiwic2VsZWN0TW9kZWwiLCJjb3N0IiwiZXN0aW1hdGVDb3N0IiwidG9CZUdyZWF0ZXJUaGFuIiwic2hvcnRQcm9tcHQiLCJsb25nUHJvbXB0Iiwic2hvcnRDb3N0IiwibG9uZ0Nvc3QiLCJyZXNwb25zZSIsImNhY2hlUmVzcG9uc2UiLCJjYWNoZWQiLCJnZXRDYWNoZWRSZXNwb25zZSIsInRvQmVOdWxsIl0sInNvdXJjZXMiOlsiQUlPcmNoZXN0cmF0b3IudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBSU9yY2hlc3RyYXRvciwgVGFzaywgVGFza0RBRywgQUlNb2RlbCB9IGZyb20gJy4uL0FJT3JjaGVzdHJhdG9yJztcbmltcG9ydCB7IENvbnRleHRNYW5hZ2VyIH0gZnJvbSAnLi4vQ29udGV4dE1hbmFnZXInO1xuaW1wb3J0IHsgUGxhbm5lckFnZW50IH0gZnJvbSAnLi4vUGxhbm5lckFnZW50JztcbmltcG9ydCB7IENvZGVHZW5lcmF0b3JBZ2VudCB9IGZyb20gJy4uL0NvZGVHZW5lcmF0b3JBZ2VudCc7XG5cbi8vIE1vY2sgZGVwZW5kZW5jaWVzXG5qZXN0Lm1vY2soJy4uL0NvbnRleHRNYW5hZ2VyJyk7XG5qZXN0Lm1vY2soJy4uL1BsYW5uZXJBZ2VudCcpO1xuamVzdC5tb2NrKCcuLi9Db2RlR2VuZXJhdG9yQWdlbnQnKTtcblxuZGVzY3JpYmUoJ0FJT3JjaGVzdHJhdG9yJywgKCkgPT4ge1xuICBsZXQgb3JjaGVzdHJhdG9yOiBBSU9yY2hlc3RyYXRvcjtcbiAgbGV0IG1vY2tDb250ZXh0TWFuYWdlcjogamVzdC5Nb2NrZWQ8Q29udGV4dE1hbmFnZXI+O1xuICBsZXQgbW9ja1BsYW5uZXJBZ2VudDogamVzdC5Nb2NrZWQ8UGxhbm5lckFnZW50PjtcbiAgbGV0IG1vY2tDb2RlR2VuZXJhdG9yOiBqZXN0Lk1vY2tlZDxDb2RlR2VuZXJhdG9yQWdlbnQ+O1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIG1vY2tDb250ZXh0TWFuYWdlciA9IG5ldyBDb250ZXh0TWFuYWdlcignL3Rlc3QvcHJvamVjdCcpIGFzIGplc3QuTW9ja2VkPENvbnRleHRNYW5hZ2VyPjtcbiAgICBtb2NrUGxhbm5lckFnZW50ID0gbmV3IFBsYW5uZXJBZ2VudCgpIGFzIGplc3QuTW9ja2VkPFBsYW5uZXJBZ2VudD47XG4gICAgbW9ja0NvZGVHZW5lcmF0b3IgPSBuZXcgQ29kZUdlbmVyYXRvckFnZW50KCkgYXMgamVzdC5Nb2NrZWQ8Q29kZUdlbmVyYXRvckFnZW50PjtcbiAgICBcbiAgICBvcmNoZXN0cmF0b3IgPSBuZXcgQUlPcmNoZXN0cmF0b3IoJy90ZXN0L3Byb2plY3QnKTtcbiAgICAob3JjaGVzdHJhdG9yIGFzIGFueSkuY29udGV4dE1hbmFnZXIgPSBtb2NrQ29udGV4dE1hbmFnZXI7XG4gICAgKG9yY2hlc3RyYXRvciBhcyBhbnkpLnBsYW5uZXJBZ2VudCA9IG1vY2tQbGFubmVyQWdlbnQ7XG4gICAgKG9yY2hlc3RyYXRvciBhcyBhbnkpLmNvZGVHZW5lcmF0b3IgPSBtb2NrQ29kZUdlbmVyYXRvcjtcbiAgICBcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3BsYW5UYXNrJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgYSB0YXNrIERBRyBmcm9tIHVzZXIgcHJvbXB0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcHJvbXB0ID0gJ0FkZCBhdXRoZW50aWNhdGlvbiB0byB0aGUgdXNlciBzZXJ2aWNlJztcbiAgICAgIGNvbnN0IG1vY2tDb250ZXh0ID0ge1xuICAgICAgICBmaWxlczogWycvdGVzdC9wcm9qZWN0L3NyYy91c2VyLXNlcnZpY2UudHMnXSxcbiAgICAgICAgcHJvamVjdEluZm86IHsgZnJhbWV3b3JrczogWydleHByZXNzJywgJ3R5cGVzY3JpcHQnXSB9LFxuICAgICAgfTtcblxuICAgICAgY29uc3QgbW9ja0RBRzogVGFza0RBRyA9IHtcbiAgICAgICAgdGFza3M6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpZDogJ3Rhc2stMScsXG4gICAgICAgICAgICB0eXBlOiAnY3JlYXRlLWZpbGUnLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246ICdDcmVhdGUgYXV0aCBtaWRkbGV3YXJlJyxcbiAgICAgICAgICAgIGRlcGVuZGVuY2llczogW10sXG4gICAgICAgICAgICByb2xsYmFja1BvaW50OiAnYmVmb3JlLXRhc2stMScsXG4gICAgICAgICAgICBvcGVyYXRpb25zOiBbXSxcbiAgICAgICAgICAgIHZlcmlmaWNhdGlvbjogW10sXG4gICAgICAgICAgICBlc3RpbWF0ZWREdXJhdGlvbjogMzAsXG4gICAgICAgICAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgZGVwZW5kZW5jaWVzOiBuZXcgTWFwKFtbJ3Rhc2stMScsIFtdXV0pLFxuICAgICAgICByb2xsYmFja1BvaW50czogWydiZWZvcmUtdGFzay0xJ10sXG4gICAgICAgIGVzdGltYXRlZER1cmF0aW9uOiAzMCxcbiAgICAgIH07XG5cbiAgICAgIG1vY2tDb250ZXh0TWFuYWdlci5idWlsZENvbnRleHQgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUobW9ja0NvbnRleHQpO1xuICAgICAgbW9ja1BsYW5uZXJBZ2VudC5nZW5lcmF0ZVBsYW4gPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUobW9ja0RBRyk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG9yY2hlc3RyYXRvci5wbGFuVGFzayhwcm9tcHQsIG1vY2tDb250ZXh0IGFzIGFueSk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocmVzdWx0LnRhc2tzLmxlbmd0aCkudG9CZSgxKTtcbiAgICAgIGV4cGVjdChyZXN1bHQudGFza3NbMF0uZGVzY3JpcHRpb24pLnRvQmUoJ0NyZWF0ZSBhdXRoIG1pZGRsZXdhcmUnKTtcbiAgICAgIGV4cGVjdChtb2NrQ29udGV4dE1hbmFnZXIuYnVpbGRDb250ZXh0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgICBleHBlY3QobW9ja1BsYW5uZXJBZ2VudC5nZW5lcmF0ZVBsYW4pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHByb21wdCwgbW9ja0NvbnRleHQpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgcGxhbm5pbmcgZXJyb3JzIGdyYWNlZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwcm9tcHQgPSAnSW52YWxpZCB0YXNrJztcbiAgICAgIGNvbnN0IG1vY2tDb250ZXh0ID0geyBmaWxlczogW10sIHByb2plY3RJbmZvOiB7fSB9O1xuXG4gICAgICBtb2NrQ29udGV4dE1hbmFnZXIuYnVpbGRDb250ZXh0ID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tDb250ZXh0KTtcbiAgICAgIG1vY2tQbGFubmVyQWdlbnQuZ2VuZXJhdGVQbGFuID0gamVzdC5mbigpLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignUGxhbm5pbmcgZmFpbGVkJykpO1xuXG4gICAgICBhd2FpdCBleHBlY3Qob3JjaGVzdHJhdG9yLnBsYW5UYXNrKHByb21wdCwgbW9ja0NvbnRleHQgYXMgYW55KSkucmVqZWN0cy50b1Rocm93KCdQbGFubmluZyBmYWlsZWQnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2V4ZWN1dGVUYXNrJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBhIHRhc2sgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdGFzazogVGFzayA9IHtcbiAgICAgICAgaWQ6ICd0YXNrLTEnLFxuICAgICAgICB0eXBlOiAnY3JlYXRlLWZpbGUnLFxuICAgICAgICBkZXNjcmlwdGlvbjogJ0NyZWF0ZSB0ZXN0IGZpbGUnLFxuICAgICAgICBkZXBlbmRlbmNpZXM6IFtdLFxuICAgICAgICByb2xsYmFja1BvaW50OiAnYmVmb3JlLXRhc2stMScsXG4gICAgICAgIG9wZXJhdGlvbnM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0eXBlOiAnY3JlYXRlJyxcbiAgICAgICAgICAgIHRhcmdldDogJy90ZXN0L3Byb2plY3Qvc3JjL3Rlc3QudHMnLFxuICAgICAgICAgICAgYWN0aW9uOiB7IGNvZGU6ICdleHBvcnQgZnVuY3Rpb24gdGVzdCgpIHt9JyB9LFxuICAgICAgICAgICAgcmV2ZXJzaWJsZTogdHJ1ZSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgICB2ZXJpZmljYXRpb246IFtdLFxuICAgICAgICBlc3RpbWF0ZWREdXJhdGlvbjogMTAsXG4gICAgICB9O1xuXG4gICAgICBtb2NrQ29kZUdlbmVyYXRvci5leGVjdXRlT3BlcmF0aW9uID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgb3V0cHV0OiAnRmlsZSBjcmVhdGVkIHN1Y2Nlc3NmdWxseScsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgb3JjaGVzdHJhdG9yLmV4ZWN1dGVUYXNrKHRhc2spO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QocmVzdWx0LnRhc2tJZCkudG9CZSgndGFzay0xJyk7XG4gICAgICBleHBlY3QobW9ja0NvZGVHZW5lcmF0b3IuZXhlY3V0ZU9wZXJhdGlvbikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByb2xsYmFjayBvbiBleGVjdXRpb24gZmFpbHVyZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHRhc2s6IFRhc2sgPSB7XG4gICAgICAgIGlkOiAndGFzay0xJyxcbiAgICAgICAgdHlwZTogJ21vZGlmeS1maWxlJyxcbiAgICAgICAgZGVzY3JpcHRpb246ICdNb2RpZnkgdGVzdCBmaWxlJyxcbiAgICAgICAgZGVwZW5kZW5jaWVzOiBbXSxcbiAgICAgICAgcm9sbGJhY2tQb2ludDogJ2JlZm9yZS10YXNrLTEnLFxuICAgICAgICBvcGVyYXRpb25zOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgdHlwZTogJ21vZGlmeScsXG4gICAgICAgICAgICB0YXJnZXQ6ICcvdGVzdC9wcm9qZWN0L3NyYy90ZXN0LnRzJyxcbiAgICAgICAgICAgIGFjdGlvbjogeyBjb2RlOiAnaW52YWxpZCBzeW50YXgnIH0sXG4gICAgICAgICAgICByZXZlcnNpYmxlOiB0cnVlLFxuICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgICAgIHZlcmlmaWNhdGlvbjogW10sXG4gICAgICAgIGVzdGltYXRlZER1cmF0aW9uOiAxMCxcbiAgICAgIH07XG5cbiAgICAgIG1vY2tDb2RlR2VuZXJhdG9yLmV4ZWN1dGVPcGVyYXRpb24gPSBqZXN0LmZuKCkubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdFeGVjdXRpb24gZmFpbGVkJykpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBvcmNoZXN0cmF0b3IuZXhlY3V0ZVRhc2sodGFzayk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QocmVzdWx0LmVycm9yKS50b0JlRGVmaW5lZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnc2VsZWN0TW9kZWwnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzZWxlY3QgR1BULTQgZm9yIGNvbXBsZXggdGFza3MnLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2RlbCA9IG9yY2hlc3RyYXRvci5zZWxlY3RNb2RlbCgncmVmYWN0b3InKTtcbiAgICAgIGV4cGVjdChtb2RlbCkudG9CZSgnZ3B0LTQtdHVyYm8nKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc2VsZWN0IENsYXVkZSBmb3IgY29kZSBnZW5lcmF0aW9uJywgKCkgPT4ge1xuICAgICAgY29uc3QgbW9kZWwgPSBvcmNoZXN0cmF0b3Iuc2VsZWN0TW9kZWwoJ2dlbmVyYXRlLWNvZGUnKTtcbiAgICAgIGV4cGVjdChtb2RlbCkudG9CZSgnY2xhdWRlLTMtb3B1cycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBzZWxlY3QgR1BULTMuNSBmb3Igc2ltcGxlIHRhc2tzJywgKCkgPT4ge1xuICAgICAgY29uc3QgbW9kZWwgPSBvcmNoZXN0cmF0b3Iuc2VsZWN0TW9kZWwoJ3NpbXBsZScpO1xuICAgICAgZXhwZWN0KG1vZGVsKS50b0JlKCdncHQtMy41LXR1cmJvJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdlc3RpbWF0ZUNvc3QnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBlc3RpbWF0ZSBjb3N0IGJhc2VkIG9uIHByb21wdCBsZW5ndGgnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwcm9tcHQgPSAnVGVzdCBwcm9tcHQnO1xuICAgICAgY29uc3QgY29zdCA9IGF3YWl0IG9yY2hlc3RyYXRvci5lc3RpbWF0ZUNvc3QocHJvbXB0KTtcbiAgICAgIFxuICAgICAgZXhwZWN0KGNvc3QpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgY29zdCkudG9CZSgnbnVtYmVyJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBoaWdoZXIgY29zdCBmb3IgbG9uZ2VyIHByb21wdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBzaG9ydFByb21wdCA9ICdTaG9ydCc7XG4gICAgICBjb25zdCBsb25nUHJvbXB0ID0gJ1RoaXMgaXMgYSBtdWNoIGxvbmdlciBwcm9tcHQgdGhhdCBzaG91bGQgY29zdCBtb3JlIHRvIHByb2Nlc3MnO1xuICAgICAgXG4gICAgICBjb25zdCBzaG9ydENvc3QgPSBhd2FpdCBvcmNoZXN0cmF0b3IuZXN0aW1hdGVDb3N0KHNob3J0UHJvbXB0KTtcbiAgICAgIGNvbnN0IGxvbmdDb3N0ID0gYXdhaXQgb3JjaGVzdHJhdG9yLmVzdGltYXRlQ29zdChsb25nUHJvbXB0KTtcbiAgICAgIFxuICAgICAgZXhwZWN0KGxvbmdDb3N0KS50b0JlR3JlYXRlclRoYW4oc2hvcnRDb3N0KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NhY2hpbmcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjYWNoZSBBSSByZXNwb25zZXMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBwcm9tcHQgPSAnVGVzdCBwcm9tcHQnO1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSAnVGVzdCByZXNwb25zZSc7XG4gICAgICBcbiAgICAgIGF3YWl0IG9yY2hlc3RyYXRvci5jYWNoZVJlc3BvbnNlKHByb21wdCwgcmVzcG9uc2UpO1xuICAgICAgY29uc3QgY2FjaGVkID0gYXdhaXQgb3JjaGVzdHJhdG9yLmdldENhY2hlZFJlc3BvbnNlKHByb21wdCk7XG4gICAgICBcbiAgICAgIGV4cGVjdChjYWNoZWQpLnRvQmUocmVzcG9uc2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gbnVsbCBmb3IgdW5jYWNoZWQgcHJvbXB0cycsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNhY2hlZCA9IGF3YWl0IG9yY2hlc3RyYXRvci5nZXRDYWNoZWRSZXNwb25zZSgnbm9uLWV4aXN0ZW50Jyk7XG4gICAgICBleHBlY3QoY2FjaGVkKS50b0JlTnVsbCgpO1xuICAgIH0pO1xuICB9KTtcbn0pOyJdLCJtYXBwaW5ncyI6Ijs7QUFLQTtBQUNBQSxXQUFBLEdBQUtDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQztBQUM5QkQsV0FBQSxHQUFLQyxJQUFJLENBQUMsaUJBQWlCLENBQUM7QUFDNUJELFdBQUEsR0FBS0MsSUFBSSxDQUFDLHVCQUF1QixDQUFDO0FBUmxDLElBQUFDLGVBQUEsR0FBQUMsT0FBQTtBQUNBLElBQUFDLGVBQUEsR0FBQUQsT0FBQTtBQUNBLElBQUFFLGFBQUEsR0FBQUYsT0FBQTtBQUNBLElBQUFHLG1CQUFBLEdBQUFILE9BQUE7QUFBMkQsU0FBQUgsWUFBQTtFQUFBO0lBQUFPO0VBQUEsSUFBQUos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W119