{"version":3,"names":["cov_2mv2hh3hby","actualCoverage","DEFAULT_MIDDLEWARE_CONFIG","s","enabled","skipPaths","skipMethods","onViolation","includeMetadata","createConstitutionalMiddleware","orchestrator","config","b","f","middlewareConfig","req","res","next","some","path","startsWith","includes","method","originalJson","json","bind","body","shouldValidateResponse","validateAndRespond","response","output","message","content","query","extractQuery","userId","extractUserId","tier","startTime","Date","now","result","validateOutput","processingTime","logValidation","constitutional","validated","complianceScore","violations","originalOutput","validatedOutput","isValid","handleViolation","length","error","console","status","map","v","type","severity","description","warning","violationCount","warn","prompt","q","user","id","headers","ip","createValidationRulesMiddleware","ubuntuThreshold","strictMode","parseInt","updateConfig","createComplianceMetricsMiddleware","metrics","getComplianceMetrics","createConstitutionalHealthCheck","testResult","timestamp","_default","exports","default"],"sources":["constitutional-middleware.ts"],"sourcesContent":["/**\r\n * Constitutional AI Middleware\r\n * Express middleware for API Gateway integration\r\n */\r\n\r\nimport { Request, Response, NextFunction } from 'express';\r\nimport { ConstitutionalOrchestrator } from '../orchestrator';\r\nimport { ConstitutionalAIConfig } from '../types';\r\n\r\n/**\r\n * Middleware configuration\r\n */\r\nexport interface ConstitutionalMiddlewareConfig {\r\n  enabled: boolean;\r\n  skipPaths?: string[]; // Paths to skip validation\r\n  skipMethods?: string[]; // HTTP methods to skip\r\n  onViolation?: 'block' | 'warn' | 'log'; // Action on violation\r\n  includeMetadata?: boolean; // Include validation metadata in response\r\n}\r\n\r\n/**\r\n * Default middleware configuration\r\n */\r\nconst DEFAULT_MIDDLEWARE_CONFIG: ConstitutionalMiddlewareConfig = {\r\n  enabled: true,\r\n  skipPaths: ['/health', '/metrics', '/status'],\r\n  skipMethods: ['OPTIONS', 'HEAD'],\r\n  onViolation: 'block',\r\n  includeMetadata: false\r\n};\r\n\r\n/**\r\n * Extended request interface with constitutional validation\r\n */\r\nexport interface ConstitutionalRequest extends Request {\r\n  constitutional?: {\r\n    validated: boolean;\r\n    complianceScore: number;\r\n    violations: any[];\r\n    originalOutput?: string;\r\n    validatedOutput?: string;\r\n  };\r\n}\r\n\r\n/**\r\n * Create constitutional validation middleware\r\n */\r\nexport function createConstitutionalMiddleware(\r\n  orchestrator: ConstitutionalOrchestrator,\r\n  config: Partial<ConstitutionalMiddlewareConfig> = {}\r\n) {\r\n  const middlewareConfig = { ...DEFAULT_MIDDLEWARE_CONFIG, ...config };\r\n\r\n  return async (req: ConstitutionalRequest, res: Response, next: NextFunction) => {\r\n    // Skip if middleware is disabled\r\n    if (!middlewareConfig.enabled) {\r\n      return next();\r\n    }\r\n\r\n    // Skip certain paths\r\n    if (middlewareConfig.skipPaths?.some(path => req.path.startsWith(path))) {\r\n      return next();\r\n    }\r\n\r\n    // Skip certain methods\r\n    if (middlewareConfig.skipMethods?.includes(req.method)) {\r\n      return next();\r\n    }\r\n\r\n    // Store original res.json to intercept AI responses\r\n    const originalJson = res.json.bind(res);\r\n\r\n    // Override res.json to validate AI outputs\r\n    res.json = function (body: any) {\r\n      // Only validate if response contains AI output\r\n      if (shouldValidateResponse(body)) {\r\n        validateAndRespond(body, req, res, originalJson, orchestrator, middlewareConfig);\r\n      } else {\r\n        return originalJson(body);\r\n      }\r\n    } as any;\r\n\r\n    next();\r\n  };\r\n}\r\n\r\n/**\r\n * Determine if response should be validated\r\n */\r\nfunction shouldValidateResponse(body: any): boolean {\r\n  // Check if response contains AI-generated content\r\n  return (\r\n    body &&\r\n    typeof body === 'object' &&\r\n    (body.response || body.output || body.message || body.content)\r\n  );\r\n}\r\n\r\n/**\r\n * Validate response and send\r\n */\r\nasync function validateAndRespond(\r\n  body: any,\r\n  req: ConstitutionalRequest,\r\n  res: Response,\r\n  originalJson: Function,\r\n  orchestrator: ConstitutionalOrchestrator,\r\n  config: ConstitutionalMiddlewareConfig\r\n): Promise<any> {\r\n  try {\r\n    // Extract AI output from response\r\n    const output = body.response || body.output || body.message || body.content;\r\n    const query = extractQuery(req);\r\n    const userId = extractUserId(req);\r\n    const tier = body.tier || 'unknown';\r\n\r\n    // Validate output\r\n    const startTime = Date.now();\r\n    const result = await orchestrator.validateOutput(query, output);\r\n    const processingTime = Date.now() - startTime;\r\n\r\n    // Log validation\r\n    await orchestrator.logValidation(\r\n      result,\r\n      userId,\r\n      query,\r\n      output,\r\n      tier,\r\n      processingTime\r\n    );\r\n\r\n    // Attach validation info to request for downstream use\r\n    req.constitutional = {\r\n      validated: true,\r\n      complianceScore: result.complianceScore,\r\n      violations: result.violations,\r\n      originalOutput: output,\r\n      validatedOutput: result.validatedOutput\r\n    };\r\n\r\n    // Handle based on validation result and config\r\n    if (!result.isValid) {\r\n      return handleViolation(result, body, req, res, originalJson, config);\r\n    }\r\n\r\n    // Replace output with validated version\r\n    if (body.response) {body.response = result.validatedOutput;}\r\n    if (body.output) {body.output = result.validatedOutput;}\r\n    if (body.message) {body.message = result.validatedOutput;}\r\n    if (body.content) {body.content = result.validatedOutput;}\r\n\r\n    // Add metadata if configured\r\n    if (config.includeMetadata) {\r\n      body.constitutional = {\r\n        validated: true,\r\n        complianceScore: result.complianceScore,\r\n        violations: result.violations.length,\r\n        processingTime\r\n      };\r\n    }\r\n\r\n    return originalJson(body);\r\n  } catch (error) {\r\n    console.error('Constitutional validation error:', error);\r\n    // On error, pass through original response\r\n    return originalJson(body);\r\n  }\r\n}\r\n\r\n/**\r\n * Handle validation violations\r\n */\r\nfunction handleViolation(\r\n  result: any,\r\n  body: any,\r\n  req: ConstitutionalRequest,\r\n  res: Response,\r\n  originalJson: Function,\r\n  config: ConstitutionalMiddlewareConfig\r\n) {\r\n  switch (config.onViolation) {\r\n    case 'block':\r\n      // Block the response and return error\r\n      return res.status(400).json({\r\n        error: 'Content validation failed',\r\n        message: 'The generated content does not meet constitutional standards',\r\n        complianceScore: result.complianceScore,\r\n        violations: result.violations.map((v: any) => ({\r\n          type: v.type,\r\n          severity: v.severity,\r\n          description: v.description\r\n        }))\r\n      });\r\n\r\n    case 'warn':\r\n      // Send validated output with warning\r\n      if (body.response) {body.response = result.validatedOutput;}\r\n      if (body.output) {body.output = result.validatedOutput;}\r\n      if (body.message) {body.message = result.validatedOutput;}\r\n      if (body.content) {body.content = result.validatedOutput;}\r\n\r\n      body.warning = {\r\n        message: 'Content was modified to meet constitutional standards',\r\n        complianceScore: result.complianceScore,\r\n        violationCount: result.violations.length\r\n      };\r\n\r\n      return originalJson(body);\r\n\r\n    case 'log':\r\n      // Just log and pass through validated output\r\n      console.warn('Constitutional violation detected:', {\r\n        complianceScore: result.complianceScore,\r\n        violations: result.violations.length\r\n      });\r\n\r\n      if (body.response) {body.response = result.validatedOutput;}\r\n      if (body.output) {body.output = result.validatedOutput;}\r\n      if (body.message) {body.message = result.validatedOutput;}\r\n      if (body.content) {body.content = result.validatedOutput;}\r\n\r\n      return originalJson(body);\r\n\r\n    default:\r\n      return originalJson(body);\r\n  }\r\n}\r\n\r\n/**\r\n * Extract query from request\r\n */\r\nfunction extractQuery(req: Request): string {\r\n  return (\r\n    req.body?.query ||\r\n    req.body?.prompt ||\r\n    req.body?.message ||\r\n    req.query?.q ||\r\n    ''\r\n  );\r\n}\r\n\r\n/**\r\n * Extract user ID from request\r\n */\r\nfunction extractUserId(req: Request): string {\r\n  // Try to get from auth token\r\n  const user = (req as any).user;\r\n  if (user?.id) {return user.id;}\r\n  if (user?.userId) {return user.userId;}\r\n\r\n  // Try to get from headers\r\n  const userId = req.headers['x-user-id'] as string;\r\n  if (userId) {return userId;}\r\n\r\n  // Fallback to IP address\r\n  return req.ip || 'anonymous';\r\n}\r\n\r\n/**\r\n * Create validation rules configuration middleware\r\n */\r\nexport function createValidationRulesMiddleware(\r\n  orchestrator: ConstitutionalOrchestrator\r\n) {\r\n  return (req: Request, res: Response, next: NextFunction) => {\r\n    // Allow dynamic configuration via headers\r\n    const ubuntuThreshold = req.headers['x-ubuntu-threshold'];\r\n    const strictMode = req.headers['x-strict-mode'];\r\n\r\n    if (ubuntuThreshold || strictMode) {\r\n      const config: Partial<ConstitutionalAIConfig> = {};\r\n\r\n      if (ubuntuThreshold) {\r\n        config.ubuntuThreshold = parseInt(ubuntuThreshold as string, 10);\r\n      }\r\n\r\n      if (strictMode) {\r\n        config.strictMode = strictMode === 'true';\r\n      }\r\n\r\n      orchestrator.updateConfig(config);\r\n    }\r\n\r\n    next();\r\n  };\r\n}\r\n\r\n/**\r\n * Create compliance metrics endpoint middleware\r\n */\r\nexport function createComplianceMetricsMiddleware(\r\n  orchestrator: ConstitutionalOrchestrator\r\n) {\r\n  return async (req: Request, res: Response) => {\r\n    try {\r\n      const metrics = await orchestrator.getComplianceMetrics();\r\n      res.json(metrics);\r\n    } catch (error) {\r\n      console.error('Failed to get compliance metrics:', error);\r\n      res.status(500).json({\r\n        error: 'Failed to retrieve compliance metrics'\r\n      });\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Create health check middleware for constitutional AI\r\n */\r\nexport function createConstitutionalHealthCheck(\r\n  orchestrator: ConstitutionalOrchestrator\r\n) {\r\n  return async (req: Request, res: Response) => {\r\n    try {\r\n      // Test validation with simple input\r\n      const testResult = await orchestrator.validateOutput(\r\n        'test query',\r\n        'This is a test output for health check'\r\n      );\r\n\r\n      res.json({\r\n        status: 'healthy',\r\n        constitutional: {\r\n          enabled: true,\r\n          complianceScore: testResult.complianceScore,\r\n          timestamp: new Date()\r\n        }\r\n      });\r\n    } catch (error) {\r\n      res.status(503).json({\r\n        status: 'unhealthy',\r\n        constitutional: {\r\n          enabled: false,\r\n          error: (error as Error).message,\r\n          timestamp: new Date()\r\n        }\r\n      });\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Export middleware factory\r\n */\r\nexport default createConstitutionalMiddleware;\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}