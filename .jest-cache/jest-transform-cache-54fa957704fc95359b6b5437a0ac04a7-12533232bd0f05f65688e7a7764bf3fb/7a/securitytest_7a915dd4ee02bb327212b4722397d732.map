{"version":3,"names":["describe","mockRequest","mockResponse","nextFunction","beforeEach","headers","body","query","setHeader","jest","fn","status","mockReturnThis","json","it","securityHeadersMiddleware","req","res","next","expect","toHaveBeenCalledWith","toHaveBeenCalled","hstsMiddleware","sanitize","input","replace","maliciousInput","sanitized","not","toContain","sanitizeSQL","sqlInjection","allowedOrigins","isOriginAllowed","origin","includes","toBe","method","corsMiddleware","requestCounts","Map","trackRequest","ip","count","get","set","MAX_REQUESTS","isRateLimited","i","isValidTokenFormat","token","test","isTokenExpired","exp","Date","now","futureTime","Math","floor","pastTime"],"sources":["security.test.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\r\n\r\ndescribe('Shared Utilities - Security', () => {\r\n  let mockRequest: Partial<Request>;\r\n  let mockResponse: Partial<Response>;\r\n  let nextFunction: NextFunction;\r\n  \r\n  beforeEach(() => {\r\n    mockRequest = {\r\n      headers: {},\r\n      body: {},\r\n      query: {}\r\n    };\r\n    mockResponse = {\r\n      setHeader: jest.fn(),\r\n      status: jest.fn().mockReturnThis(),\r\n      json: jest.fn().mockReturnThis()\r\n    };\r\n    nextFunction = jest.fn();\r\n  });\r\n  \r\n  describe('Security Headers', () => {\r\n    it('should set security headers', () => {\r\n      const securityHeadersMiddleware = (req: Request, res: Response, next: NextFunction) => {\r\n        res.setHeader('X-Content-Type-Options', 'nosniff');\r\n        res.setHeader('X-Frame-Options', 'DENY');\r\n        res.setHeader('X-XSS-Protection', '1; mode=block');\r\n        res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');\r\n        next();\r\n      };\r\n      \r\n      securityHeadersMiddleware(\r\n        mockRequest as Request,\r\n        mockResponse as Response,\r\n        nextFunction\r\n      );\r\n      \r\n      expect(mockResponse.setHeader).toHaveBeenCalledWith('X-Content-Type-Options', 'nosniff');\r\n      expect(mockResponse.setHeader).toHaveBeenCalledWith('X-Frame-Options', 'DENY');\r\n      expect(nextFunction).toHaveBeenCalled();\r\n    });\r\n    \r\n    it('should set HSTS header', () => {\r\n      const hstsMiddleware = (req: Request, res: Response, next: NextFunction) => {\r\n        res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');\r\n        next();\r\n      };\r\n      \r\n      hstsMiddleware(\r\n        mockRequest as Request,\r\n        mockResponse as Response,\r\n        nextFunction\r\n      );\r\n      \r\n      expect(mockResponse.setHeader).toHaveBeenCalledWith(\r\n        'Strict-Transport-Security',\r\n        'max-age=31536000; includeSubDomains'\r\n      );\r\n    });\r\n  });\r\n  \r\n  describe('Input Sanitization', () => {\r\n    it('should sanitize user input', () => {\r\n      const sanitize = (input: string): string => {\r\n        return input\r\n          .replace(/</g, '&lt;')\r\n          .replace(/>/g, '&gt;')\r\n          .replace(/\"/g, '&quot;')\r\n          .replace(/'/g, '&#x27;')\r\n          .replace(/\\//g, '&#x2F;');\r\n      };\r\n      \r\n      const maliciousInput = '<script>alert(\"XSS\")</script>';\r\n      const sanitized = sanitize(maliciousInput);\r\n      \r\n      expect(sanitized).not.toContain('<script>');\r\n      expect(sanitized).toContain('&lt;script&gt;');\r\n    });\r\n    \r\n    it('should handle SQL injection attempts', () => {\r\n      const sanitizeSQL = (input: string): string => {\r\n        return input.replace(/['\";\\\\]/g, '');\r\n      };\r\n      \r\n      const sqlInjection = \"'; DROP TABLE users; --\";\r\n      const sanitized = sanitizeSQL(sqlInjection);\r\n      \r\n      expect(sanitized).not.toContain(\"'\");\r\n      expect(sanitized).not.toContain(';');\r\n    });\r\n  });\r\n  \r\n  describe('CORS Configuration', () => {\r\n    it('should validate allowed origins', () => {\r\n      const allowedOrigins = [\r\n        'http://localhost:3000',\r\n        'https://azora.world'\r\n      ];\r\n      \r\n      const isOriginAllowed = (origin: string): boolean => {\r\n        return allowedOrigins.includes(origin);\r\n      };\r\n      \r\n      expect(isOriginAllowed('http://localhost:3000')).toBe(true);\r\n      expect(isOriginAllowed('https://azora.world')).toBe(true);\r\n      expect(isOriginAllowed('https://malicious.com')).toBe(false);\r\n    });\r\n    \r\n    it('should handle CORS preflight requests', () => {\r\n      mockRequest.method = 'OPTIONS';\r\n      mockRequest.headers = {\r\n        'access-control-request-method': 'POST',\r\n        'access-control-request-headers': 'content-type'\r\n      };\r\n      \r\n      const corsMiddleware = (req: Request, res: Response, next: NextFunction) => {\r\n        if (req.method === 'OPTIONS') {\r\n          res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE');\r\n          res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');\r\n          res.status(204);\r\n          return;\r\n        }\r\n        next();\r\n      };\r\n      \r\n      corsMiddleware(\r\n        mockRequest as Request,\r\n        mockResponse as Response,\r\n        nextFunction\r\n      );\r\n      \r\n      expect(mockResponse.setHeader).toHaveBeenCalledWith(\r\n        'Access-Control-Allow-Methods',\r\n        'GET, POST, PUT, DELETE'\r\n      );\r\n    });\r\n  });\r\n  \r\n  describe('Rate Limiting', () => {\r\n    it('should track request counts', () => {\r\n      const requestCounts = new Map<string, number>();\r\n      \r\n      const trackRequest = (ip: string): number => {\r\n        const count = requestCounts.get(ip) || 0;\r\n        requestCounts.set(ip, count + 1);\r\n        return count + 1;\r\n      };\r\n      \r\n      expect(trackRequest('192.168.1.1')).toBe(1);\r\n      expect(trackRequest('192.168.1.1')).toBe(2);\r\n      expect(trackRequest('192.168.1.2')).toBe(1);\r\n    });\r\n    \r\n    it('should enforce rate limits', () => {\r\n      const MAX_REQUESTS = 5;\r\n      const requestCounts = new Map<string, number>();\r\n      \r\n      const isRateLimited = (ip: string): boolean => {\r\n        const count = requestCounts.get(ip) || 0;\r\n        return count >= MAX_REQUESTS;\r\n      };\r\n      \r\n      for (let i = 0; i < MAX_REQUESTS; i++) {\r\n        requestCounts.set('192.168.1.1', i + 1);\r\n      }\r\n      \r\n      expect(isRateLimited('192.168.1.1')).toBe(true);\r\n      expect(isRateLimited('192.168.1.2')).toBe(false);\r\n    });\r\n  });\r\n  \r\n  describe('Token Validation', () => {\r\n    it('should validate token format', () => {\r\n      const isValidTokenFormat = (token: string): boolean => {\r\n        return /^[A-Za-z0-9-_]+\\.[A-Za-z0-9-_]+\\.[A-Za-z0-9-_]+$/.test(token);\r\n      };\r\n      \r\n      expect(isValidTokenFormat('header.payload.signature')).toBe(true);\r\n      expect(isValidTokenFormat('invalid-token')).toBe(false);\r\n      expect(isValidTokenFormat('')).toBe(false);\r\n    });\r\n    \r\n    it('should validate token expiration', () => {\r\n      const isTokenExpired = (exp: number): boolean => {\r\n        return exp < Date.now() / 1000;\r\n      };\r\n      \r\n      const futureTime = Math.floor(Date.now() / 1000) + 3600;\r\n      const pastTime = Math.floor(Date.now() / 1000) - 3600;\r\n      \r\n      expect(isTokenExpired(futureTime)).toBe(false);\r\n      expect(isTokenExpired(pastTime)).toBe(true);\r\n    });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}