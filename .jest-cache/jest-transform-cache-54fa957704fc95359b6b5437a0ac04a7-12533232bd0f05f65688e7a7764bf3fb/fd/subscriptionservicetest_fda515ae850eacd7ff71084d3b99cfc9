228b4308f80c1ab006e82da19292e6a0
"use strict";

// Mock logger

// Mock ErrorHandler

// Mock Prisma
_getJestObj().mock('../../shared/logging', () => ({
  logger: {
    info: _globals.jest.fn(),
    error: _globals.jest.fn(),
    warn: _globals.jest.fn(),
    debug: _globals.jest.fn()
  }
}));
_getJestObj().mock('../../payment/error-handler', () => ({
  ErrorHandler: {
    handle: _globals.jest.fn(error => error)
  }
}));
_getJestObj().mock('@prisma/client');
var _globals = require("@jest/globals");
var _subscriptionService = require("../subscription-service");
function _getJestObj() {
  const {
    jest
  } = require("@jest/globals");
  _getJestObj = () => jest;
  return jest;
}
(0, _globals.describe)('SubscriptionService', () => {
  let subscriptionService;
  let mockPrisma;
  (0, _globals.beforeEach)(() => {
    mockPrisma = {
      subscription: {
        create: _globals.jest.fn().mockResolvedValue({
          id: 'sub_123',
          userId: 'user123',
          tier: 'PRO',
          status: 'ACTIVE',
          startDate: new Date(),
          renewalDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
          createdAt: new Date(),
          updatedAt: new Date()
        }),
        findFirst: _globals.jest.fn().mockResolvedValue(null),
        findUnique: _globals.jest.fn().mockResolvedValue({
          id: 'sub_123',
          userId: 'user123',
          tier: 'PRO',
          status: 'ACTIVE',
          createdAt: new Date(),
          updatedAt: new Date()
        }),
        update: _globals.jest.fn().mockResolvedValue({
          id: 'sub_123',
          tier: 'ENTERPRISE',
          status: 'ACTIVE',
          updatedAt: new Date()
        })
      }
    };
    subscriptionService = new _subscriptionService.SubscriptionService();
  });
  (0, _globals.describe)('createSubscription', () => {
    (0, _globals.it)('should create a new subscription for a user', async () => {
      const userId = 'user123';
      const tier = 'PRO';
      const paymentMethodId = 'pm_123';
      const mockSubscription = {
        id: 'sub_123',
        userId,
        tier,
        status: 'ACTIVE',
        startDate: new Date(),
        renewalDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
        createdAt: new Date(),
        updatedAt: new Date()
      };
      mockPrisma.subscription.create = _globals.jest.fn().mockResolvedValue(mockSubscription);
      const result = await subscriptionService.createSubscription({
        userId,
        tier,
        paymentMethodId
      });
      (0, _globals.expect)(result).toEqual(mockSubscription);
      (0, _globals.expect)(mockPrisma.subscription.create).toHaveBeenCalledWith({
        data: _globals.expect.objectContaining({
          userId,
          tier
        })
      });
    });
    (0, _globals.it)('should throw error if user already has active subscription', async () => {
      const userId = 'user123';
      mockPrisma.subscription.findFirst = _globals.jest.fn().mockResolvedValue({
        id: 'sub_existing',
        userId,
        status: 'ACTIVE'
      });
      await (0, _globals.expect)(subscriptionService.createSubscription({
        userId,
        tier: 'PRO',
        paymentMethodId: 'pm_123'
      })).rejects.toThrow('User already has an active subscription');
    });
  });
  (0, _globals.describe)('updateSubscription', () => {
    (0, _globals.it)('should update subscription tier', async () => {
      const subscriptionId = 'sub_123';
      const newTier = 'ENTERPRISE';
      const mockUpdatedSubscription = {
        id: subscriptionId,
        tier: newTier,
        status: 'ACTIVE',
        updatedAt: new Date()
      };
      mockPrisma.subscription.update = _globals.jest.fn().mockResolvedValue(mockUpdatedSubscription);
      const result = await subscriptionService.updateSubscription(subscriptionId, {
        tier: newTier
      });
      (0, _globals.expect)(result.tier).toBe(newTier);
      (0, _globals.expect)(mockPrisma.subscription.update).toHaveBeenCalled();
    });
  });
  (0, _globals.describe)('cancelSubscription', () => {
    (0, _globals.it)('should cancel an active subscription', async () => {
      const subscriptionId = 'sub_123';
      const mockCancelledSubscription = {
        id: subscriptionId,
        status: 'CANCELLED',
        cancelledAt: new Date()
      };
      mockPrisma.subscription.update = _globals.jest.fn().mockResolvedValue(mockCancelledSubscription);
      const result = await subscriptionService.cancelSubscription(subscriptionId);
      (0, _globals.expect)(result.status).toBe('CANCELLED');
      (0, _globals.expect)(mockPrisma.subscription.update).toHaveBeenCalled();
    });
    (0, _globals.it)('should throw error if subscription not found', async () => {
      mockPrisma.subscription.findUnique = _globals.jest.fn().mockResolvedValue(null);
      await (0, _globals.expect)(subscriptionService.cancelSubscription('invalid_id')).rejects.toThrow('Subscription not found');
    });
  });
  (0, _globals.describe)('getSubscription', () => {
    (0, _globals.it)('should retrieve subscription by ID', async () => {
      const subscriptionId = 'sub_123';
      const mockSubscription = {
        id: subscriptionId,
        userId: 'user123',
        tier: 'PRO',
        status: 'ACTIVE'
      };
      mockPrisma.subscription.findUnique = _globals.jest.fn().mockResolvedValue(mockSubscription);
      const result = await subscriptionService.getSubscription(subscriptionId);
      (0, _globals.expect)(result).toEqual(mockSubscription);
      (0, _globals.expect)(mockPrisma.subscription.findUnique).toHaveBeenCalledWith({
        where: {
          id: subscriptionId
        }
      });
    });
    (0, _globals.it)('should return null if subscription not found', async () => {
      mockPrisma.subscription.findUnique = _globals.jest.fn().mockResolvedValue(null);
      const result = await subscriptionService.getSubscription('invalid_id');
      (0, _globals.expect)(result).toBeNull();
    });
  });
  (0, _globals.describe)('getUserSubscription', () => {
    (0, _globals.it)('should retrieve active subscription for user', async () => {
      const userId = 'user123';
      const mockSubscription = {
        id: 'sub_123',
        userId,
        tier: 'PRO',
        status: 'ACTIVE'
      };
      mockPrisma.subscription.findFirst = _globals.jest.fn().mockResolvedValue(mockSubscription);
      const result = await subscriptionService.getUserSubscription(userId);
      (0, _globals.expect)(result).toEqual(mockSubscription);
      (0, _globals.expect)(mockPrisma.subscription.findFirst).toHaveBeenCalledWith({
        where: {
          userId,
          status: 'ACTIVE'
        }
      });
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZ2V0SmVzdE9iaiIsIm1vY2siLCJsb2dnZXIiLCJpbmZvIiwiamVzdCIsImZuIiwiZXJyb3IiLCJ3YXJuIiwiZGVidWciLCJFcnJvckhhbmRsZXIiLCJoYW5kbGUiLCJfZ2xvYmFscyIsInJlcXVpcmUiLCJfc3Vic2NyaXB0aW9uU2VydmljZSIsImRlc2NyaWJlIiwic3Vic2NyaXB0aW9uU2VydmljZSIsIm1vY2tQcmlzbWEiLCJiZWZvcmVFYWNoIiwic3Vic2NyaXB0aW9uIiwiY3JlYXRlIiwibW9ja1Jlc29sdmVkVmFsdWUiLCJpZCIsInVzZXJJZCIsInRpZXIiLCJzdGF0dXMiLCJzdGFydERhdGUiLCJEYXRlIiwicmVuZXdhbERhdGUiLCJub3ciLCJjcmVhdGVkQXQiLCJ1cGRhdGVkQXQiLCJmaW5kRmlyc3QiLCJmaW5kVW5pcXVlIiwidXBkYXRlIiwiU3Vic2NyaXB0aW9uU2VydmljZSIsIml0IiwicGF5bWVudE1ldGhvZElkIiwibW9ja1N1YnNjcmlwdGlvbiIsInJlc3VsdCIsImNyZWF0ZVN1YnNjcmlwdGlvbiIsImV4cGVjdCIsInRvRXF1YWwiLCJ0b0hhdmVCZWVuQ2FsbGVkV2l0aCIsImRhdGEiLCJvYmplY3RDb250YWluaW5nIiwicmVqZWN0cyIsInRvVGhyb3ciLCJzdWJzY3JpcHRpb25JZCIsIm5ld1RpZXIiLCJtb2NrVXBkYXRlZFN1YnNjcmlwdGlvbiIsInVwZGF0ZVN1YnNjcmlwdGlvbiIsInRvQmUiLCJ0b0hhdmVCZWVuQ2FsbGVkIiwibW9ja0NhbmNlbGxlZFN1YnNjcmlwdGlvbiIsImNhbmNlbGxlZEF0IiwiY2FuY2VsU3Vic2NyaXB0aW9uIiwiZ2V0U3Vic2NyaXB0aW9uIiwid2hlcmUiLCJ0b0JlTnVsbCIsImdldFVzZXJTdWJzY3JpcHRpb24iXSwic291cmNlcyI6WyJzdWJzY3JpcHRpb24tc2VydmljZS50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGRlc2NyaWJlLCBpdCwgZXhwZWN0LCBiZWZvcmVFYWNoLCBqZXN0IH0gZnJvbSAnQGplc3QvZ2xvYmFscyc7XHJcbmltcG9ydCB7IFN1YnNjcmlwdGlvblNlcnZpY2UgfSBmcm9tICcuLi9zdWJzY3JpcHRpb24tc2VydmljZSc7XHJcbmltcG9ydCB7IFByaXNtYUNsaWVudCB9IGZyb20gJ0BwcmlzbWEvY2xpZW50JztcclxuXHJcbi8vIE1vY2sgbG9nZ2VyXHJcbmplc3QubW9jaygnLi4vLi4vc2hhcmVkL2xvZ2dpbmcnLCAoKSA9PiAoe1xyXG4gIGxvZ2dlcjoge1xyXG4gICAgaW5mbzogamVzdC5mbigpLFxyXG4gICAgZXJyb3I6IGplc3QuZm4oKSxcclxuICAgIHdhcm46IGplc3QuZm4oKSxcclxuICAgIGRlYnVnOiBqZXN0LmZuKCksXHJcbiAgfSxcclxufSkpO1xyXG5cclxuLy8gTW9jayBFcnJvckhhbmRsZXJcclxuamVzdC5tb2NrKCcuLi8uLi9wYXltZW50L2Vycm9yLWhhbmRsZXInLCAoKSA9PiAoe1xyXG4gIEVycm9ySGFuZGxlcjoge1xyXG4gICAgaGFuZGxlOiBqZXN0LmZuKChlcnJvcikgPT4gZXJyb3IpLFxyXG4gIH0sXHJcbn0pKTtcclxuXHJcbi8vIE1vY2sgUHJpc21hXHJcbmplc3QubW9jaygnQHByaXNtYS9jbGllbnQnKTtcclxuXHJcbmRlc2NyaWJlKCdTdWJzY3JpcHRpb25TZXJ2aWNlJywgKCkgPT4ge1xyXG4gIGxldCBzdWJzY3JpcHRpb25TZXJ2aWNlOiBTdWJzY3JpcHRpb25TZXJ2aWNlO1xyXG4gIGxldCBtb2NrUHJpc21hOiBhbnk7XHJcblxyXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgbW9ja1ByaXNtYSA9IHtcclxuICAgICAgc3Vic2NyaXB0aW9uOiB7XHJcbiAgICAgICAgY3JlYXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe1xyXG4gICAgICAgICAgaWQ6ICdzdWJfMTIzJyxcclxuICAgICAgICAgIHVzZXJJZDogJ3VzZXIxMjMnLFxyXG4gICAgICAgICAgdGllcjogJ1BSTycsXHJcbiAgICAgICAgICBzdGF0dXM6ICdBQ1RJVkUnLFxyXG4gICAgICAgICAgc3RhcnREYXRlOiBuZXcgRGF0ZSgpLFxyXG4gICAgICAgICAgcmVuZXdhbERhdGU6IG5ldyBEYXRlKERhdGUubm93KCkgKyAzMCAqIDI0ICogNjAgKiA2MCAqIDEwMDApLFxyXG4gICAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxyXG4gICAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIGZpbmRGaXJzdDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpLFxyXG4gICAgICAgIGZpbmRVbmlxdWU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XHJcbiAgICAgICAgICBpZDogJ3N1Yl8xMjMnLFxyXG4gICAgICAgICAgdXNlcklkOiAndXNlcjEyMycsXHJcbiAgICAgICAgICB0aWVyOiAnUFJPJyxcclxuICAgICAgICAgIHN0YXR1czogJ0FDVElWRScsXHJcbiAgICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXHJcbiAgICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgdXBkYXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe1xyXG4gICAgICAgICAgaWQ6ICdzdWJfMTIzJyxcclxuICAgICAgICAgIHRpZXI6ICdFTlRFUlBSSVNFJyxcclxuICAgICAgICAgIHN0YXR1czogJ0FDVElWRScsXHJcbiAgICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXHJcbiAgICAgICAgfSksXHJcbiAgICAgIH0sXHJcbiAgICB9O1xyXG4gICAgc3Vic2NyaXB0aW9uU2VydmljZSA9IG5ldyBTdWJzY3JpcHRpb25TZXJ2aWNlKCk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdjcmVhdGVTdWJzY3JpcHRpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBhIG5ldyBzdWJzY3JpcHRpb24gZm9yIGEgdXNlcicsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdXNlcklkID0gJ3VzZXIxMjMnO1xyXG4gICAgICBjb25zdCB0aWVyID0gJ1BSTyc7XHJcbiAgICAgIGNvbnN0IHBheW1lbnRNZXRob2RJZCA9ICdwbV8xMjMnO1xyXG5cclxuICAgICAgY29uc3QgbW9ja1N1YnNjcmlwdGlvbiA9IHtcclxuICAgICAgICBpZDogJ3N1Yl8xMjMnLFxyXG4gICAgICAgIHVzZXJJZCxcclxuICAgICAgICB0aWVyLFxyXG4gICAgICAgIHN0YXR1czogJ0FDVElWRScsXHJcbiAgICAgICAgc3RhcnREYXRlOiBuZXcgRGF0ZSgpLFxyXG4gICAgICAgIHJlbmV3YWxEYXRlOiBuZXcgRGF0ZShEYXRlLm5vdygpICsgMzAgKiAyNCAqIDYwICogNjAgKiAxMDAwKSxcclxuICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXHJcbiAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgbW9ja1ByaXNtYS5zdWJzY3JpcHRpb24uY3JlYXRlID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tTdWJzY3JpcHRpb24pO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc3Vic2NyaXB0aW9uU2VydmljZS5jcmVhdGVTdWJzY3JpcHRpb24oe1xyXG4gICAgICAgIHVzZXJJZCxcclxuICAgICAgICB0aWVyLFxyXG4gICAgICAgIHBheW1lbnRNZXRob2RJZCxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKG1vY2tTdWJzY3JpcHRpb24pO1xyXG4gICAgICBleHBlY3QobW9ja1ByaXNtYS5zdWJzY3JpcHRpb24uY3JlYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XHJcbiAgICAgICAgZGF0YTogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xyXG4gICAgICAgICAgdXNlcklkLFxyXG4gICAgICAgICAgdGllcixcclxuICAgICAgICB9KSxcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIGlmIHVzZXIgYWxyZWFkeSBoYXMgYWN0aXZlIHN1YnNjcmlwdGlvbicsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdXNlcklkID0gJ3VzZXIxMjMnO1xyXG5cclxuICAgICAgbW9ja1ByaXNtYS5zdWJzY3JpcHRpb24uZmluZEZpcnN0ID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcclxuICAgICAgICBpZDogJ3N1Yl9leGlzdGluZycsXHJcbiAgICAgICAgdXNlcklkLFxyXG4gICAgICAgIHN0YXR1czogJ0FDVElWRScsXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KFxyXG4gICAgICAgIHN1YnNjcmlwdGlvblNlcnZpY2UuY3JlYXRlU3Vic2NyaXB0aW9uKHtcclxuICAgICAgICAgIHVzZXJJZCxcclxuICAgICAgICAgIHRpZXI6ICdQUk8nLFxyXG4gICAgICAgICAgcGF5bWVudE1ldGhvZElkOiAncG1fMTIzJyxcclxuICAgICAgICB9KVxyXG4gICAgICApLnJlamVjdHMudG9UaHJvdygnVXNlciBhbHJlYWR5IGhhcyBhbiBhY3RpdmUgc3Vic2NyaXB0aW9uJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ3VwZGF0ZVN1YnNjcmlwdGlvbicsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgdXBkYXRlIHN1YnNjcmlwdGlvbiB0aWVyJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb25JZCA9ICdzdWJfMTIzJztcclxuICAgICAgY29uc3QgbmV3VGllciA9ICdFTlRFUlBSSVNFJztcclxuXHJcbiAgICAgIGNvbnN0IG1vY2tVcGRhdGVkU3Vic2NyaXB0aW9uID0ge1xyXG4gICAgICAgIGlkOiBzdWJzY3JpcHRpb25JZCxcclxuICAgICAgICB0aWVyOiBuZXdUaWVyLFxyXG4gICAgICAgIHN0YXR1czogJ0FDVElWRScsXHJcbiAgICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgbW9ja1ByaXNtYS5zdWJzY3JpcHRpb24udXBkYXRlID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tVcGRhdGVkU3Vic2NyaXB0aW9uKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHN1YnNjcmlwdGlvblNlcnZpY2UudXBkYXRlU3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbklkLCB7XHJcbiAgICAgICAgdGllcjogbmV3VGllcixcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0LnRpZXIpLnRvQmUobmV3VGllcik7XHJcbiAgICAgIGV4cGVjdChtb2NrUHJpc21hLnN1YnNjcmlwdGlvbi51cGRhdGUpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnY2FuY2VsU3Vic2NyaXB0aW9uJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjYW5jZWwgYW4gYWN0aXZlIHN1YnNjcmlwdGlvbicsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uSWQgPSAnc3ViXzEyMyc7XHJcblxyXG4gICAgICBjb25zdCBtb2NrQ2FuY2VsbGVkU3Vic2NyaXB0aW9uID0ge1xyXG4gICAgICAgIGlkOiBzdWJzY3JpcHRpb25JZCxcclxuICAgICAgICBzdGF0dXM6ICdDQU5DRUxMRUQnLFxyXG4gICAgICAgIGNhbmNlbGxlZEF0OiBuZXcgRGF0ZSgpLFxyXG4gICAgICB9O1xyXG5cclxuICAgICAgbW9ja1ByaXNtYS5zdWJzY3JpcHRpb24udXBkYXRlID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tDYW5jZWxsZWRTdWJzY3JpcHRpb24pO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc3Vic2NyaXB0aW9uU2VydmljZS5jYW5jZWxTdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uSWQpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXMpLnRvQmUoJ0NBTkNFTExFRCcpO1xyXG4gICAgICBleHBlY3QobW9ja1ByaXNtYS5zdWJzY3JpcHRpb24udXBkYXRlKS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIGlmIHN1YnNjcmlwdGlvbiBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tQcmlzbWEuc3Vic2NyaXB0aW9uLmZpbmRVbmlxdWUgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XHJcblxyXG4gICAgICBhd2FpdCBleHBlY3Qoc3Vic2NyaXB0aW9uU2VydmljZS5jYW5jZWxTdWJzY3JpcHRpb24oJ2ludmFsaWRfaWQnKSkucmVqZWN0cy50b1Rocm93KFxyXG4gICAgICAgICdTdWJzY3JpcHRpb24gbm90IGZvdW5kJ1xyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdnZXRTdWJzY3JpcHRpb24nLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHJldHJpZXZlIHN1YnNjcmlwdGlvbiBieSBJRCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uSWQgPSAnc3ViXzEyMyc7XHJcbiAgICAgIGNvbnN0IG1vY2tTdWJzY3JpcHRpb24gPSB7XHJcbiAgICAgICAgaWQ6IHN1YnNjcmlwdGlvbklkLFxyXG4gICAgICAgIHVzZXJJZDogJ3VzZXIxMjMnLFxyXG4gICAgICAgIHRpZXI6ICdQUk8nLFxyXG4gICAgICAgIHN0YXR1czogJ0FDVElWRScsXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBtb2NrUHJpc21hLnN1YnNjcmlwdGlvbi5maW5kVW5pcXVlID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tTdWJzY3JpcHRpb24pO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgc3Vic2NyaXB0aW9uU2VydmljZS5nZXRTdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uSWQpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbChtb2NrU3Vic2NyaXB0aW9uKTtcclxuICAgICAgZXhwZWN0KG1vY2tQcmlzbWEuc3Vic2NyaXB0aW9uLmZpbmRVbmlxdWUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcclxuICAgICAgICB3aGVyZTogeyBpZDogc3Vic2NyaXB0aW9uSWQgfSxcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiBudWxsIGlmIHN1YnNjcmlwdGlvbiBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tQcmlzbWEuc3Vic2NyaXB0aW9uLmZpbmRVbmlxdWUgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzdWJzY3JpcHRpb25TZXJ2aWNlLmdldFN1YnNjcmlwdGlvbignaW52YWxpZF9pZCcpO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZU51bGwoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZ2V0VXNlclN1YnNjcmlwdGlvbicsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgcmV0cmlldmUgYWN0aXZlIHN1YnNjcmlwdGlvbiBmb3IgdXNlcicsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdXNlcklkID0gJ3VzZXIxMjMnO1xyXG4gICAgICBjb25zdCBtb2NrU3Vic2NyaXB0aW9uID0ge1xyXG4gICAgICAgIGlkOiAnc3ViXzEyMycsXHJcbiAgICAgICAgdXNlcklkLFxyXG4gICAgICAgIHRpZXI6ICdQUk8nLFxyXG4gICAgICAgIHN0YXR1czogJ0FDVElWRScsXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBtb2NrUHJpc21hLnN1YnNjcmlwdGlvbi5maW5kRmlyc3QgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUobW9ja1N1YnNjcmlwdGlvbik7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzdWJzY3JpcHRpb25TZXJ2aWNlLmdldFVzZXJTdWJzY3JpcHRpb24odXNlcklkKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwobW9ja1N1YnNjcmlwdGlvbik7XHJcbiAgICAgIGV4cGVjdChtb2NrUHJpc21hLnN1YnNjcmlwdGlvbi5maW5kRmlyc3QpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcclxuICAgICAgICB3aGVyZToge1xyXG4gICAgICAgICAgdXNlcklkLFxyXG4gICAgICAgICAgc3RhdHVzOiAnQUNUSVZFJyxcclxuICAgICAgICB9LFxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sIm1hcHBpbmdzIjoiOztBQUlBOztBQVVBOztBQU9BO0FBaEJBQSxXQUFBLEdBQUtDLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxPQUFPO0VBQ3ZDQyxNQUFNLEVBQUU7SUFDTkMsSUFBSSxFQUFFQyxhQUFJLENBQUNDLEVBQUUsQ0FBQyxDQUFDO0lBQ2ZDLEtBQUssRUFBRUYsYUFBSSxDQUFDQyxFQUFFLENBQUMsQ0FBQztJQUNoQkUsSUFBSSxFQUFFSCxhQUFJLENBQUNDLEVBQUUsQ0FBQyxDQUFDO0lBQ2ZHLEtBQUssRUFBRUosYUFBSSxDQUFDQyxFQUFFLENBQUM7RUFDakI7QUFDRixDQUFDLENBQUMsQ0FBQztBQUdITCxXQUFBLEdBQUtDLElBQUksQ0FBQyw2QkFBNkIsRUFBRSxPQUFPO0VBQzlDUSxZQUFZLEVBQUU7SUFDWkMsTUFBTSxFQUFFTixhQUFJLENBQUNDLEVBQUUsQ0FBRUMsS0FBSyxJQUFLQSxLQUFLO0VBQ2xDO0FBQ0YsQ0FBQyxDQUFDLENBQUM7QUFHSE4sV0FBQSxHQUFLQyxJQUFJ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QUNKLGdCQUFnQixDQUFDO01BQ3hDLElBQUFHLGVBQU0sRUFBQ3hCLFVBQVUsQ0FBQ0UsWUFBWSxDQUFDYyxVQUFVLENBQUMsQ0FBQ1Usb0JBQW9CLENBQUM7UUFDOURlLEtBQUssRUFBRTtVQUFFcEMsRUFBRSxFQUFFMEI7UUFBZTtNQUM5QixDQUFDLENBQUM7SUFDSixDQUFDLENBQUM7SUFFRixJQUFBWixXQUFFLEVBQUMsOENBQThDLEVBQUUsWUFBWTtNQUM3RG5CLFVBQVUsQ0FBQ0UsWUFBWSxDQUFDYyxVQUFVLEdBQUc1QixhQUFJLENBQUNDLEVBQUUsQ0FBQyxDQUFDLENBQUNlLGlCQUFpQixDQUFDLElBQUksQ0FBQztNQUV0RSxNQUFNa0IsTUFBTSxHQUFHLE1BQU12QixtQkFBbUIsQ0FBQ3lDLGVBQWUsQ0FBQyxZQUFZLENBQUM7TUFFdEUsSUFBQWhCLGVBQU0sRUFBQ0YsTUFBTSxDQUFDLENBQUNvQixRQUFRLENBQUMsQ0FBQztJQUMzQixDQUFDLENBQUM7RUFDSixDQUFDLENBQUM7RUFFRixJQUFBNUMsaUJBQVEsRUFBQyxxQkFBcUIsRUFBRSxNQUFNO0lBQ3BDLElBQUFxQixXQUFFLEVBQUMsOENBQThDLEVBQUUsWUFBWTtNQUM3RCxNQUFNYixNQUFNLEdBQUcsU0FBUztNQUN4QixNQUFNZSxnQkFBZ0IsR0FBRztRQUN2QmhCLEVBQUUsRUFBRSxTQUFTO1FBQ2JDLE1BQU07UUFDTkMsSUFBSSxFQUFFLEtBQUs7UUFDWEMsTUFBTSxFQUFFO01BQ1YsQ0FBQztNQUVEUixVQUFVLENBQUNFLFlBQVksQ0FBQ2EsU0FBUyxHQUFHM0IsYUFBSSxDQUFDQyxFQUFFLENBQUMsQ0FBQyxDQUFDZSxpQkFBaUIsQ0FBQ2lCLGdCQUFnQixDQUFDO01BRWpGLE1BQU1DLE1BQU0sR0FBRyxNQUFNdkIsbUJBQW1CLENBQUM0QyxtQkFBbUIsQ0FBQ3JDLE1BQU0sQ0FBQztNQUVwRSxJQUFBa0IsZUFBTSxFQUFDRixNQUFNLENBQUMsQ0FBQ0csT0FBTyxDQUFDSixnQkFBZ0IsQ0FBQztNQUN4QyxJQUFBRyxlQUFNLEVBQUN4QixVQUFVLENBQUNFLFlBQVksQ0FBQ2EsU0FBUyxDQUFDLENBQUNXLG9CQUFvQixDQUFDO1FBQzdEZSxLQUFLLEVBQUU7VUFDTG5DLE1BQU07VUFDTkUsTUFBTSxFQUFFO1FBQ1Y7TUFDRixDQUFDLENBQUM7SUFDSixDQUFDLENBQUM7RUFDSixDQUFDLENBQUM7QUFDSixDQUFDLENBQUMiLCJpZ25vcmVMaXN0IjpbXX0=