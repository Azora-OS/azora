{"version":3,"names":["fs","_interopRequireWildcard","require","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","ContextManager","MAX_CONTEXT_FILES","MAX_FILE_SIZE","buildContext","files","projectGraph","contexts","filePath","stats","promises","stat","size","console","log","content","readFile","relevance","calculateRelevance","push","path","error","sort","a","b","slice","selectRelevantFiles","targetFile","relevantFiles","Set","deps","dependencies","some","dep","resolveImport","add","targetDeps","resolvedPath","Array","from","compressContext","map","ctx","compressCode","code","replace","split","line","trim","join","endsWith","fileNode","imports","length","exports","symbols","includes","importPath","fromFile","startsWith","fromDir","substring","lastIndexOf","resolved","parts","normalized","part","pop","extensions","ext","withExt","existsSync","estimateTokenCount","totalChars","Math","ceil"],"sources":["ContextManager.ts"],"sourcesContent":["import * as fs from 'fs';\nimport { ProjectGraph } from './ProjectIndexer';\n\nexport interface FileContext {\n  path: string;\n  content: string;\n  relevance: number;\n}\n\nexport class ContextManager {\n  private readonly MAX_CONTEXT_FILES = 10;\n  private readonly MAX_FILE_SIZE = 50000; // 50KB per file\n\n  async buildContext(\n    files: string[],\n    projectGraph: ProjectGraph | null\n  ): Promise<FileContext[]> {\n    const contexts: FileContext[] = [];\n\n    for (const filePath of files) {\n      try {\n        const stats = await fs.promises.stat(filePath);\n        \n        // Skip files that are too large\n        if (stats.size > this.MAX_FILE_SIZE) {\n          console.log(`Skipping large file: ${filePath} (${stats.size} bytes)`);\n          continue;\n        }\n\n        const content = await fs.promises.readFile(filePath, 'utf-8');\n        const relevance = this.calculateRelevance(filePath, projectGraph);\n\n        contexts.push({\n          path: filePath,\n          content,\n          relevance,\n        });\n      } catch (error) {\n        console.error(`Failed to read file ${filePath}:`, error);\n      }\n    }\n\n    // Sort by relevance and limit\n    return contexts\n      .sort((a, b) => b.relevance - a.relevance)\n      .slice(0, this.MAX_CONTEXT_FILES);\n  }\n\n  async selectRelevantFiles(\n    targetFile: string,\n    projectGraph: ProjectGraph | null\n  ): Promise<string[]> {\n    if (!projectGraph) {\n      return [targetFile];\n    }\n\n    const relevantFiles = new Set<string>([targetFile]);\n\n    // Add files that import the target file\n    for (const [filePath, deps] of projectGraph.dependencies) {\n      if (deps.some(dep => this.resolveImport(dep, filePath) === targetFile)) {\n        relevantFiles.add(filePath);\n      }\n    }\n\n    // Add files imported by the target file\n    const targetDeps = projectGraph.dependencies.get(targetFile);\n    if (targetDeps) {\n      for (const dep of targetDeps) {\n        const resolvedPath = this.resolveImport(dep, targetFile);\n        if (resolvedPath && projectGraph.files.has(resolvedPath)) {\n          relevantFiles.add(resolvedPath);\n        }\n      }\n    }\n\n    return Array.from(relevantFiles);\n  }\n\n  compressContext(contexts: FileContext[]): FileContext[] {\n    // Remove comments and extra whitespace to reduce token count\n    return contexts.map(ctx => ({\n      ...ctx,\n      content: this.compressCode(ctx.content),\n    }));\n  }\n\n  private compressCode(code: string): string {\n    // Remove single-line comments\n    code = code.replace(/\\/\\/.*$/gm, '');\n    \n    // Remove multi-line comments\n    code = code.replace(/\\/\\*[\\s\\S]*?\\*\\//g, '');\n    \n    // Remove extra whitespace\n    code = code.replace(/\\n\\s*\\n/g, '\\n');\n    \n    // Trim lines\n    code = code.split('\\n').map(line => line.trim()).join('\\n');\n    \n    return code;\n  }\n\n  private calculateRelevance(filePath: string, projectGraph: ProjectGraph | null): number {\n    let relevance = 1.0;\n\n    // Boost relevance for certain file types\n    if (filePath.endsWith('.ts') || filePath.endsWith('.tsx')) {\n      relevance += 0.5;\n    }\n\n    // Boost relevance for files with many imports/exports\n    if (projectGraph) {\n      const fileNode = projectGraph.files.get(filePath);\n      if (fileNode) {\n        relevance += fileNode.imports.length * 0.1;\n        relevance += fileNode.exports.length * 0.2;\n        relevance += fileNode.symbols.length * 0.05;\n      }\n    }\n\n    // Reduce relevance for test files\n    if (filePath.includes('.test.') || filePath.includes('.spec.')) {\n      relevance *= 0.5;\n    }\n\n    // Reduce relevance for config files\n    if (filePath.includes('config') || filePath.includes('.config.')) {\n      relevance *= 0.7;\n    }\n\n    return relevance;\n  }\n\n  private resolveImport(importPath: string, fromFile: string): string | null {\n    // Handle relative imports\n    if (importPath.startsWith('.')) {\n      const fromDir = fromFile.substring(0, fromFile.lastIndexOf('/'));\n      let resolved = `${fromDir}/${importPath}`;\n      \n      // Normalize path\n      const parts = resolved.split('/');\n      const normalized: string[] = [];\n      for (const part of parts) {\n        if (part === '..') {\n          normalized.pop();\n        } else if (part !== '.') {\n          normalized.push(part);\n        }\n      }\n      resolved = normalized.join('/');\n      \n      // Try common extensions\n      const extensions = ['.ts', '.tsx', '.js', '.jsx', '/index.ts', '/index.tsx'];\n      for (const ext of extensions) {\n        const withExt = resolved + ext;\n        try {\n          if (fs.existsSync(withExt)) {\n            return withExt;\n          }\n        } catch {\n          // Ignore\n        }\n      }\n    }\n\n    return null;\n  }\n\n  estimateTokenCount(contexts: FileContext[]): number {\n    let totalChars = 0;\n    for (const ctx of contexts) {\n      totalChars += ctx.content.length;\n    }\n    // Rough estimate: 1 token â‰ˆ 4 characters\n    return Math.ceil(totalChars / 4);\n  }\n}\n"],"mappings":"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","ignoreList":[]}