{"version":3,"names":["describe","it","generateTraceId","Date","now","Math","random","toString","substr","traceId","expect","toMatch","generateSpanId","spanId","toBeDefined","length","toBeGreaterThan","mockRequest","headers","tracingMiddleware","req","res","next","mockResponse","nextFunction","jest","fn","toHaveBeenCalled","startTime","endTime","duration","toBe","requestCounts","Map","incrementCounter","endpoint","count","get","set","metrics","totalRequests","errorRequests","recordRequest","isError","getErrorRate","checkHealth","status","timestamp","toISOString","health","checkDependencies","database","redis","externalAPI","dependencies","measureExecutionTime","start","testFunction","Promise","resolve","setTimeout","toBeGreaterThanOrEqual","slowQueries","SLOW_QUERY_THRESHOLD","recordQuery","query","push","captureError","error","context","message","stack","Error","errorDetails","userId","categorizeError","statusCode"],"sources":["observability.test.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\r\n\r\ndescribe('Shared Utilities - Observability', () => {\r\n  describe('Tracing', () => {\r\n    it('should generate trace ID', () => {\r\n      const generateTraceId = (): string => {\r\n        return `trace-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\r\n      };\r\n      \r\n      const traceId = generateTraceId();\r\n      expect(traceId).toMatch(/^trace-\\d+-[a-z0-9]+$/);\r\n    });\r\n    \r\n    it('should generate span ID', () => {\r\n      const generateSpanId = (): string => {\r\n        return Math.random().toString(36).substr(2, 16);\r\n      };\r\n      \r\n      const spanId = generateSpanId();\r\n      expect(spanId).toBeDefined();\r\n      expect(spanId.length).toBeGreaterThan(0);\r\n    });\r\n    \r\n    it('should attach trace context to request', () => {\r\n      const mockRequest: any = {\r\n        headers: {}\r\n      };\r\n      \r\n      const tracingMiddleware = (req: any, res: Response, next: NextFunction) => {\r\n        req.traceId = `trace-${Date.now()}`;\r\n        req.spanId = Math.random().toString(36).substr(2, 16);\r\n        next();\r\n      };\r\n      \r\n      const mockResponse = {} as Response;\r\n      const nextFunction = jest.fn();\r\n      \r\n      tracingMiddleware(mockRequest, mockResponse, nextFunction);\r\n      \r\n      expect(mockRequest.traceId).toBeDefined();\r\n      expect(mockRequest.spanId).toBeDefined();\r\n      expect(nextFunction).toHaveBeenCalled();\r\n    });\r\n  });\r\n  \r\n  describe('Metrics', () => {\r\n    it('should track request duration', () => {\r\n      const startTime = Date.now();\r\n      const endTime = startTime + 150;\r\n      const duration = endTime - startTime;\r\n      \r\n      expect(duration).toBe(150);\r\n    });\r\n    \r\n    it('should count requests by endpoint', () => {\r\n      const requestCounts = new Map<string, number>();\r\n      \r\n      const incrementCounter = (endpoint: string) => {\r\n        const count = requestCounts.get(endpoint) || 0;\r\n        requestCounts.set(endpoint, count + 1);\r\n      };\r\n      \r\n      incrementCounter('/api/users');\r\n      incrementCounter('/api/users');\r\n      incrementCounter('/api/courses');\r\n      \r\n      expect(requestCounts.get('/api/users')).toBe(2);\r\n      expect(requestCounts.get('/api/courses')).toBe(1);\r\n    });\r\n    \r\n    it('should track error rates', () => {\r\n      const metrics = {\r\n        totalRequests: 0,\r\n        errorRequests: 0\r\n      };\r\n      \r\n      const recordRequest = (isError: boolean) => {\r\n        metrics.totalRequests++;\r\n        if (isError) metrics.errorRequests++;\r\n      };\r\n      \r\n      const getErrorRate = (): number => {\r\n        return metrics.totalRequests > 0\r\n          ? (metrics.errorRequests / metrics.totalRequests) * 100\r\n          : 0;\r\n      };\r\n      \r\n      recordRequest(false);\r\n      recordRequest(false);\r\n      recordRequest(true);\r\n      recordRequest(false);\r\n      \r\n      expect(getErrorRate()).toBe(25);\r\n    });\r\n  });\r\n  \r\n  describe('Health Checks', () => {\r\n    it('should check service health', () => {\r\n      const checkHealth = (): { status: string; timestamp: string } => {\r\n        return {\r\n          status: 'healthy',\r\n          timestamp: new Date().toISOString()\r\n        };\r\n      };\r\n      \r\n      const health = checkHealth();\r\n      expect(health.status).toBe('healthy');\r\n      expect(health.timestamp).toBeDefined();\r\n    });\r\n    \r\n    it('should check dependency health', () => {\r\n      const checkDependencies = (): Record<string, boolean> => {\r\n        return {\r\n          database: true,\r\n          redis: true,\r\n          externalAPI: false\r\n        };\r\n      };\r\n      \r\n      const dependencies = checkDependencies();\r\n      expect(dependencies.database).toBe(true);\r\n      expect(dependencies.redis).toBe(true);\r\n      expect(dependencies.externalAPI).toBe(false);\r\n    });\r\n  });\r\n  \r\n  describe('Performance Monitoring', () => {\r\n    it('should measure function execution time', async () => {\r\n      const measureExecutionTime = async (fn: () => Promise<void>): Promise<number> => {\r\n        const start = Date.now();\r\n        await fn();\r\n        return Date.now() - start;\r\n      };\r\n      \r\n      const testFunction = async () => {\r\n        await new Promise(resolve => setTimeout(resolve, 10));\r\n      };\r\n      \r\n      const duration = await measureExecutionTime(testFunction);\r\n      expect(duration).toBeGreaterThanOrEqual(10);\r\n    });\r\n    \r\n    it('should track slow queries', () => {\r\n      const slowQueries: Array<{ query: string; duration: number }> = [];\r\n      const SLOW_QUERY_THRESHOLD = 100;\r\n      \r\n      const recordQuery = (query: string, duration: number) => {\r\n        if (duration > SLOW_QUERY_THRESHOLD) {\r\n          slowQueries.push({ query, duration });\r\n        }\r\n      };\r\n      \r\n      recordQuery('SELECT * FROM users', 50);\r\n      recordQuery('SELECT * FROM large_table', 150);\r\n      recordQuery('SELECT * FROM another_table', 200);\r\n      \r\n      expect(slowQueries.length).toBe(2);\r\n      expect(slowQueries[0].duration).toBe(150);\r\n    });\r\n  });\r\n  \r\n  describe('Error Tracking', () => {\r\n    it('should capture error details', () => {\r\n      const captureError = (error: Error, context: Record<string, any>) => {\r\n        return {\r\n          message: error.message,\r\n          stack: error.stack,\r\n          timestamp: new Date().toISOString(),\r\n          ...context\r\n        };\r\n      };\r\n      \r\n      const error = new Error('Test error');\r\n      const errorDetails = captureError(error, { userId: '123', endpoint: '/api/test' });\r\n      \r\n      expect(errorDetails.message).toBe('Test error');\r\n      expect(errorDetails.stack).toBeDefined();\r\n      expect(errorDetails.userId).toBe('123');\r\n      expect(errorDetails.endpoint).toBe('/api/test');\r\n    });\r\n    \r\n    it('should categorize errors', () => {\r\n      const categorizeError = (statusCode: number): string => {\r\n        if (statusCode >= 500) return 'server_error';\r\n        if (statusCode >= 400) return 'client_error';\r\n        return 'unknown';\r\n      };\r\n      \r\n      expect(categorizeError(500)).toBe('server_error');\r\n      expect(categorizeError(404)).toBe('client_error');\r\n      expect(categorizeError(200)).toBe('unknown');\r\n    });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}