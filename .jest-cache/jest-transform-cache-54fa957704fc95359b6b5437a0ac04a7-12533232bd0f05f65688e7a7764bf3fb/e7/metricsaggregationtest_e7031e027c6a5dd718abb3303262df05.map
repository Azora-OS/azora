{"version":3,"names":["CustomMetrics","require","describe","metrics","beforeEach","it","incrementCounter","endpoint","allMetrics","getMetrics","expect","counters","toBeDefined","source","course_id","Object","keys","length","toBeGreaterThan","counterValue","toBe","setGauge","gauges","service","recordHistogram","histograms","toHaveLength","histogram","toHaveProperty","recordUserRegistration","recordCourseEnrollment","recordPaymentTransaction","recordAPICall","prometheusOutput","exportPrometheus","toContain","method","toMatch","key1","getMetricKey","a","b","key2","key","label1","label2"],"sources":["metrics-aggregation.test.js"],"sourcesContent":["const CustomMetrics = require('../custom-metrics');\r\n\r\ndescribe('Metrics Aggregation', () => {\r\n  let metrics;\r\n\r\n  beforeEach(() => {\r\n    metrics = new CustomMetrics();\r\n  });\r\n\r\n  describe('Counter Aggregation', () => {\r\n    it('should aggregate counter metrics', () => {\r\n      metrics.incrementCounter('requests_total', { endpoint: '/api/users' });\r\n      metrics.incrementCounter('requests_total', { endpoint: '/api/users' });\r\n      metrics.incrementCounter('requests_total', { endpoint: '/api/courses' });\r\n\r\n      const allMetrics = metrics.getMetrics();\r\n      expect(allMetrics.counters).toBeDefined();\r\n    });\r\n\r\n    it('should track multiple counters independently', () => {\r\n      metrics.incrementCounter('user_registrations_total', { source: 'web' });\r\n      metrics.incrementCounter('course_enrollments_total', { course_id: '123' });\r\n\r\n      const allMetrics = metrics.getMetrics();\r\n      expect(Object.keys(allMetrics.counters).length).toBeGreaterThan(0);\r\n    });\r\n\r\n    it('should increment counters correctly', () => {\r\n      metrics.incrementCounter('test_counter', {});\r\n      metrics.incrementCounter('test_counter', {});\r\n      metrics.incrementCounter('test_counter', {});\r\n\r\n      const allMetrics = metrics.getMetrics();\r\n      const counterValue = allMetrics.counters['test_counter{}'];\r\n      expect(counterValue).toBe(3);\r\n    });\r\n  });\r\n\r\n  describe('Gauge Aggregation', () => {\r\n    it('should set gauge values', () => {\r\n      metrics.setGauge('active_users', 100);\r\n      metrics.setGauge('memory_usage', 75.5);\r\n\r\n      const allMetrics = metrics.getMetrics();\r\n      expect(allMetrics.gauges).toBeDefined();\r\n      expect(allMetrics.gauges['active_users{}']).toBe(100);\r\n    });\r\n\r\n    it('should update gauge values', () => {\r\n      metrics.setGauge('cpu_usage', 50);\r\n      metrics.setGauge('cpu_usage', 75);\r\n\r\n      const allMetrics = metrics.getMetrics();\r\n      expect(allMetrics.gauges['cpu_usage{}']).toBe(75);\r\n    });\r\n\r\n    it('should handle gauge labels', () => {\r\n      metrics.setGauge('service_health', 1, { service: 'auth' });\r\n      metrics.setGauge('service_health', 0, { service: 'payment' });\r\n\r\n      const allMetrics = metrics.getMetrics();\r\n      expect(allMetrics.gauges['service_health{service=\"auth\"}']).toBe(1);\r\n      expect(allMetrics.gauges['service_health{service=\"payment\"}']).toBe(0);\r\n    });\r\n  });\r\n\r\n  describe('Histogram Aggregation', () => {\r\n    it('should record histogram values', () => {\r\n      metrics.recordHistogram('request_duration', 100);\r\n      metrics.recordHistogram('request_duration', 200);\r\n      metrics.recordHistogram('request_duration', 150);\r\n\r\n      const allMetrics = metrics.getMetrics();\r\n      expect(allMetrics.histograms['request_duration{}']).toHaveLength(3);\r\n    });\r\n\r\n    it('should track histogram with labels', () => {\r\n      metrics.recordHistogram('api_latency', 50, { endpoint: '/api/users' });\r\n      metrics.recordHistogram('api_latency', 75, { endpoint: '/api/users' });\r\n\r\n      const allMetrics = metrics.getMetrics();\r\n      const histogram = allMetrics.histograms['api_latency{endpoint=\"/api/users\"}'];\r\n      expect(histogram).toHaveLength(2);\r\n    });\r\n\r\n    it('should include timestamps in histogram entries', () => {\r\n      metrics.recordHistogram('test_metric', 100);\r\n\r\n      const allMetrics = metrics.getMetrics();\r\n      const histogram = allMetrics.histograms['test_metric{}'];\r\n      expect(histogram[0]).toHaveProperty('timestamp');\r\n      expect(histogram[0]).toHaveProperty('value', 100);\r\n    });\r\n  });\r\n\r\n  describe('Business Metrics', () => {\r\n    it('should record user registrations', () => {\r\n      metrics.recordUserRegistration('user123', 'web');\r\n      metrics.recordUserRegistration('user456', 'mobile');\r\n\r\n      const allMetrics = metrics.getMetrics();\r\n      expect(allMetrics.counters['user_registrations_total{source=\"web\"}']).toBe(1);\r\n      expect(allMetrics.counters['user_registrations_total{source=\"mobile\"}']).toBe(1);\r\n    });\r\n\r\n    it('should record course enrollments', () => {\r\n      metrics.recordCourseEnrollment('course123', 'user456', 99.99);\r\n\r\n      const allMetrics = metrics.getMetrics();\r\n      expect(allMetrics.counters['course_enrollments_total{course_id=\"course123\"}']).toBe(1);\r\n    });\r\n\r\n    it('should record payment transactions', () => {\r\n      metrics.recordPaymentTransaction(100, 'USD', 'success');\r\n      metrics.recordPaymentTransaction(50, 'USD', 'failed');\r\n\r\n      const allMetrics = metrics.getMetrics();\r\n      expect(allMetrics.counters['payment_transactions_total{currency=\"USD\",status=\"success\"}']).toBe(1);\r\n      expect(allMetrics.counters['payment_transactions_total{currency=\"USD\",status=\"failed\"}']).toBe(1);\r\n    });\r\n\r\n    it('should record API calls', () => {\r\n      metrics.recordAPICall('/api/users', 'GET', 150, 200);\r\n      metrics.recordAPICall('/api/users', 'POST', 200, 201);\r\n\r\n      const allMetrics = metrics.getMetrics();\r\n      expect(allMetrics.counters['api_requests_total{endpoint=\"/api/users\",method=\"GET\",status=\"200\"}']).toBe(1);\r\n    });\r\n  });\r\n\r\n  describe('Prometheus Export', () => {\r\n    it('should export metrics in Prometheus format', () => {\r\n      metrics.incrementCounter('test_counter', {});\r\n      metrics.setGauge('test_gauge', 42);\r\n\r\n      const prometheusOutput = metrics.exportPrometheus();\r\n      expect(typeof prometheusOutput).toBe('string');\r\n      expect(prometheusOutput).toContain('test_counter');\r\n      expect(prometheusOutput).toContain('test_gauge');\r\n    });\r\n\r\n    it('should format counter metrics correctly', () => {\r\n      metrics.incrementCounter('requests_total', { method: 'GET' });\r\n\r\n      const prometheusOutput = metrics.exportPrometheus();\r\n      expect(prometheusOutput).toMatch(/requests_total.*1/);\r\n    });\r\n\r\n    it('should format gauge metrics correctly', () => {\r\n      metrics.setGauge('memory_usage', 75.5);\r\n\r\n      const prometheusOutput = metrics.exportPrometheus();\r\n      expect(prometheusOutput).toMatch(/memory_usage.*75\\.5/);\r\n    });\r\n  });\r\n\r\n  describe('Metric Keys', () => {\r\n    it('should generate consistent metric keys', () => {\r\n      const key1 = metrics.getMetricKey('test_metric', { a: '1', b: '2' });\r\n      const key2 = metrics.getMetricKey('test_metric', { b: '2', a: '1' });\r\n\r\n      expect(key1).toBe(key2);\r\n    });\r\n\r\n    it('should include labels in metric keys', () => {\r\n      const key = metrics.getMetricKey('test_metric', { label1: 'value1', label2: 'value2' });\r\n\r\n      expect(key).toContain('label1=\"value1\"');\r\n      expect(key).toContain('label2=\"value2\"');\r\n    });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}