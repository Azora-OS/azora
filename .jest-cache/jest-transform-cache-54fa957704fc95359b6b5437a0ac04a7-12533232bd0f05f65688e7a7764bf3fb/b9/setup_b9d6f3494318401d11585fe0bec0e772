c9dc0388cda087046bc40f1210d5b80d
"use strict";

var _env = require("./utils/env");
var _database = require("./utils/database");
var _redis = require("./utils/redis");
var _testExecutionOptimizer = require("./utils/test-execution-optimizer");
// Load test environment variables
(0, _env.loadTestEnv)();
let prisma;
let redis;
let useOptimizations = process.env.USE_TEST_OPTIMIZATIONS !== 'false';

// Global setup
beforeAll(async () => {
  try {
    // Database setup
    prisma = await (0, _database.setupTestDatabase)();

    // Redis setup
    redis = await (0, _redis.setupTestRedis)();

    // Initialize test optimizer
    if (useOptimizations) {
      await (0, _testExecutionOptimizer.initializeTestOptimizer)();
      console.log('Test optimizations enabled');
    }

    // Global test timeout
    const timeout = parseInt(process.env.TEST_TIMEOUT || '30000', 10);
    jest.setTimeout(timeout);

    // Make available globally
    global.prisma = prisma;
    global.redis = redis;
    console.log('Test environment setup complete');
  } catch (error) {
    console.error('Failed to setup test environment:', error);
    throw error;
  }
});

// Global teardown
afterAll(async () => {
  try {
    // Save test optimizer state
    if (useOptimizations) {
      await (0, _testExecutionOptimizer.saveTestOptimizer)();
      console.log('Test optimization state saved');
    }
    await (0, _database.disconnectTestDatabase)();
    await (0, _redis.disconnectTestRedis)();
    console.log('Test environment teardown complete');
  } catch (error) {
    console.error('Error during test teardown:', error);
  }
});

// Setup before each test
beforeEach(async () => {
  try {
    if (useOptimizations) {
      // Use optimized setup (begin transaction)
      await (0, _testExecutionOptimizer.setupOptimizedTest)();
    }
  } catch (error) {
    console.error('Error during test setup:', error);
    // Don't throw to avoid breaking test execution
  }
});

// Clean up after each test
afterEach(async () => {
  try {
    if (useOptimizations) {
      // Use optimized cleanup (transaction rollback + pipeline operations)
      await (0, _testExecutionOptimizer.cleanupOptimizedTest)();
    } else {
      // Use standard cleanup
      await (0, _database.cleanupTestDatabase)();
      await (0, _redis.cleanupTestRedis)();
    }
  } catch (error) {
    console.error('Error during test cleanup:', error);
    // Don't throw to avoid breaking test execution
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfZW52IiwicmVxdWlyZSIsIl9kYXRhYmFzZSIsIl9yZWRpcyIsIl90ZXN0RXhlY3V0aW9uT3B0aW1pemVyIiwibG9hZFRlc3RFbnYiLCJwcmlzbWEiLCJyZWRpcyIsInVzZU9wdGltaXphdGlvbnMiLCJwcm9jZXNzIiwiZW52IiwiVVNFX1RFU1RfT1BUSU1JWkFUSU9OUyIsImJlZm9yZUFsbCIsInNldHVwVGVzdERhdGFiYXNlIiwic2V0dXBUZXN0UmVkaXMiLCJpbml0aWFsaXplVGVzdE9wdGltaXplciIsImNvbnNvbGUiLCJsb2ciLCJ0aW1lb3V0IiwicGFyc2VJbnQiLCJURVNUX1RJTUVPVVQiLCJqZXN0Iiwic2V0VGltZW91dCIsImdsb2JhbCIsImVycm9yIiwiYWZ0ZXJBbGwiLCJzYXZlVGVzdE9wdGltaXplciIsImRpc2Nvbm5lY3RUZXN0RGF0YWJhc2UiLCJkaXNjb25uZWN0VGVzdFJlZGlzIiwiYmVmb3JlRWFjaCIsInNldHVwT3B0aW1pemVkVGVzdCIsImFmdGVyRWFjaCIsImNsZWFudXBPcHRpbWl6ZWRUZXN0IiwiY2xlYW51cFRlc3REYXRhYmFzZSIsImNsZWFudXBUZXN0UmVkaXMiXSwic291cmNlcyI6WyJzZXR1cC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQcmlzbWFDbGllbnQgfSBmcm9tICdAcHJpc21hL2NsaWVudCc7XG5pbXBvcnQgUmVkaXMgZnJvbSAnaW9yZWRpcyc7XG5pbXBvcnQgeyBsb2FkVGVzdEVudiB9IGZyb20gJy4vdXRpbHMvZW52JztcbmltcG9ydCB7IFxuICBzZXR1cFRlc3REYXRhYmFzZSwgXG4gIGNsZWFudXBUZXN0RGF0YWJhc2UsIFxuICBkaXNjb25uZWN0VGVzdERhdGFiYXNlLFxuICBnZXRUZXN0UHJpc21hQ2xpZW50IFxufSBmcm9tICcuL3V0aWxzL2RhdGFiYXNlJztcbmltcG9ydCB7IFxuICBzZXR1cFRlc3RSZWRpcywgXG4gIGNsZWFudXBUZXN0UmVkaXMsIFxuICBkaXNjb25uZWN0VGVzdFJlZGlzLFxuICBnZXRUZXN0UmVkaXNDbGllbnQgXG59IGZyb20gJy4vdXRpbHMvcmVkaXMnO1xuaW1wb3J0IHtcbiAgaW5pdGlhbGl6ZVRlc3RPcHRpbWl6ZXIsXG4gIHNhdmVUZXN0T3B0aW1pemVyLFxuICBzZXR1cE9wdGltaXplZFRlc3QsXG4gIGNsZWFudXBPcHRpbWl6ZWRUZXN0LFxufSBmcm9tICcuL3V0aWxzL3Rlc3QtZXhlY3V0aW9uLW9wdGltaXplcic7XG5cbi8vIExvYWQgdGVzdCBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbmxvYWRUZXN0RW52KCk7XG5cbmxldCBwcmlzbWE6IFByaXNtYUNsaWVudDtcbmxldCByZWRpczogUmVkaXM7XG5sZXQgdXNlT3B0aW1pemF0aW9ucyA9IHByb2Nlc3MuZW52LlVTRV9URVNUX09QVElNSVpBVElPTlMgIT09ICdmYWxzZSc7XG5cbi8vIEdsb2JhbCBzZXR1cFxuYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgdHJ5IHtcbiAgICAvLyBEYXRhYmFzZSBzZXR1cFxuICAgIHByaXNtYSA9IGF3YWl0IHNldHVwVGVzdERhdGFiYXNlKCk7XG4gICAgXG4gICAgLy8gUmVkaXMgc2V0dXBcbiAgICByZWRpcyA9IGF3YWl0IHNldHVwVGVzdFJlZGlzKCk7XG4gICAgXG4gICAgLy8gSW5pdGlhbGl6ZSB0ZXN0IG9wdGltaXplclxuICAgIGlmICh1c2VPcHRpbWl6YXRpb25zKSB7XG4gICAgICBhd2FpdCBpbml0aWFsaXplVGVzdE9wdGltaXplcigpO1xuICAgICAgY29uc29sZS5sb2coJ1Rlc3Qgb3B0aW1pemF0aW9ucyBlbmFibGVkJyk7XG4gICAgfVxuICAgIFxuICAgIC8vIEdsb2JhbCB0ZXN0IHRpbWVvdXRcbiAgICBjb25zdCB0aW1lb3V0ID0gcGFyc2VJbnQocHJvY2Vzcy5lbnYuVEVTVF9USU1FT1VUIHx8ICczMDAwMCcsIDEwKTtcbiAgICBqZXN0LnNldFRpbWVvdXQodGltZW91dCk7XG4gICAgXG4gICAgLy8gTWFrZSBhdmFpbGFibGUgZ2xvYmFsbHlcbiAgICAoZ2xvYmFsIGFzIGFueSkucHJpc21hID0gcHJpc21hO1xuICAgIChnbG9iYWwgYXMgYW55KS5yZWRpcyA9IHJlZGlzO1xuICAgIFxuICAgIGNvbnNvbGUubG9nKCdUZXN0IGVudmlyb25tZW50IHNldHVwIGNvbXBsZXRlJyk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHNldHVwIHRlc3QgZW52aXJvbm1lbnQ6JywgZXJyb3IpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59KTtcblxuLy8gR2xvYmFsIHRlYXJkb3duXG5hZnRlckFsbChhc3luYyAoKSA9PiB7XG4gIHRyeSB7XG4gICAgLy8gU2F2ZSB0ZXN0IG9wdGltaXplciBzdGF0ZVxuICAgIGlmICh1c2VPcHRpbWl6YXRpb25zKSB7XG4gICAgICBhd2FpdCBzYXZlVGVzdE9wdGltaXplcigpO1xuICAgICAgY29uc29sZS5sb2coJ1Rlc3Qgb3B0aW1pemF0aW9uIHN0YXRlIHNhdmVkJyk7XG4gICAgfVxuICAgIFxuICAgIGF3YWl0IGRpc2Nvbm5lY3RUZXN0RGF0YWJhc2UoKTtcbiAgICBhd2FpdCBkaXNjb25uZWN0VGVzdFJlZGlzKCk7XG4gICAgY29uc29sZS5sb2coJ1Rlc3QgZW52aXJvbm1lbnQgdGVhcmRvd24gY29tcGxldGUnKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBkdXJpbmcgdGVzdCB0ZWFyZG93bjonLCBlcnJvcik7XG4gIH1cbn0pO1xuXG4vLyBTZXR1cCBiZWZvcmUgZWFjaCB0ZXN0XG5iZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgdHJ5IHtcbiAgICBpZiAodXNlT3B0aW1pemF0aW9ucykge1xuICAgICAgLy8gVXNlIG9wdGltaXplZCBzZXR1cCAoYmVnaW4gdHJhbnNhY3Rpb24pXG4gICAgICBhd2FpdCBzZXR1cE9wdGltaXplZFRlc3QoKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZHVyaW5nIHRlc3Qgc2V0dXA6JywgZXJyb3IpO1xuICAgIC8vIERvbid0IHRocm93IHRvIGF2b2lkIGJyZWFraW5nIHRlc3QgZXhlY3V0aW9uXG4gIH1cbn0pO1xuXG4vLyBDbGVhbiB1cCBhZnRlciBlYWNoIHRlc3RcbmFmdGVyRWFjaChhc3luYyAoKSA9PiB7XG4gIHRyeSB7XG4gICAgaWYgKHVzZU9wdGltaXphdGlvbnMpIHtcbiAgICAgIC8vIFVzZSBvcHRpbWl6ZWQgY2xlYW51cCAodHJhbnNhY3Rpb24gcm9sbGJhY2sgKyBwaXBlbGluZSBvcGVyYXRpb25zKVxuICAgICAgYXdhaXQgY2xlYW51cE9wdGltaXplZFRlc3QoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVXNlIHN0YW5kYXJkIGNsZWFudXBcbiAgICAgIGF3YWl0IGNsZWFudXBUZXN0RGF0YWJhc2UoKTtcbiAgICAgIGF3YWl0IGNsZWFudXBUZXN0UmVkaXMoKTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZHVyaW5nIHRlc3QgY2xlYW51cDonLCBlcnJvcik7XG4gICAgLy8gRG9uJ3QgdGhyb3cgdG8gYXZvaWQgYnJlYWtpbmcgdGVzdCBleGVjdXRpb25cbiAgfVxufSk7XG4iXSwibWFwcGluZ3MiOiI7O0FBRUEsSUFBQUEsSUFBQSxHQUFBQyxPQUFBO0FBQ0EsSUFBQUMsU0FBQSxHQUFBRCxPQUFBO0FBTUEsSUFBQUUsTUFBQSxHQUFBRixPQUFBO0FBTUEsSUFBQUcsdUJBQUEsR0FBQUgsT0FBQTtBQU9BO0FBQ0EsSUFBQUksZ0JBQVcsRUFBQyxDQUFDO0FBRWIsSUFBSUMsTUFBb0I7QUFDeEIsSUFBSUMsS0FBWTtBQUNoQixJQUFJQyxnQkFBZ0IsR0FBR0MsT0FBTyxDQUFDQyxHQUFHLENBQUNDLHNCQUFzQixLQUFLLE9BQU87O0FBRXJFO0FBQ0FDLFNBQVMsQ0FBQyxZQUFZO0VBQ3BCLElBQUk7SUFDRjtJQUNBTixNQUFNLEdBQUcsTUFBTSxJQUFBTywyQkFBaUIsRUFBQyxDQUFDOztJQUVsQztJQUNBTixLQUFLLEdBQUcsTUFBTSxJQUFBTyxxQkFBYyxFQUFDLENBQUM7O0lBRTlCO0lBQ0EsSUFBSU4sZ0JBQWdCLEVBQUU7TUFDcEIsTUFBTSxJQUFBTywrQ0FBdUIsRUFBQyxDQUFDO01BQy9CQyxPQUFPLENBQUNDLEdBQUcsQ0FBQyw0QkFBNEIsQ0FBQztJQUMzQzs7SUFFQTtJQUNBLE1BQU1DLE9BQU8sR0FBR0MsUUFBUSxDQUFDVixPQUFPLENBQUNDLEdBQUcsQ0FBQ1UsWUFBWSxJQUFJLE9BQU8sRUFBRSxFQUFFLENBQUM7SUFDakVDLElBQUksQ0FBQ0MsVUFBVSxDQUFDSixPQUFPLENBQUM7O0lBRXhCO0lBQ0NLLE1BQU0sQ0FBU2pCLE1BQU0sR0FBR0EsTUFBTTtJQUM5QmlCLE1BQU0sQ0FBU2hCLEtBQUssR0FBR0EsS0FBSztJQUU3QlMsT0FBTyxDQUFDQyxHQUFHLENBQUMsaUNBQWlDLENBQUM7RUFDaEQsQ0FBQyxDQUFDLE9BQU9PLEtBQUssRUFBRTtJQUNkUixPQUFPLENBQUNRLEtBQUssQ0FBQyxtQ0FBbUMsRUFBRUEsS0FBSyxDQUFDO0lBQ3pELE1BQU1BLEtBQUs7RUFDYjtBQUNGLENBQUMsQ0FBQzs7QUFFRjtBQUNBQyxRQUFRLENBQUMsWUFBWTtFQUNuQixJQUFJO0lBQ0Y7SUFDQSxJQUFJakIsZ0JBQWdCLEVBQUU7TUFDcEIsTUFBTSxJQUFBa0IseUNBQWlCLEVBQUMsQ0FBQztNQUN6QlYsT0FBTyxDQUFDQyxHQUFHLENBQUMsK0JBQStCLENBQUM7SUFDOUM7SUFFQSxNQUFNLElBQUFVLGdDQUFzQixFQUFDLENBQUM7SUFDOUIsTUFBTSxJQUFBQywwQkFBbUIsRUFBQyxDQUFDO0lBQzNCWixPQUFPLENBQUNDLEdBQUcsQ0FBQyxvQ0FBb0MsQ0FBQztFQUNuRCxDQUFDLENBQUMsT0FBT08sS0FBSyxFQUFFO0lBQ2RSLE9BQU8sQ0FBQ1EsS0FBSyxDQUFDLDZCQUE2QixFQUFFQSxLQUFLLENBQUM7RUFDckQ7QUFDRixDQUFDLENBQUM7O0FBRUY7QUFDQUssVUFBVSxDQUFDLFlBQVk7RUFDckIsSUFBSTtJQUNGLElBQUlyQixnQkFBZ0IsRUFBRTtNQUNwQjtNQUNBLE1BQU0sSUFBQXNCLDBDQUFrQixFQUFDLENBQUM7SUFDNUI7RUFDRixDQUFDLENBQUMsT0FBT04sS0FBSyxFQUFFO0lBQ2RSLE9BQU8sQ0FBQ1EsS0FBSyxDQUFDLDBCQUEwQixFQUFFQSxLQUFLLENBQUM7SUFDaEQ7RUFDRjtBQUNGLENBQUMsQ0FBQzs7QUFFRjtBQUNBTyxTQUFTLENBQUMsWUFBWTtFQUNwQixJQUFJO0lBQ0YsSUFBSXZCLGdCQUFnQixFQUFFO01BQ3BCO01BQ0EsTUFBTSxJQUFBd0IsNENBQW9CLEVBQUMsQ0FBQztJQUM5QixDQUFDLE1BQU07TUFDTDtNQUNBLE1BQU0sSUFBQUMsNkJBQW1CLEVBQUMsQ0FBQztNQUMzQixNQUFNLElBQUFDLHVCQUFnQixFQUFDLENBQUM7SUFDMUI7RUFDRixDQUFDLENBQUMsT0FBT1YsS0FBSyxFQUFFO0lBQ2RSLE9BQU8sQ0FBQ1EsS0FBSyxDQUFDLDRCQUE0QixFQUFFQSxLQUFLLENBQUM7SUFDbEQ7RUFDRjtBQUNGLENBQUMsQ0FBQyIsImlnbm9yZUxpc3QiOltdfQ==