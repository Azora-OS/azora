{"version":3,"names":["_globals","require","_supertest","_interopRequireDefault","_stripe","e","__esModule","default","API_URL","process","env","PAY_SERVICE_URL","describe","beforeEach","mockStripe","reset","afterEach","it","res","request","post","send","amount","currency","userId","expect","status","toBe","body","clientSecret","toBeDefined","id","blockchainRecordId","citadelContribution","intentRes","paymentIntentId","refundId","get","query","Array","isArray","payments","startDate","endDate","webhookEvent","type","data","object","set","received"],"sources":["payment-processing.test.ts"],"sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from '@jest/globals';\r\nimport request from 'supertest';\r\nimport { mockStripe } from '../../../tests/mocks/stripe.mock';\r\n\r\nconst API_URL = process.env.PAY_SERVICE_URL || 'http://localhost:3010';\r\n\r\ndescribe('Azora Pay - Payment Processing', () => {\r\n  beforeEach(() => {\r\n    mockStripe.reset();\r\n  });\r\n\r\n  afterEach(() => {\r\n    mockStripe.reset();\r\n  });\r\n\r\n  describe('Payment Intent Creation', () => {\r\n    it('should create payment intent', async () => {\r\n      const res = await request(API_URL)\r\n        .post('/api/payments/intent')\r\n        .send({\r\n          amount: 1000,\r\n          currency: 'usd',\r\n          userId: 'user-123',\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.clientSecret).toBeDefined();\r\n      expect(res.body.id).toBeDefined();\r\n    });\r\n\r\n    it('should reject payment intent without amount', async () => {\r\n      const res = await request(API_URL)\r\n        .post('/api/payments/intent')\r\n        .send({\r\n          currency: 'usd',\r\n          userId: 'user-123',\r\n        });\r\n\r\n      expect(res.status).toBe(400);\r\n    });\r\n\r\n    it('should record payment to blockchain', async () => {\r\n      const res = await request(API_URL)\r\n        .post('/api/payments/intent')\r\n        .send({\r\n          amount: 1000,\r\n          currency: 'usd',\r\n          userId: 'user-123',\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.blockchainRecordId).toBeDefined();\r\n    });\r\n\r\n    it('should contribute to CitadelFund', async () => {\r\n      const res = await request(API_URL)\r\n        .post('/api/payments/intent')\r\n        .send({\r\n          amount: 1000,\r\n          currency: 'usd',\r\n          userId: 'user-123',\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.citadelContribution).toBe(100);\r\n    });\r\n  });\r\n\r\n  describe('Payment Processing', () => {\r\n    it('should process payment successfully', async () => {\r\n      const intentRes = await request(API_URL)\r\n        .post('/api/payments/intent')\r\n        .send({\r\n          amount: 1000,\r\n          currency: 'usd',\r\n          userId: 'user-123',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .post('/api/payments/process')\r\n        .send({\r\n          paymentIntentId: intentRes.body.id,\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.status).toBeDefined();\r\n    });\r\n\r\n    it('should handle payment failure', async () => {\r\n      const res = await request(API_URL)\r\n        .post('/api/payments/process')\r\n        .send({\r\n          paymentIntentId: 'invalid-intent-id',\r\n        });\r\n\r\n      expect(res.status).toBe(500);\r\n    });\r\n  });\r\n\r\n  describe('Refund Handling', () => {\r\n    it('should process refund', async () => {\r\n      const intentRes = await request(API_URL)\r\n        .post('/api/payments/intent')\r\n        .send({\r\n          amount: 1000,\r\n          currency: 'usd',\r\n          userId: 'user-123',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .post('/api/payments/refund')\r\n        .send({\r\n          paymentIntentId: intentRes.body.id,\r\n          amount: 500,\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.refundId).toBeDefined();\r\n    });\r\n\r\n    it('should reject refund for invalid payment', async () => {\r\n      const res = await request(API_URL)\r\n        .post('/api/payments/refund')\r\n        .send({\r\n          paymentIntentId: 'invalid-id',\r\n          amount: 500,\r\n        });\r\n\r\n      expect(res.status).toBe(404);\r\n    });\r\n  });\r\n\r\n  describe('Payment History', () => {\r\n    it('should retrieve payment history for user', async () => {\r\n      const res = await request(API_URL)\r\n        .get('/api/payments/history')\r\n        .query({ userId: 'user-123' });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(Array.isArray(res.body.payments)).toBe(true);\r\n    });\r\n\r\n    it('should filter payment history by date', async () => {\r\n      const res = await request(API_URL)\r\n        .get('/api/payments/history')\r\n        .query({\r\n          userId: 'user-123',\r\n          startDate: '2024-01-01',\r\n          endDate: '2024-12-31',\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(Array.isArray(res.body.payments)).toBe(true);\r\n    });\r\n\r\n    it('should filter payment history by status', async () => {\r\n      const res = await request(API_URL)\r\n        .get('/api/payments/history')\r\n        .query({\r\n          userId: 'user-123',\r\n          status: 'succeeded',\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(Array.isArray(res.body.payments)).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('Webhook Processing', () => {\r\n    it('should process payment success webhook', async () => {\r\n      const webhookEvent = {\r\n        type: 'payment_intent.succeeded',\r\n        data: {\r\n          object: {\r\n            id: 'pi_test_123',\r\n            amount: 1000,\r\n            currency: 'usd',\r\n          },\r\n        },\r\n      };\r\n\r\n      const res = await request(API_URL)\r\n        .post('/api/payments/webhook')\r\n        .set('stripe-signature', 'test-signature')\r\n        .send(webhookEvent);\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.received).toBe(true);\r\n    });\r\n\r\n    it('should process payment failure webhook', async () => {\r\n      const webhookEvent = {\r\n        type: 'payment_intent.payment_failed',\r\n        data: {\r\n          object: {\r\n            id: 'pi_test_123',\r\n            amount: 1000,\r\n            currency: 'usd',\r\n          },\r\n        },\r\n      };\r\n\r\n      const res = await request(API_URL)\r\n        .post('/api/payments/webhook')\r\n        .set('stripe-signature', 'test-signature')\r\n        .send(webhookEvent);\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.received).toBe(true);\r\n    });\r\n\r\n    it('should reject webhook with invalid signature', async () => {\r\n      const webhookEvent = {\r\n        type: 'payment_intent.succeeded',\r\n        data: {\r\n          object: {\r\n            id: 'pi_test_123',\r\n          },\r\n        },\r\n      };\r\n\r\n      const res = await request(API_URL)\r\n        .post('/api/payments/webhook')\r\n        .send(webhookEvent);\r\n\r\n      expect(res.status).toBe(400);\r\n    });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}