{"version":3,"names":["_globals","require","_supertest","_interopRequireDefault","_database","e","__esModule","default","API_URL","process","env","LEDGER_SERVICE_URL","describe","beforeEach","setupTestDatabase","afterEach","cleanupTestDatabase","it","accountId","request","post","send","amount","currency","type","res","get","expect","status","toBe","body","balance","query","Array","isArray","history","length","toBeGreaterThan","startDate","endDate","balances","toBeDefined","USD","EUR"],"sources":["balance-calculation.test.ts"],"sourcesContent":["import { describe, it, expect, beforeEach, afterEach } from '@jest/globals';\r\nimport request from 'supertest';\r\nimport { setupTestDatabase, cleanupTestDatabase } from '../../../tests/utils/database';\r\n\r\nconst API_URL = process.env.LEDGER_SERVICE_URL || 'http://localhost:3012';\r\n\r\ndescribe('Azora Ledger - Balance Calculation', () => {\r\n  beforeEach(async () => {\r\n    await setupTestDatabase();\r\n  });\r\n\r\n  afterEach(async () => {\r\n    await cleanupTestDatabase();\r\n  });\r\n\r\n  describe('Account Balance', () => {\r\n    it('should calculate account balance', async () => {\r\n      const accountId = 'account-123';\r\n\r\n      await request(API_URL)\r\n        .post('/api/transactions')\r\n        .send({\r\n          amount: 100,\r\n          currency: 'USD',\r\n          accountId,\r\n          type: 'credit',\r\n        });\r\n\r\n      await request(API_URL)\r\n        .post('/api/transactions')\r\n        .send({\r\n          amount: 30,\r\n          currency: 'USD',\r\n          accountId,\r\n          type: 'debit',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/accounts/${accountId}/balance`);\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.balance).toBe(70);\r\n    });\r\n\r\n    it('should handle zero balance', async () => {\r\n      const accountId = 'account-456';\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/accounts/${accountId}/balance`);\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.balance).toBe(0);\r\n    });\r\n\r\n    it('should handle negative balance', async () => {\r\n      const accountId = 'account-789';\r\n\r\n      await request(API_URL)\r\n        .post('/api/transactions')\r\n        .send({\r\n          amount: 50,\r\n          currency: 'USD',\r\n          accountId,\r\n          type: 'debit',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/accounts/${accountId}/balance`);\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.balance).toBe(-50);\r\n    });\r\n\r\n    it('should calculate balance by currency', async () => {\r\n      const accountId = 'account-multi';\r\n\r\n      await request(API_URL)\r\n        .post('/api/transactions')\r\n        .send({\r\n          amount: 100,\r\n          currency: 'USD',\r\n          accountId,\r\n          type: 'credit',\r\n        });\r\n\r\n      await request(API_URL)\r\n        .post('/api/transactions')\r\n        .send({\r\n          amount: 50,\r\n          currency: 'EUR',\r\n          accountId,\r\n          type: 'credit',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/accounts/${accountId}/balance`)\r\n        .query({ currency: 'USD' });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.balance).toBe(100);\r\n    });\r\n  });\r\n\r\n  describe('Balance History', () => {\r\n    it('should retrieve balance history', async () => {\r\n      const accountId = 'account-history';\r\n\r\n      await request(API_URL)\r\n        .post('/api/transactions')\r\n        .send({\r\n          amount: 100,\r\n          currency: 'USD',\r\n          accountId,\r\n          type: 'credit',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/accounts/${accountId}/balance-history`);\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(Array.isArray(res.body.history)).toBe(true);\r\n      expect(res.body.history.length).toBeGreaterThan(0);\r\n    });\r\n\r\n    it('should filter balance history by date range', async () => {\r\n      const accountId = 'account-date-filter';\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/accounts/${accountId}/balance-history`)\r\n        .query({\r\n          startDate: '2024-01-01',\r\n          endDate: '2024-12-31',\r\n        });\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(Array.isArray(res.body.history)).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('Multi-Currency Balance', () => {\r\n    it('should calculate balances for multiple currencies', async () => {\r\n      const accountId = 'account-multi-currency';\r\n\r\n      await request(API_URL)\r\n        .post('/api/transactions')\r\n        .send({\r\n          amount: 100,\r\n          currency: 'USD',\r\n          accountId,\r\n          type: 'credit',\r\n        });\r\n\r\n      await request(API_URL)\r\n        .post('/api/transactions')\r\n        .send({\r\n          amount: 50,\r\n          currency: 'EUR',\r\n          accountId,\r\n          type: 'credit',\r\n        });\r\n\r\n      const res = await request(API_URL)\r\n        .get(`/api/accounts/${accountId}/balances`);\r\n\r\n      expect(res.status).toBe(200);\r\n      expect(res.body.balances).toBeDefined();\r\n      expect(res.body.balances.USD).toBe(100);\r\n      expect(res.body.balances.EUR).toBe(50);\r\n    });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}