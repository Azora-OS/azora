{"version":3,"names":["_types","require","_redis","redis","getTestRedisClient","describe","afterEach","cleanupTestRedis","it","incr","RoutingTier","LOCAL_LLM","RAP_SYSTEM","localCount","get","rapCount","expect","parseInt","toBe","hset","total","successful","hget","successRate","times","time","lpush","toString","storedTimes","lrange","average","reduce","sum","t","length","costs","cost","parseFloat","toBeCloseTo","hits","misses","hitRate","QueryComplexity","SIMPLE","MODERATE","simple","moderate","queries","id","slowQueries","filter","q","query","JSON","stringify","stored","toHaveLength","hourly","hgetall","entries","Object","peakHour","peakCount","hour","count","countNum","avgCost","savings","EXTERNAL_LLM","localErrors","externalErrors"],"sources":["routing-analytics.test.ts"],"sourcesContent":["import { RoutingTier, QueryComplexity } from '../types';\nimport { getTestRedisClient, cleanupTestRedis } from '../../../tests/utils/redis';\n\nconst redis = getTestRedisClient();\n\ndescribe('Routing Analytics', () => {\n  afterEach(async () => {\n    await cleanupTestRedis();\n  });\n\n  it('should track routing counts by tier', async () => {\n    await redis.incr(`routing:${RoutingTier.LOCAL_LLM}`);\n    await redis.incr(`routing:${RoutingTier.LOCAL_LLM}`);\n    await redis.incr(`routing:${RoutingTier.RAP_SYSTEM}`);\n\n    const localCount = await redis.get(`routing:${RoutingTier.LOCAL_LLM}`);\n    const rapCount = await redis.get(`routing:${RoutingTier.RAP_SYSTEM}`);\n\n    expect(parseInt(localCount!)).toBe(2);\n    expect(parseInt(rapCount!)).toBe(1);\n  });\n\n  it('should calculate success rates', async () => {\n    await redis.hset(`metrics:${RoutingTier.LOCAL_LLM}`, {\n      total: 100,\n      successful: 95\n    });\n\n    const total = await redis.hget(`metrics:${RoutingTier.LOCAL_LLM}`, 'total');\n    const successful = await redis.hget(`metrics:${RoutingTier.LOCAL_LLM}`, 'successful');\n    const successRate = (parseInt(successful!) / parseInt(total!)) * 100;\n\n    expect(successRate).toBe(95);\n  });\n\n  it('should track response times', async () => {\n    const times = [100, 150, 200];\n    \n    for (const time of times) {\n      await redis.lpush(`times:${RoutingTier.LOCAL_LLM}`, time.toString());\n    }\n\n    const storedTimes = await redis.lrange(`times:${RoutingTier.LOCAL_LLM}`, 0, -1);\n    const average = storedTimes.reduce((sum, t) => sum + parseInt(t), 0) / storedTimes.length;\n\n    expect(average).toBe(150);\n  });\n\n  it('should track costs per tier', async () => {\n    await redis.lpush(`costs:${RoutingTier.LOCAL_LLM}`, '0.001');\n    await redis.lpush(`costs:${RoutingTier.LOCAL_LLM}`, '0.002');\n\n    const costs = await redis.lrange(`costs:${RoutingTier.LOCAL_LLM}`, 0, -1);\n    const total = costs.reduce((sum, cost) => sum + parseFloat(cost), 0);\n\n    expect(total).toBeCloseTo(0.003, 3);\n  });\n\n  it('should track cache hit rates', async () => {\n    await redis.incr('cache:hits');\n    await redis.incr('cache:hits');\n    await redis.incr('cache:misses');\n\n    const hits = await redis.get('cache:hits');\n    const misses = await redis.get('cache:misses');\n    const hitRate = (parseInt(hits!) / (parseInt(hits!) + parseInt(misses!))) * 100;\n\n    expect(hitRate).toBeCloseTo(66.67, 1);\n  });\n\n  it('should track query complexity', async () => {\n    await redis.incr(`complexity:${QueryComplexity.SIMPLE}`);\n    await redis.incr(`complexity:${QueryComplexity.SIMPLE}`);\n    await redis.incr(`complexity:${QueryComplexity.MODERATE}`);\n\n    const simple = await redis.get(`complexity:${QueryComplexity.SIMPLE}`);\n    const moderate = await redis.get(`complexity:${QueryComplexity.MODERATE}`);\n\n    expect(parseInt(simple!)).toBe(2);\n    expect(parseInt(moderate!)).toBe(1);\n  });\n\n  it('should identify slow queries', async () => {\n    const queries = [\n      { id: 'q1', time: 100 },\n      { id: 'q2', time: 2000 },\n      { id: 'q3', time: 150 }\n    ];\n\n    const slowQueries = queries.filter(q => q.time > 1000);\n    \n    for (const query of slowQueries) {\n      await redis.lpush('slow_queries', JSON.stringify(query));\n    }\n\n    const stored = await redis.lrange('slow_queries', 0, -1);\n    expect(stored).toHaveLength(1);\n  });\n\n  it('should track peak usage hours', async () => {\n    await redis.hset('hourly', '9', '50');\n    await redis.hset('hourly', '10', '100');\n    await redis.hset('hourly', '11', '75');\n\n    const hourly = await redis.hgetall('hourly');\n    const entries = Object.entries(hourly);\n    let peakHour = '0';\n    let peakCount = 0;\n    \n    for (const [hour, count] of entries) {\n      const countNum = parseInt(count);\n      if (countNum > peakCount) {\n        peakHour = hour;\n        peakCount = countNum;\n      }\n    }\n\n    expect(parseInt(peakHour)).toBe(10);\n    expect(peakCount).toBe(100);\n  });\n\n  it('should calculate cost savings from cache', async () => {\n    const hits = 80;\n    const avgCost = 0.01;\n    const savings = hits * avgCost;\n\n    await redis.hset('savings', {\n      hits: hits.toString(),\n      avgCost: avgCost.toString(),\n      total: savings.toString()\n    });\n\n    const total = await redis.hget('savings', 'total');\n    expect(parseFloat(total!)).toBe(0.8);\n  });\n\n  it('should track error rates', async () => {\n    await redis.incr(`errors:${RoutingTier.LOCAL_LLM}`);\n    await redis.incr(`errors:${RoutingTier.EXTERNAL_LLM}`);\n    await redis.incr(`errors:${RoutingTier.LOCAL_LLM}`);\n\n    const localErrors = await redis.get(`errors:${RoutingTier.LOCAL_LLM}`);\n    const externalErrors = await redis.get(`errors:${RoutingTier.EXTERNAL_LLM}`);\n\n    expect(parseInt(localErrors!)).toBe(2);\n    expect(parseInt(externalErrors!)).toBe(1);\n  });\n});"],"mappings":"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","ignoreList":[]}