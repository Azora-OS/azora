{"version":3,"names":["request","require","express","rateLimit","createTestApp","app","use","json","testLimiter","windowMs","max","message","error","mockAuth","req","res","next","authHeader","headers","authorization","startsWith","user","userId","email","status","get","service","success","services","education","finance","marketplace","auth","err","describe","beforeEach","it","expect","body","toBe","toBeDefined","i","set","Object","keys","length","toBeGreaterThan","values","forEach","url","toMatch","errorApp","Error"],"sources":["api-gateway.test.js"],"sourcesContent":["const request = require('supertest');\r\nconst express = require('express');\r\nconst rateLimit = require('express-rate-limit');\r\n\r\n// Create test app\r\nconst createTestApp = () => {\r\n  const app = express();\r\n  app.use(express.json());\r\n  \r\n  // Mock rate limiter for testing\r\n  const testLimiter = rateLimit({\r\n    windowMs: 15 * 60 * 1000,\r\n    max: 5, // Lower limit for testing\r\n    message: { error: 'Rate limit exceeded' }\r\n  });\r\n  \r\n  // Mock authentication middleware\r\n  const mockAuth = (req, res, next) => {\r\n    const authHeader = req.headers.authorization;\r\n    if (authHeader && authHeader.startsWith('Bearer ')) {\r\n      req.user = { userId: 1, email: 'test@azora.world' };\r\n      next();\r\n    } else {\r\n      res.status(401).json({ error: 'Unauthorized' });\r\n    }\r\n  };\r\n  \r\n  // Test routes\r\n  app.get('/health', (req, res) => {\r\n    res.json({ status: 'healthy', service: 'azora-api-gateway' });\r\n  });\r\n  \r\n  app.get('/api/test', (req, res) => {\r\n    res.json({ success: true, message: 'Test route' });\r\n  });\r\n  \r\n  app.get('/api/protected', mockAuth, (req, res) => {\r\n    res.json({ success: true, user: req.user });\r\n  });\r\n  \r\n  app.use('/api/limited', testLimiter, (req, res) => {\r\n    res.json({ success: true });\r\n  });\r\n  \r\n  // Service discovery mock\r\n  app.get('/api/services', (req, res) => {\r\n    res.json({\r\n      services: {\r\n        education: 'http://localhost:4001',\r\n        finance: 'http://localhost:4002',\r\n        marketplace: 'http://localhost:4003',\r\n        auth: 'http://localhost:4004'\r\n      }\r\n    });\r\n  });\r\n  \r\n  // Error handling\r\n  app.use((err, req, res, next) => {\r\n    res.status(err.status || 500).json({ error: err.message });\r\n  });\r\n  \r\n  return app;\r\n};\r\n\r\ndescribe('API Gateway - Request Routing', () => {\r\n  let app;\r\n  \r\n  beforeEach(() => {\r\n    app = createTestApp();\r\n  });\r\n  \r\n  it('should route requests to health endpoint', async () => {\r\n    const res = await request(app)\r\n      .get('/health')\r\n      .expect(200);\r\n    \r\n    expect(res.body.status).toBe('healthy');\r\n    expect(res.body.service).toBe('azora-api-gateway');\r\n  });\r\n  \r\n  it('should route requests to API endpoints', async () => {\r\n    const res = await request(app)\r\n      .get('/api/test')\r\n      .expect(200);\r\n    \r\n    expect(res.body.success).toBe(true);\r\n  });\r\n  \r\n  it('should handle service discovery', async () => {\r\n    const res = await request(app)\r\n      .get('/api/services')\r\n      .expect(200);\r\n    \r\n    expect(res.body.services).toBeDefined();\r\n    expect(res.body.services.education).toBeDefined();\r\n    expect(res.body.services.auth).toBeDefined();\r\n  });\r\n});\r\n\r\ndescribe('API Gateway - Rate Limiting', () => {\r\n  let app;\r\n  \r\n  beforeEach(() => {\r\n    app = createTestApp();\r\n  });\r\n  \r\n  it('should allow requests within rate limit', async () => {\r\n    const res = await request(app)\r\n      .get('/api/limited')\r\n      .expect(200);\r\n    \r\n    expect(res.body.success).toBe(true);\r\n  });\r\n  \r\n  it('should enforce rate limits', async () => {\r\n    // Make multiple requests to exceed limit\r\n    for (let i = 0; i < 5; i++) {\r\n      await request(app).get('/api/limited');\r\n    }\r\n    \r\n    // Next request should be rate limited\r\n    const res = await request(app)\r\n      .get('/api/limited')\r\n      .expect(429);\r\n    \r\n    expect(res.body.error).toBeDefined();\r\n  });\r\n});\r\n\r\ndescribe('API Gateway - Authentication Middleware', () => {\r\n  let app;\r\n  \r\n  beforeEach(() => {\r\n    app = createTestApp();\r\n  });\r\n  \r\n  it('should allow authenticated requests', async () => {\r\n    const res = await request(app)\r\n      .get('/api/protected')\r\n      .set('Authorization', 'Bearer valid-token')\r\n      .expect(200);\r\n    \r\n    expect(res.body.success).toBe(true);\r\n    expect(res.body.user).toBeDefined();\r\n  });\r\n  \r\n  it('should reject unauthenticated requests', async () => {\r\n    const res = await request(app)\r\n      .get('/api/protected')\r\n      .expect(401);\r\n    \r\n    expect(res.body.error).toBe('Unauthorized');\r\n  });\r\n  \r\n  it('should reject requests with invalid token format', async () => {\r\n    const res = await request(app)\r\n      .get('/api/protected')\r\n      .set('Authorization', 'InvalidFormat')\r\n      .expect(401);\r\n    \r\n    expect(res.body.error).toBe('Unauthorized');\r\n  });\r\n});\r\n\r\ndescribe('API Gateway - Service Discovery', () => {\r\n  let app;\r\n  \r\n  beforeEach(() => {\r\n    app = createTestApp();\r\n  });\r\n  \r\n  it('should return list of available services', async () => {\r\n    const res = await request(app)\r\n      .get('/api/services')\r\n      .expect(200);\r\n    \r\n    expect(res.body.services).toBeDefined();\r\n    expect(Object.keys(res.body.services).length).toBeGreaterThan(0);\r\n  });\r\n  \r\n  it('should include service URLs', async () => {\r\n    const res = await request(app)\r\n      .get('/api/services')\r\n      .expect(200);\r\n    \r\n    const services = res.body.services;\r\n    Object.values(services).forEach(url => {\r\n      expect(url).toMatch(/^http:\\/\\//);\r\n    });\r\n  });\r\n});\r\n\r\ndescribe('API Gateway - Error Handling', () => {\r\n  let app;\r\n  \r\n  beforeEach(() => {\r\n    app = createTestApp();\r\n  });\r\n  \r\n  it('should handle 404 errors', async () => {\r\n    const res = await request(app)\r\n      .get('/api/nonexistent')\r\n      .expect(404);\r\n  });\r\n  \r\n  it('should handle errors gracefully', async () => {\r\n    const errorApp = express();\r\n    errorApp.use(express.json());\r\n    \r\n    errorApp.get('/api/error', (req, res, next) => {\r\n      next(new Error('Test error'));\r\n    });\r\n    \r\n    errorApp.use((err, req, res, next) => {\r\n      res.status(500).json({ error: err.message });\r\n    });\r\n    \r\n    const res = await request(errorApp)\r\n      .get('/api/error')\r\n      .expect(500);\r\n    \r\n    expect(res.body.error).toBe('Test error');\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}