{"version":3,"names":["path","_interopRequireWildcard","require","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","DatabaseDesigner","generateSchema","schema","outputDir","schemaPath","join","type","content","generatePrismaSchema","generateMigration","migrationName","timestamp","Date","toISOString","replace","split","migrationDir","migrationPath","generateMigrationSQL","output","relationMap","Map","relation","relations","sourceModel","push","targetModel","model","models","name","field","fields","required","unique","defaultValue","primaryKey","isPrimaryKey","padEnd","modelRelations","processedRelations","Set","id","generateRelationField","add","currentModel","isSource","relatedModel","fieldName","sourceField","toLowerCase","targetField","onDelete","sql","columns","sqlType","getSQLType","notNull","getSQLDefault","toUpperCase","prismaType","typeMap","String","Int","Boolean","DateTime","Float","Json","previewMigration","exports"],"sources":["DatabaseDesigner.ts"],"sourcesContent":["import { FileChange } from './ChangesetManager';\nimport * as path from 'path';\n\nexport interface DatabaseModel {\n  id: string;\n  name: string;\n  fields: ModelField[];\n  relations?: ModelRelation[];\n}\n\nexport interface ModelField {\n  id: string;\n  name: string;\n  type: 'String' | 'Int' | 'Boolean' | 'DateTime' | 'Float' | 'Json';\n  required: boolean;\n  unique?: boolean;\n  default?: string;\n  isPrimaryKey?: boolean;\n}\n\nexport interface ModelRelation {\n  id: string;\n  sourceModel: string;\n  targetModel: string;\n  type: '1:1' | '1:N' | 'N:M';\n  sourceField?: string;\n  targetField?: string;\n  onDelete?: 'Cascade' | 'SetNull' | 'Restrict' | 'NoAction';\n}\n\nexport interface DatabaseSchema {\n  models: DatabaseModel[];\n  relations: ModelRelation[];\n}\n\nexport class DatabaseDesigner {\n  generateSchema(schema: DatabaseSchema, outputDir: string): FileChange[] {\n    const schemaPath = path.join(outputDir, 'prisma', 'schema.prisma');\n\n    return [{\n      path: schemaPath,\n      type: 'create',\n      content: this.generatePrismaSchema(schema),\n    }];\n  }\n\n  generateMigration(schema: DatabaseSchema, migrationName: string, outputDir: string): FileChange[] {\n    const timestamp = new Date().toISOString().replace(/[-:]/g, '').split('.')[0];\n    const migrationDir = path.join(outputDir, 'prisma', 'migrations', `${timestamp}_${migrationName}`);\n    const migrationPath = path.join(migrationDir, 'migration.sql');\n\n    return [{\n      path: migrationPath,\n      type: 'create',\n      content: this.generateMigrationSQL(schema),\n    }];\n  }\n\n  private generatePrismaSchema(schema: DatabaseSchema): string {\n    let output = `generator client {\n  provider = \"prisma-client-js\"\n}\n\ndatasource db {\n  provider = \"postgresql\"\n  url      = env(\"DATABASE_URL\")\n}\n\n`;\n\n    // Build relation map for easier lookup (both source and target)\n    const relationMap = new Map<string, ModelRelation[]>();\n    for (const relation of schema.relations) {\n      // Add to source model\n      if (!relationMap.has(relation.sourceModel)) {\n        relationMap.set(relation.sourceModel, []);\n      }\n      relationMap.get(relation.sourceModel)!.push(relation);\n      \n      // Add to target model (for reverse relation)\n      if (!relationMap.has(relation.targetModel)) {\n        relationMap.set(relation.targetModel, []);\n      }\n      relationMap.get(relation.targetModel)!.push(relation);\n    }\n\n    // Generate models\n    for (const model of schema.models) {\n      output += `model ${model.name} {\\n`;\n\n      // Add fields\n      for (const field of model.fields) {\n        const required = field.required ? '' : '?';\n        const unique = field.unique ? ' @unique' : '';\n        const defaultValue = field.default ? ` @default(${field.default})` : '';\n        const primaryKey = field.isPrimaryKey ? ' @id' : '';\n        \n        output += `  ${field.name.padEnd(12)} ${field.type}${required}${primaryKey}${defaultValue}${unique}\\n`;\n      }\n\n      // Add relations\n      const modelRelations = relationMap.get(model.name) || [];\n      const processedRelations = new Set<string>();\n      \n      for (const relation of modelRelations) {\n        // Avoid duplicates\n        if (!processedRelations.has(relation.id)) {\n          output += this.generateRelationField(relation, model.name);\n          processedRelations.add(relation.id);\n        }\n      }\n\n      output += `}\\n\\n`;\n    }\n\n    return output;\n  }\n\n  private generateRelationField(relation: ModelRelation, currentModel: string): string {\n    const isSource = relation.sourceModel === currentModel;\n    const relatedModel = isSource ? relation.targetModel : relation.sourceModel;\n    const fieldName = isSource \n      ? (relation.sourceField || relatedModel.toLowerCase())\n      : (relation.targetField || relation.sourceModel.toLowerCase());\n\n    let output = '';\n\n    if (relation.type === '1:1') {\n      if (isSource) {\n        output += `  ${fieldName.padEnd(12)} ${relatedModel}? @relation(fields: [${fieldName}Id], references: [id])\\n`;\n        output += `  ${(fieldName + 'Id').padEnd(12)} String?\\n`;\n      }\n    } else if (relation.type === '1:N') {\n      if (isSource) {\n        // Source side: array of related models\n        output += `  ${fieldName.padEnd(12)} ${relatedModel}[]\\n`;\n      } else {\n        // Target side: single related model with foreign key\n        output += `  ${fieldName.padEnd(12)} ${relatedModel}? @relation(fields: [${fieldName}Id], references: [id]${relation.onDelete ? `, onDelete: ${relation.onDelete}` : ''})\\n`;\n        output += `  ${(fieldName + 'Id').padEnd(12)} String?\\n`;\n      }\n    } else if (relation.type === 'N:M') {\n      output += `  ${fieldName.padEnd(12)} ${relatedModel}[]\\n`;\n    }\n\n    return output;\n  }\n\n  private generateMigrationSQL(schema: DatabaseSchema): string {\n    let sql = '-- CreateTable\\n';\n\n    for (const model of schema.models) {\n      sql += `CREATE TABLE \"${model.name}\" (\\n`;\n\n      const columns: string[] = [];\n      for (const field of model.fields) {\n        const sqlType = this.getSQLType(field.type);\n        const notNull = field.required ? ' NOT NULL' : '';\n        const unique = field.unique ? ' UNIQUE' : '';\n        const primaryKey = field.isPrimaryKey ? ' PRIMARY KEY' : '';\n        const defaultValue = field.default ? ` DEFAULT ${this.getSQLDefault(field.default, field.type)}` : '';\n        \n        columns.push(`    \"${field.name}\" ${sqlType}${notNull}${primaryKey}${defaultValue}${unique}`);\n      }\n\n      sql += columns.join(',\\n');\n      sql += '\\n);\\n\\n';\n    }\n\n    // Add foreign key constraints\n    for (const relation of schema.relations) {\n      if (relation.type === '1:1' || relation.type === '1:N') {\n        const sourceField = relation.sourceField || relation.targetModel.toLowerCase();\n        sql += `-- AddForeignKey\\n`;\n        sql += `ALTER TABLE \"${relation.sourceModel}\" ADD CONSTRAINT \"${relation.sourceModel}_${sourceField}Id_fkey\" `;\n        sql += `FOREIGN KEY (\"${sourceField}Id\") REFERENCES \"${relation.targetModel}\"(\"id\")`;\n        if (relation.onDelete) {\n          sql += ` ON DELETE ${relation.onDelete.toUpperCase()}`;\n        }\n        sql += ';\\n\\n';\n      }\n    }\n\n    return sql;\n  }\n\n  private getSQLType(prismaType: string): string {\n    const typeMap: Record<string, string> = {\n      String: 'TEXT',\n      Int: 'INTEGER',\n      Boolean: 'BOOLEAN',\n      DateTime: 'TIMESTAMP(3)',\n      Float: 'DOUBLE PRECISION',\n      Json: 'JSONB',\n    };\n    return typeMap[prismaType] || 'TEXT';\n  }\n\n  private getSQLDefault(defaultValue: string, type: string): string {\n    if (defaultValue === 'now()' || defaultValue === 'cuid()' || defaultValue === 'uuid()') {\n      return defaultValue.toUpperCase() + '()';\n    }\n    if (type === 'String') {\n      return `'${defaultValue}'`;\n    }\n    return defaultValue;\n  }\n\n  previewMigration(schema: DatabaseSchema): string {\n    return this.generateMigrationSQL(schema);\n  }\n}\n"],"mappings":"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","ignoreList":[]}