{"version":3,"names":["_ioredis","_interopRequireDefault","require","e","__esModule","default","redis","TEST_KEY_PREFIX","getTestRedisClient","testRedisUrl","process","env","REDIS_URL","Redis","keyPrefix","lazyConnect","retryStrategy","times","Math","min","on","err","console","error","setupTestRedis","client","ping","log","cleanupTestRedis","keys","length","pipeline","forEach","key","keyWithoutPrefix","replace","del","exec","disconnectTestRedis","quit","checkRedisHealth","result","createTestKey","setTestValue","value","expirationSeconds","setex","getTestValue","get","deleteTestKey","batchSetTestValues","entries","entry","ttl","set","batchGetTestValues","results","map","batchDeleteTestKeys"],"sources":["redis.ts"],"sourcesContent":["import Redis from 'ioredis';\r\n\r\nlet redis: Redis | null = null;\r\nconst TEST_KEY_PREFIX = 'test:';\r\n\r\n/**\r\n * Get or create a Redis client instance for testing\r\n */\r\nexport function getTestRedisClient(): Redis {\r\n  if (!redis) {\r\n    const testRedisUrl = process.env.REDIS_URL || 'redis://localhost:6379';\r\n    \r\n    redis = new Redis(testRedisUrl, {\r\n      keyPrefix: TEST_KEY_PREFIX,\r\n      lazyConnect: false,\r\n      retryStrategy: (times) => {\r\n        if (times > 3) {\r\n          return null; // Stop retrying after 3 attempts\r\n        }\r\n        return Math.min(times * 100, 2000);\r\n      },\r\n    });\r\n    \r\n    redis.on('error', (err) => {\r\n      console.error('Redis test client error:', err);\r\n    });\r\n  }\r\n  \r\n  return redis;\r\n}\r\n\r\n/**\r\n * Setup test Redis instance\r\n */\r\nexport async function setupTestRedis(): Promise<Redis> {\r\n  const client = getTestRedisClient();\r\n  \r\n  try {\r\n    // Test connection\r\n    await client.ping();\r\n    console.log('Redis test connection established');\r\n    return client;\r\n  } catch (error) {\r\n    console.error('Failed to setup test Redis:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Clean up all test keys from Redis\r\n */\r\nexport async function cleanupTestRedis(): Promise<void> {\r\n  const client = getTestRedisClient();\r\n  \r\n  try {\r\n    // Get all test keys (with prefix)\r\n    const keys = await client.keys(`${TEST_KEY_PREFIX}*`);\r\n    \r\n    if (keys.length > 0) {\r\n      // Use pipeline for efficient deletion\r\n      const pipeline = client.pipeline();\r\n      keys.forEach(key => {\r\n        // Remove prefix before deleting since client already adds it\r\n        const keyWithoutPrefix = key.replace(TEST_KEY_PREFIX, '');\r\n        pipeline.del(keyWithoutPrefix);\r\n      });\r\n      await pipeline.exec();\r\n      console.log(`Cleaned up ${keys.length} test keys from Redis`);\r\n    }\r\n  } catch (error) {\r\n    console.error('Error cleaning up test Redis:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Disconnect from test Redis\r\n */\r\nexport async function disconnectTestRedis(): Promise<void> {\r\n  if (redis) {\r\n    await redis.quit();\r\n    redis = null;\r\n  }\r\n}\r\n\r\n/**\r\n * Check Redis connection health\r\n */\r\nexport async function checkRedisHealth(): Promise<boolean> {\r\n  try {\r\n    const client = getTestRedisClient();\r\n    const result = await client.ping();\r\n    return result === 'PONG';\r\n  } catch (error) {\r\n    console.error('Redis health check failed:', error);\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Create a test-specific key with automatic prefixing\r\n */\r\nexport function createTestKey(key: string): string {\r\n  return `${TEST_KEY_PREFIX}${key}`;\r\n}\r\n\r\n/**\r\n * Set a test value with automatic expiration\r\n */\r\nexport async function setTestValue(\r\n  key: string,\r\n  value: string,\r\n  expirationSeconds: number = 3600\r\n): Promise<void> {\r\n  const client = getTestRedisClient();\r\n  await client.setex(key, expirationSeconds, value);\r\n}\r\n\r\n/**\r\n * Get a test value\r\n */\r\nexport async function getTestValue(key: string): Promise<string | null> {\r\n  const client = getTestRedisClient();\r\n  return client.get(key);\r\n}\r\n\r\n/**\r\n * Delete a specific test key\r\n */\r\nexport async function deleteTestKey(key: string): Promise<void> {\r\n  const client = getTestRedisClient();\r\n  await client.del(key);\r\n}\r\n\r\n/**\r\n * Batch set multiple key-value pairs using pipeline\r\n */\r\nexport async function batchSetTestValues(\r\n  entries: Array<{ key: string; value: string; ttl?: number }>\r\n): Promise<void> {\r\n  if (entries.length === 0) return;\r\n\r\n  const client = getTestRedisClient();\r\n  const pipeline = client.pipeline();\r\n\r\n  for (const entry of entries) {\r\n    if (entry.ttl) {\r\n      pipeline.setex(entry.key, entry.ttl, entry.value);\r\n    } else {\r\n      pipeline.set(entry.key, entry.value);\r\n    }\r\n  }\r\n\r\n  await pipeline.exec();\r\n}\r\n\r\n/**\r\n * Batch get multiple values using pipeline\r\n */\r\nexport async function batchGetTestValues(keys: string[]): Promise<Array<string | null>> {\r\n  if (keys.length === 0) return [];\r\n\r\n  const client = getTestRedisClient();\r\n  const pipeline = client.pipeline();\r\n\r\n  for (const key of keys) {\r\n    pipeline.get(key);\r\n  }\r\n\r\n  const results = await pipeline.exec();\r\n  return (results || []).map(([err, value]) => (err ? null : value as string | null));\r\n}\r\n\r\n/**\r\n * Batch delete multiple keys using pipeline\r\n */\r\nexport async function batchDeleteTestKeys(keys: string[]): Promise<number> {\r\n  if (keys.length === 0) return 0;\r\n\r\n  const client = getTestRedisClient();\r\n  const pipeline = client.pipeline();\r\n\r\n  for (const key of keys) {\r\n    pipeline.del(key);\r\n  }\r\n\r\n  await pipeline.exec();\r\n  return keys.length;\r\n}\r\n"],"mappings":"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","ignoreList":[]}