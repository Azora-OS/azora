095f654370f1669fa283f8cb811352fb
"use strict";

var _auth = require("../auth");
var _errorHandler = require("../errorHandler");
describe('Auth Middleware', () => {
  let req;
  let res;
  let next;
  beforeEach(() => {
    req = {
      headers: {},
      user: undefined
    };
    res = {};
    next = jest.fn();
  });
  describe('authenticate', () => {
    it('should throw error when no authorization header', () => {
      (0, _auth.authenticate)(req, res, next);
      expect(next).toHaveBeenCalled();
      const error = next.mock.calls[0][0];
      expect(error).toBeInstanceOf(_errorHandler.AppError);
      expect(error.statusCode).toBe(401);
    });
    it('should throw error when authorization header is invalid', () => {
      req.headers = {
        authorization: 'InvalidFormat'
      };
      (0, _auth.authenticate)(req, res, next);
      expect(next).toHaveBeenCalled();
      const error = next.mock.calls[0][0];
      expect(error).toBeInstanceOf(_errorHandler.AppError);
      expect(error.statusCode).toBe(401);
    });
    it('should throw error when token is invalid', () => {
      req.headers = {
        authorization: 'Bearer invalid-token'
      };
      (0, _auth.authenticate)(req, res, next);
      expect(next).toHaveBeenCalled();
      const error = next.mock.calls[0][0];
      expect(error).toBeInstanceOf(_errorHandler.AppError);
      expect(error.statusCode).toBe(401);
    });
    it('should set user when valid token provided', () => {
      const userData = {
        userId: 'user123',
        role: 'admin',
        email: 'test@azora.world'
      };
      const token = Buffer.from(JSON.stringify(userData)).toString('base64');
      req.headers = {
        authorization: `Bearer ${token}`
      };
      (0, _auth.authenticate)(req, res, next);
      expect(next).toHaveBeenCalledWith();
      expect(req.user).toEqual(userData);
    });
    it('should extract userId from token', () => {
      const userData = {
        userId: 'user456'
      };
      const token = Buffer.from(JSON.stringify(userData)).toString('base64');
      req.headers = {
        authorization: `Bearer ${token}`
      };
      (0, _auth.authenticate)(req, res, next);
      expect(req.user?.userId).toBe('user456');
    });
    it('should handle Bearer token with different cases', () => {
      const userData = {
        userId: 'user789'
      };
      const token = Buffer.from(JSON.stringify(userData)).toString('base64');
      req.headers = {
        authorization: `Bearer ${token}`
      };
      (0, _auth.authenticate)(req, res, next);
      expect(next).toHaveBeenCalledWith();
      expect(req.user).toBeDefined();
    });
  });
  describe('requireRole', () => {
    it('should throw error when user not authenticated', () => {
      const middleware = (0, _auth.requireRole)(['admin']);
      req.user = undefined;
      middleware(req, res, next);
      expect(next).toHaveBeenCalled();
      const error = next.mock.calls[0][0];
      expect(error).toBeInstanceOf(_errorHandler.AppError);
      expect(error.statusCode).toBe(401);
    });
    it('should throw error when user role not allowed', () => {
      const middleware = (0, _auth.requireRole)(['admin']);
      req.user = {
        userId: 'user123',
        role: 'user'
      };
      middleware(req, res, next);
      expect(next).toHaveBeenCalled();
      const error = next.mock.calls[0][0];
      expect(error).toBeInstanceOf(_errorHandler.AppError);
      expect(error.statusCode).toBe(403);
    });
    it('should allow user with correct role', () => {
      const middleware = (0, _auth.requireRole)(['admin']);
      req.user = {
        userId: 'user123',
        role: 'admin'
      };
      middleware(req, res, next);
      expect(next).toHaveBeenCalledWith();
    });
    it('should allow user with one of multiple allowed roles', () => {
      const middleware = (0, _auth.requireRole)(['admin', 'moderator']);
      req.user = {
        userId: 'user123',
        role: 'moderator'
      };
      middleware(req, res, next);
      expect(next).toHaveBeenCalledWith();
    });
    it('should throw error when user has no role', () => {
      const middleware = (0, _auth.requireRole)(['admin']);
      req.user = {
        userId: 'user123'
      };
      middleware(req, res, next);
      expect(next).toHaveBeenCalled();
      const error = next.mock.calls[0][0];
      expect(error).toBeInstanceOf(_errorHandler.AppError);
      expect(error.statusCode).toBe(403);
    });
  });
  describe('optionalAuth', () => {
    it('should continue without error when no authorization header', () => {
      (0, _auth.optionalAuth)(req, res, next);
      expect(next).toHaveBeenCalledWith();
      expect(req.user).toBeUndefined();
    });
    it('should continue without error when authorization header is invalid', () => {
      req.headers = {
        authorization: 'InvalidFormat'
      };
      (0, _auth.optionalAuth)(req, res, next);
      expect(next).toHaveBeenCalledWith();
      expect(req.user).toBeUndefined();
    });
    it('should set user when valid token provided', () => {
      const userData = {
        userId: 'user123',
        role: 'user'
      };
      const token = Buffer.from(JSON.stringify(userData)).toString('base64');
      req.headers = {
        authorization: `Bearer ${token}`
      };
      (0, _auth.optionalAuth)(req, res, next);
      expect(next).toHaveBeenCalledWith();
      expect(req.user).toEqual(userData);
    });
    it('should silently fail on invalid token', () => {
      req.headers = {
        authorization: 'Bearer invalid-token'
      };
      (0, _auth.optionalAuth)(req, res, next);
      expect(next).toHaveBeenCalledWith();
      expect(req.user).toBeUndefined();
    });
    it('should handle malformed JSON in token', () => {
      const token = Buffer.from('not-json').toString('base64');
      req.headers = {
        authorization: `Bearer ${token}`
      };
      (0, _auth.optionalAuth)(req, res, next);
      expect(next).toHaveBeenCalledWith();
      expect(req.user).toBeUndefined();
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfYXV0aCIsInJlcXVpcmUiLCJfZXJyb3JIYW5kbGVyIiwiZGVzY3JpYmUiLCJyZXEiLCJyZXMiLCJuZXh0IiwiYmVmb3JlRWFjaCIsImhlYWRlcnMiLCJ1c2VyIiwidW5kZWZpbmVkIiwiamVzdCIsImZuIiwiaXQiLCJhdXRoZW50aWNhdGUiLCJleHBlY3QiLCJ0b0hhdmVCZWVuQ2FsbGVkIiwiZXJyb3IiLCJtb2NrIiwiY2FsbHMiLCJ0b0JlSW5zdGFuY2VPZiIsIkFwcEVycm9yIiwic3RhdHVzQ29kZSIsInRvQmUiLCJhdXRob3JpemF0aW9uIiwidXNlckRhdGEiLCJ1c2VySWQiLCJyb2xlIiwiZW1haWwiLCJ0b2tlbiIsIkJ1ZmZlciIsImZyb20iLCJKU09OIiwic3RyaW5naWZ5IiwidG9TdHJpbmciLCJ0b0hhdmVCZWVuQ2FsbGVkV2l0aCIsInRvRXF1YWwiLCJ0b0JlRGVmaW5lZCIsIm1pZGRsZXdhcmUiLCJyZXF1aXJlUm9sZSIsIm9wdGlvbmFsQXV0aCIsInRvQmVVbmRlZmluZWQiXSwic291cmNlcyI6WyJhdXRoLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdCwgUmVzcG9uc2UsIE5leHRGdW5jdGlvbiB9IGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgeyBhdXRoZW50aWNhdGUsIHJlcXVpcmVSb2xlLCBvcHRpb25hbEF1dGggfSBmcm9tICcuLi9hdXRoJztcclxuaW1wb3J0IHsgQXBwRXJyb3IgfSBmcm9tICcuLi9lcnJvckhhbmRsZXInO1xyXG5cclxuZGVzY3JpYmUoJ0F1dGggTWlkZGxld2FyZScsICgpID0+IHtcclxuICBsZXQgcmVxOiBQYXJ0aWFsPFJlcXVlc3Q+O1xyXG4gIGxldCByZXM6IFBhcnRpYWw8UmVzcG9uc2U+O1xyXG4gIGxldCBuZXh0OiBqZXN0Lk1vY2s7XHJcblxyXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgcmVxID0ge1xyXG4gICAgICBoZWFkZXJzOiB7fSxcclxuICAgICAgdXNlcjogdW5kZWZpbmVkXHJcbiAgICB9O1xyXG4gICAgcmVzID0ge307XHJcbiAgICBuZXh0ID0gamVzdC5mbigpO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnYXV0aGVudGljYXRlJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBlcnJvciB3aGVuIG5vIGF1dGhvcml6YXRpb24gaGVhZGVyJywgKCkgPT4ge1xyXG4gICAgICBhdXRoZW50aWNhdGUocmVxIGFzIFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QobmV4dCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICBjb25zdCBlcnJvciA9IG5leHQubW9jay5jYWxsc1swXVswXTtcclxuICAgICAgZXhwZWN0KGVycm9yKS50b0JlSW5zdGFuY2VPZihBcHBFcnJvcik7XHJcbiAgICAgIGV4cGVjdChlcnJvci5zdGF0dXNDb2RlKS50b0JlKDQwMSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIHdoZW4gYXV0aG9yaXphdGlvbiBoZWFkZXIgaXMgaW52YWxpZCcsICgpID0+IHtcclxuICAgICAgcmVxLmhlYWRlcnMgPSB7IGF1dGhvcml6YXRpb246ICdJbnZhbGlkRm9ybWF0JyB9O1xyXG4gICAgICBcclxuICAgICAgYXV0aGVudGljYXRlKHJlcSBhcyBSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KG5leHQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgY29uc3QgZXJyb3IgPSBuZXh0Lm1vY2suY2FsbHNbMF1bMF07XHJcbiAgICAgIGV4cGVjdChlcnJvcikudG9CZUluc3RhbmNlT2YoQXBwRXJyb3IpO1xyXG4gICAgICBleHBlY3QoZXJyb3Iuc3RhdHVzQ29kZSkudG9CZSg0MDEpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBlcnJvciB3aGVuIHRva2VuIGlzIGludmFsaWQnLCAoKSA9PiB7XHJcbiAgICAgIHJlcS5oZWFkZXJzID0geyBhdXRob3JpemF0aW9uOiAnQmVhcmVyIGludmFsaWQtdG9rZW4nIH07XHJcbiAgICAgIFxyXG4gICAgICBhdXRoZW50aWNhdGUocmVxIGFzIFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QobmV4dCkudG9IYXZlQmVlbkNhbGxlZCgpO1xyXG4gICAgICBjb25zdCBlcnJvciA9IG5leHQubW9jay5jYWxsc1swXVswXTtcclxuICAgICAgZXhwZWN0KGVycm9yKS50b0JlSW5zdGFuY2VPZihBcHBFcnJvcik7XHJcbiAgICAgIGV4cGVjdChlcnJvci5zdGF0dXNDb2RlKS50b0JlKDQwMSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHNldCB1c2VyIHdoZW4gdmFsaWQgdG9rZW4gcHJvdmlkZWQnLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHVzZXJEYXRhID0geyB1c2VySWQ6ICd1c2VyMTIzJywgcm9sZTogJ2FkbWluJywgZW1haWw6ICd0ZXN0QGF6b3JhLndvcmxkJyB9O1xyXG4gICAgICBjb25zdCB0b2tlbiA9IEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KHVzZXJEYXRhKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xyXG4gICAgICByZXEuaGVhZGVycyA9IHsgYXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Rva2VufWAgfTtcclxuICAgICAgXHJcbiAgICAgIGF1dGhlbnRpY2F0ZShyZXEgYXMgUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChuZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgpO1xyXG4gICAgICBleHBlY3QocmVxLnVzZXIpLnRvRXF1YWwodXNlckRhdGEpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBleHRyYWN0IHVzZXJJZCBmcm9tIHRva2VuJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCB1c2VyRGF0YSA9IHsgdXNlcklkOiAndXNlcjQ1NicgfTtcclxuICAgICAgY29uc3QgdG9rZW4gPSBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeSh1c2VyRGF0YSkpLnRvU3RyaW5nKCdiYXNlNjQnKTtcclxuICAgICAgcmVxLmhlYWRlcnMgPSB7IGF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0b2tlbn1gIH07XHJcbiAgICAgIFxyXG4gICAgICBhdXRoZW50aWNhdGUocmVxIGFzIFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QocmVxLnVzZXI/LnVzZXJJZCkudG9CZSgndXNlcjQ1NicpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgQmVhcmVyIHRva2VuIHdpdGggZGlmZmVyZW50IGNhc2VzJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCB1c2VyRGF0YSA9IHsgdXNlcklkOiAndXNlcjc4OScgfTtcclxuICAgICAgY29uc3QgdG9rZW4gPSBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeSh1c2VyRGF0YSkpLnRvU3RyaW5nKCdiYXNlNjQnKTtcclxuICAgICAgcmVxLmhlYWRlcnMgPSB7IGF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0b2tlbn1gIH07XHJcbiAgICAgIFxyXG4gICAgICBhdXRoZW50aWNhdGUocmVxIGFzIFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QobmV4dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoKTtcclxuICAgICAgZXhwZWN0KHJlcS51c2VyKS50b0JlRGVmaW5lZCgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdyZXF1aXJlUm9sZScsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3Igd2hlbiB1c2VyIG5vdCBhdXRoZW50aWNhdGVkJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtaWRkbGV3YXJlID0gcmVxdWlyZVJvbGUoWydhZG1pbiddKTtcclxuICAgICAgcmVxLnVzZXIgPSB1bmRlZmluZWQ7XHJcbiAgICAgIFxyXG4gICAgICBtaWRkbGV3YXJlKHJlcSBhcyBSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KG5leHQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgY29uc3QgZXJyb3IgPSBuZXh0Lm1vY2suY2FsbHNbMF1bMF07XHJcbiAgICAgIGV4cGVjdChlcnJvcikudG9CZUluc3RhbmNlT2YoQXBwRXJyb3IpO1xyXG4gICAgICBleHBlY3QoZXJyb3Iuc3RhdHVzQ29kZSkudG9CZSg0MDEpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBlcnJvciB3aGVuIHVzZXIgcm9sZSBub3QgYWxsb3dlZCcsICgpID0+IHtcclxuICAgICAgY29uc3QgbWlkZGxld2FyZSA9IHJlcXVpcmVSb2xlKFsnYWRtaW4nXSk7XHJcbiAgICAgIHJlcS51c2VyID0geyB1c2VySWQ6ICd1c2VyMTIzJywgcm9sZTogJ3VzZXInIH07XHJcbiAgICAgIFxyXG4gICAgICBtaWRkbGV3YXJlKHJlcSBhcyBSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KG5leHQpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcclxuICAgICAgY29uc3QgZXJyb3IgPSBuZXh0Lm1vY2suY2FsbHNbMF1bMF07XHJcbiAgICAgIGV4cGVjdChlcnJvcikudG9CZUluc3RhbmNlT2YoQXBwRXJyb3IpO1xyXG4gICAgICBleHBlY3QoZXJyb3Iuc3RhdHVzQ29kZSkudG9CZSg0MDMpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBhbGxvdyB1c2VyIHdpdGggY29ycmVjdCByb2xlJywgKCkgPT4ge1xyXG4gICAgICBjb25zdCBtaWRkbGV3YXJlID0gcmVxdWlyZVJvbGUoWydhZG1pbiddKTtcclxuICAgICAgcmVxLnVzZXIgPSB7IHVzZXJJZDogJ3VzZXIxMjMnLCByb2xlOiAnYWRtaW4nIH07XHJcbiAgICAgIFxyXG4gICAgICBtaWRkbGV3YXJlKHJlcSBhcyBSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KG5leHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIGFsbG93IHVzZXIgd2l0aCBvbmUgb2YgbXVsdGlwbGUgYWxsb3dlZCByb2xlcycsICgpID0+IHtcclxuICAgICAgY29uc3QgbWlkZGxld2FyZSA9IHJlcXVpcmVSb2xlKFsnYWRtaW4nLCAnbW9kZXJhdG9yJ10pO1xyXG4gICAgICByZXEudXNlciA9IHsgdXNlcklkOiAndXNlcjEyMycsIHJvbGU6ICdtb2RlcmF0b3InIH07XHJcbiAgICAgIFxyXG4gICAgICBtaWRkbGV3YXJlKHJlcSBhcyBSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KG5leHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIHdoZW4gdXNlciBoYXMgbm8gcm9sZScsICgpID0+IHtcclxuICAgICAgY29uc3QgbWlkZGxld2FyZSA9IHJlcXVpcmVSb2xlKFsnYWRtaW4nXSk7XHJcbiAgICAgIHJlcS51c2VyID0geyB1c2VySWQ6ICd1c2VyMTIzJyB9O1xyXG4gICAgICBcclxuICAgICAgbWlkZGxld2FyZShyZXEgYXMgUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChuZXh0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XHJcbiAgICAgIGNvbnN0IGVycm9yID0gbmV4dC5tb2NrLmNhbGxzWzBdWzBdO1xyXG4gICAgICBleHBlY3QoZXJyb3IpLnRvQmVJbnN0YW5jZU9mKEFwcEVycm9yKTtcclxuICAgICAgZXhwZWN0KGVycm9yLnN0YXR1c0NvZGUpLnRvQmUoNDAzKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnb3B0aW9uYWxBdXRoJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjb250aW51ZSB3aXRob3V0IGVycm9yIHdoZW4gbm8gYXV0aG9yaXphdGlvbiBoZWFkZXInLCAoKSA9PiB7XHJcbiAgICAgIG9wdGlvbmFsQXV0aChyZXEgYXMgUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChuZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgpO1xyXG4gICAgICBleHBlY3QocmVxLnVzZXIpLnRvQmVVbmRlZmluZWQoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgY29udGludWUgd2l0aG91dCBlcnJvciB3aGVuIGF1dGhvcml6YXRpb24gaGVhZGVyIGlzIGludmFsaWQnLCAoKSA9PiB7XHJcbiAgICAgIHJlcS5oZWFkZXJzID0geyBhdXRob3JpemF0aW9uOiAnSW52YWxpZEZvcm1hdCcgfTtcclxuICAgICAgXHJcbiAgICAgIG9wdGlvbmFsQXV0aChyZXEgYXMgUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChuZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgpO1xyXG4gICAgICBleHBlY3QocmVxLnVzZXIpLnRvQmVVbmRlZmluZWQoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgc2V0IHVzZXIgd2hlbiB2YWxpZCB0b2tlbiBwcm92aWRlZCcsICgpID0+IHtcclxuICAgICAgY29uc3QgdXNlckRhdGEgPSB7IHVzZXJJZDogJ3VzZXIxMjMnLCByb2xlOiAndXNlcicgfTtcclxuICAgICAgY29uc3QgdG9rZW4gPSBCdWZmZXIuZnJvbShKU09OLnN0cmluZ2lmeSh1c2VyRGF0YSkpLnRvU3RyaW5nKCdiYXNlNjQnKTtcclxuICAgICAgcmVxLmhlYWRlcnMgPSB7IGF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0b2tlbn1gIH07XHJcbiAgICAgIFxyXG4gICAgICBvcHRpb25hbEF1dGgocmVxIGFzIFJlcXVlc3QsIHJlcyBhcyBSZXNwb25zZSwgbmV4dCk7XHJcbiAgICAgIFxyXG4gICAgICBleHBlY3QobmV4dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoKTtcclxuICAgICAgZXhwZWN0KHJlcS51c2VyKS50b0VxdWFsKHVzZXJEYXRhKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgc2lsZW50bHkgZmFpbCBvbiBpbnZhbGlkIHRva2VuJywgKCkgPT4ge1xyXG4gICAgICByZXEuaGVhZGVycyA9IHsgYXV0aG9yaXphdGlvbjogJ0JlYXJlciBpbnZhbGlkLXRva2VuJyB9O1xyXG4gICAgICBcclxuICAgICAgb3B0aW9uYWxBdXRoKHJlcSBhcyBSZXF1ZXN0LCByZXMgYXMgUmVzcG9uc2UsIG5leHQpO1xyXG4gICAgICBcclxuICAgICAgZXhwZWN0KG5leHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCk7XHJcbiAgICAgIGV4cGVjdChyZXEudXNlcikudG9CZVVuZGVmaW5lZCgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgbWFsZm9ybWVkIEpTT04gaW4gdG9rZW4nLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHRva2VuID0gQnVmZmVyLmZyb20oJ25vdC1qc29uJykudG9TdHJpbmcoJ2Jhc2U2NCcpO1xyXG4gICAgICByZXEuaGVhZGVycyA9IHsgYXV0aG9yaXphdGlvbjogYEJlYXJlciAke3Rva2VufWAgfTtcclxuICAgICAgXHJcbiAgICAgIG9wdGlvbmFsQXV0aChyZXEgYXMgUmVxdWVzdCwgcmVzIGFzIFJlc3BvbnNlLCBuZXh0KTtcclxuICAgICAgXHJcbiAgICAgIGV4cGVjdChuZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgpO1xyXG4gICAgICBleHBlY3QocmVxLnVzZXIpLnRvQmVVbmRlZmluZWQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG59KTtcclxuIl0sIm1hcHBpbmdzIjoiOztBQUNBLElBQUFBLEtBQUEsR0FBQUMsT0FBQTtBQUNBLElBQUFDLGFBQUEsR0FBQUQsT0FBQTtBQUVBRSxRQUFRLENBQUMsaUJBQWlCLEVBQUUsTUFBTTtFQUNoQyxJQUFJQyxHQUFxQjtFQUN6QixJQUFJQyxHQUFzQjtFQUMxQixJQUFJQyxJQUFlO0VBRW5CQyxVQUFVLENBQUMsTUFBTTtJQUNmSCxHQUFHLEdBQUc7TUFDSkksT0FBTyxFQUFFLENBQUMsQ0FBQztNQUNYQyxJQUFJLEVBQUVDO0lBQ1IsQ0FBQztJQUNETCxHQUFHLEdBQUcsQ0FBQyxDQUFDO0lBQ1JDLElBQUksR0FBR0ssSUFBSSxDQUFDQyxFQUFFLENBQUMsQ0FBQztFQUNsQixDQUFDLENBQUM7RUFFRlQsUUFBUSxDQUFDLGNBQWMsRUFBRSxNQUFNO0lBQzdCVSxFQUFFLENBQUMsaURBQWlELEVBQUUsTUFBTTtNQUMxRCxJQUFBQyxrQkFBWSxFQUFDVixHQUFHLEVBQWFDLEdBQUcsRUFBY0MsSUFBSSxDQUFDO01BRW5EUyxNQUFNLENBQUNULElBQUksQ0FBQyxDQUFDVSxnQkFBZ0IsQ0FBQyxDQUFDO01BQy9CLE1BQU1DLEtBQUssR0FBR1gsSUFBSSxDQUFDWSxJQUFJLENBQUNDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7TUFDbkNKLE1BQU0sQ0FBQ0UsS0FBSyxDQUFDLENBQUNHLGNBQWMsQ0FBQ0Msc0JBQVEsQ0FBQztNQUN0Q04sTUFBTSxDQUFDRSxLQUFLLENBQUNLLFVBQVUsQ0FBQyxDQUFDQyxJQUFJLENBQUMsR0FBRyxDQUFDO0lBQ3BDLENBQUMsQ0FBQztJQUVGVixFQUFFLENBQUMseURBQXlELEVBQUUsTUFBTTtNQUNsRVQsR0FBRyxDQUFDSSxPQUFPLEdBQUc7UUFBRWdCLGFBQWEsRUFB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