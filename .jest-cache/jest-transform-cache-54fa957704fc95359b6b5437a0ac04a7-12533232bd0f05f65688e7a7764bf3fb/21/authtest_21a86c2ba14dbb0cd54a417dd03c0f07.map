{"version":3,"names":["_auth","require","_errorHandler","describe","req","res","next","beforeEach","headers","user","undefined","jest","fn","it","authenticate","expect","toHaveBeenCalled","error","mock","calls","toBeInstanceOf","AppError","statusCode","toBe","authorization","userData","userId","role","email","token","Buffer","from","JSON","stringify","toString","toHaveBeenCalledWith","toEqual","toBeDefined","middleware","requireRole","optionalAuth","toBeUndefined"],"sources":["auth.test.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\r\nimport { authenticate, requireRole, optionalAuth } from '../auth';\r\nimport { AppError } from '../errorHandler';\r\n\r\ndescribe('Auth Middleware', () => {\r\n  let req: Partial<Request>;\r\n  let res: Partial<Response>;\r\n  let next: jest.Mock;\r\n\r\n  beforeEach(() => {\r\n    req = {\r\n      headers: {},\r\n      user: undefined\r\n    };\r\n    res = {};\r\n    next = jest.fn();\r\n  });\r\n\r\n  describe('authenticate', () => {\r\n    it('should throw error when no authorization header', () => {\r\n      authenticate(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalled();\r\n      const error = next.mock.calls[0][0];\r\n      expect(error).toBeInstanceOf(AppError);\r\n      expect(error.statusCode).toBe(401);\r\n    });\r\n\r\n    it('should throw error when authorization header is invalid', () => {\r\n      req.headers = { authorization: 'InvalidFormat' };\r\n      \r\n      authenticate(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalled();\r\n      const error = next.mock.calls[0][0];\r\n      expect(error).toBeInstanceOf(AppError);\r\n      expect(error.statusCode).toBe(401);\r\n    });\r\n\r\n    it('should throw error when token is invalid', () => {\r\n      req.headers = { authorization: 'Bearer invalid-token' };\r\n      \r\n      authenticate(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalled();\r\n      const error = next.mock.calls[0][0];\r\n      expect(error).toBeInstanceOf(AppError);\r\n      expect(error.statusCode).toBe(401);\r\n    });\r\n\r\n    it('should set user when valid token provided', () => {\r\n      const userData = { userId: 'user123', role: 'admin', email: 'test@azora.world' };\r\n      const token = Buffer.from(JSON.stringify(userData)).toString('base64');\r\n      req.headers = { authorization: `Bearer ${token}` };\r\n      \r\n      authenticate(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalledWith();\r\n      expect(req.user).toEqual(userData);\r\n    });\r\n\r\n    it('should extract userId from token', () => {\r\n      const userData = { userId: 'user456' };\r\n      const token = Buffer.from(JSON.stringify(userData)).toString('base64');\r\n      req.headers = { authorization: `Bearer ${token}` };\r\n      \r\n      authenticate(req as Request, res as Response, next);\r\n      \r\n      expect(req.user?.userId).toBe('user456');\r\n    });\r\n\r\n    it('should handle Bearer token with different cases', () => {\r\n      const userData = { userId: 'user789' };\r\n      const token = Buffer.from(JSON.stringify(userData)).toString('base64');\r\n      req.headers = { authorization: `Bearer ${token}` };\r\n      \r\n      authenticate(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalledWith();\r\n      expect(req.user).toBeDefined();\r\n    });\r\n  });\r\n\r\n  describe('requireRole', () => {\r\n    it('should throw error when user not authenticated', () => {\r\n      const middleware = requireRole(['admin']);\r\n      req.user = undefined;\r\n      \r\n      middleware(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalled();\r\n      const error = next.mock.calls[0][0];\r\n      expect(error).toBeInstanceOf(AppError);\r\n      expect(error.statusCode).toBe(401);\r\n    });\r\n\r\n    it('should throw error when user role not allowed', () => {\r\n      const middleware = requireRole(['admin']);\r\n      req.user = { userId: 'user123', role: 'user' };\r\n      \r\n      middleware(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalled();\r\n      const error = next.mock.calls[0][0];\r\n      expect(error).toBeInstanceOf(AppError);\r\n      expect(error.statusCode).toBe(403);\r\n    });\r\n\r\n    it('should allow user with correct role', () => {\r\n      const middleware = requireRole(['admin']);\r\n      req.user = { userId: 'user123', role: 'admin' };\r\n      \r\n      middleware(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalledWith();\r\n    });\r\n\r\n    it('should allow user with one of multiple allowed roles', () => {\r\n      const middleware = requireRole(['admin', 'moderator']);\r\n      req.user = { userId: 'user123', role: 'moderator' };\r\n      \r\n      middleware(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalledWith();\r\n    });\r\n\r\n    it('should throw error when user has no role', () => {\r\n      const middleware = requireRole(['admin']);\r\n      req.user = { userId: 'user123' };\r\n      \r\n      middleware(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalled();\r\n      const error = next.mock.calls[0][0];\r\n      expect(error).toBeInstanceOf(AppError);\r\n      expect(error.statusCode).toBe(403);\r\n    });\r\n  });\r\n\r\n  describe('optionalAuth', () => {\r\n    it('should continue without error when no authorization header', () => {\r\n      optionalAuth(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalledWith();\r\n      expect(req.user).toBeUndefined();\r\n    });\r\n\r\n    it('should continue without error when authorization header is invalid', () => {\r\n      req.headers = { authorization: 'InvalidFormat' };\r\n      \r\n      optionalAuth(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalledWith();\r\n      expect(req.user).toBeUndefined();\r\n    });\r\n\r\n    it('should set user when valid token provided', () => {\r\n      const userData = { userId: 'user123', role: 'user' };\r\n      const token = Buffer.from(JSON.stringify(userData)).toString('base64');\r\n      req.headers = { authorization: `Bearer ${token}` };\r\n      \r\n      optionalAuth(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalledWith();\r\n      expect(req.user).toEqual(userData);\r\n    });\r\n\r\n    it('should silently fail on invalid token', () => {\r\n      req.headers = { authorization: 'Bearer invalid-token' };\r\n      \r\n      optionalAuth(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalledWith();\r\n      expect(req.user).toBeUndefined();\r\n    });\r\n\r\n    it('should handle malformed JSON in token', () => {\r\n      const token = Buffer.from('not-json').toString('base64');\r\n      req.headers = { authorization: `Bearer ${token}` };\r\n      \r\n      optionalAuth(req as Request, res as Response, next);\r\n      \r\n      expect(next).toHaveBeenCalledWith();\r\n      expect(req.user).toBeUndefined();\r\n    });\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}