{"version":3,"names":["PrismaClient","require","Redis","TestOptimizer","constructor","prisma","redis","transactionStack","mockCache","Map","initialized","initialize","datasources","db","url","process","env","DATABASE_URL","host","REDIS_HOST","port","REDIS_PORT","retryDelayOnFailover","maxRetriesPerRequest","lazyConnect","connect","startTransaction","transaction","$begin","push","rollbackTransaction","length","pop","$rollback","executeRedisPipeline","operations","pipeline","forEach","op","command","args","exec","cacheMockResponse","key","response","set","timestamp","Date","now","getCachedMockResponse","maxAge","cached","get","delete","batchDatabaseOperations","results","result","model","operation","data","$commit","error","cleanup","clear","$disconnect","disconnect","setupTestEnvironment","flushdb","teardownTestEnvironment","status","testOptimizer","setupOptimizedTest","teardownOptimizedTest","globalCleanup","module","exports"],"sources":["test-optimization.js"],"sourcesContent":["/**\n * Test Optimization Utilities\n * Implements database transaction rollback, Redis pipeline operations, and caching\n */\n\nconst { PrismaClient } = require('@prisma/client');\nconst Redis = require('ioredis');\n\nclass TestOptimizer {\n  constructor() {\n    this.prisma = null;\n    this.redis = null;\n    this.transactionStack = [];\n    this.mockCache = new Map();\n    this.initialized = false;\n  }\n\n  async initialize() {\n    if (this.initialized) return;\n\n    // Initialize Prisma with transaction support\n    this.prisma = new PrismaClient({\n      datasources: {\n        db: {\n          url: process.env.DATABASE_URL || 'postgresql://test:test@localhost:5432/azora_test'\n        }\n      }\n    });\n\n    // Initialize Redis with pipeline support\n    this.redis = new Redis({\n      host: process.env.REDIS_HOST || 'localhost',\n      port: process.env.REDIS_PORT || 6379,\n      retryDelayOnFailover: 100,\n      maxRetriesPerRequest: 3,\n      lazyConnect: true\n    });\n\n    await this.redis.connect();\n    this.initialized = true;\n  }\n\n  /**\n   * Start a database transaction for test isolation\n   */\n  async startTransaction() {\n    if (!this.initialized) await this.initialize();\n    \n    const transaction = await this.prisma.$begin();\n    this.transactionStack.push(transaction);\n    return transaction;\n  }\n\n  /**\n   * Rollback the current transaction\n   */\n  async rollbackTransaction() {\n    if (this.transactionStack.length === 0) return;\n    \n    const transaction = this.transactionStack.pop();\n    await transaction.$rollback();\n  }\n\n  /**\n   * Execute Redis operations in pipeline for better performance\n   */\n  async executeRedisPipeline(operations) {\n    if (!this.initialized) await this.initialize();\n    \n    const pipeline = this.redis.pipeline();\n    \n    operations.forEach(op => {\n      pipeline[op.command](...op.args);\n    });\n    \n    return await pipeline.exec();\n  }\n\n  /**\n   * Cache mock responses to avoid repeated computation\n   */\n  cacheMockResponse(key, response) {\n    this.mockCache.set(key, {\n      response,\n      timestamp: Date.now()\n    });\n  }\n\n  /**\n   * Get cached mock response if still valid\n   */\n  getCachedMockResponse(key, maxAge = 300000) { // 5 minutes default\n    const cached = this.mockCache.get(key);\n    if (!cached) return null;\n    \n    if (Date.now() - cached.timestamp > maxAge) {\n      this.mockCache.delete(key);\n      return null;\n    }\n    \n    return cached.response;\n  }\n\n  /**\n   * Batch database operations for better performance\n   */\n  async batchDatabaseOperations(operations) {\n    if (!this.initialized) await this.initialize();\n    \n    const transaction = await this.startTransaction();\n    \n    try {\n      const results = [];\n      for (const op of operations) {\n        const result = await transaction[op.model][op.operation](op.data);\n        results.push(result);\n      }\n      \n      await transaction.$commit();\n      return results;\n    } catch (error) {\n      await this.rollbackTransaction();\n      throw error;\n    }\n  }\n\n  /**\n   * Clean up resources\n   */\n  async cleanup() {\n    // Rollback any pending transactions\n    while (this.transactionStack.length > 0) {\n      await this.rollbackTransaction();\n    }\n    \n    // Clear mock cache\n    this.mockCache.clear();\n    \n    // Close connections\n    if (this.prisma) {\n      await this.prisma.$disconnect();\n    }\n    \n    if (this.redis) {\n      await this.redis.disconnect();\n    }\n    \n    this.initialized = false;\n  }\n\n  /**\n   * Setup test environment with optimizations\n   */\n  async setupTestEnvironment() {\n    await this.initialize();\n    \n    // Start fresh transaction for test isolation\n    await this.startTransaction();\n    \n    // Clear Redis test data\n    await this.redis.flushdb();\n    \n    // Setup test-specific optimizations\n    await this.executeRedisPipeline([\n      { command: 'set', args: ['test:session', 'active'] },\n      { command: 'expire', args: ['test:session', 3600] }\n    ]);\n  }\n\n  /**\n   * Teardown test environment\n   */\n  async teardownTestEnvironment() {\n    // Rollback database changes\n    await this.rollbackTransaction();\n    \n    // Clear Redis test data\n    if (this.redis && this.redis.status === 'ready') {\n      await this.redis.flushdb();\n    }\n  }\n}\n\n// Singleton instance\nconst testOptimizer = new TestOptimizer();\n\n// Jest setup helpers\nconst setupOptimizedTest = async () => {\n  await testOptimizer.setupTestEnvironment();\n};\n\nconst teardownOptimizedTest = async () => {\n  await testOptimizer.teardownTestEnvironment();\n};\n\n// Global cleanup\nconst globalCleanup = async () => {\n  await testOptimizer.cleanup();\n};\n\nmodule.exports = {\n  TestOptimizer,\n  testOptimizer,\n  setupOptimizedTest,\n  teardownOptimizedTest,\n  globalCleanup\n};"],"mappings":"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","ignoreList":[]}