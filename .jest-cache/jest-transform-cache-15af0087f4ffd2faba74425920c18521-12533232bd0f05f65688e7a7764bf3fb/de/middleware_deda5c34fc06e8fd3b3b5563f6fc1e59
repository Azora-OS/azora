816098cd6478b5a25bb44ae340f40e89
/* istanbul ignore next */
function cov_2hvs3nk7vu() {
  var path = "/workspaces/azora/packages/monitoring/src/middleware.ts";
  var hash = "18005baf30da8d1e0bc9f139f24f1e938aa8734f";
  var global = new Function("return this")();
  var gcv = "__coverage__";
  var coverageData = {
    path: "/workspaces/azora/packages/monitoring/src/middleware.ts",
    statementMap: {
      "0": {
        start: {
          line: 5,
          column: 37
        },
        end: {
          line: 30,
          column: 1
        }
      },
      "1": {
        start: {
          line: 6,
          column: 16
        },
        end: {
          line: 6,
          column: 26
        }
      },
      "2": {
        start: {
          line: 7,
          column: 2
        },
        end: {
          line: 7,
          column: 26
        }
      },
      "3": {
        start: {
          line: 9,
          column: 2
        },
        end: {
          line: 27,
          column: 5
        }
      },
      "4": {
        start: {
          line: 10,
          column: 21
        },
        end: {
          line: 10,
          column: 48
        }
      },
      "5": {
        start: {
          line: 11,
          column: 18
        },
        end: {
          line: 11,
          column: 45
        }
      },
      "6": {
        start: {
          line: 13,
          column: 4
        },
        end: {
          line: 16,
          column: 6
        }
      },
      "7": {
        start: {
          line: 18,
          column: 4
        },
        end: {
          line: 18,
          column: 85
        }
      },
      "8": {
        start: {
          line: 19,
          column: 4
        },
        end: {
          line: 19,
          column: 28
        }
      },
      "9": {
        start: {
          line: 21,
          column: 4
        },
        end: {
          line: 26,
          column: 7
        }
      },
      "10": {
        start: {
          line: 29,
          column: 2
        },
        end: {
          line: 29,
          column: 9
        }
      }
    },
    fnMap: {
      "0": {
        name: "(anonymous_0)",
        decl: {
          start: {
            line: 5,
            column: 37
          },
          end: {
            line: 5,
            column: 38
          }
        },
        loc: {
          start: {
            line: 5,
            column: 90
          },
          end: {
            line: 30,
            column: 1
          }
        },
        line: 5
      },
      "1": {
        name: "(anonymous_1)",
        decl: {
          start: {
            line: 9,
            column: 19
          },
          end: {
            line: 9,
            column: 20
          }
        },
        loc: {
          start: {
            line: 9,
            column: 25
          },
          end: {
            line: 27,
            column: 3
          }
        },
        line: 9
      }
    },
    branchMap: {
      "0": {
        loc: {
          start: {
            line: 11,
            column: 18
          },
          end: {
            line: 11,
            column: 45
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 11,
            column: 18
          },
          end: {
            line: 11,
            column: 33
          }
        }, {
          start: {
            line: 11,
            column: 37
          },
          end: {
            line: 11,
            column: 45
          }
        }],
        line: 11
      }
    },
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0,
      "8": 0,
      "9": 0,
      "10": 0
    },
    f: {
      "0": 0,
      "1": 0
    },
    b: {
      "0": [0, 0]
    },
    _coverageSchema: "1a1c01bbd47fc00a2c39e90264f33305004495a9",
    hash: "18005baf30da8d1e0bc9f139f24f1e938aa8734f"
  };
  var coverage = global[gcv] || (global[gcv] = {});
  if (!coverage[path] || coverage[path].hash !== hash) {
    coverage[path] = coverageData;
  }
  var actualCoverage = coverage[path];
  {
    // @ts-ignore
    cov_2hvs3nk7vu = function () {
      return actualCoverage;
    };
  }
  return actualCoverage;
}
cov_2hvs3nk7vu();
import { httpRequestDuration, httpRequestTotal, activeConnections } from './metrics';
import { logger } from './logger';
/* istanbul ignore next */
cov_2hvs3nk7vu().s[0]++;
export const performanceMiddleware = (req, res, next) => {
  /* istanbul ignore next */
  cov_2hvs3nk7vu().f[0]++;
  const start =
  /* istanbul ignore next */
  (cov_2hvs3nk7vu().s[1]++, Date.now());
  /* istanbul ignore next */
  cov_2hvs3nk7vu().s[2]++;
  activeConnections.inc();
  /* istanbul ignore next */
  cov_2hvs3nk7vu().s[3]++;
  res.on('finish', () => {
    /* istanbul ignore next */
    cov_2hvs3nk7vu().f[1]++;
    const duration =
    /* istanbul ignore next */
    (cov_2hvs3nk7vu().s[4]++, (Date.now() - start) / 1000);
    const route =
    /* istanbul ignore next */
    (cov_2hvs3nk7vu().s[5]++,
    /* istanbul ignore next */
    (cov_2hvs3nk7vu().b[0][0]++, req.route?.path) ||
    /* istanbul ignore next */
    (cov_2hvs3nk7vu().b[0][1]++, req.path));
    /* istanbul ignore next */
    cov_2hvs3nk7vu().s[6]++;
    httpRequestDuration.observe({
      method: req.method,
      route,
      status_code: res.statusCode
    }, duration);
    /* istanbul ignore next */
    cov_2hvs3nk7vu().s[7]++;
    httpRequestTotal.inc({
      method: req.method,
      route,
      status_code: res.statusCode
    });
    /* istanbul ignore next */
    cov_2hvs3nk7vu().s[8]++;
    activeConnections.dec();
    /* istanbul ignore next */
    cov_2hvs3nk7vu().s[9]++;
    logger.info('HTTP Request', {
      method: req.method,
      route,
      status: res.statusCode,
      duration: `${duration}s`
    });
  });
  /* istanbul ignore next */
  cov_2hvs3nk7vu().s[10]++;
  next();
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb3ZfMmh2czNuazd2dSIsImFjdHVhbENvdmVyYWdlIiwiaHR0cFJlcXVlc3REdXJhdGlvbiIsImh0dHBSZXF1ZXN0VG90YWwiLCJhY3RpdmVDb25uZWN0aW9ucyIsImxvZ2dlciIsInMiLCJwZXJmb3JtYW5jZU1pZGRsZXdhcmUiLCJyZXEiLCJyZXMiLCJuZXh0IiwiZiIsInN0YXJ0IiwiRGF0ZSIsIm5vdyIsImluYyIsIm9uIiwiZHVyYXRpb24iLCJyb3V0ZSIsImIiLCJwYXRoIiwib2JzZXJ2ZSIsIm1ldGhvZCIsInN0YXR1c19jb2RlIiwic3RhdHVzQ29kZSIsImRlYyIsImluZm8iLCJzdGF0dXMiXSwic291cmNlcyI6WyJtaWRkbGV3YXJlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3QsIFJlc3BvbnNlLCBOZXh0RnVuY3Rpb24gfSBmcm9tICdleHByZXNzJztcbmltcG9ydCB7IGh0dHBSZXF1ZXN0RHVyYXRpb24sIGh0dHBSZXF1ZXN0VG90YWwsIGFjdGl2ZUNvbm5lY3Rpb25zIH0gZnJvbSAnLi9tZXRyaWNzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4vbG9nZ2VyJztcblxuZXhwb3J0IGNvbnN0IHBlcmZvcm1hbmNlTWlkZGxld2FyZSA9IChyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbikgPT4ge1xuICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7XG4gIGFjdGl2ZUNvbm5lY3Rpb25zLmluYygpO1xuXG4gIHJlcy5vbignZmluaXNoJywgKCkgPT4ge1xuICAgIGNvbnN0IGR1cmF0aW9uID0gKERhdGUubm93KCkgLSBzdGFydCkgLyAxMDAwO1xuICAgIGNvbnN0IHJvdXRlID0gcmVxLnJvdXRlPy5wYXRoIHx8IHJlcS5wYXRoO1xuICAgIFxuICAgIGh0dHBSZXF1ZXN0RHVyYXRpb24ub2JzZXJ2ZShcbiAgICAgIHsgbWV0aG9kOiByZXEubWV0aG9kLCByb3V0ZSwgc3RhdHVzX2NvZGU6IHJlcy5zdGF0dXNDb2RlIH0sXG4gICAgICBkdXJhdGlvblxuICAgICk7XG4gICAgXG4gICAgaHR0cFJlcXVlc3RUb3RhbC5pbmMoeyBtZXRob2Q6IHJlcS5tZXRob2QsIHJvdXRlLCBzdGF0dXNfY29kZTogcmVzLnN0YXR1c0NvZGUgfSk7XG4gICAgYWN0aXZlQ29ubmVjdGlvbnMuZGVjKCk7XG4gICAgXG4gICAgbG9nZ2VyLmluZm8oJ0hUVFAgUmVxdWVzdCcsIHtcbiAgICAgIG1ldGhvZDogcmVxLm1ldGhvZCxcbiAgICAgIHJvdXRlLFxuICAgICAgc3RhdHVzOiByZXMuc3RhdHVzQ29kZSxcbiAgICAgIGR1cmF0aW9uOiBgJHtkdXJhdGlvbn1zYFxuICAgIH0pO1xuICB9KTtcblxuICBuZXh0KCk7XG59O1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFlWTtJQUFBQSxjQUFBLFlBQUFBLENBQUE7TUFBQSxPQUFBQyxjQUFBO0lBQUE7RUFBQTtFQUFBLE9BQUFBLGNBQUE7QUFBQTtBQUFBRCxjQUFBO0FBZFosU0FBU0UsbUJBQW1CLEVBQUVDLGdCQUFnQixFQUFFQyxpQkFBaUIsUUFBUSxXQUFXO0FBQ3BGLFNBQVNDLE1BQU0sUUFBUSxVQUFVO0FBQUM7QUFBQUwsY0FBQSxHQUFBTSxDQUFBO0FBRWxDLE9BQU8sTUFBTUMscUJBQXFCLEdBQUdBLENBQUNDLEdBQVksRUFBRUMsR0FBYSxFQUFFQyxJQUFrQixLQUFLO0VBQUE7RUFBQVYsY0FBQSxHQUFBVyxDQUFBO0VBQ3hGLE1BQU1DLEtBQUs7RUFBQTtFQUFBLENBQUFaLGNBQUEsR0FBQU0sQ0FBQSxPQUFHTyxJQUFJLENBQUNDLEdBQUcsQ0FBQyxDQUFDO0VBQUM7RUFBQWQsY0FBQSxHQUFBTSxDQUFBO0VBQ3pCRixpQkFBaUIsQ0FBQ1csR0FBRyxDQUFDLENBQUM7RUFBQztFQUFBZixjQUFBLEdBQUFNLENBQUE7RUFFeEJHLEdBQUcsQ0FBQ08sRUFBRSxDQUFDLFFBQVEsRUFBRSxNQUFNO0lBQUE7SUFBQWhCLGNBQUEsR0FBQVcsQ0FBQTtJQUNyQixNQUFNTSxRQUFRO0lBQUE7SUFBQSxDQUFBakIsY0FBQSxHQUFBTSxDQUFBLE9BQUcsQ0FBQ08sSUFBSSxDQUFDQyxHQUFHLENBQUMsQ0FBQyxHQUFHRixLQUFLLElBQUksSUFBSTtJQUM1QyxNQUFNTSxLQUFLO0lBQUE7SUFBQSxDQUFBbEIsY0FBQSxHQUFBTSxDQUFBO0lBQUc7SUFBQSxDQUFBTixjQUFBLEdBQUFtQixDQUFBLFVBQUFYLEdBQUcsQ0FBQ1UsS0FBSyxFQUFFRSxJQUFJO0lBQUE7SUFBQSxDQUFBcEIsY0FBQSxHQUFBbUIsQ0FBQSxVQUFJWCxHQUFHLENBQUNZLElBQUk7SUFBQztJQUFBcEIsY0FBQSxHQUFBTSxDQUFBO0lBRTFDSixtQkFBbUIsQ0FBQ21CLE9BQU8sQ0FDekI7TUFBRUMsTUFBTSxFQUFFZCxHQUFHLENBQUNjLE1BQU07TUFBRUosS0FBSztNQUFFSyxXQUFXLEVBQUVkLEdBQUcsQ0FBQ2U7SUFBVyxDQUFDLEVBQzFEUCxRQUNGLENBQUM7SUFBQztJQUFBakIsY0FBQSxHQUFBTSxDQUFBO0lBRUZILGdCQUFnQixDQUFDWSxHQUFHLENBQUM7TUFBRU8sTUFBTSxFQUFFZCxHQUFHLENBQUNjLE1BQU07TUFBRUosS0FBSztNQUFFSyxXQUFXLEVBQUVkLEdBQUcsQ0FBQ2U7SUFBVyxDQUFDLENBQUM7SUFBQztJQUFBeEIsY0FBQSxHQUFBTSxDQUFBO0lBQ2pGRixpQkFBaUIsQ0FBQ3FCLEdBQUcsQ0FBQyxDQUFDO0lBQUM7SUFBQXpCLGNBQUEsR0FBQU0sQ0FBQTtJQUV4QkQsTUFBTSxDQUFDcUIsSUFBSSxDQUFDLGNBQWMsRUFBRTtNQUMxQkosTUFBTSxFQUFFZCxHQUFHLENBQUNjLE1BQU07TUFDbEJKLEtBQUs7TUFDTFMsTUFBTSxFQUFFbEIsR0FBRyxDQUFDZSxVQUFVO01BQ3RCUCxRQUFRLEVBQUUsR0FBR0EsUUFBUTtJQUN2QixDQUFDLENBQUM7RUFDSixDQUFDLENBQUM7RUFBQztFQUFBakIsY0FBQSxHQUFBTSxDQUFBO0VBRUhJLElBQUksQ0FBQyxDQUFDO0FBQ1IsQ0FBQyIsImlnbm9yZUxpc3QiOltdfQ==