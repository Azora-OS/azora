{"version":3,"names":["cov_1j5x0gh57v","actualCoverage","logger","extractUserContext","request","f","userId","s","headers","get","b","authenticated","authHeader","startsWith","token","substring","decoded","JSON","parse","Buffer","from","toString","sub","role","email","error","warn","cookies","value","requireAuth","context","path","nextUrl","pathname","method","requireRole","allowedRoles","includes","userRole","requiredRoles","verifyResourceOwnership","resourceUserId","addUserContextToRequest"],"sources":["monetization-auth.ts"],"sourcesContent":["/**\n * Monetization Auth Middleware\n * Provides standardized authentication for all monetization endpoints\n * Integrates with existing JWT auth system\n */\n\nimport { NextRequest } from 'next/server';\nimport { logger } from '../logging';\n\nexport interface AuthContext {\n  userId: string;\n  role?: string;\n  email?: string;\n  authenticated: boolean;\n}\n\n/**\n * Extract user context from request\n * Supports multiple auth methods:\n * 1. x-user-id header (for internal services)\n * 2. Authorization Bearer token (for external clients)\n * 3. JWT in cookies (for web clients)\n */\nexport function extractUserContext(request: NextRequest): AuthContext {\n  // Method 1: x-user-id header (internal services)\n  const userId = request.headers.get('x-user-id');\n  if (userId) {\n    return {\n      userId,\n      authenticated: true,\n    };\n  }\n\n  // Method 2: Authorization Bearer token\n  const authHeader = request.headers.get('authorization');\n  if (authHeader && authHeader.startsWith('Bearer ')) {\n    try {\n      const token = authHeader.substring(7);\n      // In production, verify JWT signature\n      const decoded = JSON.parse(Buffer.from(token, 'base64').toString());\n      return {\n        userId: decoded.userId || decoded.sub,\n        role: decoded.role,\n        email: decoded.email,\n        authenticated: true,\n      };\n    } catch (error) {\n      logger.warn('Failed to decode Bearer token', { error });\n    }\n  }\n\n  // Method 3: JWT in cookies\n  const cookies = request.cookies;\n  const token = cookies.get('auth_token')?.value;\n  if (token) {\n    try {\n      const decoded = JSON.parse(Buffer.from(token, 'base64').toString());\n      return {\n        userId: decoded.userId || decoded.sub,\n        role: decoded.role,\n        email: decoded.email,\n        authenticated: true,\n      };\n    } catch (error) {\n      logger.warn('Failed to decode auth cookie', { error });\n    }\n  }\n\n  return {\n    userId: '',\n    authenticated: false,\n  };\n}\n\n/**\n * Require authentication for endpoint\n * Returns 401 if not authenticated\n */\nexport function requireAuth(request: NextRequest): AuthContext | null {\n  const context = extractUserContext(request);\n  if (!context.authenticated) {\n    logger.warn('Unauthorized request', {\n      path: request.nextUrl.pathname,\n      method: request.method,\n    });\n    return null;\n  }\n  return context;\n}\n\n/**\n * Require specific role for endpoint\n * Returns 403 if user doesn't have required role\n */\nexport function requireRole(context: AuthContext, allowedRoles: string[]): boolean {\n  if (!context.authenticated) {\n    return false;\n  }\n\n  if (!context.role || !allowedRoles.includes(context.role)) {\n    logger.warn('Insufficient permissions', {\n      userId: context.userId,\n      userRole: context.role,\n      requiredRoles: allowedRoles,\n    });\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * Verify user owns resource\n * Used for endpoints that access user-specific data\n */\nexport function verifyResourceOwnership(\n  context: AuthContext,\n  resourceUserId: string\n): boolean {\n  if (!context.authenticated) {\n    return false;\n  }\n\n  if (context.userId !== resourceUserId) {\n    logger.warn('Unauthorized resource access', {\n      userId: context.userId,\n      resourceUserId,\n    });\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * Add user context to request for downstream services\n * Useful for logging and audit trails\n */\nexport function addUserContextToRequest(\n  request: NextRequest,\n  context: AuthContext\n): void {\n  // Store in request headers for downstream services\n  (request.headers as any)['x-authenticated-user-id'] = context.userId;\n  if (context.role) {\n    (request.headers as any)['x-user-role'] = context.role;\n  }\n  if (context.email) {\n    (request.headers as any)['x-user-email'] = context.email;\n  }\n}\n"],"mappings":"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","ignoreList":[]}