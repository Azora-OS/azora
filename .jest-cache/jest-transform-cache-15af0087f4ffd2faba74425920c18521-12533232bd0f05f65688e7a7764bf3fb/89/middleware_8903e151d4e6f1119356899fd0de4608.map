{"version":3,"names":["cov_2ebhxa7m9y","actualCoverage","africaCDN","riverFlows","cdnRoutingMiddleware","req","res","next","f","staticExtensions","s","isStaticAsset","some","ext","path","endsWith","b","region","headers","query","cdnUrl","getAssetURL","setHeader","process","env","CDN_REDIRECT","redirect","riverFlowMiddleware","startTime","Date","now","flowId","includes","on","duration","emit","data","method","statusCode","timestamp","priority","infrastructureHealthMiddleware","cdnStatus","getNetworkStatus","riverStatus","healthyNodes","toString","flowingFlows","error"],"sources":["middleware.ts"],"sourcesContent":["/*\nAZORA PROPRIETARY LICENSE\nCopyright Â© 2025 Azora ES (Pty) Ltd. All Rights Reserved.\n\nINFRASTRUCTURE MIDDLEWARE\nExpress middleware for CDN routing and infrastructure integration\n*/\n\nimport { Request, Response, NextFunction } from 'express';\nimport { africaCDN } from '@azora/shared-infrastructure/africa-cdn';\nimport { riverFlows } from '@azora/shared-infrastructure/river-flows';\n\n/**\n * CDN Routing Middleware\n * Routes static assets through Africa-First CDN\n */\nexport function cdnRoutingMiddleware(req: Request, res: Response, next: NextFunction): void {\n  // Check if request is for static assets\n  const staticExtensions = ['.js', '.css', '.png', '.jpg', '.jpeg', '.gif', '.svg', '.webp', '.woff', '.woff2'];\n  const isStaticAsset = staticExtensions.some(ext => req.path.endsWith(ext));\n\n  if (isStaticAsset) {\n    const region = req.headers['x-region'] as string || req.query.region as string;\n    const cdnUrl = africaCDN.getAssetURL(req.path, region);\n    \n    // Set CDN headers\n    res.setHeader('X-CDN-Node', cdnUrl);\n    res.setHeader('X-CDN-Region', region || 'auto');\n    \n    // Optionally redirect to CDN\n    if (process.env.CDN_REDIRECT === 'true') {\n      return res.redirect(302, cdnUrl);\n    }\n  }\n\n  next();\n}\n\n/**\n * River Flow Middleware\n * Tracks data flows through rivers\n */\nexport function riverFlowMiddleware(req: Request, res: Response, next: NextFunction): void {\n  const startTime = Date.now();\n\n  // Determine flow type based on route\n  let flowId = 'system-events-river';\n  if (req.path.includes('/api/user') || req.path.includes('/api/activity')) {\n    flowId = 'user-activity-river';\n  } else if (req.path.includes('/api/lms') || req.path.includes('/api/learning')) {\n    flowId = 'learning-progress-river';\n  } else if (req.path.includes('/api/wallet') || req.path.includes('/api/transaction')) {\n    flowId = 'financial-transactions-river';\n  } else if (req.path.includes('/api/ai') || req.path.includes('/api/insight')) {\n    flowId = 'ai-insights-river';\n  }\n\n  // Track request\n  res.on('finish', () => {\n    const duration = Date.now() - startTime;\n    riverFlows.emit('river-flow', {\n      flowId,\n      data: {\n        method: req.method,\n        path: req.path,\n        statusCode: res.statusCode,\n        duration,\n      },\n      timestamp: new Date(),\n      priority: 'medium',\n    });\n  });\n\n  next();\n}\n\n/**\n * Infrastructure Health Middleware\n * Adds infrastructure status to response headers\n */\nexport async function infrastructureHealthMiddleware(\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> {\n  try {\n    const cdnStatus = africaCDN.getNetworkStatus();\n    const riverStatus = riverFlows.getNetworkStatus();\n    \n    res.setHeader('X-Infrastructure-CDN-Healthy', cdnStatus.healthyNodes.toString());\n    res.setHeader('X-Infrastructure-Rivers-Flowing', riverStatus.flowingFlows.toString());\n  } catch (error) {\n    // Fail silently - don't break request\n  }\n\n  next();\n}\n\nexport default {\n  cdnRoutingMiddleware,\n  riverFlowMiddleware,\n  infrastructureHealthMiddleware,\n};\n"],"mappings":"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","ignoreList":[]}