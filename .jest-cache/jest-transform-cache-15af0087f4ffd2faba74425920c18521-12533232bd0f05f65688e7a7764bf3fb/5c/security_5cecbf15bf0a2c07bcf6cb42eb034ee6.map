{"version":3,"names":["cov_qb35i6l0q","actualCoverage","helmet","cors","rateLimit","slowDown","log","getHelmetConfig","f","s","contentSecurityPolicy","directives","defaultSrc","styleSrc","fontSrc","scriptSrc","imgSrc","connectSrc","b","process","env","API_URL","frameSrc","objectSrc","baseUri","formAction","crossOriginEmbedderPolicy","crossOriginOpenerPolicy","crossOriginResourcePolicy","policy","dnsPrefetchControl","frameguard","action","hidePoweredBy","hsts","maxAge","includeSubDomains","preload","ieNoOpen","noSniff","originAgentCluster","permittedCrossDomainPolicies","referrerPolicy","xssFilter","getCorsConfig","allowedOrigins","ALLOWED_ORIGINS","split","CORS_ORIGIN","origin","callback","includes","NODE_ENV","warn","Error","credentials","methods","allowedHeaders","exposedHeaders","createRateLimiter","options","windowMs","max","message","standardHeaders","legacyHeaders","handler","req","res","ip","path","resetTime","Date","now","status","json","error","retryAfter","Math","ceil","createSlowDown","delayAfter","delayMs","securityHeaders","_req","next","removeHeader","setHeader","requestLogger","start","on","duration","http","method","statusCode","userAgent","get","undefined"],"sources":["security.ts"],"sourcesContent":["/*\nAZORA PROPRIETARY LICENSE\n\nCopyright Â© 2025 Azora ES (Pty) Ltd. All Rights Reserved.\n\nSee LICENSE file for details.\n*/\n\n/**\n * Security Middleware Utilities\n * \n * Standardized security middleware for Express applications\n */\n\nimport helmet from 'helmet';\nimport cors from 'cors';\nimport { Request, Response, NextFunction } from 'express';\nimport { rateLimit } from 'express-rate-limit';\nimport { slowDown } from 'express-slow-down';\nimport { log } from '../logger';\n\n/**\n * Standard Helmet configuration for security headers\n */\nexport function getHelmetConfig() {\n  return helmet({\n    contentSecurityPolicy: {\n      directives: {\n        defaultSrc: [\"'self'\"],\n        styleSrc: [\"'self'\", \"'unsafe-inline'\", \"https://fonts.googleapis.com\"],\n        fontSrc: [\"'self'\", \"https://fonts.gstatic.com\"],\n        scriptSrc: [\"'self'\", \"'unsafe-inline'\", \"'unsafe-eval'\"], // Adjust for production\n        imgSrc: [\"'self'\", \"data:\", \"https:\"],\n        connectSrc: [\"'self'\", process.env.API_URL || \"http://localhost:3001\"],\n        frameSrc: [\"'none'\"],\n        objectSrc: [\"'none'\"],\n        baseUri: [\"'self'\"],\n        formAction: [\"'self'\"],\n      },\n    },\n    crossOriginEmbedderPolicy: true,\n    crossOriginOpenerPolicy: true,\n    crossOriginResourcePolicy: { policy: \"cross-origin\" },\n    dnsPrefetchControl: true,\n    frameguard: { action: 'deny' },\n    hidePoweredBy: true,\n    hsts: {\n      maxAge: 31536000,\n      includeSubDomains: true,\n      preload: true,\n    },\n    ieNoOpen: true,\n    noSniff: true,\n    originAgentCluster: true,\n    permittedCrossDomainPolicies: false,\n    referrerPolicy: { policy: \"no-referrer\" },\n    xssFilter: true,\n  });\n}\n\n/**\n * CORS configuration\n */\nexport function getCorsConfig() {\n  const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || \n                         process.env.CORS_ORIGIN?.split(',') || \n                         ['http://localhost:3000', 'http://localhost:3001'];\n\n  return cors({\n    origin: (origin: string | undefined, callback: (err: Error | null, allow?: boolean) => void) => {\n      // Allow requests with no origin (mobile apps, Postman, etc.)\n      if (!origin) {return callback(null, true);}\n      \n      if (allowedOrigins.includes(origin) || process.env.NODE_ENV === 'development') {\n        callback(null, true);\n      } else {\n        log.warn('CORS blocked origin:', { origin });\n        callback(new Error('Not allowed by CORS'));\n      }\n    },\n    credentials: true,\n    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],\n    allowedHeaders: ['Content-Type', 'Authorization', 'X-API-Key', 'X-Requested-With'],\n    exposedHeaders: ['X-Total-Count', 'X-Page-Count'],\n    maxAge: 86400, // 24 hours\n  });\n}\n\n/**\n * Rate limiter for API endpoints\n */\nexport function createRateLimiter(options?: {\n  windowMs?: number;\n  max?: number;\n  message?: string;\n}) {\n  return rateLimit({\n    windowMs: options?.windowMs || 15 * 60 * 1000, // 15 minutes\n    max: options?.max || 100, // Limit each IP to 100 requests per windowMs\n    message: options?.message || 'Too many requests from this IP, please try again later.',\n    standardHeaders: true,\n    legacyHeaders: false,\n      handler: (req: Request, res: Response) => {\n        log.warn('Rate limit exceeded', {\n          ip: req.ip,\n          path: req.path,\n        });\n        const resetTime = (req as unknown as { rateLimit?: { resetTime?: number } }).rateLimit?.resetTime || Date.now();\n        res.status(429).json({\n          error: 'Too many requests',\n          message: 'Please try again later',\n          retryAfter: Math.ceil(resetTime / 1000),\n        });\n      },\n  });\n}\n\n/**\n * Slow down middleware for API endpoints\n */\nexport function createSlowDown(options?: {\n  windowMs?: number;\n  delayAfter?: number;\n  delayMs?: number;\n}) {\n  return slowDown({\n    windowMs: options?.windowMs || 15 * 60 * 1000, // 15 minutes\n    delayAfter: options?.delayAfter || 50, // Start delaying after 50 requests\n    delayMs: options?.delayMs || 500, // Delay each request by 500ms\n  });\n}\n\n/**\n * Security headers middleware\n */\nexport function securityHeaders(_req: Request, res: Response, next: NextFunction) {\n  // Remove X-Powered-By header\n  res.removeHeader('X-Powered-By');\n  \n  // Add custom security headers\n  res.setHeader('X-Content-Type-Options', 'nosniff');\n  res.setHeader('X-Frame-Options', 'DENY');\n  res.setHeader('X-XSS-Protection', '1; mode=block');\n  res.setHeader('Referrer-Policy', 'no-referrer');\n  \n  next();\n}\n\n/**\n * Request logging middleware\n */\nexport function requestLogger(req: Request, res: Response, next: NextFunction) {\n  const start = Date.now();\n  \n  res.on('finish', () => {\n    const duration = Date.now() - start;\n    log.http(`${req.method} ${req.path}`, {\n      status: res.statusCode,\n      duration: `${duration}ms`,\n      ip: req.ip,\n      userAgent: req.get('user-agent') || undefined,\n    });\n  });\n  \n  next();\n}\n\n\n"],"mappings":"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","ignoreList":[]}