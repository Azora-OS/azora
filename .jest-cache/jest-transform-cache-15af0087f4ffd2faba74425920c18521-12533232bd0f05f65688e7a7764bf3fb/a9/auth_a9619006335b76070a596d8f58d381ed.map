{"version":3,"names":["cov_1q2ybv958r","actualCoverage","Request","AppError","s","authenticate","req","res","next","f","authHeader","headers","authorization","b","startsWith","token","substring","decoded","JSON","parse","Buffer","from","toString","user","error","requireRole","allowedRoles","includes","role","optionalAuth"],"sources":["auth.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\nimport { AppError } from './errorHandler';\n\n// Extend Express Request to include user\ndeclare global {\n  namespace Express {\n    interface Request {\n      user?: {\n        userId: string;\n        role?: string;\n        email?: string;\n      };\n    }\n  }\n}\n\n/**\n * Basic authentication middleware\n * Checks for Authorization header with Bearer token\n */\nexport const authenticate = (req: Request, res: Response, next: NextFunction) => {\n  try {\n    const authHeader = req.headers.authorization;\n    \n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      throw new AppError(401, 'Missing or invalid authorization header');\n    }\n\n    const token = authHeader.substring(7);\n    \n    // TODO: Validate token with JWT or session store\n    // For now, extract userId from token (in production, verify signature)\n    try {\n      const decoded = JSON.parse(Buffer.from(token, 'base64').toString());\n      req.user = decoded;\n      next();\n    } catch (error) {\n      throw new AppError(401, 'Invalid token');\n    }\n  } catch (error) {\n    next(error);\n  }\n};\n\n/**\n * Role-based access control middleware\n */\nexport const requireRole = (allowedRoles: string[]) => {\n  return (req: Request, res: Response, next: NextFunction) => {\n    if (!req.user) {\n      return next(new AppError(401, 'Authentication required'));\n    }\n\n    if (!allowedRoles.includes(req.user.role || '')) {\n      return next(new AppError(403, 'Insufficient permissions'));\n    }\n\n    next();\n  };\n};\n\n/**\n * Optional authentication - doesn't fail if no token\n */\nexport const optionalAuth = (req: Request, res: Response, next: NextFunction) => {\n  try {\n    const authHeader = req.headers.authorization;\n    \n    if (authHeader && authHeader.startsWith('Bearer ')) {\n      const token = authHeader.substring(7);\n      try {\n        const decoded = JSON.parse(Buffer.from(token, 'base64').toString());\n        req.user = decoded;\n      } catch (error) {\n        // Silently fail - user remains undefined\n      }\n    }\n    \n    next();\n  } catch (error) {\n    next(error);\n  }\n};\n"],"mappings":"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","ignoreList":[]}