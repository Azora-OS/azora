{"version":3,"names":["cov_20uklw5gm9","actualCoverage","PrismaClient","createLogger","logInfo","logError","prisma","s","logger","ConsentType","ConsentManager","recordConsent","record","f","consentRecord","create","data","userId","consentType","granted","timestamp","ipAddress","userAgent","type","error","getConsent","findFirst","where","orderBy","b","getConsentStatus","essential","analytics","marketing","personalization","Promise","all","ESSENTIAL","ANALYTICS","MARKETING","PERSONALIZATION","lastUpdated","Date","withdrawConsent","grantConsent","exportUserData","user","findUnique","id","include","profile","enrollments","payments","wallets","assessments","chatSessions","Error","consentRecords","findMany","email","name","role","createdAt","deleteUserData","delete","consentManager"],"sources":["consent-manager.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\nimport { createLogger, logInfo, logError } from '../logging';\n\nconst prisma = new PrismaClient();\nconst logger = createLogger('consent-manager');\n\nexport enum ConsentType {\n  ESSENTIAL = 'ESSENTIAL',\n  ANALYTICS = 'ANALYTICS',\n  MARKETING = 'MARKETING',\n  PERSONALIZATION = 'PERSONALIZATION'\n}\n\nexport interface ConsentRecord {\n  userId: string;\n  consentType: ConsentType;\n  granted: boolean;\n  timestamp: Date;\n  ipAddress?: string;\n  userAgent?: string;\n}\n\nexport interface ConsentStatus {\n  userId: string;\n  essential: boolean;\n  analytics: boolean;\n  marketing: boolean;\n  personalization: boolean;\n  lastUpdated: Date;\n}\n\nexport class ConsentManager {\n  async recordConsent(record: ConsentRecord): Promise<void> {\n    try {\n      // Store consent record in database\n      await prisma.consentRecord.create({\n        data: {\n          userId: record.userId,\n          consentType: record.consentType,\n          granted: record.granted,\n          timestamp: record.timestamp,\n          ipAddress: record.ipAddress,\n          userAgent: record.userAgent\n        }\n      });\n      logInfo(logger, '[GDPR] Consent recorded', { userId: record.userId, type: record.consentType });\n    } catch (error) {\n      logError(logger, '[GDPR] Failed to record consent', error as Error, { userId: record.userId });\n      throw error;\n    }\n  }\n\n  async getConsent(userId: string, consentType: ConsentType): Promise<boolean> {\n    try {\n      const record = await prisma.consentRecord.findFirst({\n        where: {\n          userId,\n          consentType\n        },\n        orderBy: {\n          timestamp: 'desc'\n        }\n      });\n      return record?.granted ?? false;\n    } catch (error) {\n      logError(logger, '[GDPR] Failed to get consent', error as Error, { userId });\n      return false;\n    }\n  }\n\n  async getConsentStatus(userId: string): Promise<ConsentStatus> {\n    try {\n      const [essential, analytics, marketing, personalization] = await Promise.all([\n        this.getConsent(userId, ConsentType.ESSENTIAL),\n        this.getConsent(userId, ConsentType.ANALYTICS),\n        this.getConsent(userId, ConsentType.MARKETING),\n        this.getConsent(userId, ConsentType.PERSONALIZATION)\n      ]);\n\n      return {\n        userId,\n        essential,\n        analytics,\n        marketing,\n        personalization,\n        lastUpdated: new Date()\n      };\n    } catch (error) {\n      logError(logger, '[GDPR] Failed to get consent status', error as Error, { userId });\n      throw error;\n    }\n  }\n\n  async withdrawConsent(userId: string, consentType: ConsentType): Promise<void> {\n    await this.recordConsent({\n      userId,\n      consentType,\n      granted: false,\n      timestamp: new Date()\n    });\n  }\n\n  async grantConsent(userId: string, consentType: ConsentType, ipAddress?: string, userAgent?: string): Promise<void> {\n    await this.recordConsent({\n      userId,\n      consentType,\n      granted: true,\n      timestamp: new Date(),\n      ipAddress,\n      userAgent\n    });\n  }\n\n  async exportUserData(userId: string): Promise<any> {\n    try {\n      const user = await prisma.user.findUnique({\n        where: { id: userId },\n        include: {\n          profile: true,\n          enrollments: true,\n          payments: true,\n          wallets: true,\n          assessments: true,\n          chatSessions: true\n        }\n      });\n\n      if (!user) {\n        throw new Error('User not found');\n      }\n\n      const consentRecords = await prisma.consentRecord.findMany({\n        where: { userId }\n      });\n\n      return {\n        user: {\n          id: user.id,\n          email: user.email,\n          name: user.name,\n          role: user.role,\n          createdAt: user.createdAt,\n          profile: user.profile\n        },\n        enrollments: user.enrollments,\n        payments: user.payments,\n        wallets: user.wallets,\n        assessments: user.assessments,\n        chatSessions: user.chatSessions,\n        consentRecords\n      };\n    } catch (error) {\n      logError(logger, '[GDPR] Failed to export user data', error as Error, { userId });\n      throw error;\n    }\n  }\n\n  async deleteUserData(userId: string): Promise<void> {\n    try {\n      // Delete user and all related data (cascading deletes)\n      await prisma.user.delete({\n        where: { id: userId }\n      });\n      logInfo(logger, '[GDPR] User data deleted', { userId });\n    } catch (error) {\n      logError(logger, '[GDPR] Failed to delete user data', error as Error, { userId });\n      throw error;\n    }\n  }\n}\n\nexport const consentManager = new ConsentManager();\n"],"mappings":"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","ignoreList":[]}