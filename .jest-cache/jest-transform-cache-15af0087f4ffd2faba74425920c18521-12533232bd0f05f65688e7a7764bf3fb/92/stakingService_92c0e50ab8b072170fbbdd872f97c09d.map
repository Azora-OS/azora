{"version":3,"names":["cov_4jbwq9383","actualCoverage","PrismaClient","prisma","s","STAKING_POOL_WALLET_ID","process","env","StakingService","stake","userId","amount","lockPeriodDays","f","wallet","findUnique","where","b","Error","balance","apy","$transaction","update","id","data","decrement","staked","increment","staking","create","walletId","lockPeriod","active","transaction","type","status","coinType","usdEquivalent","notes","senderId","unstake","stakingRecordId","include","lockEndDate","Date","startDate","getTime","toISOString","endDate","recipientId","distributeStakingRewards","stakingPoolWallet","rewardPie","totalStakedResult","aggregate","_sum","totalStaked","rewardRate","allStakes","findMany","rewardTransactions","rewardAmount","push","rewardsPaid"],"sources":["stakingService.ts"],"sourcesContent":["/*\nAZORA PROPRIETARY LICENSE\n\nCopyright Â© 2025 Azora ES (Pty) Ltd. All Rights Reserved.\n\nSee LICENSE file for details.\n*/\n\nimport { PrismaClient } from '@prisma/client';\nconst prisma = new PrismaClient();\n\nconst STAKING_POOL_WALLET_ID = process.env.STAKING_POOL_WALLET_ID!;\n\nclass StakingService {\n  async stake(userId: string, amount: number, lockPeriodDays: number) {\n    const wallet = await prisma.wallet.findUnique({ where: { userId } });\n    if (!wallet) {throw new Error('Wallet not found');}\n    if (wallet.balance < amount) {throw new Error('Insufficient AZR balance');}\n    const apy = lockPeriodDays > 180 ? 0.10 : 0.05;\n\n    return prisma.$transaction([\n      prisma.wallet.update({\n        where: { id: wallet.id },\n        data: { balance: { decrement: amount }, staked: { increment: amount } }\n      }),\n      prisma.staking.create({\n        data: { walletId: wallet.id, amount, lockPeriod: lockPeriodDays, apy, active: true }\n      }),\n      prisma.transaction.create({\n        data: {\n          type: 'STAKE',\n          status: 'COMPLETED',\n          amount,\n          coinType: 'AZR',\n          usdEquivalent: amount,\n          notes: `Staked for ${lockPeriodDays} days @ ${apy * 100}%`,\n          senderId: wallet.id\n        }\n      })\n    ]);\n  }\n\n  async unstake(userId: string, stakingRecordId: string) {\n    const stake = await prisma.staking.findUnique({ where: { id: stakingRecordId }, include: { wallet: true } });\n    if (!stake || stake.wallet.userId !== userId) {throw new Error('Staking record not found or permission denied');}\n    if (stake.active === false) {throw new Error('Stake is already inactive');}\n    const lockEndDate = new Date(stake.startDate.getTime() + stake.lockPeriod * 24 * 60 * 60 * 1000);\n    if (new Date() < lockEndDate) {throw new Error(`Lock period not over. Can unstake on ${lockEndDate.toISOString()}`);}\n\n    return prisma.$transaction([\n      prisma.wallet.update({ where: { id: stake.walletId }, data: { balance: { increment: stake.amount }, staked: { decrement: stake.amount } } }),\n      prisma.staking.update({ where: { id: stakingRecordId }, data: { active: false, endDate: new Date() } }),\n      prisma.transaction.create({\n        data: {\n          type: 'UNSTAKE',\n          status: 'COMPLETED',\n          amount: stake.amount,\n          coinType: 'AZR',\n          usdEquivalent: stake.amount,\n          notes: `Unstaked record ${stakingRecordId}`,\n          recipientId: stake.walletId\n        }\n      })\n    ]);\n  }\n\n  async distributeStakingRewards() {\n    const stakingPoolWallet = await prisma.wallet.findUnique({ where: { id: STAKING_POOL_WALLET_ID } });\n    const rewardPie = stakingPoolWallet?.balance || 0;\n    if (rewardPie <= 0) {return;}\n    const totalStakedResult = await prisma.staking.aggregate({ _sum: { amount: true }, where: { active: true } });\n    const totalStaked = totalStakedResult._sum.amount || 0;\n    if (totalStaked === 0) {return;}\n    const rewardRate = rewardPie / totalStaked;\n    const allStakes = await prisma.staking.findMany({ where: { active: true } });\n    const rewardTransactions: any[] = [];\n    for (const stake of allStakes) {\n      const rewardAmount = stake.amount * rewardRate;\n      rewardTransactions.push(\n        prisma.wallet.update({ where: { id: stake.walletId }, data: { balance: { increment: rewardAmount } } }),\n        prisma.transaction.create({\n          data: {\n            type: 'REWARD', status: 'COMPLETED', amount: rewardAmount, coinType: 'AZR',\n            usdEquivalent: rewardAmount, notes: `Staking reward for stake ${stake.id} @ rate ${rewardRate}`,\n            senderId: STAKING_POOL_WALLET_ID, recipientId: stake.walletId\n          }\n        }),\n        prisma.staking.update({ where: { id: stake.id }, data: { rewardsPaid: { increment: rewardAmount } } })\n      );\n    }\n    rewardTransactions.push(prisma.wallet.update({ where: { id: STAKING_POOL_WALLET_ID }, data: { balance: 0 } }));\n    await prisma.$transaction(rewardTransactions);\n  }\n}\n\nexport default new StakingService();"],"mappings":"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","ignoreList":[]}