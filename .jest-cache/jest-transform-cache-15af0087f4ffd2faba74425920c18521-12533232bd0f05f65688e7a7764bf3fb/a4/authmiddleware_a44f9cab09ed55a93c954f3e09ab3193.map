{"version":3,"names":["cov_1fnaiqtu8","actualCoverage","verifyAccessToken","requireAuth","req","res","next","f","s","authHeader","headers","authorization","b","startsWith","status","json","error","message","token","substring","payload","user","requireRole","allowedRoles","includes","role","required","current","optionalAuth"],"sources":["auth-middleware.ts"],"sourcesContent":["import { Request, Response, NextFunction } from 'express';\nimport { verifyAccessToken } from './auth-service';\n\nexport interface AuthRequest extends Request {\n    user?: {\n        userId: string;\n        email: string;\n        role: string;\n    };\n}\n\n/**\n * Middleware to verify JWT and attach user to request\n */\nexport function requireAuth(req: AuthRequest, res: Response, next: NextFunction) {\n    try {\n        const authHeader = req.headers.authorization;\n\n        if (!authHeader || !authHeader.startsWith('Bearer ')) {\n            return res.status(401).json({\n                error: 'Missing or invalid authorization header',\n                message: 'Please provide a valid Bearer token'\n            });\n        }\n\n        const token = authHeader.substring(7); // Remove 'Bearer ' prefix\n        const payload = verifyAccessToken(token);\n\n        // Attach user info to request\n        req.user = payload;\n        next();\n    } catch (error) {\n        return res.status(401).json({\n            error: 'Invalid or expired token',\n            message: 'Please login again'\n        });\n    }\n}\n\n/**\n * Middleware to check user role\n */\nexport function requireRole(...allowedRoles: string[]) {\n    return (req: AuthRequest, res: Response, next: NextFunction) => {\n        if (!req.user) {\n            return res.status(401).json({ error: 'Authentication required' });\n        }\n\n        if (!allowedRoles.includes(req.user.role)) {\n            return res.status(403).json({\n                error: 'Insufficient permissions',\n                required: allowedRoles,\n                current: req.user.role\n            });\n        }\n\n        next();\n    };\n}\n\n/**\n * Optional auth - doesn't fail if no token, but attaches user if valid\n */\nexport function optionalAuth(req: AuthRequest, res: Response, next: NextFunction) {\n    try {\n        const authHeader = req.headers.authorization;\n\n        if (authHeader && authHeader.startsWith('Bearer ')) {\n            const token = authHeader.substring(7);\n            const payload = verifyAccessToken(token);\n            req.user = payload;\n        }\n    } catch (error) {\n        // Silently ignore invalid tokens for optional auth\n    }\n\n    next();\n}\n"],"mappings":"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","ignoreList":[]}