{"version":3,"names":["cov_1j7u5sl99k","actualCoverage","z","LLMService","ActionSchema","s","object","type","string","actorId","targetId","optional","payload","any","context","ConstitutionalEngine","constructor","f","llmService","validateAction","action","parseResult","safeParse","success","b","isAllowed","score","critique","violations","console","log","evaluation","evaluateAction","error","generateConstitutionalCritique","response","biasCheck","detectBias","hasBias","explanation","processTutorRequest","courseName","topic","userMessage","systemPrompt","TUTOR_SYSTEM_PROMPT","replace","prompt","result","complete","parsed","JSON","parse","content","e"],"sources":["constitutional-engine.ts"],"sourcesContent":["import { z } from 'zod';\nimport { LLMService } from './llm-service';\n\n// Schema for an Action that needs validation\nexport const ActionSchema = z.object({\n    type: z.string(),\n    actorId: z.string(),\n    targetId: z.string().optional(),\n    payload: z.any(),\n    context: z.string().optional(),\n});\n\nexport type Action = z.infer<typeof ActionSchema>;\n\nexport interface ValidationResult {\n    isAllowed: boolean;\n    score: number; // 0-100\n    critique: string;\n    violations: string[];\n}\n\nexport class ConstitutionalEngine {\n    private llmService: LLMService;\n\n    constructor() {\n        this.llmService = new LLMService();\n    }\n\n    /**\n     * Validates an action against the Constitution using LLM reasoning.\n     * @param action The action to validate.\n     * @returns A validation result.\n     */\n    async validateAction(action: Action): Promise<ValidationResult> {\n        // 1. Basic Schema Validation\n        const parseResult = ActionSchema.safeParse(action);\n        if (!parseResult.success) {\n            return {\n                isAllowed: false,\n                score: 0,\n                critique: \"Action schema invalid.\",\n                violations: [\"Invalid Schema\"]\n            };\n        }\n\n        // 2. LLM-Based Constitutional Evaluation\n        try {\n            console.log(`[ConstitutionalEngine] Evaluating action: ${action.type}`);\n            const evaluation = await this.llmService.evaluateAction(action);\n\n            return {\n                isAllowed: evaluation.isAllowed,\n                score: evaluation.score,\n                critique: evaluation.critique,\n                violations: evaluation.violations || []\n            };\n        } catch (error) {\n            console.error('Constitutional evaluation failed:', error);\n            // Fail safe: If the judge is offline, block critical actions\n            return {\n                isAllowed: false,\n                score: 0,\n                critique: \"Constitutional Engine Error: Unable to evaluate.\",\n                violations: [\"System Error\"]\n            };\n        }\n    }\n\n    /**\n     * Generates a self-critique of an AI response.\n     * @param response The text response generated by an AI.\n     * @returns A critique string.\n     */\n    async generateConstitutionalCritique(response: string): Promise<string> {\n        const biasCheck = await this.llmService.detectBias(response);\n        if (biasCheck.hasBias) {\n            return `Critique: Potential bias detected. ${biasCheck.explanation}`;\n        }\n        return \"Critique: Response aligns with constitutional principles.\";\n    }\n\n    /**\n     * Processes a request for the AI Tutor.\n     * @param courseName The name of the course.\n     * @param topic The current topic.\n     * @param userMessage The student's message.\n     * @returns The AI Tutor's response.\n     */\n    async processTutorRequest(courseName: string, topic: string, userMessage: string): Promise<string> {\n        // 1. Construct the prompt\n        const systemPrompt = (await import('./prompts')).TUTOR_SYSTEM_PROMPT\n            .replace('{{COURSE_NAME}}', courseName)\n            .replace('{{TOPIC}}', topic);\n\n        // 2. Call LLM\n        try {\n            // We use the LLM service directly here, bypassing the strict JSON format of evaluateAction\n            // This assumes the LLM adapter can handle standard chat completions too\n            // For now, we'll reuse the adapter but we might need to adjust the adapter interface \n            // if we want to enforce JSON for actions but text for chat.\n            // The current MockAdapter returns JSON strings, so we need to handle that.\n\n            // Hack: We'll wrap the user message to ask for a JSON response with a \"response\" field\n            // to keep consistent with the current adapter implementation.\n            const prompt = `Student: ${userMessage}\\n\\nRespond as the AI Tutor in JSON format: { \"response\": \"your text here\" }`;\n\n            const result = await this.llmService['adapter'].complete(prompt, systemPrompt);\n            try {\n                const parsed = JSON.parse(result.content);\n                return parsed.response || result.content;\n            } catch (e) {\n                return result.content;\n            }\n        } catch (error) {\n            console.error('Tutor request failed:', error);\n            return \"I apologize, but I am having trouble connecting to the planetary mind right now. Please try again later.\";\n        }\n    }\n}\n"],"mappings":"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","ignoreList":[]}