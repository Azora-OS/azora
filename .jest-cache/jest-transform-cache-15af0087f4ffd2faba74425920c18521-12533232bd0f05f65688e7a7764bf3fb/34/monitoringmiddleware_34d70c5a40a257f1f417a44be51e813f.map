{"version":3,"names":["cov_13limy7vb1","actualCoverage","Request","v4","uuidv4","structuredLogger","recordHttpRequest","recordHttpError","updateSystemMetrics","requestIdMiddleware","req","res","next","f","s","requestId","b","headers","startTime","Date","now","setHeader","httpLoggingMiddleware","originalSend","send","data","duration","statusCode","method","path","logHttpRequest","userId","call","errorHandlingMiddleware","err","status","errorType","name","error","message","json","success","timestamp","toISOString","systemMetricsMiddleware","Math","random","slowRequestMiddleware","slowThresholdMs","warn","threshold","requestBodyLoggingMiddleware","process","env","LOG_REQUEST_BODY","debug","body"],"sources":["monitoring.middleware.ts"],"sourcesContent":["/**\n * Monitoring Middleware\n * Tracks HTTP requests, errors, and performance metrics\n */\n\nimport { Request, Response, NextFunction } from 'express';\nimport { v4 as uuidv4 } from 'uuid';\nimport { structuredLogger } from '../utils/structured-logger';\nimport {\n  recordHttpRequest,\n  recordHttpError,\n  updateSystemMetrics,\n} from '../utils/metrics';\n\n/**\n * Extend Express Request to include monitoring data\n */\ndeclare global {\n  namespace Express {\n    interface Request {\n      requestId: string;\n      startTime: number;\n    }\n  }\n}\n\n/**\n * Middleware to add request ID and start time\n */\nexport function requestIdMiddleware(\n  req: Request,\n  res: Response,\n  next: NextFunction\n): void {\n  req.requestId = req.headers['x-request-id'] as string || uuidv4();\n  req.startTime = Date.now();\n\n  // Add request ID to response headers\n  res.setHeader('X-Request-ID', req.requestId);\n\n  next();\n}\n\n/**\n * Middleware to log HTTP requests and record metrics\n */\nexport function httpLoggingMiddleware(\n  req: Request,\n  res: Response,\n  next: NextFunction // eslint-disable-line @typescript-eslint/no-unused-vars\n): void {\n  // Capture the original send function\n  const originalSend = res.send;\n\n  // Override send to capture response\n  res.send = function (data: any) {\n    const duration = (Date.now() - req.startTime) / 1000; // Convert to seconds\n    const statusCode = res.statusCode;\n\n    // Record metrics\n    recordHttpRequest(req.method, req.path, statusCode, duration);\n\n    // Log request\n    structuredLogger.logHttpRequest(\n      req.method,\n      req.path,\n      statusCode,\n      duration,\n      {\n        requestId: req.requestId,\n        userId: (req as any).userId,\n      }\n    );\n\n    // Call original send\n    return originalSend.call(this, data);\n  };\n\n  next();\n}\n\n/**\n * Middleware to handle errors and record error metrics\n */\nexport function errorHandlingMiddleware(\n  err: any,\n  req: Request,\n  res: Response,\n  next: NextFunction\n): void {\n  const statusCode = err.status || err.statusCode || 500;\n  const errorType = err.name || 'UnknownError';\n\n  // Record error metric\n  recordHttpError(req.method, req.path, errorType);\n\n  // Log error\n  structuredLogger.error(\n    `HTTP Error: ${err.message}`,\n    err,\n    {\n      requestId: req.requestId,\n      userId: (req as any).userId,\n    },\n    {\n      method: req.method,\n      path: req.path,\n      statusCode,\n      errorType,\n    }\n  );\n\n  // Send error response\n  res.status(statusCode).json({\n    success: false,\n    error: err.message || 'Internal server error',\n    requestId: req.requestId,\n    timestamp: new Date().toISOString(),\n  });\n}\n\n/**\n * Middleware to update system metrics periodically\n */\nexport function systemMetricsMiddleware(\n  req: Request, // eslint-disable-line @typescript-eslint/no-unused-vars\n  res: Response, // eslint-disable-line @typescript-eslint/no-unused-vars\n  next: NextFunction\n): void {\n  // Update system metrics every 10 requests\n  if (Math.random() < 0.1) {\n    updateSystemMetrics();\n  }\n\n  next();\n}\n\n/**\n * Middleware to log slow requests\n */\nexport function slowRequestMiddleware(\n  slowThresholdMs: number = 1000\n) {\n  return (req: Request, res: Response, next: NextFunction): void => {\n    const originalSend = res.send;\n\n    res.send = function (data: any) {\n      const duration = Date.now() - req.startTime;\n\n      if (duration > slowThresholdMs) {\n        structuredLogger.warn(\n          `Slow request detected: ${req.method} ${req.path} took ${duration}ms`,\n          {\n            requestId: req.requestId,\n            userId: (req as any).userId,\n          },\n          {\n            method: req.method,\n            path: req.path,\n            duration,\n            threshold: slowThresholdMs,\n          }\n        );\n      }\n\n      return originalSend.call(this, data);\n    };\n\n    next();\n  };\n}\n\n/**\n * Middleware to log request body (for debugging)\n */\nexport function requestBodyLoggingMiddleware(\n  req: Request,\n  res: Response, // eslint-disable-line @typescript-eslint/no-unused-vars\n  next: NextFunction\n): void {\n  if (process.env.LOG_REQUEST_BODY === 'true' && req.method !== 'GET') {\n    structuredLogger.debug(\n      `Request body: ${req.method} ${req.path}`,\n      {\n        requestId: req.requestId,\n        userId: (req as any).userId,\n      },\n      {\n        body: req.body,\n      }\n    );\n  }\n\n  next();\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAeY;IAAAA,cAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAAD,cAAA;AAfZ;AACA;AACA;AACA;;AAEA,SAASE,OAAO,QAAgC,SAAS;AACzD,SAASC,EAAE,IAAIC,MAAM,QAAQ,MAAM;AACnC,SAASC,gBAAgB,QAAQ,4BAA4B;AAC7D,SACEC,iBAAiB,EACjBC,eAAe,EACfC,mBAAmB,QACd,kBAAkB;;AAEzB;AACA;AACA;;AAUA;AACA;AACA;AACA,OAAO,SAASC,mBAAmBA,CACjCC,GAAY,EACZC,GAAa,EACbC,IAAkB,EACZ;EAAA;EAAAZ,cAAA,GAAAa,CAAA;EAAAb,cAAA,GAAAc,CAAA;EACNJ,GAAG,CAACK,SAAS;EAAG;EAAA,CAAAf,cAAA,GAAAgB,CAAA,UAAAN,GAAG,CAACO,OAAO,CAAC,cAAc,CAAC;EAAA;EAAA,CAAAjB,cAAA,GAAAgB,CAAA,UAAcZ,MAAM,CAAC,CAAC;EAAC;EAAAJ,cAAA,GAAAc,CAAA;EAClEJ,GAAG,CAACQ,SAAS,GAAGC,IAAI,CAACC,GAAG,CAAC,CAAC;;EAE1B;EAAA;EAAApB,cAAA,GAAAc,CAAA;EACAH,GAAG,CAACU,SAAS,CAAC,cAAc,EAAEX,GAAG,CAACK,SAAS,CAAC;EAAC;EAAAf,cAAA,GAAAc,CAAA;EAE7CF,IAAI,CAAC,CAAC;AACR;;AAEA;AACA;AACA;AACA,OAAO,SAASU,qBAAqBA,CACnCZ,GAAY,EACZC,GAAa,EACbC,IAAkB,EACZ;EAAA;EAAAZ,cAAA,GAAAa,CAAA;EACN;EACA,MAAMU,YAAY;EAAA;EAAA,CAAAvB,cAAA,GAAAc,CAAA,OAAGH,GAAG,CAACa,IAAI;;EAE7B;EAAA;EAAAxB,cAAA,GAAAc,CAAA;EACAH,GAAG,CAACa,IAAI,GAAG,UAAUC,IAAS,EAAE;IAAA;IAAAzB,cAAA,GAAAa,CAAA;IAC9B,MAAMa,QAAQ;IAAA;IAAA,CAAA1B,cAAA,GAAAc,CAAA,OAAG,CAACK,IAAI,CAACC,GAAG,CAAC,CAAC,GAAGV,GAAG,CAACQ,SAAS,IAAI,IAAI,EAAC,CAAC;IACtD,MAAMS,UAAU;IAAA;IAAA,CAAA3B,cAAA,GAAAc,CAAA,OAAGH,GAAG,CAACgB,UAAU;;IAEjC;IAAA;IAAA3B,cAAA,GAAAc,CAAA;IACAR,iBAAiB,CAACI,GAAG,CAACkB,MAAM,EAAElB,GAAG,CAACmB,IAAI,EAAEF,UAAU,EAAED,QAAQ,CAAC;;IAE7D;IAAA;IAAA1B,cAAA,GAAAc,CAAA;IACAT,gBAAgB,CAACyB,cAAc,CAC7BpB,GAAG,CAACkB,MAAM,EACVlB,GAAG,CAACmB,IAAI,EACRF,UAAU,EACVD,QAAQ,EACR;MACEX,SAAS,EAAEL,GAAG,CAACK,SAAS;MACxBgB,MAAM,EAAGrB,GAAG,CAASqB;IACvB,CACF,CAAC;;IAED;IAAA;IAAA/B,cAAA,GAAAc,CAAA;IACA,OAAOS,YAAY,CAACS,IAAI,CAAC,IAAI,EAAEP,IAAI,CAAC;EACtC,CAAC;EAAC;EAAAzB,cAAA,GAAAc,CAAA;EAEFF,IAAI,CAAC,CAAC;AACR;;AAEA;AACA;AACA;AACA,OAAO,SAASqB,uBAAuBA,CACrCC,GAAQ,EACRxB,GAAY,EACZC,GAAa,EACbC,IAAkB,EACZ;EAAA;EAAAZ,cAAA,GAAAa,CAAA;EACN,MAAMc,UAAU;EAAA;EAAA,CAAA3B,cAAA,GAAAc,CAAA;EAAG;EAAA,CAAAd,cAAA,GAAAgB,CAAA,UAAAkB,GAAG,CAACC,MAAM;EAAA;EAAA,CAAAnC,cAAA,GAAAgB,CAAA,UAAIkB,GAAG,CAACP,UAAU;EAAA;EAAA,CAAA3B,cAAA,GAAAgB,CAAA,UAAI,GAAG;EACtD,MAAMoB,SAAS;EAAA;EAAA,CAAApC,cAAA,GAAAc,CAAA;EAAG;EAAA,CAAAd,cAAA,GAAAgB,CAAA,UAAAkB,GAAG,CAACG,IAAI;EAAA;EAAA,CAAArC,cAAA,GAAAgB,CAAA,UAAI,cAAc;;EAE5C;EAAA;EAAAhB,cAAA,GAAAc,CAAA;EACAP,eAAe,CAACG,GAAG,CAACkB,MAAM,EAAElB,GAAG,CAACmB,IAAI,EAAEO,SAAS,CAAC;;EAEhD;EAAA;EAAApC,cAAA,GAAAc,CAAA;EACAT,gBAAgB,CAACiC,KAAK,CACpB,eAAeJ,GAAG,CAACK,OAAO,EAAE,EAC5BL,GAAG,EACH;IACEnB,SAAS,EAAEL,GAAG,CAACK,SAAS;IACxBgB,MAAM,EAAGrB,GAAG,CAASqB;EACvB,CAAC,EACD;IACEH,MAAM,EAAElB,GAAG,CAACkB,MAAM;IAClBC,IAAI,EAAEnB,GAAG,CAACmB,IAAI;IACdF,UAAU;IACVS;EACF,CACF,CAAC;;EAED;EAAA;EAAApC,cAAA,GAAAc,CAAA;EACAH,GAAG,CAACwB,MAAM,CAACR,UAAU,CAAC,CAACa,IAAI,CAAC;IAC1BC,OAAO,EAAE,KAAK;IACdH,KAAK;IAAE;IAAA,CAAAtC,cAAA,GAAAgB,CAAA,UAAAkB,GAAG,CAACK,OAAO;IAAA;IAAA,CAAAvC,cAAA,GAAAgB,CAAA,UAAI,uBAAuB;IAC7CD,SAAS,EAAEL,GAAG,CAACK,SAAS;IACxB2B,SAAS,EAAE,IAAIvB,IAAI,CAAC,CAAC,CAACwB,WAAW,CAAC;EACpC,CAAC,CAAC;AACJ;;AAEA;AACA;AACA;AACA,OAAO,SAASC,uBAAuBA,CACrClC,GAAY;AAAE;AACdC,GAAa;AAAE;AACfC,IAAkB,EACZ;EAAA;EAAAZ,cAAA,GAAAa,CAAA;EAAAb,cAAA,GAAAc,CAAA;EACN;EACA,IAAI+B,IAAI,CAACC,MAAM,CAAC,CAAC,GAAG,GAAG,EAAE;IAAA;IAAA9C,cAAA,GAAAgB,CAAA;IAAAhB,cAAA,GAAAc,CAAA;IACvBN,mBAAmB,CAAC,CAAC;EACvB,CAAC;EAAA;EAAA;IAAAR,cAAA,GAAAgB,CAAA;EAAA;EAAAhB,cAAA,GAAAc,CAAA;EAEDF,IAAI,CAAC,CAAC;AACR;;AAEA;AACA;AACA;AACA,OAAO,SAASmC,qBAAqBA,CACnCC,eAAuB;AAAA;AAAA,CAAAhD,cAAA,GAAAgB,CAAA,UAAG,IAAI,GAC9B;EAAA;EAAAhB,cAAA,GAAAa,CAAA;EAAAb,cAAA,GAAAc,CAAA;EACA,OAAO,CAACJ,GAAY,EAAEC,GAAa,EAAEC,IAAkB,KAAW;IAAA;IAAAZ,cAAA,GAAAa,CAAA;IAChE,MAAMU,YAAY;IAAA;IAAA,CAAAvB,cAAA,GAAAc,CAAA,QAAGH,GAAG,CAACa,IAAI;IAAC;IAAAxB,cAAA,GAAAc,CAAA;IAE9BH,GAAG,CAACa,IAAI,GAAG,UAAUC,IAAS,EAAE;MAAA;MAAAzB,cAAA,GAAAa,CAAA;MAC9B,MAAMa,QAAQ;MAAA;MAAA,CAAA1B,cAAA,GAAAc,CAAA,QAAGK,IAAI,CAACC,GAAG,CAAC,CAAC,GAAGV,GAAG,CAACQ,SAAS;MAAC;MAAAlB,cAAA,GAAAc,CAAA;MAE5C,IAAIY,QAAQ,GAAGsB,eAAe,EAAE;QAAA;QAAAhD,cAAA,GAAAgB,CAAA;QAAAhB,cAAA,GAAAc,CAAA;QAC9BT,gBAAgB,CAAC4C,IAAI,CACnB,0BAA0BvC,GAAG,CAACkB,MAAM,IAAIlB,GAAG,CAACmB,IAAI,SAASH,QAAQ,IAAI,EACrE;UACEX,SAAS,EAAEL,GAAG,CAACK,SAAS;UACxBgB,MAAM,EAAGrB,GAAG,CAASqB;QACvB,CAAC,EACD;UACEH,MAAM,EAAElB,GAAG,CAACkB,MAAM;UAClBC,IAAI,EAAEnB,GAAG,CAACmB,IAAI;UACdH,QAAQ;UACRwB,SAAS,EAAEF;QACb,CACF,CAAC;MACH,CAAC;MAAA;MAAA;QAAAhD,cAAA,GAAAgB,CAAA;MAAA;MAAAhB,cAAA,GAAAc,CAAA;MAED,OAAOS,YAAY,CAACS,IAAI,CAAC,IAAI,EAAEP,IAAI,CAAC;IACtC,CAAC;IAAC;IAAAzB,cAAA,GAAAc,CAAA;IAEFF,IAAI,CAAC,CAAC;EACR,CAAC;AACH;;AAEA;AACA;AACA;AACA,OAAO,SAASuC,4BAA4BA,CAC1CzC,GAAY,EACZC,GAAa;AAAE;AACfC,IAAkB,EACZ;EAAA;EAAAZ,cAAA,GAAAa,CAAA;EAAAb,cAAA,GAAAc,CAAA;EACN;EAAI;EAAA,CAAAd,cAAA,GAAAgB,CAAA,UAAAoC,OAAO,CAACC,GAAG,CAACC,gBAAgB,KAAK,MAAM;EAAA;EAAA,CAAAtD,cAAA,GAAAgB,CAAA,UAAIN,GAAG,CAACkB,MAAM,KAAK,KAAK,GAAE;IAAA;IAAA5B,cAAA,GAAAgB,CAAA;IAAAhB,cAAA,GAAAc,CAAA;IACnET,gBAAgB,CAACkD,KAAK,CACpB,iBAAiB7C,GAAG,CAACkB,MAAM,IAAIlB,GAAG,CAACmB,IAAI,EAAE,EACzC;MACEd,SAAS,EAAEL,GAAG,CAACK,SAAS;MACxBgB,MAAM,EAAGrB,GAAG,CAASqB;IACvB,CAAC,EACD;MACEyB,IAAI,EAAE9C,GAAG,CAAC8C;IACZ,CACF,CAAC;EACH,CAAC;EAAA;EAAA;IAAAxD,cAAA,GAAAgB,CAAA;EAAA;EAAAhB,cAAA,GAAAc,CAAA;EAEDF,IAAI,CAAC,CAAC;AACR","ignoreList":[]}