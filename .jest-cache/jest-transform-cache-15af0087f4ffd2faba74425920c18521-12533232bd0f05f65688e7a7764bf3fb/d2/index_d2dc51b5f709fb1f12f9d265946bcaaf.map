{"version":3,"names":["cov_1celbbjdv3","actualCoverage","express","bodyParser","FileWatcher","DatabaseIndexer","AIProviderRouter","logger","apiKeyOrJwtAuth","path","app","s","use","json","indexer","ai","workspacePath","b","process","env","WORKSPACE_PATH","resolve","cwd","watcher","nodes","f","n","embedding","embedText","content","indexNodes","start","get","req","res","q","query","status","error","results","search","post","apiKeyHeader","headers","indexApiKey","INDEX_API_KEY","body","Array","isArray","length","id","success","count","err","port","PORT","listen","info"],"sources":["index.ts"],"sourcesContent":["import express from 'express';\nimport bodyParser from 'body-parser';\nimport { FileWatcher } from './fileWatcher';\nimport { DatabaseIndexer } from './indexer';\nimport { AIProviderRouter } from './aiRouter';\nimport { logger } from './logger';\nimport { apiKeyOrJwtAuth } from './middleware/auth';\nimport path from 'path';\n\nconst app = express();\napp.use(bodyParser.json());\n\nconst indexer = new DatabaseIndexer();\nconst ai = new AIProviderRouter();\nconst workspacePath = process.env.WORKSPACE_PATH ?? path.resolve(process.cwd());\nconst watcher = new FileWatcher(workspacePath, async (nodes) => {\n  for (const n of nodes) {\n    (n as any).embedding = await ai.embedText(n.content);\n  }\n  await indexer.indexNodes(nodes);\n});\nwatcher.start();\n\napp.get('/search', async (req, res) => {\n  const q = req.query.q as string | undefined;\n  if (!q) return res.status(400).json({ error: 'q required' });\n  const results = await indexer.search(q, 10);\n  res.json(results);\n});\n\n// Accept content nodes for indexing (from VSCode extension or other sources)\napp.post('/index', apiKeyOrJwtAuth(true), async (req, res) => {\n  const apiKeyHeader = req.headers['x-api-key'] || req.headers['authorization'];\n  const indexApiKey = process.env.INDEX_API_KEY;\n  if (indexApiKey && (!apiKeyHeader || (apiKeyHeader !== `Bearer ${indexApiKey}` && apiKeyHeader !== indexApiKey))) {\n    return res.status(401).json({ error: 'unauthorized' });\n  }\n  const nodes = req.body as any[];\n  if (!Array.isArray(nodes) || nodes.length === 0) return res.status(400).json({ error: 'nodes array required' });\n  // Validate nodes - each should have id & content at least\n  for (const n of nodes) {\n    if (!n.id) return res.status(400).json({ error: 'node id required' });\n    if (!n.content) return res.status(400).json({ error: 'node content required' });\n  }\n  try {\n    for (const n of nodes) {\n      if (!n.embedding) n.embedding = await ai.embedText(n.content);\n    }\n    await indexer.indexNodes(nodes);\n    res.status(200).json({ success: true, count: nodes.length });\n  } catch (err) {\n    logger.error({ err }, 'Indexing failed');\n    res.status(500).json({ error: 'indexing failed' });\n  }\n});\n\nconst port = process.env.PORT ?? 4003;\napp.listen(port, () => {\n  logger.info({ port }, 'Knowledge Ocean service started');\n});\n"],"mappings":"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","ignoreList":[]}