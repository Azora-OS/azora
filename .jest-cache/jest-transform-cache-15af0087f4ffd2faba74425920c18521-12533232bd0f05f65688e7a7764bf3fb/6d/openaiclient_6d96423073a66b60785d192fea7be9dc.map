{"version":3,"names":["cov_2oqa1dw7yn","actualCoverage","OpenAI","DEFAULT_MODEL","s","b","process","env","OPENAI_MODEL","OpenAIClient","constructor","apiKey","OPENAI_API_KEY","f","Error","client","chat","messages","options","model","temperature","maxTokens","timeoutMs","controller","AbortController","id","setTimeout","abort","res","completions","create","max_tokens","signal","choices","message","content","err","status","Promise","r","clearTimeout","complete","prompt","role","embed","text","OPENAI_EMBEDDING_MODEL","embeddings","input","data","embedding","moderate","OPENAI_MODERATION_MODEL","moderations","result","results","flagged","Boolean","categories"],"sources":["openai-client.ts"],"sourcesContent":["/*\nAZORA PROPRIETARY LICENSE\nCopyright Â© 2025 Azora ES (Pty) Ltd. All Rights Reserved.\n\nOpenAI Client Wrapper\nProvides a thin, typed wrapper around the OpenAI SDK with sensible defaults\nand basic safeguards (timeouts, simple retry on rate limit).\n*/\n\nimport OpenAI from 'openai';\n\nexport type ChatMessage = { role: 'system' | 'user' | 'assistant'; content: string };\n\nexport interface ChatOptions {\n  model?: string;\n  temperature?: number;\n  maxTokens?: number;\n  timeoutMs?: number;\n}\n\nexport interface CompletionOptions extends ChatOptions {}\n\nconst DEFAULT_MODEL = process.env.OPENAI_MODEL || 'gpt-4o-mini';\n\nexport class OpenAIClient {\n  private client: OpenAI;\n\n  constructor(apiKey = process.env.OPENAI_API_KEY) {\n    if (!apiKey) {\n      throw new Error('OPENAI_API_KEY is required');\n    }\n    this.client = new OpenAI({ apiKey });\n  }\n\n  async chat(messages: ChatMessage[], options: ChatOptions = {}): Promise<string> {\n    const { model = DEFAULT_MODEL, temperature = 0.7, maxTokens = 800, timeoutMs = 60000 } = options;\n    const controller = new AbortController();\n    const id = setTimeout(() => controller.abort(), timeoutMs);\n    try {\n      const res = await this.client.chat.completions.create(\n        {\n          model,\n          messages,\n          temperature,\n          max_tokens: maxTokens,\n        },\n        { signal: controller.signal as any }\n      );\n      return res.choices?.[0]?.message?.content ?? '';\n    } catch (err: any) {\n      if (err?.status === 429) {\n        await new Promise(r => setTimeout(r, 250));\n        const res = await this.client.chat.completions.create({ model, messages, temperature, max_tokens: maxTokens });\n        return res.choices?.[0]?.message?.content ?? '';\n      }\n      throw err;\n    } finally {\n      clearTimeout(id);\n    }\n  }\n\n  async complete(prompt: string, options: CompletionOptions = {}): Promise<string> {\n    const messages: ChatMessage[] = [\n      { role: 'user', content: prompt },\n    ];\n    return this.chat(messages, options);\n  }\n\n  async embed(text: string): Promise<number[]> {\n    const model = process.env.OPENAI_EMBEDDING_MODEL || 'text-embedding-3-small';\n    const res = await this.client.embeddings.create({ model, input: text });\n    return (res.data?.[0]?.embedding as number[]) || [];\n  }\n\n  async moderate(content: string): Promise<{ flagged: boolean; categories?: Record<string, boolean> }>{\n    // The new OpenAI SDK v4 no longer exposes moderation as a first-class method in all setups;\n    // use the HTTP endpoint via client as recommended.\n    const model = process.env.OPENAI_MODERATION_MODEL || 'omni-moderation-latest';\n    try {\n      // @ts-expect-error: moderation endpoint may not be typed depending on SDK version\n      const res = await this.client.moderations.create({ model, input: content });\n      const result = res.results?.[0];\n      return { flagged: Boolean(result?.flagged), categories: result?.categories };\n    } catch {\n      // Fail-open but unflagged if moderation not available\n      return { flagged: false };\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}