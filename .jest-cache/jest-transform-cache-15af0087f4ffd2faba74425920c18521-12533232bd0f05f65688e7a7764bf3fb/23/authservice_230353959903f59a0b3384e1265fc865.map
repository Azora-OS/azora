{"version":3,"names":["cov_2o4xio9kqx","actualCoverage","bcrypt","jwt","PrismaClient","prisma","s","JWT_SECRET","b","process","env","JWT_REFRESH_SECRET","JWT_EXPIRY","JWT_REFRESH_EXPIRY","BCRYPT_ROUNDS","parseInt","console","warn","register","input","f","email","password","name","existingUser","user","findUnique","where","Error","passwordHash","hash","create","data","role","accessToken","generateAccessToken","id","refreshToken","generateRefreshToken","token","userId","type","expiresAt","Date","now","login","isValidPassword","compare","payload","verify","error","logout","deleteMany","sign","expiresIn"],"sources":["auth-service.ts"],"sourcesContent":["import bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport { PrismaClient } from '@prisma/client';\n\nconst prisma = new PrismaClient();\n\n// Environment variables with defaults for development\nconst JWT_SECRET = process.env.JWT_SECRET || 'CHANGE_THIS_IN_PRODUCTION';\nconst JWT_REFRESH_SECRET = process.env.JWT_REFRESH_SECRET || 'CHANGE_THIS_REFRESH_IN_PRODUCTION';\nconst JWT_EXPIRY = process.env.JWT_EXPIRY || '24h';\nconst JWT_REFRESH_EXPIRY = process.env.JWT_REFRESH_EXPIRY || '7d';\nconst BCRYPT_ROUNDS = parseInt(process.env.BCRYPT_ROUNDS || '12');\n\n// Warn if using default secrets\nif (JWT_SECRET === 'CHANGE_THIS_IN_PRODUCTION') {\n    console.warn('⚠️  WARNING: Using default JWT_SECRET. Set JWT_SECRET environment variable in production!');\n}\n\nexport interface RegisterInput {\n    email: string;\n    password: string;\n    name: string;\n}\n\nexport interface LoginInput {\n    email: string;\n    password: string;\n}\n\nexport interface AuthResult {\n    user: {\n        id: string;\n        email: string;\n        name: string;\n        role: string;\n    };\n    accessToken: string;\n    refreshToken: string;\n}\n\n/**\n * Register a new user with bcrypt password hashing\n */\nexport async function register(input: RegisterInput): Promise<AuthResult> {\n    const { email, password, name } = input;\n\n    // Check if user already exists\n    const existingUser = await prisma.user.findUnique({\n        where: { email }\n    });\n\n    if (existingUser) {\n        throw new Error('User with this email already exists');\n    }\n\n    // Hash password with bcrypt\n    const passwordHash = await bcrypt.hash(password, BCRYPT_ROUNDS);\n\n    // Create user\n    const user = await prisma.user.create({\n        data: {\n            email,\n            password: passwordHash,\n            name,\n            role: 'STUDENT' // Default role\n        }\n    });\n\n    // Generate tokens\n    const accessToken = generateAccessToken(user.id, user.email, user.role);\n    const refreshToken = generateRefreshToken(user.id);\n\n    // Store refresh token in database\n    await prisma.token.create({\n        data: {\n            userId: user.id,\n            type: 'REFRESH',\n            token: refreshToken,\n            expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7 days\n        }\n    });\n\n    return {\n        user: {\n            id: user.id,\n            email: user.email,\n            name: user.name,\n            role: user.role\n        },\n        accessToken,\n        refreshToken\n    };\n}\n\n/**\n * Login with email and password\n */\nexport async function login(input: LoginInput): Promise<AuthResult> {\n    const { email, password } = input;\n\n    // Find user by email\n    const user = await prisma.user.findUnique({\n        where: { email }\n    });\n\n    if (!user) {\n        throw new Error('Invalid credentials');\n    }\n\n    // Verify password with bcrypt\n    const isValidPassword = await bcrypt.compare(password, user.password);\n\n    if (!isValidPassword) {\n        throw new Error('Invalid credentials');\n    }\n\n    // Generate tokens\n    const accessToken = generateAccessToken(user.id, user.email, user.role);\n    const refreshToken = generateRefreshToken(user.id);\n\n    // Store refresh token\n    await prisma.token.create({\n        data: {\n            userId: user.id,\n            type: 'REFRESH',\n            token: refreshToken,\n            expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)\n        }\n    });\n\n    return {\n        user: {\n            id: user.id,\n            email: user.email,\n            name: user.name,\n            role: user.role\n        },\n        accessToken,\n        refreshToken\n    };\n    try {\n        const payload = jwt.verify(token, JWT_SECRET) as {\n            userId: string;\n            email: string;\n            role: string;\n        };\n        return payload;\n    } catch (error) {\n        throw new Error('Invalid or expired token');\n    }\n}\n\n/**\n * Logout - invalidate refresh token\n */\nexport async function logout(refreshToken: string): Promise<void> {\n    await prisma.token.deleteMany({\n        where: {\n            token: refreshToken,\n            type: 'REFRESH'\n        }\n    });\n}\n\n// Helper functions\n\nfunction generateAccessToken(userId: string, email: string, role: string): string {\n    return jwt.sign(\n        { userId, email, role },\n        JWT_SECRET,\n        { expiresIn: JWT_EXPIRY }\n    );\n}\n\nfunction generateRefreshToken(userId: string): string {\n    return jwt.sign(\n        { userId },\n        JWT_REFRESH_SECRET,\n        { expiresIn: JWT_REFRESH_EXPIRY }\n    );\n}\n"],"mappings":"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","ignoreList":[]}