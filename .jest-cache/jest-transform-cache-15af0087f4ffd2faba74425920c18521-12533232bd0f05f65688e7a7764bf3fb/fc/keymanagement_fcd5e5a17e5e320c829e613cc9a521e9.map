{"version":3,"names":["cov_jyxmm9tgg","actualCoverage","crypto","EventEmitter","KeyManagementService","keys","s","Map","keyRotationInterval","auditLog","constructor","config","f","initialize","logAudit","provider","timestamp","Date","rotationIntervalDays","b","startKeyRotationScheduler","generateKey","keyId","algorithm","keyConfig","createdAt","rotatedAt","set","emit","error","String","Error","encrypt","plaintext","get","iv","randomBytes","key","scryptSync","cipher","createCipheriv","ciphertext","update","final","authTag","getAuthTag","toString","dataSize","length","decrypt","encryptedData","Buffer","from","decipher","createDecipheriv","setAuthTag","rotateKey","oldKeyConfig","newKeyConfig","now","oldKeyId","newKeyId","intervalMs","setInterval","entries","daysSinceRotation","getTime","getKeyConfig","listKeys","Array","values","action","details","auditEntry","push","slice","getAuditLog","filter","logs","log","since","destroy","clearInterval","removeAllListeners","keyManagementService","initializeKeyManagement","getKeyManagementService"],"sources":["key-management.ts"],"sourcesContent":["/**\n * Centralized Key Management Service\n * Implements AWS KMS or HashiCorp Vault integration\n * Handles encryption key lifecycle management\n */\n\nimport crypto from 'crypto';\nimport { EventEmitter } from 'events';\n\ninterface KeyConfig {\n  keyId: string;\n  algorithm: string;\n  createdAt: Date;\n  rotatedAt: Date;\n  expiresAt?: Date;\n  metadata?: Record<string, any>;\n}\n\ninterface EncryptedData {\n  ciphertext: string;\n  iv: string;\n  authTag: string;\n  keyId: string;\n  algorithm: string;\n}\n\n/**\n * Key Management Service\n * Provides centralized key management with rotation and audit logging\n */\nexport class KeyManagementService extends EventEmitter {\n  private keys: Map<string, KeyConfig> = new Map();\n  private keyRotationInterval: NodeJS.Timer | null = null;\n  private auditLog: Array<{\n    timestamp: Date;\n    action: string;\n    keyId: string;\n    details: any;\n  }> = [];\n\n  constructor(private config: {\n    provider: 'kms' | 'vault' | 'local';\n    kmsRegion?: string;\n    vaultAddr?: string;\n    vaultToken?: string;\n    rotationIntervalDays?: number;\n  }) {\n    super();\n    this.initialize();\n  }\n\n  /**\n   * Initialize key management service\n   */\n  private initialize(): void {\n    this.logAudit('SERVICE_INITIALIZED', 'system', {\n      provider: this.config.provider,\n      timestamp: new Date()\n    });\n\n    // Start key rotation scheduler\n    if (this.config.rotationIntervalDays) {\n      this.startKeyRotationScheduler();\n    }\n  }\n\n  /**\n   * Generate a new encryption key\n   */\n  async generateKey(keyId: string, algorithm: string = 'aes-256-gcm'): Promise<KeyConfig> {\n    try {\n      const keyConfig: KeyConfig = {\n        keyId,\n        algorithm,\n        createdAt: new Date(),\n        rotatedAt: new Date()\n      };\n\n      this.keys.set(keyId, keyConfig);\n      this.logAudit('KEY_GENERATED', keyId, { algorithm });\n      this.emit('key:generated', { keyId, algorithm });\n\n      return keyConfig;\n    } catch (error) {\n      this.logAudit('KEY_GENERATION_FAILED', keyId, { error: String(error) });\n      throw new Error(`Failed to generate key: ${error}`);\n    }\n  }\n\n  /**\n   * Encrypt data using a specific key\n   */\n  async encrypt(keyId: string, plaintext: string): Promise<EncryptedData> {\n    try {\n      const keyConfig = this.keys.get(keyId);\n      if (!keyConfig) {\n        throw new Error(`Key not found: ${keyId}`);\n      }\n\n      // Generate random IV\n      const iv = crypto.randomBytes(16);\n      \n      // For demonstration, use a derived key from keyId\n      // In production, this would use actual key material from KMS/Vault\n      const key = crypto.scryptSync(keyId, 'salt', 32);\n\n      // Create cipher\n      const cipher = crypto.createCipheriv(keyConfig.algorithm, key, iv);\n      \n      let ciphertext = cipher.update(plaintext, 'utf8', 'hex');\n      ciphertext += cipher.final('hex');\n      \n      const authTag = cipher.getAuthTag().toString('hex');\n\n      this.logAudit('DATA_ENCRYPTED', keyId, { \n        dataSize: plaintext.length,\n        algorithm: keyConfig.algorithm\n      });\n\n      return {\n        ciphertext,\n        iv: iv.toString('hex'),\n        authTag,\n        keyId,\n        algorithm: keyConfig.algorithm\n      };\n    } catch (error) {\n      this.logAudit('ENCRYPTION_FAILED', keyId, { error: String(error) });\n      throw new Error(`Encryption failed: ${error}`);\n    }\n  }\n\n  /**\n   * Decrypt data using a specific key\n   */\n  async decrypt(encryptedData: EncryptedData): Promise<string> {\n    try {\n      const keyConfig = this.keys.get(encryptedData.keyId);\n      if (!keyConfig) {\n        throw new Error(`Key not found: ${encryptedData.keyId}`);\n      }\n\n      // Derive key from keyId (same as encryption)\n      const key = crypto.scryptSync(encryptedData.keyId, 'salt', 32);\n      const iv = Buffer.from(encryptedData.iv, 'hex');\n      const authTag = Buffer.from(encryptedData.authTag, 'hex');\n\n      // Create decipher\n      const decipher = crypto.createDecipheriv(\n        encryptedData.algorithm,\n        key,\n        iv\n      );\n      decipher.setAuthTag(authTag);\n\n      let plaintext = decipher.update(encryptedData.ciphertext, 'hex', 'utf8');\n      plaintext += decipher.final('utf8');\n\n      this.logAudit('DATA_DECRYPTED', encryptedData.keyId, {\n        algorithm: encryptedData.algorithm\n      });\n\n      return plaintext;\n    } catch (error) {\n      this.logAudit('DECRYPTION_FAILED', encryptedData.keyId, { error: String(error) });\n      throw new Error(`Decryption failed: ${error}`);\n    }\n  }\n\n  /**\n   * Rotate a key\n   */\n  async rotateKey(keyId: string): Promise<KeyConfig> {\n    try {\n      const oldKeyConfig = this.keys.get(keyId);\n      if (!oldKeyConfig) {\n        throw new Error(`Key not found: ${keyId}`);\n      }\n\n      // Generate new key\n      const newKeyConfig = await this.generateKey(`${keyId}-rotated-${Date.now()}`, oldKeyConfig.algorithm);\n      \n      // Update rotation timestamp\n      oldKeyConfig.rotatedAt = new Date();\n\n      this.logAudit('KEY_ROTATED', keyId, {\n        oldKeyId: keyId,\n        newKeyId: newKeyConfig.keyId\n      });\n\n      this.emit('key:rotated', { oldKeyId: keyId, newKeyId: newKeyConfig.keyId });\n\n      return newKeyConfig;\n    } catch (error) {\n      this.logAudit('KEY_ROTATION_FAILED', keyId, { error: String(error) });\n      throw new Error(`Key rotation failed: ${error}`);\n    }\n  }\n\n  /**\n   * Start automatic key rotation scheduler\n   */\n  private startKeyRotationScheduler(): void {\n    const intervalMs = (this.config.rotationIntervalDays || 90) * 24 * 60 * 60 * 1000;\n    \n    this.keyRotationInterval = setInterval(async () => {\n      try {\n        for (const [keyId, keyConfig] of this.keys.entries()) {\n          const daysSinceRotation = (Date.now() - keyConfig.rotatedAt.getTime()) / (24 * 60 * 60 * 1000);\n          \n          if (daysSinceRotation >= (this.config.rotationIntervalDays || 90)) {\n            await this.rotateKey(keyId);\n          }\n        }\n      } catch (error) {\n        this.logAudit('KEY_ROTATION_SCHEDULER_ERROR', 'system', { error: String(error) });\n      }\n    }, intervalMs);\n  }\n\n  /**\n   * Get key configuration\n   */\n  getKeyConfig(keyId: string): KeyConfig | undefined {\n    return this.keys.get(keyId);\n  }\n\n  /**\n   * List all keys\n   */\n  listKeys(): KeyConfig[] {\n    return Array.from(this.keys.values());\n  }\n\n  /**\n   * Log audit event\n   */\n  private logAudit(action: string, keyId: string, details: any): void {\n    const auditEntry = {\n      timestamp: new Date(),\n      action,\n      keyId,\n      details\n    };\n\n    this.auditLog.push(auditEntry);\n    this.emit('audit:log', auditEntry);\n\n    // Keep only last 10000 entries in memory\n    if (this.auditLog.length > 10000) {\n      this.auditLog = this.auditLog.slice(-10000);\n    }\n  }\n\n  /**\n   * Get audit log\n   */\n  getAuditLog(filter?: { keyId?: string; action?: string; since?: Date }): typeof this.auditLog {\n    let logs = this.auditLog;\n\n    if (filter?.keyId) {\n      logs = logs.filter(log => log.keyId === filter.keyId);\n    }\n\n    if (filter?.action) {\n      logs = logs.filter(log => log.action === filter.action);\n    }\n\n    if (filter?.since) {\n      logs = logs.filter(log => log.timestamp >= filter.since!);\n    }\n\n    return logs;\n  }\n\n  /**\n   * Cleanup resources\n   */\n  destroy(): void {\n    if (this.keyRotationInterval) {\n      clearInterval(this.keyRotationInterval);\n    }\n    this.removeAllListeners();\n  }\n}\n\n// Export singleton instance\nlet keyManagementService: KeyManagementService | null = null;\n\nexport function initializeKeyManagement(config: {\n  provider: 'kms' | 'vault' | 'local';\n  kmsRegion?: string;\n  vaultAddr?: string;\n  vaultToken?: string;\n  rotationIntervalDays?: number;\n}): KeyManagementService {\n  if (!keyManagementService) {\n    keyManagementService = new KeyManagementService(config);\n  }\n  return keyManagementService;\n}\n\nexport function getKeyManagementService(): KeyManagementService {\n  if (!keyManagementService) {\n    throw new Error('Key Management Service not initialized');\n  }\n  return keyManagementService;\n}\n\nexport default KeyManagementService;\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}