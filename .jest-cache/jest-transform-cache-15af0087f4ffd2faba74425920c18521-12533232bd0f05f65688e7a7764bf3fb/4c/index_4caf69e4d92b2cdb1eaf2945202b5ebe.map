{"version":3,"names":["cov_rfsjihaur","actualCoverage","express","s","require","compression","stripe","process","env","STRIPE_SECRET_KEY","helmetConfig","corsConfig","rateLimiters","errorHandler","app","use","json","financial","PORT","b","get","req","res","f","status","service","timestamp","Date","toISOString","post","amount","currency","userId","body","mutationRecord","id","randomUUID","actorId","actionType","payloadHash","createHash","update","JSON","stringify","digest","previousHash","signature","metadata","blockchainResponse","fetch","method","headers","from","to","type","data","paymentIntent","fiatCurrency","catch","ok","console","warn","blockchainError","error","source","paymentId","citadelError","paymentIntents","create","Math","round","blockchainRecordId","clientSecret","client_secret","citadelContribution","message","paymentIntentId","retrieve","raw","sig","event","webhooks","constructEvent","STRIPE_WEBHOOK_SECRET","log","object","received","listen","module","exports"],"sources":["index.js"],"sourcesContent":["const express = require('express');\nconst compression = require('compression');\nconst stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);\nconst { helmetConfig, corsConfig, rateLimiters, errorHandler } = require('../shared/middleware');\n\nconst app = express();\n\n// Security middleware stack\napp.use(helmetConfig);\napp.use(corsConfig);\napp.use(compression());\napp.use(express.json());\napp.use(rateLimiters.financial); // Payment service - strict rate limiting\n\nconst PORT = process.env.PORT || 3010;\n\n// Health check\napp.get('/health', (req, res) => {\n  res.json({ status: 'healthy', service: 'azora-pay', timestamp: new Date().toISOString() });\n});\n\n// Create payment intent\napp.post('/api/payments/intent', async (req, res) => {\n  try {\n    const { amount, currency = 'usd', userId } = req.body;\n\n    // 1. Record to Blockchain (using existing azora-mint/blockchain-ledger)\n    // In production, import and use: const { azoraBlockchain } = require('../azora-mint/blockchain-ledger');\n    const mutationRecord = {\n      id: require('crypto').randomUUID(),\n      timestamp: new Date().toISOString(),\n      actorId: userId,\n      actionType: 'PAYMENT_INTENT',\n      payloadHash: require('crypto').createHash('sha256').update(JSON.stringify({ amount, currency, userId })).digest('hex'),\n      previousHash: '0',\n      signature: 'MOCK_SIGNATURE',\n      metadata: { amount, currency }\n    };\n\n    // Record to Blockchain via azora-mint service\n    // TODO: Replace with direct blockchain.createTransaction() call\n    try {\n      const blockchainResponse = await fetch('http://localhost:3011/api/blockchain/transaction', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          from: userId,\n          to: 'stripe-gateway',\n          amount: amount,\n          currency: 'AZR', // Convert to AZR in production\n          type: 'Transfer',\n          data: { paymentIntent: true, fiatCurrency: currency }\n        })\n      }).catch(() => null);\n\n      if (!blockchainResponse || !blockchainResponse.ok) {\n        console.warn('Blockchain recording failed, proceeding with payment');\n        // Fail-open for now (in production, decide based on criticality)\n      }\n    } catch (blockchainError) {\n      console.error('Blockchain recording error:', blockchainError);\n    }\n\n    // 2. Contribute to CitadelFund (10% of payment)\n    try {\n      await fetch('http://localhost:3011/api/citadel/contribute', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          source: userId,\n          amount: amount * 0.10, // 10% contribution\n          metadata: { paymentId: mutationRecord.id, currency }\n        })\n      }).catch(() => console.warn('CitadelFund contribution failed'));\n    } catch (citadelError) {\n      console.warn('CitadelFund error:', citadelError);\n    }\n\n    // 3. Proceed with Stripe payment intent\n    const paymentIntent = await stripe.paymentIntents.create({\n      amount: Math.round(amount * 100),\n      currency,\n      metadata: { userId, blockchainRecordId: mutationRecord.id }\n    });\n\n    res.json({\n      clientSecret: paymentIntent.client_secret,\n      id: paymentIntent.id,\n      blockchainRecordId: mutationRecord.id,\n      citadelContribution: amount * 0.10\n    });\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// Process payment\napp.post('/api/payments/process', async (req, res) => {\n  try {\n    const { paymentIntentId } = req.body;\n    const paymentIntent = await stripe.paymentIntents.retrieve(paymentIntentId);\n\n    res.json({\n      status: paymentIntent.status,\n      amount: paymentIntent.amount / 100,\n      currency: paymentIntent.currency\n    });\n  } catch (error) {\n    res.status(500).json({ error: error.message });\n  }\n});\n\n// Webhook handler\napp.post('/api/payments/webhook', express.raw({ type: 'application/json' }), async (req, res) => {\n  const sig = req.headers['stripe-signature'];\n\n  try {\n    const event = stripe.webhooks.constructEvent(req.body, sig, process.env.STRIPE_WEBHOOK_SECRET);\n\n    if (event.type === 'payment_intent.succeeded') {\n      console.log('Payment succeeded:', event.data.object.id);\n    }\n\n    res.json({ received: true });\n  } catch (error) {\n    res.status(400).json({ error: error.message });\n  }\n});\n\n// Error handling middleware (must be last)\napp.use(errorHandler);\n\napp.listen(PORT, () => {\n  console.log(`ðŸ’° Azora Pay running on port ${PORT}`);\n});\n\nmodule.exports = app;\n"],"mappings":"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","ignoreList":[]}