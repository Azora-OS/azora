{"version":3,"names":["cov_bxsq6ijo5","actualCoverage","prisma","logger","Joi","conversionEventSchema","s","object","studentId","string","required","eventType","valid","triggerValue","number","min","max","conversionOfferSchema","offerType","discount","expirationDays","default","ConversionService","trackConversionEvent","data","f","error","value","validate","b","Error","message","student","user","findUnique","where","id","event","conversionEvent","create","timestamp","Date","info","generateConversionOfferIfEligible","eventId","tier","createConversionOffer","existingOffer","conversionOffer","findFirst","accepted","expiresAt","gt","setDate","getDate","offer","getStudentConversionEvents","events","findMany","orderBy","getStudentActiveOffers","offers","acceptConversionOffer","offerId","updatedOffer","update","acceptedAt","getConversionOffer","expireOldOffers","result","updateMany","lt","count","getConversionMetrics","period","year","month","split","startDate","endDate","setMonth","getMonth","gte","acceptedOffers","filter","o","acceptanceRate","length","eventsByType","forEach","totalEvents","offersGenerated","offersAccepted","conversionService"],"sources":["conversion.service.ts"],"sourcesContent":["import { prisma } from '../index';\nimport { ConversionEvent, ConversionOffer } from '../types';\nimport { logger } from '../utils/logger';\nimport Joi from 'joi';\n\nconst conversionEventSchema = Joi.object({\n  studentId: Joi.string().required(),\n  eventType: Joi.string().valid('module_completion', 'assessment_pass', 'course_completion', 'inactivity_alert').required(),\n  triggerValue: Joi.number().min(0).max(100).required(),\n});\n\nconst conversionOfferSchema = Joi.object({\n  studentId: Joi.string().required(),\n  offerType: Joi.string().valid('upgrade_discount', 'premium_trial', 'bundle_deal').required(),\n  discount: Joi.number().min(0).max(100).required(),\n  expirationDays: Joi.number().min(1).default(7),\n});\n\nexport class ConversionService {\n  /**\n   * Track a conversion event (module completion, assessment pass, course completion)\n   */\n  async trackConversionEvent(data: {\n    studentId: string;\n    eventType: 'module_completion' | 'assessment_pass' | 'course_completion' | 'inactivity_alert';\n    triggerValue: number;\n  }): Promise<ConversionEvent> {\n    try {\n      const { error, value } = conversionEventSchema.validate(data);\n      if (error) {\n        throw new Error(`Validation error: ${error.message}`);\n      }\n\n      // Check if student exists\n      const student = await prisma.user.findUnique({\n        where: { id: value.studentId },\n      });\n\n      if (!student) {\n        throw new Error('Student not found');\n      }\n\n      // Create conversion event\n      const event = await prisma.conversionEvent.create({\n        data: {\n          studentId: value.studentId,\n          eventType: value.eventType,\n          triggerValue: value.triggerValue,\n          timestamp: new Date(),\n        },\n      });\n\n      logger.info(`Conversion event tracked: ${event.id} (${value.eventType})`);\n\n      // Check if conversion offer should be generated\n      await this.generateConversionOfferIfEligible(value.studentId, value.eventType, value.triggerValue, event.id);\n\n      return event as ConversionEvent;\n    } catch (error) {\n      logger.error('Error tracking conversion event:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Generate conversion offer based on event type and trigger value\n   */\n  private async generateConversionOfferIfEligible(\n    studentId: string,\n    eventType: string,\n    triggerValue: number,\n    eventId: string\n  ): Promise<void> {\n    try {\n      // Get student's current tier\n      const student = await prisma.user.findUnique({\n        where: { id: studentId },\n      });\n\n      if (!student || student.tier !== 'free') {\n        // Only generate offers for free tier students\n        return;\n      }\n\n      let offerType: 'upgrade_discount' | 'premium_trial' | 'bundle_deal' | null = null;\n      let discount = 0;\n\n      // Determine offer based on event type and trigger value\n      if (eventType === 'module_completion' && triggerValue >= 40) {\n        // 40% course completion: offer 50% discount on Premium\n        offerType = 'upgrade_discount';\n        discount = 50;\n      } else if (eventType === 'assessment_pass') {\n        // Assessment pass: offer premium trial\n        offerType = 'premium_trial';\n        discount = 100; // 100% discount for trial period\n      } else if (eventType === 'course_completion') {\n        // Course completion: offer bundle deal\n        offerType = 'bundle_deal';\n        discount = 30; // 30% discount on bundle\n      }\n\n      if (offerType) {\n        await this.createConversionOffer({\n          studentId,\n          offerType,\n          discount,\n          expirationDays: 7,\n          eventId,\n        });\n      }\n    } catch (error) {\n      logger.error('Error generating conversion offer:', error);\n      // Don't throw - this is a non-critical operation\n    }\n  }\n\n  /**\n   * Create a conversion offer\n   */\n  async createConversionOffer(data: {\n    studentId: string;\n    offerType: 'upgrade_discount' | 'premium_trial' | 'bundle_deal';\n    discount: number;\n    expirationDays: number;\n    eventId?: string;\n  }): Promise<ConversionOffer> {\n    try {\n      const { error, value } = conversionOfferSchema.validate(data);\n      if (error) {\n        throw new Error(`Validation error: ${error.message}`);\n      }\n\n      // Check if student already has an active offer\n      const existingOffer = await prisma.conversionOffer.findFirst({\n        where: {\n          studentId: value.studentId,\n          accepted: false,\n          expiresAt: {\n            gt: new Date(),\n          },\n        },\n      });\n\n      if (existingOffer) {\n        logger.info(`Student ${value.studentId} already has an active offer`);\n        return existingOffer as ConversionOffer;\n      }\n\n      // Calculate expiration date\n      const expiresAt = new Date();\n      expiresAt.setDate(expiresAt.getDate() + value.expirationDays);\n\n      // Create offer\n      const offer = await prisma.conversionOffer.create({\n        data: {\n          eventId: data.eventId || '',\n          studentId: value.studentId,\n          offerType: value.offerType,\n          discount: value.discount,\n          expiresAt,\n          accepted: false,\n        },\n      });\n\n      logger.info(`Conversion offer created: ${offer.id} (${value.offerType})`);\n      return offer as ConversionOffer;\n    } catch (error) {\n      logger.error('Error creating conversion offer:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get conversion events for a student\n   */\n  async getStudentConversionEvents(studentId: string): Promise<ConversionEvent[]> {\n    try {\n      const events = await prisma.conversionEvent.findMany({\n        where: { studentId },\n        orderBy: { timestamp: 'desc' },\n      });\n\n      return events as ConversionEvent[];\n    } catch (error) {\n      logger.error('Error getting conversion events:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get active conversion offers for a student\n   */\n  async getStudentActiveOffers(studentId: string): Promise<ConversionOffer[]> {\n    try {\n      const offers = await prisma.conversionOffer.findMany({\n        where: {\n          studentId,\n          accepted: false,\n          expiresAt: {\n            gt: new Date(),\n          },\n        },\n        orderBy: { expiresAt: 'asc' },\n      });\n\n      return offers as ConversionOffer[];\n    } catch (error) {\n      logger.error('Error getting active offers:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Accept a conversion offer\n   */\n  async acceptConversionOffer(offerId: string): Promise<ConversionOffer> {\n    try {\n      const offer = await prisma.conversionOffer.findUnique({\n        where: { id: offerId },\n      });\n\n      if (!offer) {\n        throw new Error('Offer not found');\n      }\n\n      if (offer.accepted) {\n        throw new Error('Offer already accepted');\n      }\n\n      if (new Date() > offer.expiresAt) {\n        throw new Error('Offer has expired');\n      }\n\n      // Update offer as accepted\n      const updatedOffer = await prisma.conversionOffer.update({\n        where: { id: offerId },\n        data: {\n          accepted: true,\n          acceptedAt: new Date(),\n        },\n      });\n\n      logger.info(`Conversion offer accepted: ${offerId}`);\n\n      // Upgrade student to premium tier\n      await prisma.user.update({\n        where: { id: offer.studentId },\n        data: { tier: 'premium' },\n      });\n\n      logger.info(`Student ${offer.studentId} upgraded to premium tier`);\n\n      return updatedOffer as ConversionOffer;\n    } catch (error) {\n      logger.error('Error accepting conversion offer:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get conversion offer by ID\n   */\n  async getConversionOffer(offerId: string): Promise<ConversionOffer | null> {\n    try {\n      const offer = await prisma.conversionOffer.findUnique({\n        where: { id: offerId },\n      });\n\n      return offer as ConversionOffer | null;\n    } catch (error) {\n      logger.error('Error getting conversion offer:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Check and expire old conversion offers\n   */\n  async expireOldOffers(): Promise<number> {\n    try {\n      const result = await prisma.conversionOffer.updateMany({\n        where: {\n          accepted: false,\n          expiresAt: {\n            lt: new Date(),\n          },\n        },\n        data: {\n          accepted: false, // Mark as expired by not accepting\n        },\n      });\n\n      logger.info(`Expired ${result.count} old conversion offers`);\n      return result.count;\n    } catch (error) {\n      logger.error('Error expiring old offers:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get conversion metrics for analytics\n   */\n  async getConversionMetrics(period: string): Promise<{\n    totalEvents: number;\n    eventsByType: Record<string, number>;\n    offersGenerated: number;\n    offersAccepted: number;\n    acceptanceRate: number;\n  }> {\n    try {\n      // Parse period (e.g., \"2024-01\")\n      const [year, month] = period.split('-');\n      const startDate = new Date(`${year}-${month}-01`);\n      const endDate = new Date(startDate);\n      endDate.setMonth(endDate.getMonth() + 1);\n\n      // Get conversion events\n      const events = await prisma.conversionEvent.findMany({\n        where: {\n          timestamp: {\n            gte: startDate,\n            lt: endDate,\n          },\n        },\n      });\n\n      // Get conversion offers (filter by expiresAt since createdAt doesn't exist)\n      const offers = await prisma.conversionOffer.findMany({\n        where: {\n          expiresAt: {\n            gte: startDate,\n            lt: endDate,\n          },\n        },\n      });\n\n      const acceptedOffers = offers.filter((o: any) => o.accepted);\n      const acceptanceRate = offers.length > 0 ? (acceptedOffers.length / offers.length) * 100 : 0;\n\n      // Count events by type\n      const eventsByType: Record<string, number> = {};\n      events.forEach((event: any) => {\n        eventsByType[event.eventType] = (eventsByType[event.eventType] || 0) + 1;\n      });\n\n      return {\n        totalEvents: events.length,\n        eventsByType,\n        offersGenerated: offers.length,\n        offersAccepted: acceptedOffers.length,\n        acceptanceRate,\n      };\n    } catch (error) {\n      logger.error('Error getting conversion metrics:', error);\n      throw error;\n    }\n  }\n}\n\nexport const conversionService = new ConversionService();\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}