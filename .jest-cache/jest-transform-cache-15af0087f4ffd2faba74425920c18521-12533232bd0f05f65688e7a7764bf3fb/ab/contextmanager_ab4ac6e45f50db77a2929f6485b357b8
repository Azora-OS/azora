ef0866c968fa45cbaa446fcc7e2f0d15
/* istanbul ignore next */
function cov_1kwm06l260() {
  var path = "/workspaces/azora/services/ai-family-service/engines/context-manager.js";
  var hash = "04b2452d422dcb48b903c11653825baa380974e3";
  var global = new Function("return this")();
  var gcv = "__coverage__";
  var coverageData = {
    path: "/workspaces/azora/services/ai-family-service/engines/context-manager.js",
    statementMap: {
      "0": {
        start: {
          line: 1,
          column: 25
        },
        end: {
          line: 1,
          column: 50
        }
      },
      "1": {
        start: {
          line: 5,
          column: 4
        },
        end: {
          line: 5,
          column: 37
        }
      },
      "2": {
        start: {
          line: 6,
          column: 4
        },
        end: {
          line: 6,
          column: 25
        }
      },
      "3": {
        start: {
          line: 10,
          column: 25
        },
        end: {
          line: 18,
          column: 6
        }
      },
      "4": {
        start: {
          line: 20,
          column: 4
        },
        end: {
          line: 20,
          column: 40
        }
      },
      "5": {
        start: {
          line: 24,
          column: 4
        },
        end: {
          line: 33,
          column: 7
        }
      },
      "6": {
        start: {
          line: 37,
          column: 4
        },
        end: {
          line: 39,
          column: 7
        }
      },
      "7": {
        start: {
          line: 43,
          column: 0
        },
        end: {
          line: 43,
          column: 38
        }
      }
    },
    fnMap: {
      "0": {
        name: "(anonymous_0)",
        decl: {
          start: {
            line: 4,
            column: 2
          },
          end: {
            line: 4,
            column: 3
          }
        },
        loc: {
          start: {
            line: 4,
            column: 16
          },
          end: {
            line: 7,
            column: 3
          }
        },
        line: 4
      },
      "1": {
        name: "(anonymous_1)",
        decl: {
          start: {
            line: 9,
            column: 2
          },
          end: {
            line: 9,
            column: 3
          }
        },
        loc: {
          start: {
            line: 9,
            column: 49
          },
          end: {
            line: 21,
            column: 3
          }
        },
        line: 9
      },
      "2": {
        name: "(anonymous_2)",
        decl: {
          start: {
            line: 23,
            column: 2
          },
          end: {
            line: 23,
            column: 3
          }
        },
        loc: {
          start: {
            line: 23,
            column: 87
          },
          end: {
            line: 34,
            column: 3
          }
        },
        line: 23
      },
      "3": {
        name: "(anonymous_3)",
        decl: {
          start: {
            line: 36,
            column: 2
          },
          end: {
            line: 36,
            column: 3
          }
        },
        loc: {
          start: {
            line: 36,
            column: 59
          },
          end: {
            line: 40,
            column: 3
          }
        },
        line: 36
      }
    },
    branchMap: {
      "0": {
        loc: {
          start: {
            line: 20,
            column: 11
          },
          end: {
            line: 20,
            column: 39
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 20,
            column: 11
          },
          end: {
            line: 20,
            column: 33
          }
        }, {
          start: {
            line: 20,
            column: 37
          },
          end: {
            line: 20,
            column: 39
          }
        }],
        line: 20
      },
      "1": {
        loc: {
          start: {
            line: 23,
            column: 69
          },
          end: {
            line: 23,
            column: 85
          }
        },
        type: "default-arg",
        locations: [{
          start: {
            line: 23,
            column: 76
          },
          end: {
            line: 23,
            column: 85
          }
        }],
        line: 23
      },
      "2": {
        loc: {
          start: {
            line: 36,
            column: 45
          },
          end: {
            line: 36,
            column: 57
          }
        },
        type: "default-arg",
        locations: [{
          start: {
            line: 36,
            column: 55
          },
          end: {
            line: 36,
            column: 57
          }
        }],
        line: 36
      }
    },
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0
    },
    f: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0
    },
    b: {
      "0": [0, 0],
      "1": [0],
      "2": [0]
    },
    _coverageSchema: "1a1c01bbd47fc00a2c39e90264f33305004495a9",
    hash: "04b2452d422dcb48b903c11653825baa380974e3"
  };
  var coverage = global[gcv] || (global[gcv] = {});
  if (!coverage[path] || coverage[path].hash !== hash) {
    coverage[path] = coverageData;
  }
  var actualCoverage = coverage[path];
  {
    // @ts-ignore
    cov_1kwm06l260 = function () {
      return actualCoverage;
    };
  }
  return actualCoverage;
}
cov_1kwm06l260();
const {
  PrismaClient
} =
/* istanbul ignore next */
(cov_1kwm06l260().s[0]++, require('@prisma/client'));
class ContextManager {
  constructor() {
    /* istanbul ignore next */
    cov_1kwm06l260().f[0]++;
    cov_1kwm06l260().s[1]++;
    this.prisma = new PrismaClient();
    /* istanbul ignore next */
    cov_1kwm06l260().s[2]++;
    this.maxHistory = 10;
  }
  async getConversationHistory(userId, memberId) {
    /* istanbul ignore next */
    cov_1kwm06l260().f[1]++;
    const conversation =
    /* istanbul ignore next */
    (cov_1kwm06l260().s[3]++, await this.prisma.conversation.findFirst({
      where: {
        userId,
        memberId
      },
      include: {
        messages: {
          orderBy: {
            timestamp: 'asc'
          },
          take: this.maxHistory
        }
      }
    }));
    /* istanbul ignore next */
    cov_1kwm06l260().s[4]++;
    return /* istanbul ignore next */(cov_1kwm06l260().b[0][0]++, conversation?.messages) ||
    /* istanbul ignore next */
    (cov_1kwm06l260().b[0][1]++, []);
  }
  async saveMessage(conversationId, memberId, userId, role, content, mood =
  /* istanbul ignore next */
  (cov_1kwm06l260().b[1][0]++, 'neutral')) {
    /* istanbul ignore next */
    cov_1kwm06l260().f[2]++;
    cov_1kwm06l260().s[5]++;
    return await this.prisma.message.create({
      data: {
        conversationId,
        memberId,
        userId,
        role,
        content,
        mood
      }
    });
  }
  async createConversation(userId, memberId, context =
  /* istanbul ignore next */
  (cov_1kwm06l260().b[2][0]++, {})) {
    /* istanbul ignore next */
    cov_1kwm06l260().f[3]++;
    cov_1kwm06l260().s[6]++;
    return await this.prisma.conversation.create({
      data: {
        userId,
        memberId,
        context
      }
    });
  }
}
/* istanbul ignore next */
cov_1kwm06l260().s[7]++;
module.exports = new ContextManager();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb3ZfMWt3bTA2bDI2MCIsImFjdHVhbENvdmVyYWdlIiwiUHJpc21hQ2xpZW50IiwicyIsInJlcXVpcmUiLCJDb250ZXh0TWFuYWdlciIsImNvbnN0cnVjdG9yIiwiZiIsInByaXNtYSIsIm1heEhpc3RvcnkiLCJnZXRDb252ZXJzYXRpb25IaXN0b3J5IiwidXNlcklkIiwibWVtYmVySWQiLCJjb252ZXJzYXRpb24iLCJmaW5kRmlyc3QiLCJ3aGVyZSIsImluY2x1ZGUiLCJtZXNzYWdlcyIsIm9yZGVyQnkiLCJ0aW1lc3RhbXAiLCJ0YWtlIiwiYiIsInNhdmVNZXNzYWdlIiwiY29udmVyc2F0aW9uSWQiLCJyb2xlIiwiY29udGVudCIsIm1vb2QiLCJtZXNzYWdlIiwiY3JlYXRlIiwiZGF0YSIsImNyZWF0ZUNvbnZlcnNhdGlvbiIsImNvbnRleHQiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiY29udGV4dC1tYW5hZ2VyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgUHJpc21hQ2xpZW50IH0gPSByZXF1aXJlKCdAcHJpc21hL2NsaWVudCcpO1xuXG5jbGFzcyBDb250ZXh0TWFuYWdlciB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMucHJpc21hID0gbmV3IFByaXNtYUNsaWVudCgpO1xuICAgIHRoaXMubWF4SGlzdG9yeSA9IDEwO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q29udmVyc2F0aW9uSGlzdG9yeSh1c2VySWQsIG1lbWJlcklkKSB7XG4gICAgY29uc3QgY29udmVyc2F0aW9uID0gYXdhaXQgdGhpcy5wcmlzbWEuY29udmVyc2F0aW9uLmZpbmRGaXJzdCh7XG4gICAgICB3aGVyZTogeyB1c2VySWQsIG1lbWJlcklkIH0sXG4gICAgICBpbmNsdWRlOiB7XG4gICAgICAgIG1lc3NhZ2VzOiB7XG4gICAgICAgICAgb3JkZXJCeTogeyB0aW1lc3RhbXA6ICdhc2MnIH0sXG4gICAgICAgICAgdGFrZTogdGhpcy5tYXhIaXN0b3J5XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgICBcbiAgICByZXR1cm4gY29udmVyc2F0aW9uPy5tZXNzYWdlcyB8fCBbXTtcbiAgfVxuXG4gIGFzeW5jIHNhdmVNZXNzYWdlKGNvbnZlcnNhdGlvbklkLCBtZW1iZXJJZCwgdXNlcklkLCByb2xlLCBjb250ZW50LCBtb29kID0gJ25ldXRyYWwnKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJpc21hLm1lc3NhZ2UuY3JlYXRlKHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgY29udmVyc2F0aW9uSWQsXG4gICAgICAgIG1lbWJlcklkLFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIHJvbGUsXG4gICAgICAgIGNvbnRlbnQsXG4gICAgICAgIG1vb2RcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZUNvbnZlcnNhdGlvbih1c2VySWQsIG1lbWJlcklkLCBjb250ZXh0ID0ge30pIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcmlzbWEuY29udmVyc2F0aW9uLmNyZWF0ZSh7XG4gICAgICBkYXRhOiB7IHVzZXJJZCwgbWVtYmVySWQsIGNvbnRleHQgfVxuICAgIH0pO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gbmV3IENvbnRleHRNYW5hZ2VyKCk7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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