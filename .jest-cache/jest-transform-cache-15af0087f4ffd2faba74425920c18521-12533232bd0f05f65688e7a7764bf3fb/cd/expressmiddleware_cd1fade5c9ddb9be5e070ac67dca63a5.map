{"version":3,"names":["cov_m81tw4bel","actualCoverage","trace","context","SpanStatusCode","createTracingMiddleware","f","s","req","res","next","tracer","getTracer","span","startSpan","method","path","attributes","url","hostname","protocol","ip","get","traceId","spanContext","spanId","originalSend","send","data","setAttributes","statusCode","Buffer","byteLength","JSON","stringify","b","setStatus","code","ERROR","OK","end","call","with","setSpan","active","createDatabaseSpan","operation","query","createServiceSpan","serviceName","recordSpanError","error","targetSpan","getActiveSpan","recordException","addSpanAttributes","createCacheSpan","key","createBusinessSpan"],"sources":["express-middleware.ts"],"sourcesContent":["/**\n * Express middleware for OpenTelemetry tracing\n * Automatically traces all HTTP requests and responses\n */\n\nimport { Request, Response, NextFunction } from 'express';\nimport { trace, context, SpanStatusCode } from '@opentelemetry/api';\n\n/**\n * Middleware to trace HTTP requests\n */\nexport function createTracingMiddleware() {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const tracer = trace.getTracer('express-http');\n    \n    // Create span for this request\n    const span = tracer.startSpan(`${req.method} ${req.path}`, {\n      attributes: {\n        'http.method': req.method,\n        'http.url': req.url,\n        'http.target': req.path,\n        'http.host': req.hostname,\n        'http.scheme': req.protocol,\n        'http.client_ip': req.ip,\n        'http.user_agent': req.get('user-agent'),\n      },\n    });\n\n    // Store trace context in request for child spans\n    (req as any).span = span;\n    (req as any).traceId = span.spanContext().traceId;\n    (req as any).spanId = span.spanContext().spanId;\n\n    // Capture response\n    const originalSend = res.send;\n    res.send = function (data: any) {\n      span.setAttributes({\n        'http.status_code': res.statusCode,\n        'http.response_content_length': Buffer.byteLength(JSON.stringify(data)),\n      });\n\n      if (res.statusCode >= 400) {\n        span.setStatus({ code: SpanStatusCode.ERROR });\n      } else {\n        span.setStatus({ code: SpanStatusCode.OK });\n      }\n\n      span.end();\n      return originalSend.call(this, data);\n    };\n\n    // Run handler in span context\n    context.with(trace.setSpan(context.active(), span), () => {\n      next();\n    });\n  };\n}\n\n/**\n * Create a child span for database operations\n */\nexport function createDatabaseSpan(\n  operation: string,\n  query: string,\n  attributes?: Record<string, any>\n) {\n  const tracer = trace.getTracer('database');\n  const span = tracer.startSpan(`db.${operation}`, {\n    attributes: {\n      'db.operation': operation,\n      'db.statement': query,\n      ...attributes,\n    },\n  });\n\n  return span;\n}\n\n/**\n * Create a child span for external service calls\n */\nexport function createServiceSpan(\n  serviceName: string,\n  method: string,\n  path: string,\n  attributes?: Record<string, any>\n) {\n  const tracer = trace.getTracer('http-client');\n  const span = tracer.startSpan(`${serviceName}.${method}`, {\n    attributes: {\n      'http.method': method,\n      'http.url': path,\n      'peer.service': serviceName,\n      ...attributes,\n    },\n  });\n\n  return span;\n}\n\n/**\n * Record an error in the current span\n */\nexport function recordSpanError(error: Error, span?: any) {\n  const targetSpan = span || trace.getActiveSpan();\n  if (targetSpan) {\n    targetSpan.recordException(error);\n    targetSpan.setStatus({ code: SpanStatusCode.ERROR });\n  }\n}\n\n/**\n * Add custom attributes to current span\n */\nexport function addSpanAttributes(attributes: Record<string, any>) {\n  const span = trace.getActiveSpan();\n  if (span) {\n    span.setAttributes(attributes);\n  }\n}\n\n/**\n * Create a child span for cache operations\n */\nexport function createCacheSpan(\n  operation: string,\n  key: string,\n  attributes?: Record<string, any>\n) {\n  const tracer = trace.getTracer('cache');\n  const span = tracer.startSpan(`cache.${operation}`, {\n    attributes: {\n      'cache.operation': operation,\n      'cache.key': key,\n      ...attributes,\n    },\n  });\n\n  return span;\n}\n\n/**\n * Create a child span for business operations\n */\nexport function createBusinessSpan(\n  operation: string,\n  attributes?: Record<string, any>\n) {\n  const tracer = trace.getTracer('business');\n  const span = tracer.startSpan(`business.${operation}`, {\n    attributes,\n  });\n\n  return span;\n}\n\nexport default {\n  createTracingMiddleware,\n  createDatabaseSpan,\n  createServiceSpan,\n  recordSpanError,\n  addSpanAttributes,\n  createCacheSpan,\n  createBusinessSpan,\n};\n"],"mappings":"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","ignoreList":[]}