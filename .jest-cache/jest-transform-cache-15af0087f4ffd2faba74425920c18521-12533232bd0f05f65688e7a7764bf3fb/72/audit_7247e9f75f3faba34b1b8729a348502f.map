{"version":3,"names":["cov_2261tbehwl","actualCoverage","logAudit","action","entityType","f","s","req","res","next","originalJson","json","statusCode","body","call","setImmediate","prisma","b","console","warn","checkResult","constitutionalCheckResult","userEmail","user","email","entityId","params","id","enrollmentId","attemptId","cohortId","sessionId","constitutionalConcern","passed","integritySignals","browserTabSwitches","evidence","violations","requestPath","path","requestMethod","method","courseId","type","integrityLevel","auditLog","constitutionalAuditLog","create","data","extractEntityType","preChecksPassed","postChecksPassed","JSON","stringify","log","error","parts","split","length","entityPart","charAt","toUpperCase","slice","toLowerCase","getUserAuditLog","days","since","Date","setDate","getDate","logs","findMany","where","createdAt","gte","orderBy","take","getAuditLogsByAction","limit","getConstitutionalViolations","map","parse","generateFERPAReport","potentialViolations","OR","reportType","periodDays","generatedAt","toISOString","timestamp","concern","generateGDPRReport","dataProcessingEvents","in","eventsByType","reduce","acc","event","totalDataProcessingEvents","uniqueSubjects","Set","e","size","consentRecordsRequired","filter","generatePOPIAReport","consentRecords","consentRecord","unauthorizedAccess","consentRecordsCollected","consentGranted","c","consentGiven","consentDenied","unauthorizedAccessAttempts","dataMinimizationScore","calculateDataMinimizationScore","totalOps","count","minimalOps","Math","min"],"sources":["audit.ts"],"sourcesContent":["/**\n * Constitutional Audit Logging Middleware\n * \n * Logs all Sapiens actions to ConstitutionalAuditLog entity for compliance\n * and governance tracking. Captures:\n * - Pre-check and post-check results\n * - Entity state before/after\n * - User identity and authorization\n * - Constitutional violations or concerns\n * - Evidence for compliance audits (FERPA, GDPR, POPIA)\n */\n\nimport { Request, Response, NextFunction } from 'express';\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface AuditLogEntry {\n  action: string;\n  entityType: string;\n  entityId: string;\n  userEmail: string;\n  preChecksPassed?: boolean;\n  postChecksPassed?: boolean;\n  constitutionalConcern?: boolean;\n  evidence?: Record<string, any>;\n  requestPath: string;\n  requestMethod: string;\n  statusCode?: number;\n  timestamp: string;\n}\n\n// ============================================================================\n// Audit Logging Middleware\n// ============================================================================\n\n/**\n * Middleware to log constitutional audit entries\n * Usage: router.post('/enrollments', logAudit('ENROLLMENT_CREATE'), ...)\n */\nexport function logAudit(action: string, entityType?: string) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    // Capture response status code\n    const originalJson = res.json;\n    let statusCode = 200;\n\n    res.json = function (body) {\n      statusCode = res.statusCode;\n      return originalJson.call(this, body);\n    };\n\n    // Call next middleware\n    next();\n\n    // After route handler completes, log the audit entry\n    setImmediate(async () => {\n      try {\n        const prisma = (req as any).prisma;\n        if (!prisma) {\n          console.warn('[AuditLog] Prisma client not available, skipping audit log');\n          return;\n        }\n\n        const checkResult = (req as any).constitutionalCheckResult;\n        const userEmail = req.user?.email || 'unknown';\n\n        // Extract entity ID from request\n        let entityId = '';\n        if (req.params.id) {\n          entityId = req.params.id;\n        } else if (req.params.enrollmentId) {\n          entityId = req.params.enrollmentId;\n        } else if (req.params.attemptId) {\n          entityId = req.params.attemptId;\n        } else if (req.params.cohortId) {\n          entityId = req.params.cohortId;\n        } else if (req.params.sessionId) {\n          entityId = req.params.sessionId;\n        } else if (req.body?.id) {\n          entityId = req.body.id;\n        }\n\n        // Determine if there was a constitutional concern\n        const constitutionalConcern =\n          statusCode === 403 ||\n          (checkResult && !checkResult.passed) ||\n          req.body?.integritySignals?.browserTabSwitches > 3;\n\n        // Build evidence object\n        const evidence = {\n          ...checkResult?.evidence,\n          statusCode,\n          violations: checkResult?.violations,\n          requestPath: req.path,\n          requestMethod: req.method,\n          // Include relevant request body fields for compliance\n          ...(req.body?.courseId && { courseId: req.body.courseId }),\n          ...(req.body?.type && { type: req.body.type }),\n          ...(req.body?.integrityLevel && { integrityLevel: req.body.integrityLevel }),\n          ...(req.params.courseId && { courseId: req.params.courseId })\n        };\n\n        // Create audit log entry\n        const auditLog = await prisma.constitutionalAuditLog.create({\n          data: {\n            action,\n            entityType: entityType || extractEntityType(action),\n            entityId,\n            userEmail,\n            preChecksPassed: checkResult?.passed !== false,\n            postChecksPassed: statusCode < 400,\n            constitutionalConcern,\n            evidence: JSON.stringify(evidence)\n          }\n        });\n\n        // Log to console for debugging\n        if (constitutionalConcern) {\n          console.warn('[AuditLog] Constitutional concern detected:', {\n            action,\n            entityId,\n            userEmail,\n            violations: checkResult?.violations,\n            statusCode\n          });\n        } else {\n          console.log('[AuditLog]', action, 'by', userEmail, '- status:', statusCode);\n        }\n      } catch (error) {\n        console.error('[AuditLog] Failed to write audit entry:', error);\n        // Don't throw - audit logging failure shouldn't break the request\n      }\n    });\n  };\n}\n\n/**\n * Extract entity type from action string\n * e.g., \"ENROLLMENT_CREATE\" -> \"Enrollment\"\n */\nfunction extractEntityType(action: string): string {\n  const parts = action.split('_');\n  if (parts.length > 0) {\n    const entityPart = parts[0];\n    return entityPart.charAt(0).toUpperCase() + entityPart.slice(1).toLowerCase();\n  }\n  return 'Unknown';\n}\n\n/**\n * Query recent audit logs for a user (for compliance review)\n */\nexport async function getUserAuditLog(\n  userEmail: string,\n  days: number = 30,\n  prisma: any\n) {\n  const since = new Date();\n  since.setDate(since.getDate() - days);\n\n  const logs = await prisma.constitutionalAuditLog.findMany({\n    where: {\n      userEmail,\n      createdAt: { gte: since }\n    },\n    orderBy: { createdAt: 'desc' },\n    take: 100\n  });\n\n  return logs;\n}\n\n/**\n * Query audit logs by action type (for compliance review)\n */\nexport async function getAuditLogsByAction(\n  action: string,\n  days: number = 30,\n  limit: number = 100,\n  prisma: any\n) {\n  const since = new Date();\n  since.setDate(since.getDate() - days);\n\n  const logs = await prisma.constitutionalAuditLog.findMany({\n    where: {\n      action,\n      createdAt: { gte: since }\n    },\n    orderBy: { createdAt: 'desc' },\n    take: limit\n  });\n\n  return logs;\n}\n\n/**\n * Query constitutional violations (for governance dashboard)\n */\nexport async function getConstitutionalViolations(\n  days: number = 30,\n  prisma: any\n) {\n  const since = new Date();\n  since.setDate(since.getDate() - days);\n\n  const violations = await prisma.constitutionalAuditLog.findMany({\n    where: {\n      constitutionalConcern: true,\n      createdAt: { gte: since }\n    },\n    orderBy: { createdAt: 'desc' }\n  });\n\n  // Parse and annotate violations\n  return violations.map((log) => ({\n    ...log,\n    evidence: log.evidence ? JSON.parse(log.evidence) : {}\n  }));\n}\n\n/**\n * Compliance report: FERPA violations (unauthorized access to student records)\n */\nexport async function generateFERPAReport(\n  days: number = 90,\n  prisma: any\n) {\n  const since = new Date();\n  since.setDate(since.getDate() - days);\n\n  // Actions that could trigger FERPA concerns:\n  // - Enrollment without proper authorization\n  // - Assessment attempt by unauthorized user\n  // - Assessment score access by non-instructor\n  // - Credential verification without consent\n\n  const potentialViolations = await prisma.constitutionalAuditLog.findMany({\n    where: {\n      createdAt: { gte: since },\n      OR: [\n        { action: 'ENROLLMENT_CREATE', postChecksPassed: false },\n        { action: 'ASSESSMENT_SUBMIT', constitutionalConcern: true },\n        { action: 'CREDENTIAL_VERIFY', postChecksPassed: false }\n      ]\n    },\n    orderBy: { createdAt: 'desc' }\n  });\n\n  return {\n    reportType: 'FERPA_COMPLIANCE',\n    periodDays: days,\n    generatedAt: new Date().toISOString(),\n    potentialViolations: potentialViolations.length,\n    violations: potentialViolations.map((log) => ({\n      timestamp: log.createdAt,\n      action: log.action,\n      entityType: log.entityType,\n      userEmail: log.userEmail,\n      concern: log.constitutionalConcern,\n      evidence: log.evidence ? JSON.parse(log.evidence) : {}\n    }))\n  };\n}\n\n/**\n * Compliance report: GDPR compliance (data processing tracking)\n */\nexport async function generateGDPRReport(\n  days: number = 90,\n  prisma: any\n) {\n  const since = new Date();\n  since.setDate(since.getDate() - days);\n\n  // Actions involving personal data:\n  // - Enrollment (personal data processing)\n  // - Assessment (performance data)\n  // - Credential issuance (identity claims)\n  // - Tutoring sessions (interaction data)\n\n  const dataProcessingEvents = await prisma.constitutionalAuditLog.findMany({\n    where: {\n      createdAt: { gte: since },\n      action: {\n        in: [\n          'ENROLLMENT_CREATE',\n          'ASSESSMENT_SUBMIT',\n          'CREDENTIAL_ISSUE',\n          'TUTOR_SESSION_START',\n          'TUTOR_MESSAGE'\n        ]\n      }\n    }\n  });\n\n  // Count by action type\n  const eventsByType = dataProcessingEvents.reduce((acc, event) => {\n    acc[event.action] = (acc[event.action] || 0) + 1;\n    return acc;\n  }, {} as Record<string, number>);\n\n  return {\n    reportType: 'GDPR_COMPLIANCE',\n    periodDays: days,\n    generatedAt: new Date().toISOString(),\n    totalDataProcessingEvents: dataProcessingEvents.length,\n    eventsByType,\n    uniqueSubjects: new Set(dataProcessingEvents.map((e) => e.userEmail)).size,\n    consentRecordsRequired: dataProcessingEvents\n      .filter((e) => e.action === 'ENROLLMENT_CREATE')\n      .map((e) => e.userEmail)\n  };\n}\n\n/**\n * Compliance report: POPIA compliance (South African data protection)\n */\nexport async function generatePOPIAReport(\n  days: number = 90,\n  prisma: any\n) {\n  const since = new Date();\n  since.setDate(since.getDate() - days);\n\n  // POPIA applies to organizations processing personal information\n  // Track consent and data minimization\n\n  const consentRecords = await prisma.consentRecord.findMany({\n    where: {\n      timestamp: { gte: since }\n    }\n  });\n\n  const unauthorizedAccess = await prisma.constitutionalAuditLog.findMany({\n    where: {\n      createdAt: { gte: since },\n      constitutionalConcern: true\n    }\n  });\n\n  return {\n    reportType: 'POPIA_COMPLIANCE',\n    periodDays: days,\n    generatedAt: new Date().toISOString(),\n    consentRecordsCollected: consentRecords.length,\n    consentGranted: consentRecords.filter((c) => c.consentGiven).length,\n    consentDenied: consentRecords.filter((c) => !c.consentGiven).length,\n    unauthorizedAccessAttempts: unauthorizedAccess.length,\n    dataMinimizationScore: await calculateDataMinimizationScore(prisma, since)\n  };\n}\n\n/**\n * Calculate data minimization score (0-1 scale)\n * Higher score = more minimal data collection\n */\nasync function calculateDataMinimizationScore(prisma: any, since: Date): Promise<number> {\n  // Simplified metric: ratio of minimal operations to total operations\n  const totalOps = await prisma.constitutionalAuditLog.count({\n    where: { createdAt: { gte: since } }\n  });\n\n  const minimalOps = await prisma.constitutionalAuditLog.count({\n    where: {\n      createdAt: { gte: since },\n      // Operations that involve less data: reading vs writing\n      action: { in: ['ACHIEVEMENTS_FETCH', 'COURSES_GET', 'BALANCE_CHECK'] }\n    }\n  });\n\n  return totalOps === 0 ? 1.0 : Math.min(minimalOps / totalOps, 1.0);\n}\n\nexport default logAudit;\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}