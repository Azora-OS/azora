{"version":3,"names":["cov_satmvo6vu","actualCoverage","jwt","s","authMiddleware","req","res","next","f","token","headers","authorization","split","b","status","json","success","error","secret","process","env","JWT_SECRET","console","decoded","verify","userId","user","optionalAuthMiddleware","authenticateSession"],"sources":["middleware.ts"],"sourcesContent":["/*\nAZORA PROPRIETARY LICENSE\nCopyright Â© 2025 Azora ES (Pty) Ltd. All Rights Reserved.\n\nSHARED AUTH MIDDLEWARE\nExpress middleware for authentication and authorization\n*/\n\nimport { Request, Response, NextFunction } from 'express';\nimport jwt, { JwtPayload } from 'jsonwebtoken';\n\nexport interface AuthRequest extends Request {\n  userId?: string;\n  user?: JwtPayload;\n}\n\ninterface AzoraJwtPayload extends JwtPayload {\n  userId: string;\n}\n\n/**\n * Authentication middleware\n * Validates JWT token and attaches user information to request\n */\nexport const authMiddleware = (req: AuthRequest, res: Response, next: NextFunction) => {\n  try {\n    const token = req.headers.authorization?.split(' ')[1];\n    \n    if (!token) {\n      return res.status(401).json({ success: false, error: 'No token provided' });\n    }\n\n    const secret = process.env.JWT_SECRET;\n    if (!secret) {\n      console.error('JWT_SECRET is not configured');\n      return res.status(500).json({ success: false, error: 'Server configuration error' });\n    }\n\n    const decoded = jwt.verify(token, secret) as AzoraJwtPayload;\n    req.userId = decoded.userId;\n    req.user = decoded;\n    next();\n  } catch (error) {\n    return res.status(401).json({ success: false, error: 'Invalid token' });\n  }\n};\n\n/**\n * Optional authentication middleware\n * Attaches user information if token is present, but doesn't fail if missing\n */\nexport const optionalAuthMiddleware = (req: AuthRequest, res: Response, next: NextFunction) => {\n  try {\n    const token = req.headers.authorization?.split(' ')[1];\n    \n    if (token) {\n      const secret = process.env.JWT_SECRET;\n      if (secret) {\n        const decoded = jwt.verify(token, secret) as AzoraJwtPayload;\n        req.userId = decoded.userId;\n        req.user = decoded;\n      }\n    }\n    next();\n  } catch (error) {\n    // Continue without authentication\n    next();\n  }\n};\n\n/**\n * Authenticate session and return user context\n * Used by AI data access layer\n */\nexport async function authenticateSession(req: AuthRequest): Promise<string | null> {\n  try {\n    const token = req.headers.authorization?.split(' ')[1];\n    \n    if (!token) {\n      return null;\n    }\n\n    const secret = process.env.JWT_SECRET;\n    if (!secret) {\n      console.error('JWT_SECRET is not configured');\n      return null;\n    }\n\n    const decoded = jwt.verify(token, secret) as AzoraJwtPayload;\n    return decoded.userId || null;\n  } catch (error) {\n    return null;\n  }\n}\n\nexport default {\n  authMiddleware,\n  optionalAuthMiddleware,\n  authenticateSession,\n};\n"],"mappings":"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","ignoreList":[]}