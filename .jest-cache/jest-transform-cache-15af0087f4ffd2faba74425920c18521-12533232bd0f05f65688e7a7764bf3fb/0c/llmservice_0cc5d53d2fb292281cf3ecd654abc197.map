{"version":3,"names":["cov_2hsfy87xxq","actualCoverage","axios","SYSTEM_PROMPT","ACTION_EVALUATION_PROMPT","BIAS_DETECTION_PROMPT","MockAdapter","complete","prompt","systemPrompt","f","s","console","log","substring","Promise","resolve","setTimeout","includes","b","content","JSON","stringify","hasBias","confidence","explanation","isAllowed","score","critique","violations","OpenAIAdapter","constructor","apiKey","model","messages","role","response","post","temperature","response_format","type","headers","data","choices","message","usage","error","Error","LLMService","process","env","OPENAI_API_KEY","adapter","evaluateAction","action","replace","actorId","payload","context","parse","e","detectBias","text"],"sources":["llm-service.ts"],"sourcesContent":["import axios from 'axios';\nimport { SYSTEM_PROMPT, ACTION_EVALUATION_PROMPT, BIAS_DETECTION_PROMPT } from './prompts';\n\nexport interface LLMResponse {\n    content: string;\n    usage?: {\n        prompt_tokens: number;\n        completion_tokens: number;\n    };\n}\n\nexport interface LLMAdapter {\n    complete(prompt: string, systemPrompt?: string): Promise<LLMResponse>;\n}\n\nexport class MockAdapter implements LLMAdapter {\n    async complete(prompt: string, systemPrompt?: string): Promise<LLMResponse> {\n        console.log('[MockLLM] Processing prompt:', prompt.substring(0, 50) + '...');\n\n        // Simulate processing delay\n        await new Promise(resolve => setTimeout(resolve, 500));\n\n        // Simple heuristic simulation for dev\n        if (prompt.includes('bias')) {\n            return {\n                content: JSON.stringify({\n                    hasBias: false,\n                    confidence: 0.9,\n                    explanation: \"Mock analysis: No obvious bias detected in this text.\"\n                })\n            };\n        }\n\n        // Default \"Allowed\" response for actions\n        return {\n            content: JSON.stringify({\n                isAllowed: true,\n                score: 95,\n                critique: \"Action aligns with Ubuntu principles. No violations detected.\",\n                violations: []\n            })\n        };\n    }\n}\n\nexport class OpenAIAdapter implements LLMAdapter {\n    private apiKey: string;\n    private model: string;\n\n    constructor(apiKey: string, model: string = 'gpt-4') {\n        this.apiKey = apiKey;\n        this.model = model;\n    }\n\n    async complete(prompt: string, systemPrompt?: string): Promise<LLMResponse> {\n        try {\n            const messages = [\n                { role: 'system', content: systemPrompt || 'You are a helpful assistant.' },\n                { role: 'user', content: prompt }\n            ];\n\n            const response = await axios.post(\n                'https://api.openai.com/v1/chat/completions',\n                {\n                    model: this.model,\n                    messages: messages,\n                    temperature: 0.2, // Low temperature for consistent rule enforcement\n                    response_format: { type: \"json_object\" } // Force JSON output\n                },\n                {\n                    headers: {\n                        'Authorization': `Bearer ${this.apiKey}`,\n                        'Content-Type': 'application/json'\n                    }\n                }\n            );\n\n            return {\n                content: response.data.choices[0].message.content,\n                usage: response.data.usage\n            };\n        } catch (error: any) {\n            console.error('OpenAI API Error:', error.response?.data || error.message);\n            throw new Error('Failed to get completion from OpenAI');\n        }\n    }\n}\n\nexport class LLMService {\n    private adapter: LLMAdapter;\n\n    constructor() {\n        const apiKey = process.env.OPENAI_API_KEY;\n        if (apiKey && apiKey !== 'mock') {\n            console.log('üîå Initializing LLM Service with OpenAI Adapter');\n            this.adapter = new OpenAIAdapter(apiKey);\n        } else {\n            console.log('‚ö†Ô∏è Initializing LLM Service with Mock Adapter (Dev Mode)');\n            this.adapter = new MockAdapter();\n        }\n    }\n\n    async evaluateAction(action: any): Promise<any> {\n        const prompt = ACTION_EVALUATION_PROMPT\n            .replace('{{TYPE}}', action.type)\n            .replace('{{ACTOR}}', action.actorId)\n            .replace('{{PAYLOAD}}', JSON.stringify(action.payload))\n            .replace('{{CONTEXT}}', action.context || 'None');\n\n        const response = await this.adapter.complete(prompt, SYSTEM_PROMPT);\n        try {\n            return JSON.parse(response.content);\n        } catch (e) {\n            console.error('Failed to parse LLM JSON response:', response.content);\n            return { isAllowed: false, score: 0, critique: \"System Error: Invalid LLM Response\", violations: [\"Internal Error\"] };\n        }\n    }\n\n    async detectBias(text: string): Promise<any> {\n        const prompt = BIAS_DETECTION_PROMPT.replace('{{TEXT}}', text);\n        const response = await this.adapter.complete(prompt, SYSTEM_PROMPT);\n        try {\n            return JSON.parse(response.content);\n        } catch (e) {\n            return { hasBias: true, confidence: 0, explanation: \"System Error: Failed to parse analysis.\" };\n        }\n    }\n}\n"],"mappings":"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","ignoreList":[]}