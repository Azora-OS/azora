{"version":3,"names":["cov_28phey1our","actualCoverage","express","createProxyMiddleware","cors","helmet","rateLimit","RedisStore","Redis","authMiddleware","BlockchainService","ConstitutionalEngine","initializeSecrets","app","s","PORT","b","process","env","blockchain","engine","redis","host","REDIS_HOST","port","parseInt","REDIS_PORT","retryStrategy","f","limiter","store","client","prefix","windowMs","max","message","standardHeaders","legacyHeaders","use","json","req","res","next","console","log","method","path","get","status","service","address","params","reputation","getReputationScore","error","post","change","body","success","updateReputation","email","password","authService","require","result","login","token","accessToken","refreshToken","user","routes","Object","entries","forEach","target","changeOrigin","pathRewrite","onError","err","main","module","listen"],"sources":["gateway.ts"],"sourcesContent":["import express from 'express';\nimport { createProxyMiddleware } from 'http-proxy-middleware';\nimport cors from 'cors';\nimport helmet from 'helmet';\nimport rateLimit from 'express-rate-limit';\nimport RedisStore from 'rate-limit-redis';\nimport Redis from 'ioredis';\nimport { authMiddleware, optionalAuth } from './auth-middleware';\nimport { BlockchainService } from '../../azora-blockchain/src/blockchain-service';\nimport { ConstitutionalEngine } from '../../constitutional-ai/src/constitutional-engine';\nimport { initializeSecrets } from './secrets-init';\n\nconst app = express();\nconst PORT = process.env.PORT || 3000;\n\n// Initialize Services\nconst blockchain = new BlockchainService();\nconst engine = new ConstitutionalEngine();\n\n// Redis client for rate limiting\nconst redis = new Redis({\n    host: process.env.REDIS_HOST || 'localhost',\n    port: parseInt(process.env.REDIS_PORT || '6379'),\n    retryStrategy: () => null, // Don't retry if Redis is down (graceful degradation)\n});\n\n// Rate limiter configuration\nconst limiter = rateLimit({\n    store: new RedisStore({\n        // @ts-ignore - Type mismatch but works\n        client: redis,\n        prefix: 'rl:',\n    }),\n    windowMs: 15 * 60 * 1000, // 15 minutes\n    max: 100, // Limit each IP to 100 requests per windowMs\n    message: 'Too many requests from this IP, please try again later.',\n    standardHeaders: true,\n    legacyHeaders: false,\n});\n\n// Middleware\napp.use(cors());\napp.use(helmet());\napp.use(express.json());\napp.use(limiter);\n\n// Logging Middleware\napp.use((req, res, next) => {\n    console.log(`[Gateway] ${req.method} ${req.path}`);\n    next();\n});\n\n// Health Check (public)\napp.get('/health', (req, res) => {\n    res.status(200).json({ status: 'OK', service: 'API Gateway' });\n});\n\n// --- Reputation Routes ---\n\napp.get('/api/reputation/:address', async (req, res) => {\n    try {\n        const { address } = req.params;\n        const reputation = await blockchain.getReputationScore(address);\n        res.json(reputation);\n    } catch (error: any) {\n        res.status(500).json({ error: error.message });\n    }\n});\n\napp.post('/api/reputation/update', async (req, res) => {\n    try {\n        const { address, change } = req.body;\n        // In a real app, we'd verify the caller has admin rights or it's a system event\n        const success = await blockchain.updateReputation(address, change);\n        res.json({ success });\n    } catch (error: any) {\n        res.status(500).json({ error: error.message });\n    }\n});\n\n// Auth endpoint (public) - proxy to auth service\napp.post('/api/auth/login', async (req, res) => {\n    const { email, password } = req.body;\n\n    if (!email || !password) {\n        return res.status(400).json({ error: 'Email and password required' });\n    }\n\n    try {\n        // Call production auth service\n        const authService = require('../../azora-auth/src/auth-service');\n        const result = await authService.login({ email, password });\n\n        res.json({\n            token: result.accessToken,\n            refreshToken: result.refreshToken,\n            user: result.user\n        });\n    } catch (error: any) {\n        res.status(401).json({ error: error.message || 'Authentication failed' });\n    }\n});\n\n// Service Routes Configuration\nconst routes = {\n    '/api/blockchain': 'http://localhost:3001',\n    '/api/mint': 'http://localhost:3002',\n    '/api/constitutional': 'http://localhost:3003',\n};\n\n// Protected routes - require authentication\nObject.entries(routes).forEach(([path, target]) => {\n    app.use(path, authMiddleware, createProxyMiddleware({\n        target,\n        changeOrigin: true,\n        pathRewrite: {\n            [`^${path}`]: '',\n        },\n        onError: (err, req, res) => {\n            console.error(`[Gateway] Proxy error for ${path}:`, err.message);\n            res.status(503).json({ error: 'Service temporarily unavailable' });\n        },\n    }));\n});\n\n// Export app for testing\nexport { app };\n\n// Start Gateway only if run directly\nif (require.main === module) {\n    (async () => {\n        await initializeSecrets();\n        app.listen(PORT, () => {\n            console.log(`[Gateway] API Gateway running on port ${PORT}`);\n            console.log(`[Gateway] Rate limiting: 100 req/15min per IP`);\n            console.log(`[Gateway] JWT authentication: enabled`);\n        });\n    })();\n}\n"],"mappings":"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","ignoreList":[]}