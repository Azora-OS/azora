{"version":3,"names":["cov_2m2kl2juui","actualCoverage","DisputeService","createDispute","data","f","escrowId","projectId","sellerId","buyerId","initiatedBy","reason","s","length","b","Error","dispute","id","Date","now","Math","random","toString","substr","evidence","status","createdAt","notifyDisputeOpened","assignMediator","emitEvent","addEvidence","disputeId","userId","newEvidence","timestamp","mediatorId","resolveDispute","resolution","finalResolution","decidedAt","executeResolution","outcome","refundPercentage","getDispute","getUserDisputes","getDisputeStats","total","byStatus","byOutcome","averageResolutionTime","console","log","autoResolveSimpleDispute","event"],"sources":["disputeService.ts"],"sourcesContent":["/*\nAZORA PROPRIETARY LICENSE\n\nCopyright ¬© 2025 Azora ES (Pty) Ltd. All Rights Reserved.\n\nSee LICENSE file for details.\n*/\n\nexport interface Dispute {\n  id: string;\n  escrowId: string;\n  projectId: string;\n  sellerId: string;\n  buyerId: string;\n  initiatedBy: 'buyer' | 'seller';\n  reason: string;\n  evidence: DisputeEvidence[];\n  status: 'open' | 'under_review' | 'resolved' | 'closed';\n  resolution?: DisputeResolution;\n  mediatorId?: string;\n  createdAt: Date;\n  resolvedAt?: Date;\n}\n\nexport interface DisputeEvidence {\n  id: string;\n  disputeId: string;\n  submittedBy: string;\n  type: 'text' | 'image' | 'file' | 'message';\n  content: string;\n  fileUrl?: string;\n  timestamp: Date;\n}\n\nexport interface DisputeResolution {\n  outcome: 'buyer_wins' | 'seller_wins' | 'partial_refund' | 'rework';\n  refundAmount?: number;\n  refundPercentage?: number;\n  explanation: string;\n  decidedBy: string;\n  decidedAt: Date;\n}\n\n/**\n * ‚öñÔ∏è DISPUTE RESOLUTION SERVICE\n * \n * Handles conflicts between buyers and sellers.\n * Fair, transparent, and efficient dispute resolution.\n */\nexport class DisputeService {\n  \n  /**\n   * Create a new dispute\n   */\n  static async createDispute(data: {\n    escrowId: string;\n    projectId: string;\n    sellerId: string;\n    buyerId: string;\n    initiatedBy: 'buyer' | 'seller';\n    reason: string;\n  }): Promise<Dispute> {\n    const { escrowId, projectId, sellerId, buyerId, initiatedBy, reason } = data;\n\n    // Validate reason is substantial\n    if (reason.length < 20) {\n      throw new Error('Dispute reason must be at least 20 characters');\n    }\n\n    const dispute: Dispute = {\n      id: `dispute_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      escrowId,\n      projectId,\n      sellerId,\n      buyerId,\n      initiatedBy,\n      reason,\n      evidence: [],\n      status: 'open',\n      createdAt: new Date()\n    };\n\n    // TODO: Save to database\n    // await prisma.dispute.create({ data: dispute });\n\n    // Notify other party\n    await this.notifyDisputeOpened(dispute);\n\n    // Assign mediator if available\n    await this.assignMediator(dispute.id);\n\n    this.emitEvent('dispute:created', dispute);\n\n    return dispute;\n  }\n\n  /**\n   * Add evidence to dispute\n   */\n  static async addEvidence(\n    disputeId: string,\n    userId: string,\n    evidence: Omit<DisputeEvidence, 'id' | 'disputeId' | 'timestamp'>\n  ): Promise<DisputeEvidence> {\n    // TODO: Validate user is part of dispute\n    // const dispute = await prisma.dispute.findUnique({ where: { id: disputeId } });\n    // if (userId !== dispute.buyerId && userId !== dispute.sellerId) {\n    //   throw new Error('Only parties involved can submit evidence');\n    // }\n\n    const newEvidence: DisputeEvidence = {\n      ...evidence,\n      id: `evidence_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n      disputeId,\n      timestamp: new Date()\n    };\n\n    // TODO: Save to database\n    // await prisma.disputeEvidence.create({ data: newEvidence });\n\n    this.emitEvent('dispute:evidence_added', { disputeId, evidence: newEvidence });\n\n    return newEvidence;\n  }\n\n  /**\n   * Assign mediator to dispute\n   */\n  private static async assignMediator(disputeId: string): Promise<void> {\n    // TODO: Find available mediator\n    // Could be:\n    // 1. Human mediator (Azora staff)\n    // 2. AI mediator (for simple cases)\n    // 3. Community mediator (trusted users)\n\n    // For now, assign to AI mediator for simple cases\n    const mediatorId = 'ai_mediator_001';\n\n    // await prisma.dispute.update({\n    //   where: { id: disputeId },\n    //   data: {\n    //     mediatorId,\n    //     status: 'under_review'\n    //   }\n    // });\n\n    this.emitEvent('dispute:mediator_assigned', { disputeId, mediatorId });\n  }\n\n  /**\n   * Resolve dispute\n   */\n  static async resolveDispute(\n    disputeId: string,\n    resolution: Omit<DisputeResolution, 'decidedAt'>,\n    mediatorId: string\n  ): Promise<Dispute> {\n    // TODO: Validate mediator is assigned to this dispute\n    // const dispute = await prisma.dispute.findUnique({ where: { id: disputeId } });\n    // if (dispute.mediatorId !== mediatorId) {\n    //   throw new Error('Only assigned mediator can resolve dispute');\n    // }\n\n    const finalResolution: DisputeResolution = {\n      ...resolution,\n      decidedAt: new Date()\n    };\n\n    // Update dispute\n    // await prisma.dispute.update({\n    //   where: { id: disputeId },\n    //   data: {\n    //     status: 'resolved',\n    //     resolution: finalResolution,\n    //     resolvedAt: new Date()\n    //   }\n    // });\n\n    // Execute resolution (refund, release, etc.)\n    await this.executeResolution(disputeId, finalResolution);\n\n    this.emitEvent('dispute:resolved', { disputeId, resolution: finalResolution });\n\n    return { id: disputeId, resolution: finalResolution } as Dispute;\n  }\n\n  /**\n   * Execute resolution (process refunds/releases)\n   */\n  private static async executeResolution(\n    disputeId: string,\n    resolution: DisputeResolution\n  ): Promise<void> {\n    // TODO: Get dispute details\n    // const dispute = await prisma.dispute.findUnique({\n    //   where: { id: disputeId },\n    //   include: { escrow: true }\n    // });\n\n    switch (resolution.outcome) {\n      case 'buyer_wins':\n        // Full refund to buyer\n        // await EscrowService.refundEscrow(dispute.escrowId, resolution.explanation, 'mediator');\n        break;\n\n      case 'seller_wins':\n        // Full release to seller\n        // await EscrowService.releaseFunds(\n        //   dispute.escrowId,\n        //   { type: 'full', amount: dispute.escrow.amount, approvedBy: 'dispute_resolution' },\n        //   'mediator'\n        // );\n        break;\n\n      case 'partial_refund':\n        // Partial refund\n        if (resolution.refundPercentage) {\n          // const refundAmount = dispute.escrow.amount * (resolution.refundPercentage / 100);\n          // const releaseAmount = dispute.escrow.amount - refundAmount;\n\n          // Release to seller\n          // await EscrowService.releaseFunds(...);\n          // Refund to buyer\n          // await EscrowService.refundEscrow(...);\n        }\n        break;\n\n      case 'rework':\n        // Seller must rework, escrow stays funded\n        // Notify seller to rework\n        break;\n    }\n  }\n\n  /**\n   * Get dispute details\n   */\n  static async getDispute(disputeId: string): Promise<Dispute | null> {\n    // TODO: Fetch from database\n    // return await prisma.dispute.findUnique({\n    //   where: { id: disputeId },\n    //   include: { evidence: true }\n    // });\n    return null;\n  }\n\n  /**\n   * Get user's disputes\n   */\n  static async getUserDisputes(userId: string): Promise<Dispute[]> {\n    // TODO: Fetch from database\n    // return await prisma.dispute.findMany({\n    //   where: {\n    //     OR: [\n    //       { buyerId: userId },\n    //       { sellerId: userId }\n    //     ]\n    //   },\n    //   orderBy: { createdAt: 'desc' }\n    // });\n    return [];\n  }\n\n  /**\n   * Get dispute statistics\n   */\n  static async getDisputeStats(): Promise<{\n    total: number;\n    byStatus: Record<string, number>;\n    byOutcome: Record<string, number>;\n    averageResolutionTime: number;\n  }> {\n    // TODO: Aggregate from database\n    return {\n      total: 0,\n      byStatus: {},\n      byOutcome: {},\n      averageResolutionTime: 0\n    };\n  }\n\n  /**\n   * Notify parties that dispute was opened\n   */\n  private static async notifyDisputeOpened(dispute: Dispute): Promise<void> {\n    // TODO: Send notifications via notification service\n    console.log(`üìß Notifying parties about dispute ${dispute.id}`);\n  }\n\n  /**\n   * AI-powered dispute resolution for simple cases\n   */\n  static async autoResolveSimpleDispute(disputeId: string): Promise<boolean> {\n    // TODO: Implement AI logic\n    // Analyze evidence, previous cases, and suggest resolution\n    // For now, return false (manual resolution required)\n    return false;\n  }\n\n  private static emitEvent(event: string, data: any) {\n    console.log(`üîî Dispute Event: ${event}`, data);\n    // Emit to organism event bus\n    // OrganismEventBus.emit(event, data);\n  }\n}\n"],"mappings":"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","ignoreList":[]}