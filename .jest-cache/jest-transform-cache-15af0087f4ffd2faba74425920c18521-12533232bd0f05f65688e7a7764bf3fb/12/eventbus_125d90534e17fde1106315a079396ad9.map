{"version":3,"names":["cov_217t5gophg","actualCoverage","Redis","EventSchema","EventBus","constructor","redisUrl","b","f","s","publisher","subscriber","dlq","on","err","console","warn","message","publish","channel","payload","validation","safeParse","success","error","format","sendToDLQ","JSON","stringify","log","type","subscribe","callback","chn","parse","reason","dlqMessage","timestamp","Date","toISOString","lpush"],"sources":["event-bus.ts"],"sourcesContent":["import Redis from 'ioredis';\nimport { EventSchema } from './schemas/events';\n\nexport class EventBus {\n    private publisher: Redis;\n    private subscriber: Redis;\n    private dlq: Redis; // Dead Letter Queue\n\n    constructor(redisUrl: string = 'redis://localhost:6379') {\n        this.publisher = new Redis(redisUrl);\n        this.subscriber = new Redis(redisUrl);\n        this.dlq = new Redis(redisUrl);\n\n        // Handle connection errors (fallback to in-memory if Redis is missing for dev)\n        this.publisher.on('error', (err) => console.warn('[EventBus] Publisher Redis Error:', err.message));\n        this.subscriber.on('error', (err) => console.warn('[EventBus] Subscriber Redis Error:', err.message));\n    }\n\n    /**\n     * Publishes an event to a specific channel with schema validation.\n     * @param channel The event channel name.\n     * @param payload The data to send.\n     */\n    async publish(channel: string, payload: any): Promise<void> {\n        try {\n            // Validate payload against schema\n            const validation = EventSchema.safeParse(payload);\n\n            if (!validation.success) {\n                console.error(`[EventBus] Schema validation failed for ${channel}:`, validation.error.format());\n                await this.sendToDLQ(channel, payload, 'Schema Validation Failed');\n                return;\n            }\n\n            const message = JSON.stringify(payload);\n            await this.publisher.publish(channel, message);\n            console.log(`[EventBus] Published to ${channel}:`, payload.type);\n        } catch (error) {\n            console.error(`[EventBus] Failed to publish to ${channel}:`, error);\n        }\n    }\n\n    /**\n     * Subscribes to a channel and executes a callback on message receipt.\n     * @param channel The event channel name.\n     * @param callback Function to execute with the received payload.\n     */\n    async subscribe(channel: string, callback: (payload: any) => void): Promise<void> {\n        try {\n            await this.subscriber.subscribe(channel);\n            this.subscriber.on('message', (chn, message) => {\n                if (chn === channel) {\n                    try {\n                        const payload = JSON.parse(message);\n                        callback(payload);\n                    } catch (err) {\n                        console.error(`[EventBus] Failed to parse message on ${channel}:`, err);\n                    }\n                }\n            });\n            console.log(`[EventBus] Subscribed to ${channel}`);\n        } catch (error) {\n            console.error(`[EventBus] Failed to subscribe to ${channel}:`, error);\n        }\n    }\n\n    /**\n     * Sends invalid events to the Dead Letter Queue.\n     */\n    private async sendToDLQ(channel: string, payload: any, reason: string): Promise<void> {\n        const dlqMessage = {\n            channel,\n            payload,\n            reason,\n            timestamp: new Date().toISOString()\n        };\n        await this.dlq.lpush('azora:dlq', JSON.stringify(dlqMessage));\n        console.warn(`[EventBus] Event sent to DLQ:`, dlqMessage);\n    }\n}\n"],"mappings":"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","ignoreList":[]}