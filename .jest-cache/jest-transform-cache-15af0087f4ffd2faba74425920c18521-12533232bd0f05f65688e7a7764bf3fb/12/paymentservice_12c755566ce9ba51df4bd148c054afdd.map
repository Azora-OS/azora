{"version":3,"names":["cov_6q8qjleqc","actualCoverage","prisma","logger","Stripe","NotFoundError","BadRequestError","InternalServerError","BusinessLogicError","Joi","stripe","s","b","process","env","STRIPE_SECRET_KEY","apiVersion","processPaymentSchema","object","studentId","string","required","courseId","amount","number","positive","tier","valid","period","pattern","paymentMethodId","refundPaymentSchema","reason","optional","PaymentService","processPayment","data","f","error","value","validate","details","message","student","user","findUnique","where","id","course","paymentIntent","paymentIntents","create","Math","round","currency","payment_method","confirm","metadata","status","stripeStatus","payment","stripePaymentId","info","Number","getStudentPayments","payments","findMany","orderBy","createdAt","map","p","getPaymentById","paymentId","refundPayment","options","refundAmount","undefined","refund","refunds","payment_intent","originalAmount","toString","updatedPayment","update","stripeRefundId","getPaymentStats","stats","totalPayments","length","totalAmount","reduce","sum","completedPayments","filter","refundedPayments","pendingPayments","getCoursePaymentHistory","validatePaymentAmount","pricingTier","name","expectedAmount","monthlyPrice","variance","isValid","abs","paymentService"],"sources":["payment.service.ts"],"sourcesContent":["import { prisma } from '../index';\nimport { Payment } from '../types';\nimport { logger } from '../utils/logger';\nimport Stripe from 'stripe';\nimport { NotFoundError, BadRequestError, InternalServerError, BusinessLogicError } from '../utils/errors';\nimport Joi from 'joi';\n\n// Initialize Stripe\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY || '', {\n  apiVersion: '2023-08-16',\n});\n\n// Validation schemas\nconst processPaymentSchema = Joi.object({\n  studentId: Joi.string().required(),\n  courseId: Joi.string().required(),\n  amount: Joi.number().positive().required(),\n  tier: Joi.string().valid('free', 'premium', 'pro').required(),\n  period: Joi.string().pattern(/^\\d{4}-\\d{2}$/).required(), // YYYY-MM format\n  paymentMethodId: Joi.string().required(),\n});\n\nconst refundPaymentSchema = Joi.object({\n  reason: Joi.string().optional(),\n  amount: Joi.number().positive().optional(),\n});\n\nexport class PaymentService {\n  /**\n   * Process a payment using Stripe\n   * Requirements: 1.2, 5.1\n   */\n  async processPayment(data: {\n    studentId: string;\n    courseId: string;\n    amount: number;\n    tier: string;\n    period: string;\n    paymentMethodId: string;\n  }): Promise<Payment> {\n    try {\n      // Validate input\n      const { error, value } = processPaymentSchema.validate(data);\n      if (error) {\n        throw new BadRequestError(error.details[0].message, 'INVALID_PAYMENT_DATA');\n      }\n\n      // Verify student exists\n      const student = await prisma.user.findUnique({\n        where: { id: value.studentId },\n      });\n      if (!student) {\n        throw new NotFoundError('Student', value.studentId);\n      }\n\n      // Verify course exists\n      const course = await prisma.course.findUnique({\n        where: { id: value.courseId },\n      });\n      if (!course) {\n        throw new NotFoundError('Course', value.courseId);\n      }\n\n      // Create payment intent with Stripe\n      const paymentIntent = await stripe.paymentIntents.create({\n        amount: Math.round(value.amount * 100), // Convert to cents\n        currency: 'usd',\n        payment_method: value.paymentMethodId,\n        confirm: true,\n        metadata: {\n          studentId: value.studentId,\n          courseId: value.courseId,\n          tier: value.tier,\n          period: value.period,\n        },\n      });\n\n      // Check if payment was successful\n      if (paymentIntent.status !== 'succeeded') {\n        throw new BusinessLogicError(\n          `Payment failed with status: ${paymentIntent.status}`,\n          'PAYMENT_FAILED',\n          { stripeStatus: paymentIntent.status }\n        );\n      }\n\n      // Record payment in database\n      const payment = await prisma.payment.create({\n        data: {\n          studentId: value.studentId,\n          courseId: value.courseId,\n          amount: value.amount,\n          tier: value.tier,\n          period: value.period,\n          status: 'completed',\n          stripePaymentId: paymentIntent.id,\n        },\n      });\n\n      logger.info(`Payment processed successfully: ${payment.id}`, {\n        studentId: value.studentId,\n        courseId: value.courseId,\n        amount: value.amount,\n        stripePaymentId: paymentIntent.id,\n      });\n\n      return {\n        ...payment,\n        amount: Number(payment.amount),\n      } as Payment;\n    } catch (error) {\n      logger.error('Error processing payment:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get payments for a student\n   * Requirements: 1.2, 5.1\n   */\n  async getStudentPayments(studentId: string): Promise<Payment[]> {\n    try {\n      // Verify student exists\n      const student = await prisma.user.findUnique({\n        where: { id: studentId },\n      });\n      if (!student) {\n        throw new NotFoundError('Student', studentId);\n      }\n\n      const payments = await prisma.payment.findMany({\n        where: { studentId },\n        orderBy: { createdAt: 'desc' },\n      });\n\n      return payments.map((p) => ({\n        ...p,\n        amount: Number(p.amount),\n      })) as Payment[];\n    } catch (error) {\n      logger.error('Error fetching student payments:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get a specific payment by ID\n   * Requirements: 1.2, 5.1\n   */\n  async getPaymentById(paymentId: string): Promise<Payment> {\n    try {\n      const payment = await prisma.payment.findUnique({\n        where: { id: paymentId },\n      });\n\n      if (!payment) {\n        throw new NotFoundError('Payment', paymentId);\n      }\n\n      return {\n        ...payment,\n        amount: Number(payment.amount),\n      } as Payment;\n    } catch (error) {\n      logger.error('Error fetching payment:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Refund a payment\n   * Requirements: 1.2, 5.1\n   */\n  async refundPayment(\n    paymentId: string,\n    options?: {\n      reason?: string;\n      amount?: number;\n    }\n  ): Promise<Payment> {\n    try {\n      // Validate input\n      if (options) {\n        const { error } = refundPaymentSchema.validate(options);\n        if (error) {\n          throw new BadRequestError(error.details[0].message, 'INVALID_REFUND_DATA');\n        }\n      }\n\n      // Get payment\n      const payment = await prisma.payment.findUnique({\n        where: { id: paymentId },\n      });\n\n      if (!payment) {\n        throw new NotFoundError('Payment', paymentId);\n      }\n\n      // Check if payment can be refunded\n      if (payment.status === 'refunded') {\n        throw new BusinessLogicError(\n          'Payment has already been refunded',\n          'PAYMENT_ALREADY_REFUNDED'\n        );\n      }\n\n      if (payment.status === 'pending') {\n        throw new BusinessLogicError(\n          'Cannot refund a pending payment',\n          'CANNOT_REFUND_PENDING'\n        );\n      }\n\n      if (!payment.stripePaymentId) {\n        throw new InternalServerError('Payment has no Stripe ID for refund');\n      }\n\n      // Create refund with Stripe\n      const refundAmount = options?.amount ? Math.round(options.amount * 100) : undefined;\n      const refund = await stripe.refunds.create({\n        payment_intent: payment.stripePaymentId,\n        amount: refundAmount,\n        reason: (options?.reason as any) || 'requested_by_customer',\n        metadata: {\n          paymentId,\n          originalAmount: Number(payment.amount).toString(),\n        },\n      });\n\n      // Check if refund was successful\n      if (refund.status !== 'succeeded') {\n        throw new BusinessLogicError(\n          `Refund failed with status: ${refund.status}`,\n          'REFUND_FAILED',\n          { stripeStatus: refund.status }\n        );\n      }\n\n      // Update payment status\n      const updatedPayment = await prisma.payment.update({\n        where: { id: paymentId },\n        data: {\n          status: 'refunded',\n        },\n      });\n\n      logger.info(`Payment refunded successfully: ${paymentId}`, {\n        stripeRefundId: refund.id,\n        amount: refund.amount ? refund.amount / 100 : Number(payment.amount),\n      });\n\n      return {\n        ...updatedPayment,\n        amount: Number(updatedPayment.amount),\n      } as Payment;\n    } catch (error) {\n      logger.error('Error refunding payment:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get payment statistics for a period\n   * Requirements: 5.1\n   */\n  async getPaymentStats(period: string): Promise<{\n    totalPayments: number;\n    totalAmount: number;\n    completedPayments: number;\n    refundedPayments: number;\n    pendingPayments: number;\n  }> {\n    try {\n      const payments = await prisma.payment.findMany({\n        where: { period },\n      });\n\n      const stats = {\n        totalPayments: payments.length,\n        totalAmount: payments.reduce((sum, p) => sum + Number(p.amount), 0),\n        completedPayments: payments.filter((p) => p.status === 'completed').length,\n        refundedPayments: payments.filter((p) => p.status === 'refunded').length,\n        pendingPayments: payments.filter((p) => p.status === 'pending').length,\n      };\n\n      return stats;\n    } catch (error) {\n      logger.error('Error fetching payment statistics:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Get payment history for a course\n   * Requirements: 5.1\n   */\n  async getCoursePaymentHistory(courseId: string): Promise<Payment[]> {\n    try {\n      // Verify course exists\n      const course = await prisma.course.findUnique({\n        where: { id: courseId },\n      });\n      if (!course) {\n        throw new NotFoundError('Course', courseId);\n      }\n\n      const payments = await prisma.payment.findMany({\n        where: { courseId },\n        orderBy: { createdAt: 'desc' },\n      });\n\n      return payments.map((p) => ({\n        ...p,\n        amount: Number(p.amount),\n      })) as Payment[];\n    } catch (error) {\n      logger.error('Error fetching course payment history:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Validate payment amount against course pricing\n   * Requirements: 1.2, 5.1\n   */\n  async validatePaymentAmount(courseId: string, amount: number, tier: string): Promise<boolean> {\n    try {\n      // Get course\n      const course = await prisma.course.findUnique({\n        where: { id: courseId },\n      });\n      if (!course) {\n        throw new NotFoundError('Course', courseId);\n      }\n\n      // Get pricing tier\n      const pricingTier = await prisma.pricingTier.findUnique({\n        where: { name: tier },\n      });\n      if (!pricingTier) {\n        throw new NotFoundError('Pricing tier', tier);\n      }\n\n      // Validate amount is within acceptable range (allow 1% variance for currency conversion)\n      const expectedAmount = Number(pricingTier.monthlyPrice);\n      const variance = expectedAmount * 0.01;\n      const isValid = Math.abs(amount - expectedAmount) <= variance;\n\n      return isValid;\n    } catch (error) {\n      logger.error('Error validating payment amount:', error);\n      throw error;\n    }\n  }\n}\n\nexport const paymentService = new PaymentService();\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}