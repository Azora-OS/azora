{"version":3,"names":["cov_t8hm6mswa","actualCoverage","prisma","logger","EscrowSystem","createEscrow","projectId","clientId","freelancerId","amount","f","s","clientWallet","wallet","findUnique","where","userId","b","balance","Error","escrow","create","data","status","createdAt","Date","update","decrement","locked","increment","transaction","type","coinType","usdEquivalent","hash","id","senderId","notes","info","escrowId","error","releaseEscrow","releasedBy","isAdmin","releasedAt","freelancerWallet","recipientId","success","disputeEscrow","disputedBy","reason","disputedAt","disputeReason","dispute","user","select","role"],"sources":["escrow-system.ts"],"sourcesContent":["import { prisma } from '../../infrastructure/database/prisma-config'\nimport { logger } from '../../infrastructure/monitoring/logger'\n\nexport class EscrowSystem {\n  async createEscrow(projectId: string, clientId: string, freelancerId: string, amount: number) {\n    try {\n      // Check client has sufficient balance\n      const clientWallet = await prisma.wallet.findUnique({\n        where: { userId: clientId }\n      })\n\n      if (!clientWallet || clientWallet.balance < amount) {\n        throw new Error('Insufficient balance')\n      }\n\n      // Create escrow record\n      const escrow = await prisma.escrow.create({\n        data: {\n          projectId,\n          clientId,\n          freelancerId,\n          amount,\n          status: 'PENDING',\n          createdAt: new Date()\n        }\n      })\n\n      // Lock funds in client wallet\n      await prisma.wallet.update({\n        where: { userId: clientId },\n        data: {\n          balance: { decrement: amount },\n          locked: { increment: amount }\n        }\n      })\n\n      // Create transaction record\n      await prisma.transaction.create({\n        data: {\n          type: 'ESCROW_LOCK',\n          status: 'COMPLETED',\n          amount,\n          coinType: 'AZR',\n          usdEquivalent: amount,\n          hash: `escrow-${escrow.id}`,\n          senderId: clientWallet.id,\n          notes: `Escrow for project ${projectId}`\n        }\n      })\n\n      logger.info('Escrow created', { escrowId: escrow.id, projectId, amount })\n      return escrow\n    } catch (error) {\n      logger.error('Escrow creation failed', { error, projectId, clientId, freelancerId })\n      throw error\n    }\n  }\n\n  async releaseEscrow(escrowId: string, releasedBy: string) {\n    try {\n      const escrow = await prisma.escrow.findUnique({\n        where: { id: escrowId }\n      })\n\n      if (!escrow || escrow.status !== 'PENDING') {\n        throw new Error('Invalid escrow or already processed')\n      }\n\n      // Verify authorization (client or admin)\n      if (releasedBy !== escrow.clientId && !await this.isAdmin(releasedBy)) {\n        throw new Error('Unauthorized to release escrow')\n      }\n\n      // Update escrow status\n      await prisma.escrow.update({\n        where: { id: escrowId },\n        data: {\n          status: 'RELEASED',\n          releasedAt: new Date(),\n          releasedBy\n        }\n      })\n\n      // Transfer funds to freelancer\n      const freelancerWallet = await prisma.wallet.findUnique({\n        where: { userId: escrow.freelancerId }\n      })\n\n      if (freelancerWallet) {\n        await prisma.wallet.update({\n          where: { userId: escrow.freelancerId },\n          data: { balance: { increment: escrow.amount } }\n        })\n      }\n\n      // Unlock funds from client wallet\n      await prisma.wallet.update({\n        where: { userId: escrow.clientId },\n        data: { locked: { decrement: escrow.amount } }\n      })\n\n      // Create transaction record\n      await prisma.transaction.create({\n        data: {\n          type: 'ESCROW_RELEASE',\n          status: 'COMPLETED',\n          amount: escrow.amount,\n          coinType: 'AZR',\n          usdEquivalent: escrow.amount,\n          hash: `escrow-release-${escrowId}`,\n          recipientId: freelancerWallet?.id,\n          notes: `Escrow released for project ${escrow.projectId}`\n        }\n      })\n\n      logger.info('Escrow released', { escrowId, releasedBy })\n      return { success: true }\n    } catch (error) {\n      logger.error('Escrow release failed', { error, escrowId, releasedBy })\n      throw error\n    }\n  }\n\n  async disputeEscrow(escrowId: string, disputedBy: string, reason: string) {\n    try {\n      const escrow = await prisma.escrow.findUnique({\n        where: { id: escrowId }\n      })\n\n      if (!escrow || escrow.status !== 'PENDING') {\n        throw new Error('Invalid escrow or already processed')\n      }\n\n      // Update escrow status\n      await prisma.escrow.update({\n        where: { id: escrowId },\n        data: {\n          status: 'DISPUTED',\n          disputedAt: new Date(),\n          disputedBy,\n          disputeReason: reason\n        }\n      })\n\n      // Create dispute record for admin review\n      await prisma.dispute.create({\n        data: {\n          escrowId,\n          disputedBy,\n          reason,\n          status: 'OPEN',\n          createdAt: new Date()\n        }\n      })\n\n      logger.info('Escrow disputed', { escrowId, disputedBy, reason })\n      return { success: true }\n    } catch (error) {\n      logger.error('Escrow dispute failed', { error, escrowId, disputedBy })\n      throw error\n    }\n  }\n\n  private async isAdmin(userId: string): Promise<boolean> {\n    const user = await prisma.user.findUnique({\n      where: { id: userId },\n      select: { role: true }\n    })\n    return user?.role === 'ADMIN'\n  }\n}"],"mappings":"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","ignoreList":[]}