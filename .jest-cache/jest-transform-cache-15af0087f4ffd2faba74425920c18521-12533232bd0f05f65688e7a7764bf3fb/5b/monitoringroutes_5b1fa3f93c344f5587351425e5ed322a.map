{"version":3,"names":["cov_60luhw29a","actualCoverage","Router","prisma","HealthCheckService","getMetrics","structuredLogger","router","s","healthCheckService","get","req","res","f","health","getHealthStatus","statusCode","status","b","json","error","message","timestamp","Date","toISOString","isReady","checks","metrics","set","send","diagnostics","getDiagnostics","userCount","user","count","courseCount","course","enrollmentCount","enrollment","statistics","totalUsers","totalCourses","totalEnrollments"],"sources":["monitoring.routes.ts"],"sourcesContent":["/**\n * Monitoring Routes\n * Endpoints for health checks, metrics, and diagnostics\n */\n\nimport { Router, Request, Response } from 'express';\nimport { prisma } from '../index';\nimport { HealthCheckService } from '../services/health-check.service';\nimport { getMetrics } from '../utils/metrics';\nimport { structuredLogger } from '../utils/structured-logger';\n\nconst router = Router();\nconst healthCheckService = new HealthCheckService(prisma);\n\n/**\n * GET /health\n * Basic health check endpoint\n */\nrouter.get('/health', async (req: Request, res: Response) => {\n  try {\n    const health = await healthCheckService.getHealthStatus();\n    const statusCode = health.status === 'healthy' ? 200 : health.status === 'degraded' ? 503 : 503;\n\n    res.status(statusCode).json(health);\n  } catch (error) {\n    structuredLogger.error('Health check failed', error as Error);\n    res.status(503).json({\n      status: 'unhealthy',\n      error: (error as Error).message,\n      timestamp: new Date().toISOString(),\n    });\n  }\n});\n\n/**\n * GET /health/live\n * Kubernetes liveness probe endpoint\n */\nrouter.get('/health/live', (req: Request, res: Response) => {\n  res.status(200).json({\n    status: 'alive',\n    timestamp: new Date().toISOString(),\n  });\n});\n\n/**\n * GET /health/ready\n * Kubernetes readiness probe endpoint\n */\nrouter.get('/health/ready', async (req: Request, res: Response) => {\n  try {\n    const health = await healthCheckService.getHealthStatus();\n    const isReady = health.status !== 'unhealthy';\n\n    res.status(isReady ? 200 : 503).json({\n      status: isReady ? 'ready' : 'not_ready',\n      checks: health.checks,\n      timestamp: new Date().toISOString(),\n    });\n  } catch (error) {\n    res.status(503).json({\n      status: 'not_ready',\n      error: (error as Error).message,\n      timestamp: new Date().toISOString(),\n    });\n  }\n});\n\n/**\n * GET /metrics\n * Prometheus metrics endpoint\n */\nrouter.get('/metrics', async (req: Request, res: Response) => {\n  try {\n    const metrics = await getMetrics();\n    res.set('Content-Type', 'text/plain; version=0.0.4; charset=utf-8');\n    res.send(metrics);\n  } catch (error) {\n    structuredLogger.error('Failed to get metrics', error as Error);\n    res.status(500).json({\n      error: 'Failed to get metrics',\n      timestamp: new Date().toISOString(),\n    });\n  }\n});\n\n/**\n * GET /diagnostics\n * Detailed diagnostics endpoint\n */\nrouter.get('/diagnostics', async (req: Request, res: Response) => {\n  try {\n    const diagnostics = await healthCheckService.getDiagnostics();\n    res.json(diagnostics);\n  } catch (error) {\n    structuredLogger.error('Failed to get diagnostics', error as Error);\n    res.status(500).json({\n      error: 'Failed to get diagnostics',\n      timestamp: new Date().toISOString(),\n    });\n  }\n});\n\n/**\n * GET /status\n * Detailed status endpoint\n */\nrouter.get('/status', async (req: Request, res: Response) => {\n  try {\n    const health = await healthCheckService.getHealthStatus();\n\n    // Get additional statistics\n    const userCount = await prisma.user.count();\n    const courseCount = await prisma.course.count();\n    const enrollmentCount = await prisma.enrollment.count();\n\n    res.json({\n      health,\n      statistics: {\n        totalUsers: userCount,\n        totalCourses: courseCount,\n        totalEnrollments: enrollmentCount,\n      },\n      timestamp: new Date().toISOString(),\n    });\n  } catch (error) {\n    structuredLogger.error('Failed to get status', error as Error);\n    res.status(500).json({\n      error: 'Failed to get status',\n      timestamp: new Date().toISOString(),\n    });\n  }\n});\n\nexport default router;\n"],"mappings":"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","ignoreList":[]}