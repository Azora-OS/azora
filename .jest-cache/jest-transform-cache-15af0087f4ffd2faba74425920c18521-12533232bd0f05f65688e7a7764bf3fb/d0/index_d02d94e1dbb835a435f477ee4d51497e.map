{"version":3,"names":["cov_2de2hfcow0","actualCoverage","express","helmet","cors","morgan","dotenv","PrismaClient","structuredLogger","enrollmentRoutes","courseRoutes","assessmentRoutes","tutoringRoutes","contextRoutes","validationRoutes","pricingRoutes","conversionRoutes","paymentRoutes","revenueRoutes","learningOutcomesRoutes","cohortAnalyticsRoutes","monitoringRoutes","alertsRoutes","pricingService","alertsService","requestIdMiddleware","httpLoggingMiddleware","errorHandlingMiddleware","systemMetricsMiddleware","slowRequestMiddleware","requestBodyLoggingMiddleware","s","config","prisma","app","PORT","b","process","env","use","json","urlencoded","extended","_req","res","f","status","success","error","timestamp","Date","startServer","$queryRaw","info","initializeDefaultTiers","alertCheckInterval","parseInt","ALERT_CHECK_INTERVAL","startAlertChecking","undefined","intervalMs","listen","port","environment","NODE_ENV","exit","on","stopAlertChecking","$disconnect"],"sources":["index.ts"],"sourcesContent":["import express, { Express, Request, Response } from 'express';\nimport helmet from 'helmet';\nimport cors from 'cors';\nimport morgan from 'morgan';\nimport dotenv from 'dotenv';\nimport { PrismaClient } from '@prisma/client';\nimport { structuredLogger } from './utils/structured-logger';\nimport enrollmentRoutes from './routes/enrollment.routes';\nimport courseRoutes from './routes/course.routes';\nimport assessmentRoutes from './routes/assessment.routes';\nimport tutoringRoutes from './routes/tutoring.routes';\nimport contextRoutes from './routes/context.routes';\nimport validationRoutes from './routes/validation.routes';\nimport pricingRoutes from './routes/pricing.routes';\nimport conversionRoutes from './routes/conversion.routes';\nimport paymentRoutes from './routes/payment.routes';\nimport revenueRoutes from './routes/revenue.routes';\nimport learningOutcomesRoutes from './routes/learning-outcomes.routes';\nimport cohortAnalyticsRoutes from './routes/cohort-analytics.routes';\nimport monitoringRoutes from './routes/monitoring.routes';\nimport alertsRoutes from './routes/alerts.routes';\nimport { pricingService } from './services/pricing.service';\nimport { alertsService } from './services/alerts.service';\nimport {\n  requestIdMiddleware,\n  httpLoggingMiddleware,\n  errorHandlingMiddleware,\n  systemMetricsMiddleware,\n  slowRequestMiddleware,\n  requestBodyLoggingMiddleware,\n} from './middleware/monitoring.middleware';\n\n// Load environment variables\ndotenv.config();\n\n// Initialize Prisma\nexport const prisma = new PrismaClient();\n\n// Initialize Express\nconst app: Express = express();\nconst PORT = process.env.PORT || 3020;\n\n// Middleware\napp.use(helmet());\napp.use(cors());\napp.use(morgan('combined'));\napp.use(express.json());\napp.use(express.urlencoded({ extended: true }));\n\n// Monitoring middleware\napp.use(requestIdMiddleware);\napp.use(systemMetricsMiddleware);\napp.use(httpLoggingMiddleware);\napp.use(slowRequestMiddleware(1000)); // Log requests slower than 1 second\napp.use(requestBodyLoggingMiddleware);\n\n// Monitoring Routes (before API routes)\napp.use('/monitoring', monitoringRoutes);\napp.use('/alerts', alertsRoutes);\n\n// API Routes\napp.use('/api/v1/enrollments', enrollmentRoutes);\napp.use('/api/v1/courses', courseRoutes);\napp.use('/api/v1/assessments', assessmentRoutes);\napp.use('/api/v1/tutoring', tutoringRoutes);\napp.use('/api/v1/context', contextRoutes);\napp.use('/api/v1/validation', validationRoutes);\napp.use('/api/v1/pricing', pricingRoutes);\napp.use('/api/v1/conversions', conversionRoutes);\napp.use('/api/v1/payments', paymentRoutes);\napp.use('/api/v1/revenue', revenueRoutes);\napp.use('/api/v1/analytics', learningOutcomesRoutes);\napp.use('/api/v1/analytics', cohortAnalyticsRoutes);\n\n// Error handling middleware\napp.use(errorHandlingMiddleware);\n\n// 404 handler\napp.use((_req: Request, res: Response) => {\n  res.status(404).json({\n    success: false,\n    error: 'Not found',\n    timestamp: new Date()\n  });\n});\n\n// Start server\nconst startServer = async () => {\n  try {\n    // Test database connection\n    await prisma.$queryRaw`SELECT 1`;\n    structuredLogger.info('Database connection successful');\n\n    // Initialize default pricing tiers\n    await pricingService.initializeDefaultTiers();\n    structuredLogger.info('Pricing tiers initialized');\n\n    // Start alert checking\n    const alertCheckInterval = parseInt(process.env.ALERT_CHECK_INTERVAL || '60000');\n    alertsService.startAlertChecking(alertCheckInterval);\n    structuredLogger.info('Alert checking started', undefined, {\n      intervalMs: alertCheckInterval,\n    });\n\n    app.listen(PORT, () => {\n      structuredLogger.info(`Education Revenue Engine running on port ${PORT}`, undefined, {\n        port: PORT,\n        environment: process.env.NODE_ENV || 'development',\n      });\n    });\n  } catch (error) {\n    structuredLogger.error('Failed to start server:', error as Error);\n    process.exit(1);\n  }\n};\n\n// Graceful shutdown\nprocess.on('SIGINT', async () => {\n  structuredLogger.info('Shutting down gracefully...');\n  alertsService.stopAlertChecking();\n  await prisma.$disconnect();\n  process.exit(0);\n});\n\n// Only start server if not in test environment\nif (process.env.NODE_ENV !== 'test') {\n  startServer();\n}\n\nexport default app;\n"],"mappings":"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","ignoreList":[]}