97cf6b8e0bbfff80e06ab4267eb71739
/* istanbul ignore next */
function cov_2keta19bh0() {
  var path = "/workspaces/azora/services/azora-auth/src/middleware/audit.js";
  var hash = "56df8c0a9b2bbc79d8c81f1fe2dbc75145a7dbb1";
  var global = new Function("return this")();
  var gcv = "__coverage__";
  var coverageData = {
    path: "/workspaces/azora/services/azora-auth/src/middleware/audit.js",
    statementMap: {
      "0": {
        start: {
          line: 1,
          column: 11
        },
        end: {
          line: 1,
          column: 33
        }
      },
      "1": {
        start: {
          line: 2,
          column: 13
        },
        end: {
          line: 2,
          column: 28
        }
      },
      "2": {
        start: {
          line: 4,
          column: 23
        },
        end: {
          line: 4,
          column: 71
        }
      },
      "3": {
        start: {
          line: 7,
          column: 16
        },
        end: {
          line: 10,
          column: 3
        }
      },
      "4": {
        start: {
          line: 12,
          column: 2
        },
        end: {
          line: 16,
          column: 3
        }
      },
      "5": {
        start: {
          line: 13,
          column: 4
        },
        end: {
          line: 13,
          column: 70
        }
      },
      "6": {
        start: {
          line: 15,
          column: 4
        },
        end: {
          line: 15,
          column: 44
        }
      },
      "7": {
        start: {
          line: 20,
          column: 23
        },
        end: {
          line: 20,
          column: 31
        }
      },
      "8": {
        start: {
          line: 22,
          column: 2
        },
        end: {
          line: 34,
          column: 4
        }
      },
      "9": {
        start: {
          line: 23,
          column: 4
        },
        end: {
          line: 31,
          column: 7
        }
      },
      "10": {
        start: {
          line: 33,
          column: 4
        },
        end: {
          line: 33,
          column: 34
        }
      },
      "11": {
        start: {
          line: 36,
          column: 2
        },
        end: {
          line: 36,
          column: 9
        }
      },
      "12": {
        start: {
          line: 40,
          column: 2
        },
        end: {
          line: 45,
          column: 5
        }
      },
      "13": {
        start: {
          line: 49,
          column: 2
        },
        end: {
          line: 54,
          column: 5
        }
      },
      "14": {
        start: {
          line: 58,
          column: 2
        },
        end: {
          line: 64,
          column: 5
        }
      },
      "15": {
        start: {
          line: 67,
          column: 0
        },
        end: {
          line: 72,
          column: 2
        }
      }
    },
    fnMap: {
      "0": {
        name: "logAudit",
        decl: {
          start: {
            line: 6,
            column: 15
          },
          end: {
            line: 6,
            column: 23
          }
        },
        loc: {
          start: {
            line: 6,
            column: 31
          },
          end: {
            line: 17,
            column: 1
          }
        },
        line: 6
      },
      "1": {
        name: "auditMiddleware",
        decl: {
          start: {
            line: 19,
            column: 9
          },
          end: {
            line: 19,
            column: 24
          }
        },
        loc: {
          start: {
            line: 19,
            column: 41
          },
          end: {
            line: 37,
            column: 1
          }
        },
        line: 19
      },
      "2": {
        name: "(anonymous_2)",
        decl: {
          start: {
            line: 22,
            column: 13
          },
          end: {
            line: 22,
            column: 14
          }
        },
        loc: {
          start: {
            line: 22,
            column: 28
          },
          end: {
            line: 34,
            column: 3
          }
        },
        line: 22
      },
      "3": {
        name: "logAuthAttempt",
        decl: {
          start: {
            line: 39,
            column: 15
          },
          end: {
            line: 39,
            column: 29
          }
        },
        loc: {
          start: {
            line: 39,
            column: 50
          },
          end: {
            line: 46,
            column: 1
          }
        },
        line: 39
      },
      "4": {
        name: "logDataAccess",
        decl: {
          start: {
            line: 48,
            column: 15
          },
          end: {
            line: 48,
            column: 28
          }
        },
        loc: {
          start: {
            line: 48,
            column: 55
          },
          end: {
            line: 55,
            column: 1
          }
        },
        line: 48
      },
      "5": {
        name: "logDataModification",
        decl: {
          start: {
            line: 57,
            column: 15
          },
          end: {
            line: 57,
            column: 34
          }
        },
        loc: {
          start: {
            line: 57,
            column: 70
          },
          end: {
            line: 65,
            column: 1
          }
        },
        line: 57
      }
    },
    branchMap: {
      "0": {
        loc: {
          start: {
            line: 4,
            column: 23
          },
          end: {
            line: 4,
            column: 71
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 4,
            column: 23
          },
          end: {
            line: 4,
            column: 49
          }
        }, {
          start: {
            line: 4,
            column: 53
          },
          end: {
            line: 4,
            column: 71
          }
        }],
        line: 4
      }
    },
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0,
      "8": 0,
      "9": 0,
      "10": 0,
      "11": 0,
      "12": 0,
      "13": 0,
      "14": 0,
      "15": 0
    },
    f: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0
    },
    b: {
      "0": [0, 0]
    },
    _coverageSchema: "1a1c01bbd47fc00a2c39e90264f33305004495a9",
    hash: "56df8c0a9b2bbc79d8c81f1fe2dbc75145a7dbb1"
  };
  var coverage = global[gcv] || (global[gcv] = {});
  if (!coverage[path] || coverage[path].hash !== hash) {
    coverage[path] = coverageData;
  }
  var actualCoverage = coverage[path];
  {
    // @ts-ignore
    cov_2keta19bh0 = function () {
      return actualCoverage;
    };
  }
  return actualCoverage;
}
cov_2keta19bh0();
const fs =
/* istanbul ignore next */
(cov_2keta19bh0().s[0]++, require('fs').promises);
const path =
/* istanbul ignore next */
(cov_2keta19bh0().s[1]++, require('path'));
const AUDIT_LOG_PATH =
/* istanbul ignore next */
(cov_2keta19bh0().s[2]++,
/* istanbul ignore next */
(cov_2keta19bh0().b[0][0]++, process.env.AUDIT_LOG_PATH) ||
/* istanbul ignore next */
(cov_2keta19bh0().b[0][1]++, './logs/audit.log'));
async function logAudit(event) {
  /* istanbul ignore next */
  cov_2keta19bh0().f[0]++;
  const entry =
  /* istanbul ignore next */
  (cov_2keta19bh0().s[3]++, {
    timestamp: new Date().toISOString(),
    ...event
  });
  /* istanbul ignore next */
  cov_2keta19bh0().s[4]++;
  try {
    /* istanbul ignore next */
    cov_2keta19bh0().s[5]++;
    await fs.appendFile(AUDIT_LOG_PATH, JSON.stringify(entry) + '\n');
  } catch (err) {
    /* istanbul ignore next */
    cov_2keta19bh0().s[6]++;
    console.error('Audit log failed:', err);
  }
}
function auditMiddleware(req, res, next) {
  /* istanbul ignore next */
  cov_2keta19bh0().f[1]++;
  const originalSend =
  /* istanbul ignore next */
  (cov_2keta19bh0().s[7]++, res.send);
  /* istanbul ignore next */
  cov_2keta19bh0().s[8]++;
  res.send = function (data) {
    /* istanbul ignore next */
    cov_2keta19bh0().f[2]++;
    cov_2keta19bh0().s[9]++;
    logAudit({
      type: 'api_request',
      method: req.method,
      path: req.path,
      userId: req.user?.userId,
      ip: req.ip,
      statusCode: res.statusCode,
      userAgent: req.get('user-agent')
    });
    /* istanbul ignore next */
    cov_2keta19bh0().s[10]++;
    originalSend.call(this, data);
  };
  /* istanbul ignore next */
  cov_2keta19bh0().s[11]++;
  next();
}
async function logAuthAttempt(email, success, ip) {
  /* istanbul ignore next */
  cov_2keta19bh0().f[3]++;
  cov_2keta19bh0().s[12]++;
  await logAudit({
    type: 'auth_attempt',
    email,
    success,
    ip
  });
}
async function logDataAccess(userId, resource, action) {
  /* istanbul ignore next */
  cov_2keta19bh0().f[4]++;
  cov_2keta19bh0().s[13]++;
  await logAudit({
    type: 'data_access',
    userId,
    resource,
    action
  });
}
async function logDataModification(userId, resource, action, changes) {
  /* istanbul ignore next */
  cov_2keta19bh0().f[5]++;
  cov_2keta19bh0().s[14]++;
  await logAudit({
    type: 'data_modification',
    userId,
    resource,
    action,
    changes
  });
}
/* istanbul ignore next */
cov_2keta19bh0().s[15]++;
module.exports = {
  auditMiddleware,
  logAuthAttempt,
  logDataAccess,
  logDataModification
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb3ZfMmtldGExOWJoMCIsImFjdHVhbENvdmVyYWdlIiwiZnMiLCJzIiwicmVxdWlyZSIsInByb21pc2VzIiwicGF0aCIsIkFVRElUX0xPR19QQVRIIiwiYiIsInByb2Nlc3MiLCJlbnYiLCJsb2dBdWRpdCIsImV2ZW50IiwiZiIsImVudHJ5IiwidGltZXN0YW1wIiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwiYXBwZW5kRmlsZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJlcnIiLCJjb25zb2xlIiwiZXJyb3IiLCJhdWRpdE1pZGRsZXdhcmUiLCJyZXEiLCJyZXMiLCJuZXh0Iiwib3JpZ2luYWxTZW5kIiwic2VuZCIsImRhdGEiLCJ0eXBlIiwibWV0aG9kIiwidXNlcklkIiwidXNlciIsImlwIiwic3RhdHVzQ29kZSIsInVzZXJBZ2VudCIsImdldCIsImNhbGwiLCJsb2dBdXRoQXR0ZW1wdCIsImVtYWlsIiwic3VjY2VzcyIsImxvZ0RhdGFBY2Nlc3MiLCJyZXNvdXJjZSIsImFjdGlvbiIsImxvZ0RhdGFNb2RpZmljYXRpb24iLCJjaGFuZ2VzIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbImF1ZGl0LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKS5wcm9taXNlcztcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cbmNvbnN0IEFVRElUX0xPR19QQVRIID0gcHJvY2Vzcy5lbnYuQVVESVRfTE9HX1BBVEggfHwgJy4vbG9ncy9hdWRpdC5sb2cnO1xuXG5hc3luYyBmdW5jdGlvbiBsb2dBdWRpdChldmVudCkge1xuICBjb25zdCBlbnRyeSA9IHtcbiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAuLi5ldmVudFxuICB9O1xuICBcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy5hcHBlbmRGaWxlKEFVRElUX0xPR19QQVRILCBKU09OLnN0cmluZ2lmeShlbnRyeSkgKyAnXFxuJyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0F1ZGl0IGxvZyBmYWlsZWQ6JywgZXJyKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhdWRpdE1pZGRsZXdhcmUocmVxLCByZXMsIG5leHQpIHtcbiAgY29uc3Qgb3JpZ2luYWxTZW5kID0gcmVzLnNlbmQ7XG4gIFxuICByZXMuc2VuZCA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICBsb2dBdWRpdCh7XG4gICAgICB0eXBlOiAnYXBpX3JlcXVlc3QnLFxuICAgICAgbWV0aG9kOiByZXEubWV0aG9kLFxuICAgICAgcGF0aDogcmVxLnBhdGgsXG4gICAgICB1c2VySWQ6IHJlcS51c2VyPy51c2VySWQsXG4gICAgICBpcDogcmVxLmlwLFxuICAgICAgc3RhdHVzQ29kZTogcmVzLnN0YXR1c0NvZGUsXG4gICAgICB1c2VyQWdlbnQ6IHJlcS5nZXQoJ3VzZXItYWdlbnQnKVxuICAgIH0pO1xuICAgIFxuICAgIG9yaWdpbmFsU2VuZC5jYWxsKHRoaXMsIGRhdGEpO1xuICB9O1xuICBcbiAgbmV4dCgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBsb2dBdXRoQXR0ZW1wdChlbWFpbCwgc3VjY2VzcywgaXApIHtcbiAgYXdhaXQgbG9nQXVkaXQoe1xuICAgIHR5cGU6ICdhdXRoX2F0dGVtcHQnLFxuICAgIGVtYWlsLFxuICAgIHN1Y2Nlc3MsXG4gICAgaXBcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvZ0RhdGFBY2Nlc3ModXNlcklkLCByZXNvdXJjZSwgYWN0aW9uKSB7XG4gIGF3YWl0IGxvZ0F1ZGl0KHtcbiAgICB0eXBlOiAnZGF0YV9hY2Nlc3MnLFxuICAgIHVzZXJJZCxcbiAgICByZXNvdXJjZSxcbiAgICBhY3Rpb25cbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGxvZ0RhdGFNb2RpZmljYXRpb24odXNlcklkLCByZXNvdXJjZSwgYWN0aW9uLCBjaGFuZ2VzKSB7XG4gIGF3YWl0IGxvZ0F1ZGl0KHtcbiAgICB0eXBlOiAnZGF0YV9tb2RpZmljYXRpb24nLFxuICAgIHVzZXJJZCxcbiAgICByZXNvdXJjZSxcbiAgICBhY3Rpb24sXG4gICAgY2hhbmdlc1xuICB9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGF1ZGl0TWlkZGxld2FyZSxcbiAgbG9nQXV0aEF0dGVtcHQsXG4gIGxvZ0RhdGFBY2Nlc3MsXG4gIGxvZ0RhdGFNb2RpZmljYXRpb25cbn07XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBZVk7SUFBQUEsY0FBQSxZQUFBQSxDQUFBO01BQUEsT0FBQUMsY0FBQTtJQUFBO0VBQUE7RUFBQSxPQUFBQSxjQUFBO0FBQUE7QUFBQUQsY0FBQTtBQWZaLE1BQU1FLEVBQUU7QUFBQTtBQUFBLENBQUFGLGNBQUEsR0FBQUcsQ0FBQSxPQUFHQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUNDLFFBQVE7QUFDakMsTUFBTUMsSUFBSTtBQUFBO0FBQUEsQ0FBQU4sY0FBQSxHQUFBRyxDQUFBLE9BQUdDLE9BQU8sQ0FBQyxNQUFNLENBQUM7QUFFNUIsTUFBTUcsY0FBYztBQUFBO0FBQUEsQ0FBQVAsY0FBQSxHQUFBRyxDQUFBO0FBQUc7QUFBQSxDQUFBSCxjQUFBLEdBQUFRLENBQUEsVUFBQUMsT0FBTyxDQUFDQyxHQUFHLENBQUNILGNBQWM7QUFBQTtBQUFBLENBQUFQLGNBQUEsR0FBQVEsQ0FBQSxVQUFJLGtCQUFrQjtBQUV2RSxlQUFlRyxRQUFRQSxDQUFDQyxLQUFLLEVBQUU7RUFBQTtFQUFBWixjQUFBLEdBQUFhLENBQUE7RUFDN0IsTUFBTUMsS0FBSztFQUFBO0VBQUEsQ0FBQWQsY0FBQSxHQUFBRyxDQUFBLE9BQUc7SUFDWlksU0FBUyxFQUFFLElBQUlDLElBQUksQ0FBQyxDQUFDLENBQUNDLFdBQVcsQ0FBQyxDQUFDO0lBQ25DLEdBQUdMO0VBQ0wsQ0FBQztFQUFDO0VBQUFaLGNBQUEsR0FBQUcsQ0FBQTtFQUVGLElBQUk7SUFBQTtJQUFBSCxjQUFBLEdBQUFHLENBQUE7SUFDRixNQUFNRCxFQUFFLENBQUNnQixVQUFVLENBQUNYLGNBQWMsRUFBRVksSUFBSSxDQUFDQyxTQUFTLENBQUNOLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQztFQUNuRSxDQUFDLENBQUMsT0FBT08sR0FBRyxFQUFFO0lBQUE7SUFBQXJCLGNBQUEsR0FBQUcsQ0FBQTtJQUNabUIsT0FBTyxDQUFDQyxLQUFLLENBQUMsbUJBQW1CLEVBQUVGLEdBQUcsQ0FBQztFQUN6QztBQUNGO0FBRUEsU0FBU0csZUFBZUEsQ0FBQ0MsR0FBRyxFQUFFQyxHQUFHLEVBQUVDLElBQUksRUFBRTtFQUFBO0VBQUEzQixjQUFBLEdBQUFhLENBQUE7RUFDdkMsTUFBTWUsWUFBWTtFQUFBO0VBQUEsQ0FBQTVCLGNBQUEsR0FBQUcsQ0FBQSxPQUFHdUIsR0FBRyxDQUFDRyxJQUFJO0VBQUM7RUFBQTdCLGNBQUEsR0FBQUcsQ0FBQTtFQUU5QnVCLEdBQUcsQ0FBQ0csSUFBSSxHQUFHLFVBQVNDLElBQUksRUFBRTtJQUFBO0lBQUE5QixjQUFBLEdBQUFhLENBQUE7SUFBQWIsY0FBQSxHQUFBRyxDQUFBO0lBQ3hCUSxRQUFRLENBQUM7TUFDUG9CLElBQUksRUFBRSxhQUFhO01BQ25CQyxNQUFNLEVBQUVQLEdBQUcsQ0FBQ08sTUFBTTtNQUNsQjFCLElBQUksRUFBRW1CLEdBQUcsQ0FBQ25CLElBQUk7TUFDZDJCLE1BQU0sRUFBRVIsR0FBRyxDQUFDUyxJQUFJLEVBQUVELE1BQU07TUFDeEJFLEVBQUUsRUFBRVYsR0FBRyxDQUFDVSxFQUFFO01BQ1ZDLFVBQVUsRUFBRVYsR0FBRyxDQUFDVSxVQUFVO01BQzFCQyxTQUFTLEVBQUVaLEdBQUcsQ0FBQ2EsR0FBRyxDQUFDLFlBQVk7SUFDakMsQ0FBQyxDQUFDO0lBQUM7SUFBQXRDLGNBQUEsR0FBQUcsQ0FBQTtJQUVIeUIsWUFBWSxDQUFDVyxJQUFJLENBQUMsSUFBSSxFQUFFVCxJQUFJLENBQUM7RUFDL0IsQ0FBQztFQUFDO0VBQUE5QixjQUFBLEdBQUFHLENBQUE7RUFFRndCLElBQUksQ0FBQyxDQUFDO0FBQ1I7QUFFQSxlQUFlYSxjQUFjQSxDQUFDQyxLQUFLLEVBQUVDLE9BQU8sRUFBRVAsRUFBRSxFQUFFO0VBQUE7RUFBQW5DLGNBQUEsR0FBQWEsQ0FBQTtFQUFBYixjQUFBLEdBQUFHLENBQUE7RUFDaEQsTUFBTVEsUUFBUSxDQUFDO0lBQ2JvQixJQUFJLEVBQUUsY0FBYztJQUNwQlUsS0FBSztJQUNMQyxPQUFPO0lBQ1BQO0VBQ0YsQ0FBQyxDQUFDO0FBQ0o7QUFFQSxlQUFlUSxhQUFhQSxDQUFDVixNQUFNLEVBQUVXLFFBQVEsRUFBRUMsTUFBTSxFQUFFO0VBQUE7RUFBQTdDLGNBQUEsR0FBQWEsQ0FBQTtFQUFBYixjQUFBLEdBQUFHLENBQUE7RUFDckQsTUFBTVEsUUFBUSxDQUFDO0lBQ2JvQixJQUFJLEVBQUUsYUFBYTtJQUNuQkUsTUFBTTtJQUNOVyxRQUFRO0lBQ1JDO0VBQ0YsQ0FBQyxDQUFDO0FBQ0o7QUFFQSxlQUFlQyxtQkFBbUJBLENBQUNiLE1BQU0sRUFBRVcsUUFBUSxFQUFFQyxNQUFNLEVBQUVFLE9BQU8sRUFBRTtFQUFBO0VBQUEvQyxjQUFBLEdBQUFhLENBQUE7RUFBQWIsY0FBQSxHQUFBRyxDQUFBO0VBQ3BFLE1BQU1RLFFBQVEsQ0FBQztJQUNib0IsSUFBSSxFQUFFLG1CQUFtQjtJQUN6QkUsTUFBTTtJQUNOVyxRQUFRO0lBQ1JDLE1BQU07SUFDTkU7RUFDRixDQUFDLENBQUM7QUFDSjtBQUFDO0FBQUEvQyxjQUFBLEdBQUFHLENBQUE7QUFFRDZDLE1BQU0sQ0FBQ0MsT0FBTyxHQUFHO0VBQ2Z6QixlQUFlO0VBQ2ZnQixjQUFjO0VBQ2RHLGFBQWE7RUFDYkc7QUFDRixDQUFDIiwiaWdub3JlTGlzdCI6W119