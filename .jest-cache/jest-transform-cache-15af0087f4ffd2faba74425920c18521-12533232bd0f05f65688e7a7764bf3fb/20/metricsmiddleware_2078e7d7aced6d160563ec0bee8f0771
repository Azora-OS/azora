8ad533a985ff739dbab89472ea82e1d1
/* istanbul ignore next */
function cov_175wcwatl7() {
  var path = "/workspaces/azora/packages/shared-infrastructure/metrics-middleware.js";
  var hash = "fb7b3138af0f5775d1dc10c93ed76a6e747cf886";
  var global = new Function("return this")();
  var gcv = "__coverage__";
  var coverageData = {
    path: "/workspaces/azora/packages/shared-infrastructure/metrics-middleware.js",
    statementMap: {
      "0": {
        start: {
          line: 1,
          column: 14
        },
        end: {
          line: 1,
          column: 30
        }
      },
      "1": {
        start: {
          line: 3,
          column: 23
        },
        end: {
          line: 3,
          column: 76
        }
      },
      "2": {
        start: {
          line: 7,
          column: 2
        },
        end: {
          line: 26,
          column: 4
        }
      },
      "3": {
        start: {
          line: 8,
          column: 18
        },
        end: {
          line: 8,
          column: 28
        }
      },
      "4": {
        start: {
          line: 10,
          column: 4
        },
        end: {
          line: 23,
          column: 7
        }
      },
      "5": {
        start: {
          line: 11,
          column: 23
        },
        end: {
          line: 11,
          column: 50
        }
      },
      "6": {
        start: {
          line: 13,
          column: 6
        },
        end: {
          line: 22,
          column: 7
        }
      },
      "7": {
        start: {
          line: 14,
          column: 8
        },
        end: {
          line: 19,
          column: 30
        }
      },
      "8": {
        start: {
          line: 25,
          column: 4
        },
        end: {
          line: 25,
          column: 11
        }
      },
      "9": {
        start: {
          line: 31,
          column: 2
        },
        end: {
          line: 38,
          column: 3
        }
      },
      "10": {
        start: {
          line: 32,
          column: 4
        },
        end: {
          line: 35,
          column: 6
        }
      },
      "11": {
        start: {
          line: 43,
          column: 2
        },
        end: {
          line: 50,
          column: 3
        }
      },
      "12": {
        start: {
          line: 44,
          column: 4
        },
        end: {
          line: 47,
          column: 6
        }
      },
      "13": {
        start: {
          line: 53,
          column: 0
        },
        end: {
          line: 57,
          column: 2
        }
      }
    },
    fnMap: {
      "0": {
        name: "metricsMiddleware",
        decl: {
          start: {
            line: 6,
            column: 9
          },
          end: {
            line: 6,
            column: 26
          }
        },
        loc: {
          start: {
            line: 6,
            column: 40
          },
          end: {
            line: 27,
            column: 1
          }
        },
        line: 6
      },
      "1": {
        name: "(anonymous_1)",
        decl: {
          start: {
            line: 7,
            column: 9
          },
          end: {
            line: 7,
            column: 10
          }
        },
        loc: {
          start: {
            line: 7,
            column: 29
          },
          end: {
            line: 26,
            column: 3
          }
        },
        line: 7
      },
      "2": {
        name: "(anonymous_2)",
        decl: {
          start: {
            line: 10,
            column: 21
          },
          end: {
            line: 10,
            column: 22
          }
        },
        loc: {
          start: {
            line: 10,
            column: 33
          },
          end: {
            line: 23,
            column: 5
          }
        },
        line: 10
      },
      "3": {
        name: "reportHealth",
        decl: {
          start: {
            line: 30,
            column: 15
          },
          end: {
            line: 30,
            column: 27
          }
        },
        loc: {
          start: {
            line: 30,
            column: 61
          },
          end: {
            line: 39,
            column: 1
          }
        },
        line: 30
      },
      "4": {
        name: "reportActiveUsers",
        decl: {
          start: {
            line: 42,
            column: 15
          },
          end: {
            line: 42,
            column: 32
          }
        },
        loc: {
          start: {
            line: 42,
            column: 40
          },
          end: {
            line: 51,
            column: 1
          }
        },
        line: 42
      }
    },
    branchMap: {
      "0": {
        loc: {
          start: {
            line: 3,
            column: 23
          },
          end: {
            line: 3,
            column: 76
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 3,
            column: 23
          },
          end: {
            line: 3,
            column: 49
          }
        }, {
          start: {
            line: 3,
            column: 53
          },
          end: {
            line: 3,
            column: 76
          }
        }],
        line: 3
      },
      "1": {
        loc: {
          start: {
            line: 16,
            column: 17
          },
          end: {
            line: 16,
            column: 44
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 16,
            column: 17
          },
          end: {
            line: 16,
            column: 32
          }
        }, {
          start: {
            line: 16,
            column: 36
          },
          end: {
            line: 16,
            column: 44
          }
        }],
        line: 16
      },
      "2": {
        loc: {
          start: {
            line: 30,
            column: 41
          },
          end: {
            line: 30,
            column: 59
          }
        },
        type: "default-arg",
        locations: [{
          start: {
            line: 30,
            column: 50
          },
          end: {
            line: 30,
            column: 59
          }
        }],
        line: 30
      }
    },
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0,
      "8": 0,
      "9": 0,
      "10": 0,
      "11": 0,
      "12": 0,
      "13": 0
    },
    f: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0
    },
    b: {
      "0": [0, 0],
      "1": [0, 0],
      "2": [0]
    },
    _coverageSchema: "1a1c01bbd47fc00a2c39e90264f33305004495a9",
    hash: "fb7b3138af0f5775d1dc10c93ed76a6e747cf886"
  };
  var coverage = global[gcv] || (global[gcv] = {});
  if (!coverage[path] || coverage[path].hash !== hash) {
    coverage[path] = coverageData;
  }
  var actualCoverage = coverage[path];
  {
    // @ts-ignore
    cov_175wcwatl7 = function () {
      return actualCoverage;
    };
  }
  return actualCoverage;
}
cov_175wcwatl7();
const axios =
/* istanbul ignore next */
(cov_175wcwatl7().s[0]++, require('axios'));
const MONITORING_URL =
/* istanbul ignore next */
(cov_175wcwatl7().s[1]++,
/* istanbul ignore next */
(cov_175wcwatl7().b[0][0]++, process.env.MONITORING_URL) ||
/* istanbul ignore next */
(cov_175wcwatl7().b[0][1]++, 'http://localhost:9090'));

// Middleware to track HTTP metrics
function metricsMiddleware(serviceName) {
  /* istanbul ignore next */
  cov_175wcwatl7().f[0]++;
  cov_175wcwatl7().s[2]++;
  return (req, res, next) => {
    /* istanbul ignore next */
    cov_175wcwatl7().f[1]++;
    const start =
    /* istanbul ignore next */
    (cov_175wcwatl7().s[3]++, Date.now());
    /* istanbul ignore next */
    cov_175wcwatl7().s[4]++;
    res.on('finish', async () => {
      /* istanbul ignore next */
      cov_175wcwatl7().f[2]++;
      const duration =
      /* istanbul ignore next */
      (cov_175wcwatl7().s[5]++, (Date.now() - start) / 1000);
      /* istanbul ignore next */
      cov_175wcwatl7().s[6]++;
      try {
        /* istanbul ignore next */
        cov_175wcwatl7().s[7]++;
        await axios.post(`${MONITORING_URL}/api/metrics/http`, {
          method: req.method,
          route:
          /* istanbul ignore next */
          (cov_175wcwatl7().b[1][0]++, req.route?.path) ||
          /* istanbul ignore next */
          (cov_175wcwatl7().b[1][1]++, req.path),
          status: res.statusCode,
          duration
        }, {
          timeout: 1000
        });
      } catch (error) {
        // Silent fail - don't break app if monitoring is down
      }
    });
    /* istanbul ignore next */
    cov_175wcwatl7().s[8]++;
    next();
  };
}

// Report service health
async function reportHealth(serviceName, status =
/* istanbul ignore next */
(cov_175wcwatl7().b[2][0]++, 'healthy')) {
  /* istanbul ignore next */
  cov_175wcwatl7().f[3]++;
  cov_175wcwatl7().s[9]++;
  try {
    /* istanbul ignore next */
    cov_175wcwatl7().s[10]++;
    await axios.post(`${MONITORING_URL}/api/health/${serviceName}`, {
      status
    }, {
      timeout: 1000
    });
  } catch (error) {
    // Silent fail
  }
}

// Report active users
async function reportActiveUsers(count) {
  /* istanbul ignore next */
  cov_175wcwatl7().f[4]++;
  cov_175wcwatl7().s[11]++;
  try {
    /* istanbul ignore next */
    cov_175wcwatl7().s[12]++;
    await axios.post(`${MONITORING_URL}/api/metrics/users`, {
      count
    }, {
      timeout: 1000
    });
  } catch (error) {
    // Silent fail
  }
}
/* istanbul ignore next */
cov_175wcwatl7().s[13]++;
module.exports = {
  metricsMiddleware,
  reportHealth,
  reportActiveUsers
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb3ZfMTc1d2N3YXRsNyIsImFjdHVhbENvdmVyYWdlIiwiYXhpb3MiLCJzIiwicmVxdWlyZSIsIk1PTklUT1JJTkdfVVJMIiwiYiIsInByb2Nlc3MiLCJlbnYiLCJtZXRyaWNzTWlkZGxld2FyZSIsInNlcnZpY2VOYW1lIiwiZiIsInJlcSIsInJlcyIsIm5leHQiLCJzdGFydCIsIkRhdGUiLCJub3ciLCJvbiIsImR1cmF0aW9uIiwicG9zdCIsIm1ldGhvZCIsInJvdXRlIiwicGF0aCIsInN0YXR1cyIsInN0YXR1c0NvZGUiLCJ0aW1lb3V0IiwiZXJyb3IiLCJyZXBvcnRIZWFsdGgiLCJyZXBvcnRBY3RpdmVVc2VycyIsImNvdW50IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbIm1ldHJpY3MtbWlkZGxld2FyZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBheGlvcyA9IHJlcXVpcmUoJ2F4aW9zJyk7XG5cbmNvbnN0IE1PTklUT1JJTkdfVVJMID0gcHJvY2Vzcy5lbnYuTU9OSVRPUklOR19VUkwgfHwgJ2h0dHA6Ly9sb2NhbGhvc3Q6OTA5MCc7XG5cbi8vIE1pZGRsZXdhcmUgdG8gdHJhY2sgSFRUUCBtZXRyaWNzXG5mdW5jdGlvbiBtZXRyaWNzTWlkZGxld2FyZShzZXJ2aWNlTmFtZSkge1xuICByZXR1cm4gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIHJlcy5vbignZmluaXNoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZHVyYXRpb24gPSAoRGF0ZS5ub3coKSAtIHN0YXJ0KSAvIDEwMDA7XG4gICAgICBcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGF4aW9zLnBvc3QoYCR7TU9OSVRPUklOR19VUkx9L2FwaS9tZXRyaWNzL2h0dHBgLCB7XG4gICAgICAgICAgbWV0aG9kOiByZXEubWV0aG9kLFxuICAgICAgICAgIHJvdXRlOiByZXEucm91dGU/LnBhdGggfHwgcmVxLnBhdGgsXG4gICAgICAgICAgc3RhdHVzOiByZXMuc3RhdHVzQ29kZSxcbiAgICAgICAgICBkdXJhdGlvblxuICAgICAgICB9LCB7IHRpbWVvdXQ6IDEwMDAgfSk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAvLyBTaWxlbnQgZmFpbCAtIGRvbid0IGJyZWFrIGFwcCBpZiBtb25pdG9yaW5nIGlzIGRvd25cbiAgICAgIH1cbiAgICB9KTtcbiAgICBcbiAgICBuZXh0KCk7XG4gIH07XG59XG5cbi8vIFJlcG9ydCBzZXJ2aWNlIGhlYWx0aFxuYXN5bmMgZnVuY3Rpb24gcmVwb3J0SGVhbHRoKHNlcnZpY2VOYW1lLCBzdGF0dXMgPSAnaGVhbHRoeScpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBheGlvcy5wb3N0KGAke01PTklUT1JJTkdfVVJMfS9hcGkvaGVhbHRoLyR7c2VydmljZU5hbWV9YCwgXG4gICAgICB7IHN0YXR1cyB9LFxuICAgICAgeyB0aW1lb3V0OiAxMDAwIH1cbiAgICApO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIC8vIFNpbGVudCBmYWlsXG4gIH1cbn1cblxuLy8gUmVwb3J0IGFjdGl2ZSB1c2Vyc1xuYXN5bmMgZnVuY3Rpb24gcmVwb3J0QWN0aXZlVXNlcnMoY291bnQpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBheGlvcy5wb3N0KGAke01PTklUT1JJTkdfVVJMfS9hcGkvbWV0cmljcy91c2Vyc2AsXG4gICAgICB7IGNvdW50IH0sXG4gICAgICB7IHRpbWVvdXQ6IDEwMDAgfVxuICAgICk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgLy8gU2lsZW50IGZhaWxcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgbWV0cmljc01pZGRsZXdhcmUsXG4gIHJlcG9ydEhlYWx0aCxcbiAgcmVwb3J0QWN0aXZlVXNlcnNcbn07XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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