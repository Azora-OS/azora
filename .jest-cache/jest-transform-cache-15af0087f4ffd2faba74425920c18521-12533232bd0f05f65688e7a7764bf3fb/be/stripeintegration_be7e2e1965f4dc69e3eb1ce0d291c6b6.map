{"version":3,"names":["cov_193j0vqjdt","actualCoverage","Stripe","prisma","logger","stripe","s","process","env","STRIPE_SECRET_KEY","apiVersion","StripePaymentProcessor","createPaymentIntent","amount","currency","userId","f","paymentIntent","paymentIntents","create","Math","round","toLowerCase","metadata","transaction","data","type","status","coinType","usdEquivalent","hash","id","externalTxnId","senderId","clientSecret","client_secret","paymentIntentId","error","handleWebhook","body","signature","event","webhooks","constructEvent","STRIPE_WEBHOOK_SECRET","b","handlePaymentSuccess","object","handlePaymentFailure","received","updateMany","where","wallet","update","balance","increment"],"sources":["stripe-integration.ts"],"sourcesContent":["import Stripe from 'stripe'\nimport { prisma } from '../../infrastructure/database/prisma-config'\nimport { logger } from '../../infrastructure/monitoring/logger'\n\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {\n  apiVersion: '2023-10-16'\n})\n\nexport class StripePaymentProcessor {\n  // Create payment intent\n  async createPaymentIntent(amount: number, currency: string, userId: string) {\n    try {\n      const paymentIntent = await stripe.paymentIntents.create({\n        amount: Math.round(amount * 100), // Convert to cents\n        currency: currency.toLowerCase(),\n        metadata: { userId }\n      })\n\n      // Store in database\n      await prisma.transaction.create({\n        data: {\n          type: 'PAYMENT',\n          status: 'PENDING',\n          amount,\n          coinType: currency as any,\n          usdEquivalent: amount,\n          hash: paymentIntent.id,\n          externalTxnId: paymentIntent.id,\n          senderId: userId\n        }\n      })\n\n      return {\n        clientSecret: paymentIntent.client_secret,\n        paymentIntentId: paymentIntent.id\n      }\n    } catch (error) {\n      logger.error('Payment intent creation failed', { error, userId, amount })\n      throw error\n    }\n  }\n\n  // Handle webhook events\n  async handleWebhook(body: string, signature: string) {\n    try {\n      const event = stripe.webhooks.constructEvent(\n        body,\n        signature,\n        process.env.STRIPE_WEBHOOK_SECRET!\n      )\n\n      switch (event.type) {\n        case 'payment_intent.succeeded':\n          await this.handlePaymentSuccess(event.data.object)\n          break\n        case 'payment_intent.payment_failed':\n          await this.handlePaymentFailure(event.data.object)\n          break\n      }\n\n      return { received: true }\n    } catch (error) {\n      logger.error('Webhook handling failed', { error })\n      throw error\n    }\n  }\n\n  private async handlePaymentSuccess(paymentIntent: Stripe.PaymentIntent) {\n    await prisma.transaction.updateMany({\n      where: { externalTxnId: paymentIntent.id },\n      data: { status: 'COMPLETED' }\n    })\n\n    // Update user wallet\n    const userId = paymentIntent.metadata.userId\n    if (userId) {\n      await prisma.wallet.update({\n        where: { userId },\n        data: {\n          balance: {\n            increment: paymentIntent.amount / 100\n          }\n        }\n      })\n    }\n  }\n\n  private async handlePaymentFailure(paymentIntent: Stripe.PaymentIntent) {\n    await prisma.transaction.updateMany({\n      where: { externalTxnId: paymentIntent.id },\n      data: { status: 'FAILED' }\n    })\n  }\n}"],"mappings":"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","ignoreList":[]}