{"version":3,"names":["cov_1h0skwkvyo","actualCoverage","PrismaClient","InternalServerError","prisma","getPrismaClient","f","s","b","initializePrisma","client","$connect","error","disconnectPrisma","$disconnect","handlePrismaError","code","field","meta","target","Error","withPrismaErrorHandling","operation","withTransaction","callback","$transaction","tx"],"sources":["database.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\nimport { InternalServerError } from './errors';\n\nlet prisma: PrismaClient;\n\n/**\n * Gets or creates a Prisma client instance\n */\nexport function getPrismaClient(): PrismaClient {\n  if (!prisma) {\n    prisma = new PrismaClient();\n  }\n  return prisma;\n}\n\n/**\n * Initializes the Prisma client\n */\nexport async function initializePrisma(): Promise<void> {\n  try {\n    const client = getPrismaClient();\n    await client.$connect();\n  } catch (error) {\n    throw new InternalServerError('Failed to connect to database');\n  }\n}\n\n/**\n * Disconnects the Prisma client\n */\nexport async function disconnectPrisma(): Promise<void> {\n  if (prisma) {\n    await prisma.$disconnect();\n  }\n}\n\n/**\n * Handles Prisma errors and converts them to AppErrors\n */\nexport function handlePrismaError(error: any): Error {\n  if (error.code === 'P2002') {\n    // Unique constraint violation\n    const field = error.meta?.target?.[0] || 'field';\n    return new Error(`A record with this ${field} already exists`);\n  }\n\n  if (error.code === 'P2025') {\n    // Record not found\n    return new Error('Record not found');\n  }\n\n  if (error.code === 'P2003') {\n    // Foreign key constraint violation\n    return new Error('Invalid reference to related record');\n  }\n\n  if (error.code === 'P2014') {\n    // Required relation violation\n    return new Error('Cannot delete record due to related records');\n  }\n\n  return new InternalServerError('Database operation failed');\n}\n\n/**\n * Wraps a database operation with error handling\n */\nexport async function withPrismaErrorHandling<T>(\n  operation: () => Promise<T>\n): Promise<T> {\n  try {\n    return await operation();\n  } catch (error) {\n    throw handlePrismaError(error);\n  }\n}\n\n/**\n * Transaction wrapper for multiple operations\n */\nexport async function withTransaction<T>(\n  callback: (prisma: PrismaClient) => Promise<T>\n): Promise<T> {\n  const client = getPrismaClient();\n  try {\n    return await client.$transaction(async (tx) => {\n      return await callback(tx as PrismaClient);\n    });\n  } catch (error) {\n    throw handlePrismaError(error);\n  }\n}\n"],"mappings":"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","ignoreList":[]}