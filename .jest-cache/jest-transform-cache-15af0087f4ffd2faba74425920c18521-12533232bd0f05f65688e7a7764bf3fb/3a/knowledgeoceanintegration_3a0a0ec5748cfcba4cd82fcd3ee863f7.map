{"version":3,"names":["cov_27450pooj4","actualCoverage","axios","prisma","logger","Joi","contextRetrievalSchema","s","object","studentId","string","required","courseId","moduleId","query","min","language","optional","default","topK","number","ContextRetrievalService","constructor","f","knowledgeOceanUrl","b","process","env","KNOWLEDGE_OCEAN_URL","knowledgeOceanClient","create","baseURL","timeout","internalResourceCache","Map","cacheExpiry","retrieveContext","data","error","value","validate","Error","message","startTime","Date","now","course","findUnique","where","id","module","searchContext","courseTitle","title","moduleTitle","tier","response","post","context","resources","applySeventyThirtyRule","documents","internalCount","filter","r","source","length","externalCount","totalCount","result","internalPercentage","externalPercentage","retrievalTime","timestamp","info","targetCount","internalTarget","Math","ceil","externalTarget","floor","internal","d","map","mapToResource","external","selectedInternal","slice","selectedExternal","combined","remaining","additionalInternal","push","additionalExternal","sort","a","relevanceScore","doc","name","content","text","score","url","getLanguageSpecificResources","cacheKey","cached","get","set","setTimeout","delete","rankResources","rankedResources","rankedDocuments","clearCache","clear","contextRetrievalService"],"sources":["knowledge-ocean-integration.ts"],"sourcesContent":["import axios, { AxiosInstance } from 'axios';\nimport { prisma } from '../index';\nimport { logger } from '../utils/logger';\nimport Joi from 'joi';\n\nconst contextRetrievalSchema = Joi.object({\n  studentId: Joi.string().required(),\n  courseId: Joi.string().required(),\n  moduleId: Joi.string().required(),\n  query: Joi.string().required().min(5),\n  language: Joi.string().optional().default('en'),\n  topK: Joi.number().optional().default(10),\n});\n\ninterface RetrievedResource {\n  id: string;\n  title: string;\n  content: string;\n  source: 'internal' | 'external';\n  relevanceScore: number;\n  url?: string;\n}\n\ninterface ContextRetrievalResult {\n  query: string;\n  resources: RetrievedResource[];\n  internalCount: number;\n  externalCount: number;\n  internalPercentage: number;\n  externalPercentage: number;\n  retrievalTime: number;\n  timestamp: Date;\n}\n\nexport class ContextRetrievalService {\n  private knowledgeOceanClient: AxiosInstance;\n  private knowledgeOceanUrl: string;\n  private internalResourceCache: Map<string, RetrievedResource[]>;\n  private cacheExpiry: number;\n\n  constructor() {\n    this.knowledgeOceanUrl = process.env.KNOWLEDGE_OCEAN_URL || 'http://localhost:3002';\n    this.knowledgeOceanClient = axios.create({\n      baseURL: this.knowledgeOceanUrl,\n      timeout: 10000,\n    });\n    this.internalResourceCache = new Map();\n    this.cacheExpiry = 3600000; // 1 hour\n  }\n\n  /**\n   * Retrieve context for a student query\n   */\n  async retrieveContext(data: any): Promise<ContextRetrievalResult> {\n    try {\n      const { error, value } = contextRetrievalSchema.validate(data);\n      if (error) {\n        throw new Error(`Validation error: ${error.message}`);\n      }\n\n      const startTime = Date.now();\n\n      // Get course and module context\n      const course = await prisma.course.findUnique({\n        where: { id: value.courseId },\n      });\n\n      if (!course) {\n        throw new Error('Course not found');\n      }\n\n      const module = await prisma.module.findUnique({\n        where: { id: value.moduleId },\n      });\n\n      if (!module) {\n        throw new Error('Module not found');\n      }\n\n      // Build search context\n      const searchContext = {\n        courseTitle: course.title,\n        moduleTitle: module.title,\n        language: value.language,\n        tier: 'all', // Can be filtered by student tier\n      };\n\n      // Call Knowledge Ocean for retrieval\n      const response = await this.knowledgeOceanClient.post('/api/knowledge-ocean/retrieve', {\n        query: value.query,\n        context: searchContext,\n        topK: value.topK * 2, // Fetch more to apply 70/30 rule\n      });\n\n      // Apply 70/30 rule: 70% internal, 30% external\n      const resources = this.applySeventyThirtyRule(response.data.documents, value.topK);\n\n      // Calculate metrics\n      const internalCount = resources.filter(r => r.source === 'internal').length;\n      const externalCount = resources.filter(r => r.source === 'external').length;\n      const totalCount = internalCount + externalCount;\n\n      const result: ContextRetrievalResult = {\n        query: value.query,\n        resources,\n        internalCount,\n        externalCount,\n        internalPercentage: totalCount > 0 ? (internalCount / totalCount) * 100 : 0,\n        externalPercentage: totalCount > 0 ? (externalCount / totalCount) * 100 : 0,\n        retrievalTime: Date.now() - startTime,\n        timestamp: new Date(),\n      };\n\n      logger.info(\n        `Context retrieved for student ${value.studentId}: ${internalCount} internal, ${externalCount} external`\n      );\n\n      return result;\n    } catch (error) {\n      logger.error('Error retrieving context:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Apply 70/30 rule: 70% internal sources, 30% external sources\n   */\n  private applySeventyThirtyRule(documents: any[], targetCount: number): RetrievedResource[] {\n    const internalTarget = Math.ceil(targetCount * 0.7);\n    const externalTarget = Math.floor(targetCount * 0.3);\n\n    const internal = documents\n      .filter((d: any) => d.source === 'internal')\n      .map((d: any) => this.mapToResource(d, 'internal'));\n\n    const external = documents\n      .filter((d: any) => d.source === 'external')\n      .map((d: any) => this.mapToResource(d, 'external'));\n\n    // Take top documents from each source up to target\n    const selectedInternal = internal.slice(0, internalTarget);\n    const selectedExternal = external.slice(0, externalTarget);\n\n    // Combine and sort by relevance\n    const combined = [...selectedInternal, ...selectedExternal];\n\n    // If we don't have enough, fill with remaining\n    if (combined.length < targetCount) {\n      const remaining = targetCount - combined.length;\n      if (selectedInternal.length < internalTarget) {\n        const additionalInternal = internal.slice(internalTarget, internalTarget + remaining);\n        combined.push(...additionalInternal);\n      } else if (selectedExternal.length < externalTarget) {\n        const additionalExternal = external.slice(externalTarget, externalTarget + remaining);\n        combined.push(...additionalExternal);\n      }\n    }\n\n    return combined\n      .sort((a, b) => b.relevanceScore - a.relevanceScore)\n      .slice(0, targetCount);\n  }\n\n  /**\n   * Map document to resource\n   */\n  private mapToResource(doc: any, source: 'internal' | 'external'): RetrievedResource {\n    return {\n      id: doc.id || `resource-${Date.now()}`,\n      title: doc.title || doc.name || 'Untitled',\n      content: doc.content || doc.text || '',\n      source,\n      relevanceScore: doc.score || 0.5,\n      url: doc.url,\n    };\n  }\n\n  /**\n   * Get language-specific resources\n   */\n  async getLanguageSpecificResources(\n    courseId: string,\n    moduleId: string,\n    language: string\n  ): Promise<RetrievedResource[]> {\n    try {\n      // Check cache first\n      const cacheKey = `${courseId}-${moduleId}-${language}`;\n      const cached = this.internalResourceCache.get(cacheKey);\n      if (cached) {\n        logger.info(`Cache hit for language resources: ${language}`);\n        return cached;\n      }\n\n      // Get course and module\n      const course = await prisma.course.findUnique({\n        where: { id: courseId },\n      });\n\n      const module = await prisma.module.findUnique({\n        where: { id: moduleId },\n      });\n\n      if (!course || !module) {\n        throw new Error('Course or module not found');\n      }\n\n      // Call Knowledge Ocean for language-specific resources\n      const response = await this.knowledgeOceanClient.post(\n        '/api/knowledge-ocean/retrieve-language',\n        {\n          courseTitle: course.title,\n          moduleTitle: module.title,\n          language,\n        }\n      );\n\n      const resources = response.data.documents.map((d: any) =>\n        this.mapToResource(d, d.source || 'external')\n      );\n\n      // Cache the resources\n      this.internalResourceCache.set(cacheKey, resources);\n      setTimeout(() => this.internalResourceCache.delete(cacheKey), this.cacheExpiry);\n\n      logger.info(`Retrieved ${resources.length} language-specific resources for ${language}`);\n\n      return resources;\n    } catch (error) {\n      logger.error('Error getting language-specific resources:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Rank resources by relevance\n   */\n  async rankResources(resources: RetrievedResource[]): Promise<RetrievedResource[]> {\n    try {\n      // Call Knowledge Ocean for ranking\n      const response = await this.knowledgeOceanClient.post('/api/knowledge-ocean/rank', {\n        documents: resources,\n      });\n\n      const rankedResources = response.data.rankedDocuments.map((d: any) =>\n        this.mapToResource(d, d.source || 'external')\n      );\n\n      logger.info(`Ranked ${rankedResources.length} resources`);\n\n      return rankedResources;\n    } catch (error) {\n      logger.error('Error ranking resources:', error);\n      // Return original resources if ranking fails\n      return resources;\n    }\n  }\n\n  /**\n   * Clear cache\n   */\n  clearCache(): void {\n    this.internalResourceCache.clear();\n    logger.info('Context retrieval cache cleared');\n  }\n}\n\nexport const contextRetrievalService = new ContextRetrievalService();\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}