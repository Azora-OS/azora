{"version":3,"names":["cov_17ofyzu7no","actualCoverage","SimpleExecutor","SandboxExecutor","CircuitBreaker","saveTask","updateTask","getTask","nanoid","logger","EventBus","AgentRuntime","active","s","Map","bus","constructor","f","process","env","SANDBOX_ENABLED","b","executor","circuit","executeTask","payload","id","task","status","createdAt","Date","now","updatedAt","agentId","info","taskId","promise","publish","result","execute","toISOString","success","err","error","message","stack","set","finally","delete","getActiveExecutions","Array","from","keys","getAgentStatus","tasks","push","state","length","activeTasks","cancelTask","pauseTask","resumeTask","t","Error"],"sources":["runtime.ts"],"sourcesContent":["import { SimpleExecutor } from './executor';\nimport { SandboxExecutor } from './sandboxExecutor';\nimport { CircuitBreaker } from '../../../packages/shared/circuit-breaker/src/index';\nimport { AgentTask, AgentExecutionResult } from './types';\nimport { saveTask, updateTask, TaskRecord, getTask } from './persistence';\nimport { nanoid } from 'nanoid';\nimport { logger } from './logger';\nimport { EventBus } from '../../../packages/shared/event-bus/src/index';\n\nexport class AgentRuntime {\n  private executor: SimpleExecutor | SandboxExecutor;\n  private active: Map<string, Promise<AgentExecutionResult>> = new Map();\n  private bus = new EventBus();\n\n  private circuit: CircuitBreaker;\n  constructor(bus?: EventBus) {\n    if (process.env.SANDBOX_ENABLED === 'true') {\n      this.executor = new SandboxExecutor();\n    } else this.executor = new SimpleExecutor();\n    this.circuit = new CircuitBreaker();\n    if (bus) this.bus = bus;\n  }\n\n  async executeTask(payload: Omit<AgentTask, 'id' | 'createdAt' | 'status'> & { status?: string }): Promise<AgentExecutionResult> {\n    const id = nanoid();\n    const task: TaskRecord = {\n      id,\n      status: 'pending',\n      payload: payload.payload,\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      agentId: payload.agentId\n    };\n\n    await saveTask(task);\n    logger.info({ taskId: id }, 'Saved task, starting execution');\n\n    const promise = (async () => {\n      try {\n        await updateTask(id, { status: 'in-progress' });\n        this.bus.publish('task.started', { taskId: id, agentId: payload.agentId });\n        const result = await this.circuit.execute(() => this.executor.executeTask({\n          id,\n          createdAt: new Date().toISOString(),\n          payload: payload.payload,\n          status: 'in-progress',\n          agentId: payload.agentId\n        } as AgentTask));\n\n        await updateTask(id, {\n          status: result.success ? 'completed' : 'failed'\n        });\n        this.bus.publish('task.completed', { taskId: id, agentId: payload.agentId, success: result.success });\n\n        return result;\n      } catch (err: any) {\n        await updateTask(id, { status: 'failed' });\n        return { success: false, error: { message: err.message, stack: err.stack } } as AgentExecutionResult;\n      }\n    })();\n\n    this.active.set(id, promise);\n    // Remove active after completion\n    promise.finally(() => this.active.delete(id));\n    return promise;\n  }\n\n  getActiveExecutions(): string[] {\n    return Array.from(this.active.keys());\n  }\n\n  async getAgentStatus(agentId: string) {\n    // Minimal implementation: list active tasks owned by agent and return a status.\n    const tasks = [] as any[];\n    for (const [id] of this.active) {\n      // We can't fetch task details if we don't store execution metadata; return id only\n      tasks.push({ id, agentId });\n    }\n    return { agentId, state: tasks.length ? 'busy' : 'idle', activeTasks: tasks };\n  }\n\n  async cancelTask(taskId: string): Promise<void> {\n    // Cancellation is best-effort in this minimal skeleton;\n    await updateTask(taskId, { status: 'cancelled' });\n    logger.info({ taskId }, 'Task cancelled');\n  }\n\n  async pauseTask(taskId: string): Promise<void> {\n    // Best effort: mark as paused; real pause requires executor cooperation\n    await updateTask(taskId, { status: 'paused' as any });\n  }\n\n  async resumeTask(taskId: string): Promise<void> {\n    const t = await getTask(taskId);\n    if (!t) throw new Error('Task not found');\n    if (t.status !== 'paused') throw new Error('Task not paused');\n    await updateTask(taskId, { status: 'in-progress' });\n    // For a resumed task we might re-execute; that behavior is customizable\n  }\n}\n"],"mappings":"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","ignoreList":[]}