{"version":3,"names":["cov_1y8rstclhg","actualCoverage","DEFAULT_MIDDLEWARE_CONFIG","s","enabled","skipPaths","skipMethods","onViolation","includeMetadata","createConstitutionalMiddleware","orchestrator","config","b","f","middlewareConfig","req","res","next","some","path","startsWith","includes","method","originalJson","json","bind","body","shouldValidateResponse","validateAndRespond","response","output","message","content","query","extractQuery","userId","extractUserId","tier","startTime","Date","now","result","validateOutput","processingTime","logValidation","constitutional","validated","complianceScore","violations","originalOutput","validatedOutput","isValid","handleViolation","length","error","console","status","map","v","type","severity","description","warning","violationCount","warn","prompt","q","user","id","headers","ip","createValidationRulesMiddleware","ubuntuThreshold","strictMode","parseInt","updateConfig","createComplianceMetricsMiddleware","metrics","getComplianceMetrics","createConstitutionalHealthCheck","testResult","timestamp"],"sources":["constitutional-middleware.ts"],"sourcesContent":["/**\n * Constitutional AI Middleware\n * Express middleware for API Gateway integration\n */\n\nimport { Request, Response, NextFunction } from 'express';\nimport { ConstitutionalOrchestrator } from '../orchestrator';\nimport { ConstitutionalAIConfig } from '../types';\n\n/**\n * Middleware configuration\n */\nexport interface ConstitutionalMiddlewareConfig {\n  enabled: boolean;\n  skipPaths?: string[]; // Paths to skip validation\n  skipMethods?: string[]; // HTTP methods to skip\n  onViolation?: 'block' | 'warn' | 'log'; // Action on violation\n  includeMetadata?: boolean; // Include validation metadata in response\n}\n\n/**\n * Default middleware configuration\n */\nconst DEFAULT_MIDDLEWARE_CONFIG: ConstitutionalMiddlewareConfig = {\n  enabled: true,\n  skipPaths: ['/health', '/metrics', '/status'],\n  skipMethods: ['OPTIONS', 'HEAD'],\n  onViolation: 'block',\n  includeMetadata: false\n};\n\n/**\n * Extended request interface with constitutional validation\n */\nexport interface ConstitutionalRequest extends Request {\n  constitutional?: {\n    validated: boolean;\n    complianceScore: number;\n    violations: any[];\n    originalOutput?: string;\n    validatedOutput?: string;\n  };\n}\n\n/**\n * Create constitutional validation middleware\n */\nexport function createConstitutionalMiddleware(\n  orchestrator: ConstitutionalOrchestrator,\n  config: Partial<ConstitutionalMiddlewareConfig> = {}\n) {\n  const middlewareConfig = { ...DEFAULT_MIDDLEWARE_CONFIG, ...config };\n\n  return async (req: ConstitutionalRequest, res: Response, next: NextFunction) => {\n    // Skip if middleware is disabled\n    if (!middlewareConfig.enabled) {\n      return next();\n    }\n\n    // Skip certain paths\n    if (middlewareConfig.skipPaths?.some(path => req.path.startsWith(path))) {\n      return next();\n    }\n\n    // Skip certain methods\n    if (middlewareConfig.skipMethods?.includes(req.method)) {\n      return next();\n    }\n\n    // Store original res.json to intercept AI responses\n    const originalJson = res.json.bind(res);\n\n    // Override res.json to validate AI outputs\n    res.json = function (body: any) {\n      // Only validate if response contains AI output\n      if (shouldValidateResponse(body)) {\n        validateAndRespond(body, req, res, originalJson, orchestrator, middlewareConfig);\n      } else {\n        return originalJson(body);\n      }\n    } as any;\n\n    next();\n  };\n}\n\n/**\n * Determine if response should be validated\n */\nfunction shouldValidateResponse(body: any): boolean {\n  // Check if response contains AI-generated content\n  return (\n    body &&\n    typeof body === 'object' &&\n    (body.response || body.output || body.message || body.content)\n  );\n}\n\n/**\n * Validate response and send\n */\nasync function validateAndRespond(\n  body: any,\n  req: ConstitutionalRequest,\n  res: Response,\n  originalJson: Function,\n  orchestrator: ConstitutionalOrchestrator,\n  config: ConstitutionalMiddlewareConfig\n): Promise<any> {\n  try {\n    // Extract AI output from response\n    const output = body.response || body.output || body.message || body.content;\n    const query = extractQuery(req);\n    const userId = extractUserId(req);\n    const tier = body.tier || 'unknown';\n\n    // Validate output\n    const startTime = Date.now();\n    const result = await orchestrator.validateOutput(query, output);\n    const processingTime = Date.now() - startTime;\n\n    // Log validation\n    await orchestrator.logValidation(\n      result,\n      userId,\n      query,\n      output,\n      tier,\n      processingTime\n    );\n\n    // Attach validation info to request for downstream use\n    req.constitutional = {\n      validated: true,\n      complianceScore: result.complianceScore,\n      violations: result.violations,\n      originalOutput: output,\n      validatedOutput: result.validatedOutput\n    };\n\n    // Handle based on validation result and config\n    if (!result.isValid) {\n      return handleViolation(result, body, req, res, originalJson, config);\n    }\n\n    // Replace output with validated version\n    if (body.response) {body.response = result.validatedOutput;}\n    if (body.output) {body.output = result.validatedOutput;}\n    if (body.message) {body.message = result.validatedOutput;}\n    if (body.content) {body.content = result.validatedOutput;}\n\n    // Add metadata if configured\n    if (config.includeMetadata) {\n      body.constitutional = {\n        validated: true,\n        complianceScore: result.complianceScore,\n        violations: result.violations.length,\n        processingTime\n      };\n    }\n\n    return originalJson(body);\n  } catch (error) {\n    console.error('Constitutional validation error:', error);\n    // On error, pass through original response\n    return originalJson(body);\n  }\n}\n\n/**\n * Handle validation violations\n */\nfunction handleViolation(\n  result: any,\n  body: any,\n  req: ConstitutionalRequest,\n  res: Response,\n  originalJson: Function,\n  config: ConstitutionalMiddlewareConfig\n) {\n  switch (config.onViolation) {\n    case 'block':\n      // Block the response and return error\n      return res.status(400).json({\n        error: 'Content validation failed',\n        message: 'The generated content does not meet constitutional standards',\n        complianceScore: result.complianceScore,\n        violations: result.violations.map((v: any) => ({\n          type: v.type,\n          severity: v.severity,\n          description: v.description\n        }))\n      });\n\n    case 'warn':\n      // Send validated output with warning\n      if (body.response) {body.response = result.validatedOutput;}\n      if (body.output) {body.output = result.validatedOutput;}\n      if (body.message) {body.message = result.validatedOutput;}\n      if (body.content) {body.content = result.validatedOutput;}\n\n      body.warning = {\n        message: 'Content was modified to meet constitutional standards',\n        complianceScore: result.complianceScore,\n        violationCount: result.violations.length\n      };\n\n      return originalJson(body);\n\n    case 'log':\n      // Just log and pass through validated output\n      console.warn('Constitutional violation detected:', {\n        complianceScore: result.complianceScore,\n        violations: result.violations.length\n      });\n\n      if (body.response) {body.response = result.validatedOutput;}\n      if (body.output) {body.output = result.validatedOutput;}\n      if (body.message) {body.message = result.validatedOutput;}\n      if (body.content) {body.content = result.validatedOutput;}\n\n      return originalJson(body);\n\n    default:\n      return originalJson(body);\n  }\n}\n\n/**\n * Extract query from request\n */\nfunction extractQuery(req: Request): string {\n  return (\n    req.body?.query ||\n    req.body?.prompt ||\n    req.body?.message ||\n    req.query?.q ||\n    ''\n  );\n}\n\n/**\n * Extract user ID from request\n */\nfunction extractUserId(req: Request): string {\n  // Try to get from auth token\n  const user = (req as any).user;\n  if (user?.id) {return user.id;}\n  if (user?.userId) {return user.userId;}\n\n  // Try to get from headers\n  const userId = req.headers['x-user-id'] as string;\n  if (userId) {return userId;}\n\n  // Fallback to IP address\n  return req.ip || 'anonymous';\n}\n\n/**\n * Create validation rules configuration middleware\n */\nexport function createValidationRulesMiddleware(\n  orchestrator: ConstitutionalOrchestrator\n) {\n  return (req: Request, res: Response, next: NextFunction) => {\n    // Allow dynamic configuration via headers\n    const ubuntuThreshold = req.headers['x-ubuntu-threshold'];\n    const strictMode = req.headers['x-strict-mode'];\n\n    if (ubuntuThreshold || strictMode) {\n      const config: Partial<ConstitutionalAIConfig> = {};\n\n      if (ubuntuThreshold) {\n        config.ubuntuThreshold = parseInt(ubuntuThreshold as string, 10);\n      }\n\n      if (strictMode) {\n        config.strictMode = strictMode === 'true';\n      }\n\n      orchestrator.updateConfig(config);\n    }\n\n    next();\n  };\n}\n\n/**\n * Create compliance metrics endpoint middleware\n */\nexport function createComplianceMetricsMiddleware(\n  orchestrator: ConstitutionalOrchestrator\n) {\n  return async (req: Request, res: Response) => {\n    try {\n      const metrics = await orchestrator.getComplianceMetrics();\n      res.json(metrics);\n    } catch (error) {\n      console.error('Failed to get compliance metrics:', error);\n      res.status(500).json({\n        error: 'Failed to retrieve compliance metrics'\n      });\n    }\n  };\n}\n\n/**\n * Create health check middleware for constitutional AI\n */\nexport function createConstitutionalHealthCheck(\n  orchestrator: ConstitutionalOrchestrator\n) {\n  return async (req: Request, res: Response) => {\n    try {\n      // Test validation with simple input\n      const testResult = await orchestrator.validateOutput(\n        'test query',\n        'This is a test output for health check'\n      );\n\n      res.json({\n        status: 'healthy',\n        constitutional: {\n          enabled: true,\n          complianceScore: testResult.complianceScore,\n          timestamp: new Date()\n        }\n      });\n    } catch (error) {\n      res.status(503).json({\n        status: 'unhealthy',\n        constitutional: {\n          enabled: false,\n          error: (error as Error).message,\n          timestamp: new Date()\n        }\n      });\n    }\n  };\n}\n\n/**\n * Export middleware factory\n */\nexport default createConstitutionalMiddleware;\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAeY;IAAAA,cAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IAAA;EAAA;EAAA,OAAAA,cAAA;AAAA;AAAAD,cAAA;AAfZ;AACA;AACA;AACA;;AAMA;AACA;AACA;;AASA;AACA;AACA;AACA,MAAME,yBAAyD;AAAA;AAAA,CAAAF,cAAA,GAAAG,CAAA,OAAG;EAChEC,OAAO,EAAE,IAAI;EACbC,SAAS,EAAE,CAAC,SAAS,EAAE,UAAU,EAAE,SAAS,CAAC;EAC7CC,WAAW,EAAE,CAAC,SAAS,EAAE,MAAM,CAAC;EAChCC,WAAW,EAAE,OAAO;EACpBC,eAAe,EAAE;AACnB,CAAC;;AAED;AACA;AACA;;AAWA;AACA;AACA;AACA,OAAO,SAASC,8BAA8BA,CAC5CC,YAAwC,EACxCC,MAA+C;AAAA;AAAA,CAAAX,cAAA,GAAAY,CAAA,UAAG,CAAC,CAAC,GACpD;EAAA;EAAAZ,cAAA,GAAAa,CAAA;EACA,MAAMC,gBAAgB;EAAA;EAAA,CAAAd,cAAA,GAAAG,CAAA,OAAG;IAAE,GAAGD,yBAAyB;IAAE,GAAGS;EAAO,CAAC;EAAC;EAAAX,cAAA,GAAAG,CAAA;EAErE,OAAO,OAAOY,GAA0B,EAAEC,GAAa,EAAEC,IAAkB,KAAK;IAAA;IAAAjB,cAAA,GAAAa,CAAA;IAAAb,cAAA,GAAAG,CAAA;IAC9E;IACA,IAAI,CAACW,gBAAgB,CAACV,OAAO,EAAE;MAAA;MAAAJ,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MAC7B,OAAOc,IAAI,CAAC,CAAC;IACf,CAAC;IAAA;IAAA;MAAAjB,cAAA,GAAAY,CAAA;IAAA;;IAED;IAAAZ,cAAA,GAAAG,CAAA;IACA,IAAIW,gBAAgB,CAACT,SAAS,EAAEa,IAAI,CAACC,IAAI,IAAI;MAAA;MAAAnB,cAAA,GAAAa,CAAA;MAAAb,cAAA,GAAAG,CAAA;MAAA,OAAAY,GAAG,CAACI,IAAI,CAACC,UAAU,CAACD,IAAI,CAAC;IAAD,CAAC,CAAC,EAAE;MAAA;MAAAnB,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MACvE,OAAOc,IAAI,CAAC,CAAC;IACf,CAAC;IAAA;IAAA;MAAAjB,cAAA,GAAAY,CAAA;IAAA;;IAED;IAAAZ,cAAA,GAAAG,CAAA;IACA,IAAIW,gBAAgB,CAACR,WAAW,EAAEe,QAAQ,CAACN,GAAG,CAACO,MAAM,CAAC,EAAE;MAAA;MAAAtB,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MACtD,OAAOc,IAAI,CAAC,CAAC;IACf,CAAC;IAAA;IAAA;MAAAjB,cAAA,GAAAY,CAAA;IAAA;;IAED;IACA,MAAMW,YAAY;IAAA;IAAA,CAAAvB,cAAA,GAAAG,CAAA,QAAGa,GAAG,CAACQ,IAAI,CAACC,IAAI,CAACT,GAAG,CAAC;;IAEvC;IAAA;IAAAhB,cAAA,GAAAG,CAAA;IACAa,GAAG,CAACQ,IAAI,GAAG,UAAUE,IAAS,EAAE;MAAA;MAAA1B,cAAA,GAAAa,CAAA;MAAAb,cAAA,GAAAG,CAAA;MAC9B;MACA,IAAIwB,sBAAsB,CAACD,IAAI,CAAC,EAAE;QAAA;QAAA1B,cAAA,GAAAY,CAAA;QAAAZ,cAAA,GAAAG,CAAA;QAChCyB,kBAAkB,CAACF,IAAI,EAAEX,GAAG,EAAEC,GAAG,EAAEO,YAAY,EAAEb,YAAY,EAAEI,gBAAgB,CAAC;MAClF,CAAC,MAAM;QAAA;QAAAd,cAAA,GAAAY,CAAA;QAAAZ,cAAA,GAAAG,CAAA;QACL,OAAOoB,YAAY,CAACG,IAAI,CAAC;MAC3B;IACF,CAAQ;IAAC;IAAA1B,cAAA,GAAAG,CAAA;IAETc,IAAI,CAAC,CAAC;EACR,CAAC;AACH;;AAEA;AACA;AACA;AACA,SAASU,sBAAsBA,CAACD,IAAS,EAAW;EAAA;EAAA1B,cAAA,GAAAa,CAAA;EAAAb,cAAA,GAAAG,CAAA;EAClD;EACA,OACE,2BAAAH,cAAA,GAAAY,CAAA,UAAAc,IAAI;EAAA;EAAA,CAAA1B,cAAA,GAAAY,CAAA,UACJ,OAAOc,IAAI,KAAK,QAAQ;EACvB;EAAA,CAAA1B,cAAA,GAAAY,CAAA,UAAAc,IAAI,CAACG,QAAQ;EAAA;EAAA,CAAA7B,cAAA,GAAAY,CAAA,UAAIc,IAAI,CAACI,MAAM;EAAA;EAAA,CAAA9B,cAAA,GAAAY,CAAA,UAAIc,IAAI,CAACK,OAAO;EAAA;EAAA,CAAA/B,cAAA,GAAAY,CAAA,UAAIc,IAAI,CAACM,OAAO,EAAC;AAElE;;AAEA;AACA;AACA;AACA,eAAeJ,kBAAkBA,CAC/BF,IAAS,EACTX,GAA0B,EAC1BC,GAAa,EACbO,YAAsB,EACtBb,YAAwC,EACxCC,MAAsC,EACxB;EAAA;EAAAX,cAAA,GAAAa,CAAA;EAAAb,cAAA,GAAAG,CAAA;EACd,IAAI;IACF;IACA,MAAM2B,MAAM;IAAA;IAAA,CAAA9B,cAAA,GAAAG,CAAA;IAAG;IAAA,CAAAH,cAAA,GAAAY,CAAA,UAAAc,IAAI,CAACG,QAAQ;IAAA;IAAA,CAAA7B,cAAA,GAAAY,CAAA,UAAIc,IAAI,CAACI,MAAM;IAAA;IAAA,CAAA9B,cAAA,GAAAY,CAAA,UAAIc,IAAI,CAACK,OAAO;IAAA;IAAA,CAAA/B,cAAA,GAAAY,CAAA,UAAIc,IAAI,CAACM,OAAO;IAC3E,MAAMC,KAAK;IAAA;IAAA,CAAAjC,cAAA,GAAAG,CAAA,QAAG+B,YAAY,CAACnB,GAAG,CAAC;IAC/B,MAAMoB,MAAM;IAAA;IAAA,CAAAnC,cAAA,GAAAG,CAAA,QAAGiC,aAAa,CAACrB,GAAG,CAAC;IACjC,MAAMsB,IAAI;IAAA;IAAA,CAAArC,cAAA,GAAAG,CAAA;IAAG;IAAA,CAAAH,cAAA,GAAAY,CAAA,UAAAc,IAAI,CAACW,IAAI;IAAA;IAAA,CAAArC,cAAA,GAAAY,CAAA,UAAI,SAAS;;IAEnC;IACA,MAAM0B,SAAS;IAAA;IAAA,CAAAtC,cAAA,GAAAG,CAAA,QAAGoC,IAAI,CAACC,GAAG,CAAC,CAAC;IAC5B,MAAMC,MAAM;IAAA;IAAA,CAAAzC,cAAA,GAAAG,CAAA,QAAG,MAAMO,YAAY,CAACgC,cAAc,CAACT,KAAK,EAAEH,MAAM,CAAC;IAC/D,MAAMa,cAAc;IAAA;IAAA,CAAA3C,cAAA,GAAAG,CAAA,QAAGoC,IAAI,CAACC,GAAG,CAAC,CAAC,GAAGF,SAAS;;IAE7C;IAAA;IAAAtC,cAAA,GAAAG,CAAA;IACA,MAAMO,YAAY,CAACkC,aAAa,CAC9BH,MAAM,EACNN,MAAM,EACNF,KAAK,EACLH,MAAM,EACNO,IAAI,EACJM,cACF,CAAC;;IAED;IAAA;IAAA3C,cAAA,GAAAG,CAAA;IACAY,GAAG,CAAC8B,cAAc,GAAG;MACnBC,SAAS,EAAE,IAAI;MACfC,eAAe,EAAEN,MAAM,CAACM,eAAe;MACvCC,UAAU,EAAEP,MAAM,CAACO,UAAU;MAC7BC,cAAc,EAAEnB,MAAM;MACtBoB,eAAe,EAAET,MAAM,CAACS;IAC1B,CAAC;;IAED;IAAA;IAAAlD,cAAA,GAAAG,CAAA;IACA,IAAI,CAACsC,MAAM,CAACU,OAAO,EAAE;MAAA;MAAAnD,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MACnB,OAAOiD,eAAe,CAACX,MAAM,EAAEf,IAAI,EAAEX,GAAG,EAAEC,GAAG,EAAEO,YAAY,EAAEZ,MAAM,CAAC;IACtE,CAAC;IAAA;IAAA;MAAAX,cAAA,GAAAY,CAAA;IAAA;;IAED;IAAAZ,cAAA,GAAAG,CAAA;IACA,IAAIuB,IAAI,CAACG,QAAQ,EAAE;MAAA;MAAA7B,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MAACuB,IAAI,CAACG,QAAQ,GAAGY,MAAM,CAACS,eAAe;IAAC,CAAC;IAAA;IAAA;MAAAlD,cAAA,GAAAY,CAAA;IAAA;IAAAZ,cAAA,GAAAG,CAAA;IAC5D,IAAIuB,IAAI,CAACI,MAAM,EAAE;MAAA;MAAA9B,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MAACuB,IAAI,CAACI,MAAM,GAAGW,MAAM,CAACS,eAAe;IAAC,CAAC;IAAA;IAAA;MAAAlD,cAAA,GAAAY,CAAA;IAAA;IAAAZ,cAAA,GAAAG,CAAA;IACxD,IAAIuB,IAAI,CAACK,OAAO,EAAE;MAAA;MAAA/B,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MAACuB,IAAI,CAACK,OAAO,GAAGU,MAAM,CAACS,eAAe;IAAC,CAAC;IAAA;IAAA;MAAAlD,cAAA,GAAAY,CAAA;IAAA;IAAAZ,cAAA,GAAAG,CAAA;IAC1D,IAAIuB,IAAI,CAACM,OAAO,EAAE;MAAA;MAAAhC,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MAACuB,IAAI,CAACM,OAAO,GAAGS,MAAM,CAACS,eAAe;IAAC,CAAC;IAAA;IAAA;MAAAlD,cAAA,GAAAY,CAAA;IAAA;;IAE1D;IAAAZ,cAAA,GAAAG,CAAA;IACA,IAAIQ,MAAM,CAACH,eAAe,EAAE;MAAA;MAAAR,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MAC1BuB,IAAI,CAACmB,cAAc,GAAG;QACpBC,SAAS,EAAE,IAAI;QACfC,eAAe,EAAEN,MAAM,CAACM,eAAe;QACvCC,UAAU,EAAEP,MAAM,CAACO,UAAU,CAACK,MAAM;QACpCV;MACF,CAAC;IACH,CAAC;IAAA;IAAA;MAAA3C,cAAA,GAAAY,CAAA;IAAA;IAAAZ,cAAA,GAAAG,CAAA;IAED,OAAOoB,YAAY,CAACG,IAAI,CAAC;EAC3B,CAAC,CAAC,OAAO4B,KAAK,EAAE;IAAA;IAAAtD,cAAA,GAAAG,CAAA;IACdoD,OAAO,CAACD,KAAK,CAAC,kCAAkC,EAAEA,KAAK,CAAC;IACxD;IAAA;IAAAtD,cAAA,GAAAG,CAAA;IACA,OAAOoB,YAAY,CAACG,IAAI,CAAC;EAC3B;AACF;;AAEA;AACA;AACA;AACA,SAAS0B,eAAeA,CACtBX,MAAW,EACXf,IAAS,EACTX,GAA0B,EAC1BC,GAAa,EACbO,YAAsB,EACtBZ,MAAsC,EACtC;EAAA;EAAAX,cAAA,GAAAa,CAAA;EAAAb,cAAA,GAAAG,CAAA;EACA,QAAQQ,MAAM,CAACJ,WAAW;IACxB,KAAK,OAAO;MAAA;MAAAP,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MACV;MACA,OAAOa,GAAG,CAACwC,MAAM,CAAC,GAAG,CAAC,CAAChC,IAAI,CAAC;QAC1B8B,KAAK,EAAE,2BAA2B;QAClCvB,OAAO,EAAE,8DAA8D;QACvEgB,eAAe,EAAEN,MAAM,CAACM,eAAe;QACvCC,UAAU,EAAEP,MAAM,CAACO,UAAU,CAACS,GAAG,CAAEC,CAAM,IAAM;UAAA;UAAA1D,cAAA,GAAAa,CAAA;UAAAb,cAAA,GAAAG,CAAA;UAAA;YAC7CwD,IAAI,EAAED,CAAC,CAACC,IAAI;YACZC,QAAQ,EAAEF,CAAC,CAACE,QAAQ;YACpBC,WAAW,EAAEH,CAAC,CAACG;UACjB,CAAC;QAAD,CAAE;MACJ,CAAC,CAAC;IAEJ,KAAK,MAAM;MAAA;MAAA7D,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MACT;MACA,IAAIuB,IAAI,CAACG,QAAQ,EAAE;QAAA;QAAA7B,cAAA,GAAAY,CAAA;QAAAZ,cAAA,GAAAG,CAAA;QAACuB,IAAI,CAACG,QAAQ,GAAGY,MAAM,CAACS,eAAe;MAAC,CAAC;MAAA;MAAA;QAAAlD,cAAA,GAAAY,CAAA;MAAA;MAAAZ,cAAA,GAAAG,CAAA;MAC5D,IAAIuB,IAAI,CAACI,MAAM,EAAE;QAAA;QAAA9B,cAAA,GAAAY,CAAA;QAAAZ,cAAA,GAAAG,CAAA;QAACuB,IAAI,CAACI,MAAM,GAAGW,MAAM,CAACS,eAAe;MAAC,CAAC;MAAA;MAAA;QAAAlD,cAAA,GAAAY,CAAA;MAAA;MAAAZ,cAAA,GAAAG,CAAA;MACxD,IAAIuB,IAAI,CAACK,OAAO,EAAE;QAAA;QAAA/B,cAAA,GAAAY,CAAA;QAAAZ,cAAA,GAAAG,CAAA;QAACuB,IAAI,CAACK,OAAO,GAAGU,MAAM,CAACS,eAAe;MAAC,CAAC;MAAA;MAAA;QAAAlD,cAAA,GAAAY,CAAA;MAAA;MAAAZ,cAAA,GAAAG,CAAA;MAC1D,IAAIuB,IAAI,CAACM,OAAO,EAAE;QAAA;QAAAhC,cAAA,GAAAY,CAAA;QAAAZ,cAAA,GAAAG,CAAA;QAACuB,IAAI,CAACM,OAAO,GAAGS,MAAM,CAACS,eAAe;MAAC,CAAC;MAAA;MAAA;QAAAlD,cAAA,GAAAY,CAAA;MAAA;MAAAZ,cAAA,GAAAG,CAAA;MAE1DuB,IAAI,CAACoC,OAAO,GAAG;QACb/B,OAAO,EAAE,uDAAuD;QAChEgB,eAAe,EAAEN,MAAM,CAACM,eAAe;QACvCgB,cAAc,EAAEtB,MAAM,CAACO,UAAU,CAACK;MACpC,CAAC;MAAC;MAAArD,cAAA,GAAAG,CAAA;MAEF,OAAOoB,YAAY,CAACG,IAAI,CAAC;IAE3B,KAAK,KAAK;MAAA;MAAA1B,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MACR;MACAoD,OAAO,CAACS,IAAI,CAAC,oCAAoC,EAAE;QACjDjB,eAAe,EAAEN,MAAM,CAACM,eAAe;QACvCC,UAAU,EAAEP,MAAM,CAACO,UAAU,CAACK;MAChC,CAAC,CAAC;MAAC;MAAArD,cAAA,GAAAG,CAAA;MAEH,IAAIuB,IAAI,CAACG,QAAQ,EAAE;QAAA;QAAA7B,cAAA,GAAAY,CAAA;QAAAZ,cAAA,GAAAG,CAAA;QAACuB,IAAI,CAACG,QAAQ,GAAGY,MAAM,CAACS,eAAe;MAAC,CAAC;MAAA;MAAA;QAAAlD,cAAA,GAAAY,CAAA;MAAA;MAAAZ,cAAA,GAAAG,CAAA;MAC5D,IAAIuB,IAAI,CAACI,MAAM,EAAE;QAAA;QAAA9B,cAAA,GAAAY,CAAA;QAAAZ,cAAA,GAAAG,CAAA;QAACuB,IAAI,CAACI,MAAM,GAAGW,MAAM,CAACS,eAAe;MAAC,CAAC;MAAA;MAAA;QAAAlD,cAAA,GAAAY,CAAA;MAAA;MAAAZ,cAAA,GAAAG,CAAA;MACxD,IAAIuB,IAAI,CAACK,OAAO,EAAE;QAAA;QAAA/B,cAAA,GAAAY,CAAA;QAAAZ,cAAA,GAAAG,CAAA;QAACuB,IAAI,CAACK,OAAO,GAAGU,MAAM,CAACS,eAAe;MAAC,CAAC;MAAA;MAAA;QAAAlD,cAAA,GAAAY,CAAA;MAAA;MAAAZ,cAAA,GAAAG,CAAA;MAC1D,IAAIuB,IAAI,CAACM,OAAO,EAAE;QAAA;QAAAhC,cAAA,GAAAY,CAAA;QAAAZ,cAAA,GAAAG,CAAA;QAACuB,IAAI,CAACM,OAAO,GAAGS,MAAM,CAACS,eAAe;MAAC,CAAC;MAAA;MAAA;QAAAlD,cAAA,GAAAY,CAAA;MAAA;MAAAZ,cAAA,GAAAG,CAAA;MAE1D,OAAOoB,YAAY,CAACG,IAAI,CAAC;IAE3B;MAAA;MAAA1B,cAAA,GAAAY,CAAA;MAAAZ,cAAA,GAAAG,CAAA;MACE,OAAOoB,YAAY,CAACG,IAAI,CAAC;EAC7B;AACF;;AAEA;AACA;AACA;AACA,SAASQ,YAAYA,CAACnB,GAAY,EAAU;EAAA;EAAAf,cAAA,GAAAa,CAAA;EAAAb,cAAA,GAAAG,CAAA;EAC1C,OACE,2BAAAH,cAAA,GAAAY,CAAA,WAAAG,GAAG,CAACW,IAAI,EAAEO,KAAK;EAAA;EAAA,CAAAjC,cAAA,GAAAY,CAAA,WACfG,GAAG,CAACW,IAAI,EAAEuC,MAAM;EAAA;EAAA,CAAAjE,cAAA,GAAAY,CAAA,WAChBG,GAAG,CAACW,IAAI,EAAEK,OAAO;EAAA;EAAA,CAAA/B,cAAA,GAAAY,CAAA,WACjBG,GAAG,CAACkB,KAAK,EAAEiC,CAAC;EAAA;EAAA,CAAAlE,cAAA,GAAAY,CAAA,WACZ,EAAE;AAEN;;AAEA;AACA;AACA;AACA,SAASwB,aAAaA,CAACrB,GAAY,EAAU;EAAA;EAAAf,cAAA,GAAAa,CAAA;EAC3C;EACA,MAAMsD,IAAI;EAAA;EAAA,CAAAnE,cAAA,GAAAG,CAAA,QAAIY,GAAG,CAASoD,IAAI;EAAC;EAAAnE,cAAA,GAAAG,CAAA;EAC/B,IAAIgE,IAAI,EAAEC,EAAE,EAAE;IAAA;IAAApE,cAAA,GAAAY,CAAA;IAAAZ,cAAA,GAAAG,CAAA;IAAC,OAAOgE,IAAI,CAACC,EAAE;EAAC,CAAC;EAAA;EAAA;IAAApE,cAAA,GAAAY,CAAA;EAAA;EAAAZ,cAAA,GAAAG,CAAA;EAC/B,IAAIgE,IAAI,EAAEhC,MAAM,EAAE;IAAA;IAAAnC,cAAA,GAAAY,CAAA;IAAAZ,cAAA,GAAAG,CAAA;IAAC,OAAOgE,IAAI,CAAChC,MAAM;EAAC,CAAC;EAAA;EAAA;IAAAnC,cAAA,GAAAY,CAAA;EAAA;;EAEvC;EACA,MAAMuB,MAAM;EAAA;EAAA,CAAAnC,cAAA,GAAAG,CAAA,QAAGY,GAAG,CAACsD,OAAO,CAAC,WAAW,CAAC,CAAU;EAAC;EAAArE,cAAA,GAAAG,CAAA;EAClD,IAAIgC,MAAM,EAAE;IAAA;IAAAnC,cAAA,GAAAY,CAAA;IAAAZ,cAAA,GAAAG,CAAA;IAAC,OAAOgC,MAAM;EAAC,CAAC;EAAA;EAAA;IAAAnC,cAAA,GAAAY,CAAA;EAAA;;EAE5B;EAAAZ,cAAA,GAAAG,CAAA;EACA,OAAO,2BAAAH,cAAA,GAAAY,CAAA,WAAAG,GAAG,CAACuD,EAAE;EAAA;EAAA,CAAAtE,cAAA,GAAAY,CAAA,WAAI,WAAW;AAC9B;;AAEA;AACA;AACA;AACA,OAAO,SAAS2D,+BAA+BA,CAC7C7D,YAAwC,EACxC;EAAA;EAAAV,cAAA,GAAAa,CAAA;EAAAb,cAAA,GAAAG,CAAA;EACA,OAAO,CAACY,GAAY,EAAEC,GAAa,EAAEC,IAAkB,KAAK;IAAA;IAAAjB,cAAA,GAAAa,CAAA;IAC1D;IACA,MAAM2D,eAAe;IAAA;IAAA,CAAAxE,cAAA,GAAAG,CAAA,QAAGY,GAAG,CAACsD,OAAO,CAAC,oBAAoB,CAAC;IACzD,MAAMI,UAAU;IAAA;IAAA,CAAAzE,cAAA,GAAAG,CAAA,QAAGY,GAAG,CAACsD,OAAO,CAAC,eAAe,CAAC;IAAC;IAAArE,cAAA,GAAAG,CAAA;IAEhD;IAAI;IAAA,CAAAH,cAAA,GAAAY,CAAA,WAAA4D,eAAe;IAAA;IAAA,CAAAxE,cAAA,GAAAY,CAAA,WAAI6D,UAAU,GAAE;MAAA;MAAAzE,cAAA,GAAAY,CAAA;MACjC,MAAMD,MAAuC;MAAA;MAAA,CAAAX,cAAA,GAAAG,CAAA,QAAG,CAAC,CAAC;MAAC;MAAAH,cAAA,GAAAG,CAAA;MAEnD,IAAIqE,eAAe,EAAE;QAAA;QAAAxE,cAAA,GAAAY,CAAA;QAAAZ,cAAA,GAAAG,CAAA;QACnBQ,MAAM,CAAC6D,eAAe,GAAGE,QAAQ,CAACF,eAAe,EAAY,EAAE,CAAC;MAClE,CAAC;MAAA;MAAA;QAAAxE,cAAA,GAAAY,CAAA;MAAA;MAAAZ,cAAA,GAAAG,CAAA;MAED,IAAIsE,UAAU,EAAE;QAAA;QAAAzE,cAAA,GAAAY,CAAA;QAAAZ,cAAA,GAAAG,CAAA;QACdQ,MAAM,CAAC8D,UAAU,GAAGA,UAAU,KAAK,MAAM;MAC3C,CAAC;MAAA;MAAA;QAAAzE,cAAA,GAAAY,CAAA;MAAA;MAAAZ,cAAA,GAAAG,CAAA;MAEDO,YAAY,CAACiE,YAAY,CAAChE,MAAM,CAAC;IACnC,CAAC;IAAA;IAAA;MAAAX,cAAA,GAAAY,CAAA;IAAA;IAAAZ,cAAA,GAAAG,CAAA;IAEDc,IAAI,CAAC,CAAC;EACR,CAAC;AACH;;AAEA;AACA;AACA;AACA,OAAO,SAAS2D,iCAAiCA,CAC/ClE,YAAwC,EACxC;EAAA;EAAAV,cAAA,GAAAa,CAAA;EAAAb,cAAA,GAAAG,CAAA;EACA,OAAO,OAAOY,GAAY,EAAEC,GAAa,KAAK;IAAA;IAAAhB,cAAA,GAAAa,CAAA;IAAAb,cAAA,GAAAG,CAAA;IAC5C,IAAI;MACF,MAAM0E,OAAO;MAAA;MAAA,CAAA7E,cAAA,GAAAG,CAAA,QAAG,MAAMO,YAAY,CAACoE,oBAAoB,CAAC,CAAC;MAAC;MAAA9E,cAAA,GAAAG,CAAA;MAC1Da,GAAG,CAACQ,IAAI,CAACqD,OAAO,CAAC;IACnB,CAAC,CAAC,OAAOvB,KAAK,EAAE;MAAA;MAAAtD,cAAA,GAAAG,CAAA;MACdoD,OAAO,CAACD,KAAK,CAAC,mCAAmC,EAAEA,KAAK,CAAC;MAAC;MAAAtD,cAAA,GAAAG,CAAA;MAC1Da,GAAG,CAACwC,MAAM,CAAC,GAAG,CAAC,CAAChC,IAAI,CAAC;QACnB8B,KAAK,EAAE;MACT,CAAC,CAAC;IACJ;EACF,CAAC;AACH;;AAEA;AACA;AACA;AACA,OAAO,SAASyB,+BAA+BA,CAC7CrE,YAAwC,EACxC;EAAA;EAAAV,cAAA,GAAAa,CAAA;EAAAb,cAAA,GAAAG,CAAA;EACA,OAAO,OAAOY,GAAY,EAAEC,GAAa,KAAK;IAAA;IAAAhB,cAAA,GAAAa,CAAA;IAAAb,cAAA,GAAAG,CAAA;IAC5C,IAAI;MACF;MACA,MAAM6E,UAAU;MAAA;MAAA,CAAAhF,cAAA,GAAAG,CAAA,QAAG,MAAMO,YAAY,CAACgC,cAAc,CAClD,YAAY,EACZ,wCACF,CAAC;MAAC;MAAA1C,cAAA,GAAAG,CAAA;MAEFa,GAAG,CAACQ,IAAI,CAAC;QACPgC,MAAM,EAAE,SAAS;QACjBX,cAAc,EAAE;UACdzC,OAAO,EAAE,IAAI;UACb2C,eAAe,EAAEiC,UAAU,CAACjC,eAAe;UAC3CkC,SAAS,EAAE,IAAI1C,IAAI,CAAC;QACtB;MACF,CAAC,CAAC;IACJ,CAAC,CAAC,OAAOe,KAAK,EAAE;MAAA;MAAAtD,cAAA,GAAAG,CAAA;MACda,GAAG,CAACwC,MAAM,CAAC,GAAG,CAAC,CAAChC,IAAI,CAAC;QACnBgC,MAAM,EAAE,WAAW;QACnBX,cAAc,EAAE;UACdzC,OAAO,EAAE,KAAK;UACdkD,KAAK,EAAGA,KAAK,CAAWvB,OAAO;UAC/BkD,SAAS,EAAE,IAAI1C,IAAI,CAAC;QACtB;MACF,CAAC,CAAC;IACJ;EACF,CAAC;AACH;;AAEA;AACA;AACA;AACA,eAAe9B,8BAA8B","ignoreList":[]}