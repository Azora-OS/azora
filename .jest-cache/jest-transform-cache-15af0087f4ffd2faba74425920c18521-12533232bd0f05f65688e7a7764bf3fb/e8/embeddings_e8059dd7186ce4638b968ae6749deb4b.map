{"version":3,"names":["cov_21q5wn3pe5","actualCoverage","OpenAI","NodeCache","EmbeddingService","model","s","constructor","apiKey","f","openai","cache","stdTTL","generateEmbedding","text","cached","get","b","embedding","response","embeddings","create","input","data","set","timestamp","Date","now","error","console","generateBatchEmbeddings","texts","uncachedTexts","i","length","push","index","batchSize","batch","slice","batchTexts","map","item","j","originalIndex","clearCache","flushAll","getCacheStats","getStats"],"sources":["embeddings.ts"],"sourcesContent":["import { OpenAI } from 'openai';\nimport NodeCache from 'node-cache';\n\ninterface EmbeddingCache {\n  text: string;\n  embedding: number[];\n  timestamp: number;\n}\n\nexport class EmbeddingService {\n  private openai: OpenAI;\n  private cache: NodeCache;\n  private model = 'text-embedding-3-small';\n\n  constructor(apiKey: string) {\n    this.openai = new OpenAI({ apiKey });\n    this.cache = new NodeCache({ stdTTL: 86400 }); // 24 hour TTL\n  }\n\n  /**\n   * Generate embedding for a single text\n   */\n  async generateEmbedding(text: string): Promise<number[]> {\n    // Check cache first\n    const cached = this.cache.get<EmbeddingCache>(text);\n    if (cached) {\n      return cached.embedding;\n    }\n\n    try {\n      const response = await this.openai.embeddings.create({\n        model: this.model,\n        input: text,\n      });\n\n      const embedding = response.data[0].embedding;\n\n      // Cache the result\n      this.cache.set(text, {\n        text,\n        embedding,\n        timestamp: Date.now(),\n      });\n\n      return embedding;\n    } catch (error) {\n      console.error('Error generating embedding:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Generate embeddings for multiple texts in batch\n   */\n  async generateBatchEmbeddings(texts: string[]): Promise<number[][]> {\n    const embeddings: number[][] = [];\n    const uncachedTexts: { index: number; text: string }[] = [];\n\n    // Check cache for each text\n    for (let i = 0; i < texts.length; i++) {\n      const cached = this.cache.get<EmbeddingCache>(texts[i]);\n      if (cached) {\n        embeddings[i] = cached.embedding;\n      } else {\n        uncachedTexts.push({ index: i, text: texts[i] });\n      }\n    }\n\n    // If all cached, return early\n    if (uncachedTexts.length === 0) {\n      return embeddings;\n    }\n\n    // Process uncached texts in batches of 100\n    const batchSize = 100;\n    for (let i = 0; i < uncachedTexts.length; i += batchSize) {\n      const batch = uncachedTexts.slice(i, i + batchSize);\n      const batchTexts = batch.map((item) => item.text);\n\n      try {\n        const response = await this.openai.embeddings.create({\n          model: this.model,\n          input: batchTexts,\n        });\n\n        for (let j = 0; j < response.data.length; j++) {\n          const originalIndex = batch[j].index;\n          const embedding = response.data[j].embedding;\n          embeddings[originalIndex] = embedding;\n\n          // Cache each result\n          this.cache.set(batch[j].text, {\n            text: batch[j].text,\n            embedding,\n            timestamp: Date.now(),\n          });\n        }\n      } catch (error) {\n        console.error('Error generating batch embeddings:', error);\n        throw error;\n      }\n    }\n\n    return embeddings;\n  }\n\n  /**\n   * Clear cache\n   */\n  clearCache(): void {\n    this.cache.flushAll();\n  }\n\n  /**\n   * Get cache stats\n   */\n  getCacheStats() {\n    return this.cache.getStats();\n  }\n}\n\nexport default EmbeddingService;\n"],"mappings":"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","ignoreList":[]}