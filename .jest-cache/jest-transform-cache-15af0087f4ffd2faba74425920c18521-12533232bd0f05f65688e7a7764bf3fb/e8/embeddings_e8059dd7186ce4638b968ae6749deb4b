c570e83c3ad971d3981925d5f9f8e1c3
/* istanbul ignore next */
function cov_21q5wn3pe5() {
  var path = "/workspaces/azora/services/azora-sapiens/src/embeddings.ts";
  var hash = "a0121b641dfe89b44643e5d562b8d273d822555b";
  var global = new Function("return this")();
  var gcv = "__coverage__";
  var coverageData = {
    path: "/workspaces/azora/services/azora-sapiens/src/embeddings.ts",
    statementMap: {
      "0": {
        start: {
          line: 13,
          column: 18
        },
        end: {
          line: 13,
          column: 42
        }
      },
      "1": {
        start: {
          line: 16,
          column: 4
        },
        end: {
          line: 16,
          column: 41
        }
      },
      "2": {
        start: {
          line: 17,
          column: 4
        },
        end: {
          line: 17,
          column: 50
        }
      },
      "3": {
        start: {
          line: 25,
          column: 19
        },
        end: {
          line: 25,
          column: 55
        }
      },
      "4": {
        start: {
          line: 26,
          column: 4
        },
        end: {
          line: 28,
          column: 5
        }
      },
      "5": {
        start: {
          line: 27,
          column: 6
        },
        end: {
          line: 27,
          column: 30
        }
      },
      "6": {
        start: {
          line: 30,
          column: 4
        },
        end: {
          line: 49,
          column: 5
        }
      },
      "7": {
        start: {
          line: 31,
          column: 23
        },
        end: {
          line: 34,
          column: 8
        }
      },
      "8": {
        start: {
          line: 36,
          column: 24
        },
        end: {
          line: 36,
          column: 50
        }
      },
      "9": {
        start: {
          line: 39,
          column: 6
        },
        end: {
          line: 43,
          column: 9
        }
      },
      "10": {
        start: {
          line: 45,
          column: 6
        },
        end: {
          line: 45,
          column: 23
        }
      },
      "11": {
        start: {
          line: 47,
          column: 6
        },
        end: {
          line: 47,
          column: 58
        }
      },
      "12": {
        start: {
          line: 48,
          column: 6
        },
        end: {
          line: 48,
          column: 18
        }
      },
      "13": {
        start: {
          line: 56,
          column: 35
        },
        end: {
          line: 56,
          column: 37
        }
      },
      "14": {
        start: {
          line: 57,
          column: 61
        },
        end: {
          line: 57,
          column: 63
        }
      },
      "15": {
        start: {
          line: 60,
          column: 4
        },
        end: {
          line: 67,
          column: 5
        }
      },
      "16": {
        start: {
          line: 60,
          column: 17
        },
        end: {
          line: 60,
          column: 18
        }
      },
      "17": {
        start: {
          line: 61,
          column: 21
        },
        end: {
          line: 61,
          column: 61
        }
      },
      "18": {
        start: {
          line: 62,
          column: 6
        },
        end: {
          line: 66,
          column: 7
        }
      },
      "19": {
        start: {
          line: 63,
          column: 8
        },
        end: {
          line: 63,
          column: 41
        }
      },
      "20": {
        start: {
          line: 65,
          column: 8
        },
        end: {
          line: 65,
          column: 57
        }
      },
      "21": {
        start: {
          line: 70,
          column: 4
        },
        end: {
          line: 72,
          column: 5
        }
      },
      "22": {
        start: {
          line: 71,
          column: 6
        },
        end: {
          line: 71,
          column: 24
        }
      },
      "23": {
        start: {
          line: 75,
          column: 22
        },
        end: {
          line: 75,
          column: 25
        }
      },
      "24": {
        start: {
          line: 76,
          column: 4
        },
        end: {
          line: 102,
          column: 5
        }
      },
      "25": {
        start: {
          line: 76,
          column: 17
        },
        end: {
          line: 76,
          column: 18
        }
      },
      "26": {
        start: {
          line: 77,
          column: 20
        },
        end: {
          line: 77,
          column: 57
        }
      },
      "27": {
        start: {
          line: 78,
          column: 25
        },
        end: {
          line: 78,
          column: 55
        }
      },
      "28": {
        start: {
          line: 78,
          column: 45
        },
        end: {
          line: 78,
          column: 54
        }
      },
      "29": {
        start: {
          line: 80,
          column: 6
        },
        end: {
          line: 101,
          column: 7
        }
      },
      "30": {
        start: {
          line: 81,
          column: 25
        },
        end: {
          line: 84,
          column: 10
        }
      },
      "31": {
        start: {
          line: 86,
          column: 8
        },
        end: {
          line: 97,
          column: 9
        }
      },
      "32": {
        start: {
          line: 86,
          column: 21
        },
        end: {
          line: 86,
          column: 22
        }
      },
      "33": {
        start: {
          line: 87,
          column: 32
        },
        end: {
          line: 87,
          column: 46
        }
      },
      "34": {
        start: {
          line: 88,
          column: 28
        },
        end: {
          line: 88,
          column: 54
        }
      },
      "35": {
        start: {
          line: 89,
          column: 10
        },
        end: {
          line: 89,
          column: 48
        }
      },
      "36": {
        start: {
          line: 92,
          column: 10
        },
        end: {
          line: 96,
          column: 13
        }
      },
      "37": {
        start: {
          line: 99,
          column: 8
        },
        end: {
          line: 99,
          column: 67
        }
      },
      "38": {
        start: {
          line: 100,
          column: 8
        },
        end: {
          line: 100,
          column: 20
        }
      },
      "39": {
        start: {
          line: 104,
          column: 4
        },
        end: {
          line: 104,
          column: 22
        }
      },
      "40": {
        start: {
          line: 111,
          column: 4
        },
        end: {
          line: 111,
          column: 26
        }
      },
      "41": {
        start: {
          line: 118,
          column: 4
        },
        end: {
          line: 118,
          column: 33
        }
      }
    },
    fnMap: {
      "0": {
        name: "(anonymous_0)",
        decl: {
          start: {
            line: 15,
            column: 2
          },
          end: {
            line: 15,
            column: 3
          }
        },
        loc: {
          start: {
            line: 15,
            column: 30
          },
          end: {
            line: 18,
            column: 3
          }
        },
        line: 15
      },
      "1": {
        name: "(anonymous_1)",
        decl: {
          start: {
            line: 23,
            column: 2
          },
          end: {
            line: 23,
            column: 3
          }
        },
        loc: {
          start: {
            line: 23,
            column: 59
          },
          end: {
            line: 50,
            column: 3
          }
        },
        line: 23
      },
      "2": {
        name: "(anonymous_2)",
        decl: {
          start: {
            line: 55,
            column: 2
          },
          end: {
            line: 55,
            column: 3
          }
        },
        loc: {
          start: {
            line: 55,
            column: 70
          },
          end: {
            line: 105,
            column: 3
          }
        },
        line: 55
      },
      "3": {
        name: "(anonymous_3)",
        decl: {
          start: {
            line: 78,
            column: 35
          },
          end: {
            line: 78,
            column: 36
          }
        },
        loc: {
          start: {
            line: 78,
            column: 45
          },
          end: {
            line: 78,
            column: 54
          }
        },
        line: 78
      },
      "4": {
        name: "(anonymous_4)",
        decl: {
          start: {
            line: 110,
            column: 2
          },
          end: {
            line: 110,
            column: 3
          }
        },
        loc: {
          start: {
            line: 110,
            column: 21
          },
          end: {
            line: 112,
            column: 3
          }
        },
        line: 110
      },
      "5": {
        name: "(anonymous_5)",
        decl: {
          start: {
            line: 117,
            column: 2
          },
          end: {
            line: 117,
            column: 3
          }
        },
        loc: {
          start: {
            line: 117,
            column: 18
          },
          end: {
            line: 119,
            column: 3
          }
        },
        line: 117
      }
    },
    branchMap: {
      "0": {
        loc: {
          start: {
            line: 26,
            column: 4
          },
          end: {
            line: 28,
            column: 5
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 26,
            column: 4
          },
          end: {
            line: 28,
            column: 5
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 26
      },
      "1": {
        loc: {
          start: {
            line: 62,
            column: 6
          },
          end: {
            line: 66,
            column: 7
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 62,
            column: 6
          },
          end: {
            line: 66,
            column: 7
          }
        }, {
          start: {
            line: 64,
            column: 13
          },
          end: {
            line: 66,
            column: 7
          }
        }],
        line: 62
      },
      "2": {
        loc: {
          start: {
            line: 70,
            column: 4
          },
          end: {
            line: 72,
            column: 5
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 70,
            column: 4
          },
          end: {
            line: 72,
            column: 5
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 70
      }
    },
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0,
      "8": 0,
      "9": 0,
      "10": 0,
      "11": 0,
      "12": 0,
      "13": 0,
      "14": 0,
      "15": 0,
      "16": 0,
      "17": 0,
      "18": 0,
      "19": 0,
      "20": 0,
      "21": 0,
      "22": 0,
      "23": 0,
      "24": 0,
      "25": 0,
      "26": 0,
      "27": 0,
      "28": 0,
      "29": 0,
      "30": 0,
      "31": 0,
      "32": 0,
      "33": 0,
      "34": 0,
      "35": 0,
      "36": 0,
      "37": 0,
      "38": 0,
      "39": 0,
      "40": 0,
      "41": 0
    },
    f: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0
    },
    b: {
      "0": [0, 0],
      "1": [0, 0],
      "2": [0, 0]
    },
    _coverageSchema: "1a1c01bbd47fc00a2c39e90264f33305004495a9",
    hash: "a0121b641dfe89b44643e5d562b8d273d822555b"
  };
  var coverage = global[gcv] || (global[gcv] = {});
  if (!coverage[path] || coverage[path].hash !== hash) {
    coverage[path] = coverageData;
  }
  var actualCoverage = coverage[path];
  {
    // @ts-ignore
    cov_21q5wn3pe5 = function () {
      return actualCoverage;
    };
  }
  return actualCoverage;
}
cov_21q5wn3pe5();
import { OpenAI } from 'openai';
import NodeCache from 'node-cache';
export class EmbeddingService {
  model =
  /* istanbul ignore next */
  (cov_21q5wn3pe5().s[0]++, 'text-embedding-3-small');
  constructor(apiKey) {
    /* istanbul ignore next */
    cov_21q5wn3pe5().f[0]++;
    cov_21q5wn3pe5().s[1]++;
    this.openai = new OpenAI({
      apiKey
    });
    /* istanbul ignore next */
    cov_21q5wn3pe5().s[2]++;
    this.cache = new NodeCache({
      stdTTL: 86400
    }); // 24 hour TTL
  }

  /**
   * Generate embedding for a single text
   */
  async generateEmbedding(text) {
    /* istanbul ignore next */
    cov_21q5wn3pe5().f[1]++;
    // Check cache first
    const cached =
    /* istanbul ignore next */
    (cov_21q5wn3pe5().s[3]++, this.cache.get(text));
    /* istanbul ignore next */
    cov_21q5wn3pe5().s[4]++;
    if (cached) {
      /* istanbul ignore next */
      cov_21q5wn3pe5().b[0][0]++;
      cov_21q5wn3pe5().s[5]++;
      return cached.embedding;
    } else
    /* istanbul ignore next */
    {
      cov_21q5wn3pe5().b[0][1]++;
    }
    cov_21q5wn3pe5().s[6]++;
    try {
      const response =
      /* istanbul ignore next */
      (cov_21q5wn3pe5().s[7]++, await this.openai.embeddings.create({
        model: this.model,
        input: text
      }));
      const embedding =
      /* istanbul ignore next */
      (cov_21q5wn3pe5().s[8]++, response.data[0].embedding);

      // Cache the result
      /* istanbul ignore next */
      cov_21q5wn3pe5().s[9]++;
      this.cache.set(text, {
        text,
        embedding,
        timestamp: Date.now()
      });
      /* istanbul ignore next */
      cov_21q5wn3pe5().s[10]++;
      return embedding;
    } catch (error) {
      /* istanbul ignore next */
      cov_21q5wn3pe5().s[11]++;
      console.error('Error generating embedding:', error);
      /* istanbul ignore next */
      cov_21q5wn3pe5().s[12]++;
      throw error;
    }
  }

  /**
   * Generate embeddings for multiple texts in batch
   */
  async generateBatchEmbeddings(texts) {
    /* istanbul ignore next */
    cov_21q5wn3pe5().f[2]++;
    const embeddings =
    /* istanbul ignore next */
    (cov_21q5wn3pe5().s[13]++, []);
    const uncachedTexts =
    /* istanbul ignore next */
    (cov_21q5wn3pe5().s[14]++, []);

    // Check cache for each text
    /* istanbul ignore next */
    cov_21q5wn3pe5().s[15]++;
    for (let i =
    /* istanbul ignore next */
    (cov_21q5wn3pe5().s[16]++, 0); i < texts.length; i++) {
      const cached =
      /* istanbul ignore next */
      (cov_21q5wn3pe5().s[17]++, this.cache.get(texts[i]));
      /* istanbul ignore next */
      cov_21q5wn3pe5().s[18]++;
      if (cached) {
        /* istanbul ignore next */
        cov_21q5wn3pe5().b[1][0]++;
        cov_21q5wn3pe5().s[19]++;
        embeddings[i] = cached.embedding;
      } else {
        /* istanbul ignore next */
        cov_21q5wn3pe5().b[1][1]++;
        cov_21q5wn3pe5().s[20]++;
        uncachedTexts.push({
          index: i,
          text: texts[i]
        });
      }
    }

    // If all cached, return early
    /* istanbul ignore next */
    cov_21q5wn3pe5().s[21]++;
    if (uncachedTexts.length === 0) {
      /* istanbul ignore next */
      cov_21q5wn3pe5().b[2][0]++;
      cov_21q5wn3pe5().s[22]++;
      return embeddings;
    } else
    /* istanbul ignore next */
    {
      cov_21q5wn3pe5().b[2][1]++;
    }

    // Process uncached texts in batches of 100
    const batchSize =
    /* istanbul ignore next */
    (cov_21q5wn3pe5().s[23]++, 100);
    /* istanbul ignore next */
    cov_21q5wn3pe5().s[24]++;
    for (let i =
    /* istanbul ignore next */
    (cov_21q5wn3pe5().s[25]++, 0); i < uncachedTexts.length; i += batchSize) {
      const batch =
      /* istanbul ignore next */
      (cov_21q5wn3pe5().s[26]++, uncachedTexts.slice(i, i + batchSize));
      const batchTexts =
      /* istanbul ignore next */
      (cov_21q5wn3pe5().s[27]++, batch.map(item => {
        /* istanbul ignore next */
        cov_21q5wn3pe5().f[3]++;
        cov_21q5wn3pe5().s[28]++;
        return item.text;
      }));
      /* istanbul ignore next */
      cov_21q5wn3pe5().s[29]++;
      try {
        const response =
        /* istanbul ignore next */
        (cov_21q5wn3pe5().s[30]++, await this.openai.embeddings.create({
          model: this.model,
          input: batchTexts
        }));
        /* istanbul ignore next */
        cov_21q5wn3pe5().s[31]++;
        for (let j =
        /* istanbul ignore next */
        (cov_21q5wn3pe5().s[32]++, 0); j < response.data.length; j++) {
          const originalIndex =
          /* istanbul ignore next */
          (cov_21q5wn3pe5().s[33]++, batch[j].index);
          const embedding =
          /* istanbul ignore next */
          (cov_21q5wn3pe5().s[34]++, response.data[j].embedding);
          /* istanbul ignore next */
          cov_21q5wn3pe5().s[35]++;
          embeddings[originalIndex] = embedding;

          // Cache each result
          /* istanbul ignore next */
          cov_21q5wn3pe5().s[36]++;
          this.cache.set(batch[j].text, {
            text: batch[j].text,
            embedding,
            timestamp: Date.now()
          });
        }
      } catch (error) {
        /* istanbul ignore next */
        cov_21q5wn3pe5().s[37]++;
        console.error('Error generating batch embeddings:', error);
        /* istanbul ignore next */
        cov_21q5wn3pe5().s[38]++;
        throw error;
      }
    }
    /* istanbul ignore next */
    cov_21q5wn3pe5().s[39]++;
    return embeddings;
  }

  /**
   * Clear cache
   */
  clearCache() {
    /* istanbul ignore next */
    cov_21q5wn3pe5().f[4]++;
    cov_21q5wn3pe5().s[40]++;
    this.cache.flushAll();
  }

  /**
   * Get cache stats
   */
  getCacheStats() {
    /* istanbul ignore next */
    cov_21q5wn3pe5().f[5]++;
    cov_21q5wn3pe5().s[41]++;
    return this.cache.getStats();
  }
}
export default EmbeddingService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb3ZfMjFxNXduM3BlNSIsImFjdHVhbENvdmVyYWdlIiwiT3BlbkFJIiwiTm9kZUNhY2hlIiwiRW1iZWRkaW5nU2VydmljZSIsIm1vZGVsIiwicyIsImNvbnN0cnVjdG9yIiwiYXBpS2V5IiwiZiIsIm9wZW5haSIsImNhY2hlIiwic3RkVFRMIiwiZ2VuZXJhdGVFbWJlZGRpbmciLCJ0ZXh0IiwiY2FjaGVkIiwiZ2V0IiwiYiIsImVtYmVkZGluZyIsInJlc3BvbnNlIiwiZW1iZWRkaW5ncyIsImNyZWF0ZSIsImlucHV0IiwiZGF0YSIsInNldCIsInRpbWVzdGFtcCIsIkRhdGUiLCJub3ciLCJlcnJvciIsImNvbnNvbGUiLCJnZW5lcmF0ZUJhdGNoRW1iZWRkaW5ncyIsInRleHRzIiwidW5jYWNoZWRUZXh0cyIsImkiLCJsZW5ndGgiLCJwdXNoIiwiaW5kZXgiLCJiYXRjaFNpemUiLCJiYXRjaCIsInNsaWNlIiwiYmF0Y2hUZXh0cyIsIm1hcCIsIml0ZW0iLCJqIiwib3JpZ2luYWxJbmRleCIsImNsZWFyQ2FjaGUiLCJmbHVzaEFsbCIsImdldENhY2hlU3RhdHMiLCJnZXRTdGF0cyJdLCJzb3VyY2VzIjpbImVtYmVkZGluZ3MudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT3BlbkFJIH0gZnJvbSAnb3BlbmFpJztcbmltcG9ydCBOb2RlQ2FjaGUgZnJvbSAnbm9kZS1jYWNoZSc7XG5cbmludGVyZmFjZSBFbWJlZGRpbmdDYWNoZSB7XG4gIHRleHQ6IHN0cmluZztcbiAgZW1iZWRkaW5nOiBudW1iZXJbXTtcbiAgdGltZXN0YW1wOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBFbWJlZGRpbmdTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBvcGVuYWk6IE9wZW5BSTtcbiAgcHJpdmF0ZSBjYWNoZTogTm9kZUNhY2hlO1xuICBwcml2YXRlIG1vZGVsID0gJ3RleHQtZW1iZWRkaW5nLTMtc21hbGwnO1xuXG4gIGNvbnN0cnVjdG9yKGFwaUtleTogc3RyaW5nKSB7XG4gICAgdGhpcy5vcGVuYWkgPSBuZXcgT3BlbkFJKHsgYXBpS2V5IH0pO1xuICAgIHRoaXMuY2FjaGUgPSBuZXcgTm9kZUNhY2hlKHsgc3RkVFRMOiA4NjQwMCB9KTsgLy8gMjQgaG91ciBUVExcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBlbWJlZGRpbmcgZm9yIGEgc2luZ2xlIHRleHRcbiAgICovXG4gIGFzeW5jIGdlbmVyYXRlRW1iZWRkaW5nKHRleHQ6IHN0cmluZyk6IFByb21pc2U8bnVtYmVyW10+IHtcbiAgICAvLyBDaGVjayBjYWNoZSBmaXJzdFxuICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMuY2FjaGUuZ2V0PEVtYmVkZGluZ0NhY2hlPih0ZXh0KTtcbiAgICBpZiAoY2FjaGVkKSB7XG4gICAgICByZXR1cm4gY2FjaGVkLmVtYmVkZGluZztcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLm9wZW5haS5lbWJlZGRpbmdzLmNyZWF0ZSh7XG4gICAgICAgIG1vZGVsOiB0aGlzLm1vZGVsLFxuICAgICAgICBpbnB1dDogdGV4dCxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBlbWJlZGRpbmcgPSByZXNwb25zZS5kYXRhWzBdLmVtYmVkZGluZztcblxuICAgICAgLy8gQ2FjaGUgdGhlIHJlc3VsdFxuICAgICAgdGhpcy5jYWNoZS5zZXQodGV4dCwge1xuICAgICAgICB0ZXh0LFxuICAgICAgICBlbWJlZGRpbmcsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gZW1iZWRkaW5nO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBnZW5lcmF0aW5nIGVtYmVkZGluZzonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgZW1iZWRkaW5ncyBmb3IgbXVsdGlwbGUgdGV4dHMgaW4gYmF0Y2hcbiAgICovXG4gIGFzeW5jIGdlbmVyYXRlQmF0Y2hFbWJlZGRpbmdzKHRleHRzOiBzdHJpbmdbXSk6IFByb21pc2U8bnVtYmVyW11bXT4ge1xuICAgIGNvbnN0IGVtYmVkZGluZ3M6IG51bWJlcltdW10gPSBbXTtcbiAgICBjb25zdCB1bmNhY2hlZFRleHRzOiB7IGluZGV4OiBudW1iZXI7IHRleHQ6IHN0cmluZyB9W10gPSBbXTtcblxuICAgIC8vIENoZWNrIGNhY2hlIGZvciBlYWNoIHRleHRcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRleHRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBjYWNoZWQgPSB0aGlzLmNhY2hlLmdldDxFbWJlZGRpbmdDYWNoZT4odGV4dHNbaV0pO1xuICAgICAgaWYgKGNhY2hlZCkge1xuICAgICAgICBlbWJlZGRpbmdzW2ldID0gY2FjaGVkLmVtYmVkZGluZztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHVuY2FjaGVkVGV4dHMucHVzaCh7IGluZGV4OiBpLCB0ZXh0OiB0ZXh0c1tpXSB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBJZiBhbGwgY2FjaGVkLCByZXR1cm4gZWFybHlcbiAgICBpZiAodW5jYWNoZWRUZXh0cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBlbWJlZGRpbmdzO1xuICAgIH1cblxuICAgIC8vIFByb2Nlc3MgdW5jYWNoZWQgdGV4dHMgaW4gYmF0Y2hlcyBvZiAxMDBcbiAgICBjb25zdCBiYXRjaFNpemUgPSAxMDA7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB1bmNhY2hlZFRleHRzLmxlbmd0aDsgaSArPSBiYXRjaFNpemUpIHtcbiAgICAgIGNvbnN0IGJhdGNoID0gdW5jYWNoZWRUZXh0cy5zbGljZShpLCBpICsgYmF0Y2hTaXplKTtcbiAgICAgIGNvbnN0IGJhdGNoVGV4dHMgPSBiYXRjaC5tYXAoKGl0ZW0pID0+IGl0ZW0udGV4dCk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5vcGVuYWkuZW1iZWRkaW5ncy5jcmVhdGUoe1xuICAgICAgICAgIG1vZGVsOiB0aGlzLm1vZGVsLFxuICAgICAgICAgIGlucHV0OiBiYXRjaFRleHRzLFxuICAgICAgICB9KTtcblxuICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJlc3BvbnNlLmRhdGEubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICBjb25zdCBvcmlnaW5hbEluZGV4ID0gYmF0Y2hbal0uaW5kZXg7XG4gICAgICAgICAgY29uc3QgZW1iZWRkaW5nID0gcmVzcG9uc2UuZGF0YVtqXS5lbWJlZGRpbmc7XG4gICAgICAgICAgZW1iZWRkaW5nc1tvcmlnaW5hbEluZGV4XSA9IGVtYmVkZGluZztcblxuICAgICAgICAgIC8vIENhY2hlIGVhY2ggcmVzdWx0XG4gICAgICAgICAgdGhpcy5jYWNoZS5zZXQoYmF0Y2hbal0udGV4dCwge1xuICAgICAgICAgICAgdGV4dDogYmF0Y2hbal0udGV4dCxcbiAgICAgICAgICAgIGVtYmVkZGluZyxcbiAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZ2VuZXJhdGluZyBiYXRjaCBlbWJlZGRpbmdzOicsIGVycm9yKTtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGVtYmVkZGluZ3M7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgY2FjaGVcbiAgICovXG4gIGNsZWFyQ2FjaGUoKTogdm9pZCB7XG4gICAgdGhpcy5jYWNoZS5mbHVzaEFsbCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjYWNoZSBzdGF0c1xuICAgKi9cbiAgZ2V0Q2FjaGVTdGF0cygpIHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZS5nZXRTdGF0cygpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEVtYmVkZGluZ1NlcnZpY2U7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBZVk7SUFBQUEsY0FBQSxZQUFBQSxDQUFBO01BQUEsT0FBQUMsY0FBQTtJQUFBO0VBQUE7RUFBQSxPQUFBQSxjQUFBO0FBQUE7QUFBQUQsY0FBQTtBQWZaLFNBQVNFLE1BQU0sUUFBUSxRQUFR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