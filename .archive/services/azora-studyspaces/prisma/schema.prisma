// Azora OS - azora-studyspaces Database Schema
// Ubuntu: "My data strengthens our foundation"

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model StudySpace {
  id          String   @id @default(uuid())
  name        String
  description String?
  ownerId     String
  courseId    String?
  maxMembers  Int      @default(10)
  privacy     PrivacyLevel @default(PUBLIC)
  status      SpaceStatus @default(ACTIVE)
  tags        String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([name])
  @@index([ownerId])
  @@index([courseId])
  @@index([status])
  @@map("study_spaces")
}

model StudySpaceMember {
  id          String   @id @default(uuid())
  spaceId     String
  userId      String
  role        MemberRole @default(MEMBER)
  joinedAt    DateTime @default(now())
  leftAt      DateTime?
  status      MembershipStatus @default(ACTIVE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  space       StudySpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  
  @@unique([spaceId, userId])
  @@index([spaceId])
  @@index([userId])
  @@index([status])
  @@map("study_space_members")
}

model StudySession {
  id          String   @id @default(uuid())
  spaceId     String
  title       String
  description String?
  scheduledAt DateTime
  duration    Int      // in minutes
  hostId      String
  maxParticipants Int  @default(10)
  status      SessionStatus @default(SCHEDULED)
  recordingUrl String?
  tags        String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  space       StudySpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  
  @@index([spaceId])
  @@index([hostId])
  @@index([status])
  @@index([scheduledAt])
  @@map("study_sessions")
}

model SessionParticipant {
  id          String   @id @default(uuid())
  sessionId   String
  userId      String
  joinedAt    DateTime @default(now())
  leftAt      DateTime?
  status      ParticipationStatus @default(ATTENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  session     StudySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@unique([sessionId, userId])
  @@index([sessionId])
  @@index([userId])
  @@map("session_participants")
}

model StudyResource {
  id          String   @id @default(uuid())
  spaceId     String
  title       String
  description String?
  url         String?
  fileType    String?
  fileSize    Int?
  uploadedById String
  accessLevel AccessLevel @default(PUBLIC)
  tags        String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  space       StudySpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  
  @@index([spaceId])
  @@index([uploadedById])
  @@index([accessLevel])
  @@map("study_resources")
}

model StudyTask {
  id          String   @id @default(uuid())
  spaceId     String
  title       String
  description String?
  assignedTo  String?
  dueDate     DateTime?
  priority    TaskPriority @default(MEDIUM)
  status      TaskStatus @default(PENDING)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  space       StudySpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  
  @@index([spaceId])
  @@index([assignedTo])
  @@index([status])
  @@index([dueDate])
  @@map("study_tasks")
}

model StudyMessage {
  id          String   @id @default(uuid())
  spaceId     String
  userId      String
  content     String
  messageType MessageType @default(TEXT)
  parentId    String?  // For threaded replies
  reactions   Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  space       StudySpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  
  @@index([spaceId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@map("study_messages")
}

model StudyProgress {
  id          String   @id @default(uuid())
  spaceId     String
  userId      String
  taskId      String?
  resourceId  String?
  progress    Int      @default(0) // 0-100
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  space       StudySpace @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  
  @@unique([spaceId, userId, taskId])
  @@unique([spaceId, userId, resourceId])
  @@index([spaceId])
  @@index([userId])
  @@map("study_progress")
}

enum PrivacyLevel {
  PUBLIC
  PRIVATE
  COURSE_ONLY
}

enum SpaceStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum MemberRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
}

enum MembershipStatus {
  ACTIVE
  INACTIVE
  REMOVED
  LEFT
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ParticipationStatus {
  ATTENDING
  LEFT
  MISSED
}

enum AccessLevel {
  PUBLIC
  SPACE_MEMBERS
  PRIVATE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

// Constitutional Compliance
model ConstitutionalLog {
  id        String   @id @default(uuid())
  action    String
  userId    String?
  metadata  Json?
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
  @@map("constitutional_logs")
}