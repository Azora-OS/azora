/*
AZORA PROPRIETARY LICENSE
Copyright Â© 2025 Azora ES (Pty) Ltd. All Rights Reserved.

COMPLETE UNIFIED DATABASE SCHEMA - 100%
All missing relations and cross-service synchronization added
*/

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Missing User relations from unified schema
model User {
  // ... (all existing fields from unified-schema.prisma)
  
  // Additional missing relations
  complianceActions ComplianceAction[]
  auditLogs         AuditLog[]
  microserviceMeters MicroserviceMeter[]
  wallet            Wallet?
  
  // Forge/Marketplace relations
  jobsPosted        Job[]    @relation("ClientJobs")
  jobsApplied       Application[]
  jobsAssigned      Job[]    @relation("FreelancerJobs")
  reviews           Review[]
  skillVerifications SkillVerification[]
  
  // Instructor relation
  coursesInstructed Course[] @relation("CourseInstructor")
}

// ============================================================================
// MARKETPLACE & FORGE (Complete Integration)
// ============================================================================

model Job {
  id            String      @id @default(cuid())
  title         String
  description   String
  budget        Decimal     @db.Decimal(20, 2)
  currency      String      @default("AZR")
  skills        String[]
  status        JobStatus   @default(OPEN)
  clientId      String
  freelancerId  String?
  escrowId      String?     @unique
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  client        User        @relation("ClientJobs", fields: [clientId], references: [id])
  freelancer    User?       @relation("FreelancerJobs", fields: [freelancerId], references: [id])
  applications  Application[]
  escrow        Escrow?
  milestones    Milestone[]
  disputes      Dispute[]
  
  @@index([status, createdAt])
  @@index([clientId])
  @@index([freelancerId])
}

model Application {
  id            String      @id @default(cuid())
  jobId         String
  freelancerId  String
  proposal      String
  bidAmount     Decimal     @db.Decimal(20, 2)
  status        ApplicationStatus @default(PENDING)
  createdAt     DateTime    @default(now())
  
  job           Job         @relation(fields: [jobId], references: [id])
  freelancer    User        @relation(fields: [freelancerId], references: [id])
  
  @@unique([jobId, freelancerId])
  @@index([freelancerId])
}

model Escrow {
  id            String      @id @default(cuid())
  jobId         String      @unique
  amount        Decimal     @db.Decimal(20, 2)
  currency      String      @default("AZR")
  status        EscrowStatus @default(HELD)
  createdAt     DateTime    @default(now())
  releasedAt    DateTime?
  
  job           Job         @relation(fields: [jobId], references: [id])
  
  @@index([status])
}

model Milestone {
  id            String      @id @default(cuid())
  jobId         String
  title         String
  description   String
  amount        Decimal     @db.Decimal(20, 2)
  status        MilestoneStatus @default(PENDING)
  dueDate       DateTime?
  completedAt   DateTime?
  createdAt     DateTime    @default(now())
  
  job           Job         @relation(fields: [jobId], references: [id])
  
  @@index([jobId])
}

model Review {
  id            String      @id @default(cuid())
  jobId         String
  reviewerId    String
  revieweeId    String
  rating        Int
  comment       String?
  createdAt     DateTime    @default(now())
  
  reviewer      User        @relation(fields: [reviewerId], references: [id])
  
  @@index([revieweeId])
}

model SkillVerification {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  skill         String
  level         SkillLevel
  verifiedBy    String?
  verifiedAt    DateTime?
  createdAt     DateTime    @default(now())
  
  @@unique([userId, skill])
  @@index([userId])
}

model Dispute {
  id            String      @id @default(cuid())
  jobId         String
  job           Job         @relation(fields: [jobId], references: [id])
  raisedBy      String
  reason        String
  status        DisputeStatus @default(OPEN)
  resolution    String?
  resolvedAt    DateTime?
  createdAt     DateTime    @default(now())
  
  @@index([jobId])
  @@index([status])
}

// ============================================================================
// CROSS-SERVICE SYNCHRONIZATION
// ============================================================================

model ServiceSync {
  id            String      @id @default(cuid())
  serviceName   String
  entityType    String
  entityId      String
  operation     SyncOperation
  data          Json
  status        SyncStatus  @default(PENDING)
  retryCount    Int         @default(0)
  lastError     String?
  createdAt     DateTime    @default(now())
  processedAt   DateTime?
  
  @@index([serviceName, status])
  @@index([entityType, entityId])
}

model EventLog {
  id            String      @id @default(cuid())
  eventType     String
  source        String
  target        String?
  payload       Json
  status        EventStatus @default(PENDING)
  processedAt   DateTime?
  createdAt     DateTime    @default(now())
  
  @@index([eventType, status])
  @@index([source])
}

// ============================================================================
// SECURITY & COMPLIANCE (Complete)
// ============================================================================

model KYCVerification {
  id            String      @id @default(cuid())
  userId        String      @unique
  user          User        @relation(fields: [userId], references: [id])
  status        KYCStatus   @default(PENDING)
  riskLevel     RiskLevel   @default(LOW)
  documentType  String?
  documentNumber String?
  verifiedAt    DateTime?
  expiresAt     DateTime?
  metadata      Json?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([status])
}

model AMLCheck {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  transactionId String?
  amount        Decimal     @db.Decimal(20, 2)
  currency      String
  riskScore     Int
  flagged       Boolean     @default(false)
  reason        String?
  checkedAt     DateTime    @default(now())
  
  @@index([userId])
  @@index([flagged])
}

model SecurityEvent {
  id            String      @id @default(cuid())
  userId        String?
  user          User?       @relation(fields: [userId], references: [id])
  eventType     String
  severity      Severity
  ip            String?
  userAgent     String?
  details       Json?
  createdAt     DateTime    @default(now())
  
  @@index([userId])
  @@index([eventType, severity])
}

// ============================================================================
// ENUMS
// ============================================================================

enum JobStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum EscrowStatus {
  HELD
  RELEASED
  REFUNDED
  DISPUTED
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  APPROVED
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum DisputeStatus {
  OPEN
  IN_REVIEW
  RESOLVED
  ESCALATED
}

enum SyncOperation {
  CREATE
  UPDATE
  DELETE
  SYNC
}

enum SyncStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum EventStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum KYCStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}
