#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Check if we're in a merge commit
if git rev-parse -q --verify MERGE_HEAD; then
  echo "‚ö†Ô∏è  Merge commit detected, skipping pre-commit hooks"
  exit 0
fi

# Run linting
echo "üìù Running ESLint..."
npm run lint --silent || {
  echo "‚ùå Linting failed. Please fix the errors above."
  exit 1
}

# Run type checking
echo "üîç Running TypeScript type check..."
npm run typecheck --silent || {
  echo "‚ùå Type checking failed. Please fix the errors above."
  exit 1
}

# Check test coverage requirements
echo "üìä Checking test coverage requirements..."
node scripts/pre-commit-coverage-check.js || {
  echo "‚ùå Coverage requirements not met. Please add tests."
  exit 1
}

# Run affected tests
echo "üß™ Running affected tests..."
npm run test:affected --silent || {
  echo "‚ùå Tests failed. Please fix the failing tests."
  exit 1
}

# Security checks
echo "üîí Running security audit..."
npm audit --audit-level=high --silent || {
  echo "‚ö†Ô∏è  Security vulnerabilities detected. Please review and fix."
  exit 1
}

# Check for secrets
echo "üîê Checking for secrets..."
if command -v trufflehog >/dev/null 2>&1; then
  trufflehog git file://. --since-commit HEAD~1 --only-verified --fail || {
    echo "‚ùå Secrets detected in commit. Please remove them."
    exit 1
  }
else
  echo "‚ö†Ô∏è  TruffleHog not installed, skipping secret detection"
fi

echo "‚úÖ All pre-commit checks passed!"